rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user has a specific role
    function hasRole(role) {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([role]);
    }
    
    // Helper function to check if user has any of the specified roles
    function hasAnyRole(roles) {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(roles);
    }
    
    // Users collection
    match /users/{userId} {
      // Any authenticated user can read user profiles (needed for FSM assignment dropdown)
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    
    // SUPPLY SIDE (Vendors, Recruitment)
    match /vendors/{vendorId} {
      allow read: if true;
      allow update: if true;
      allow create: if true;
      allow delete: if hasAnyRole(['admin', 'recruiter']);
    }
    
    match /vendor_activities/{activityId} {
      allow read, write: if hasAnyRole(['admin', 'recruiter']);
    }
    
    match /outreach_queue/{queueId} {
      allow read, write: if hasAnyRole(['admin', 'recruiter']);
    }
    
    // SALES SIDE (Leads, Clients)
    match /leads/{leadId} {
      allow create: if true;
      allow read: if true;
      allow update: if true;
      allow delete: if hasAnyRole(['admin', 'sales']);
    }

    match /sales_leads/{leadId} {
      allow read, write: if hasAnyRole(['admin', 'sales']);
    }
    
    match /sales_activities/{activityId} {
      allow read, write: if hasAnyRole(['admin', 'sales']);
    }
    
    match /sales_outreach_queue/{queueId} {
      allow read, write: if hasAnyRole(['admin', 'sales']);
    }
    
    // OPERATIONS BACKBONE (Quotes, Contracts, Work Orders)
    match /quotes/{quoteId} {
      // Authenticated dashboard users
      allow read: if hasAnyRole(['admin', 'sales', 'fsm']);
      // Public review page: allow unauthenticated read on quotes that have been sent
      // Security: reviewToken is a UUID v4 (unguessable), acts as capability-based auth
      allow read: if resource.data.reviewToken is string
                  && resource.data.status in ['sent', 'accepted', 'rejected'];
      allow create: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm']);
      allow update: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm']);
      // Allow public update only to mark as viewed (viewedAt field)
      allow update: if request.auth == null
                    && resource.data.reviewToken is string
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedAt']);
      allow delete: if hasRole('admin');
    }

    // Public quote review (by token) - handled by Cloud Functions, not direct Firestore access

    match /contracts/{contractId} {
      allow read: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm', 'accounting']);
      allow create: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm']);
      allow update: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm']);
      allow delete: if hasRole('admin');
    }

    match /work_orders/{workOrderId} {
      allow read: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm', 'night_mgr']);
      allow create: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'sales_exec', 'fsm']);
      allow update: if hasAnyRole(['admin', 'fsm', 'night_mgr', 'sales_mgr']);
      allow delete: if hasRole('admin');
    }

    match /check_ins/{checkInId} {
      allow read: if hasAnyRole(['admin', 'fsm', 'night_mgr']);
      allow create: if hasAnyRole(['admin', 'fsm', 'night_mgr']);
      allow update: if hasAnyRole(['admin', 'fsm']);
      allow delete: if hasRole('admin');
    }

    match /invoices/{invoiceId} {
      allow read: if hasAnyRole(['admin', 'fsm', 'accounting']);
      allow create: if hasAnyRole(['admin', 'accounting']);
      allow update: if hasAnyRole(['admin', 'accounting']);
      allow delete: if hasRole('admin');
    }

    // Commissions & Ledger
    match /commissions/{commissionId} {
      allow read: if hasAnyRole(['admin', 'accounting', 'sales', 'sales_mgr', 'fsm']);
      allow create: if hasAnyRole(['admin', 'sales', 'sales_mgr', 'fsm']);
      allow update: if hasAnyRole(['admin', 'accounting']);
      allow delete: if hasRole('admin');
    }

    match /commission_ledger/{entryId} {
      allow read: if hasAnyRole(['admin', 'accounting', 'sales', 'sales_mgr', 'fsm']);
      allow create: if request.auth != null;
      allow update, delete: if false; // Immutable audit trail
    }

    // Activity logs - append-only for all authenticated users
    match /activity_logs/{logId} {
      allow read: if hasAnyRole(['admin', 'fsm']);
      allow create: if request.auth != null;
      allow update, delete: if false; // Immutable audit trail
    }
    
    // ADMIN ONLY (Settings, Templates, Agents)
    match /templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if hasRole('admin');
    }
    
    match /agent_configs/{agentId} {
      allow read: if request.auth != null;
      allow write: if hasRole('admin');
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
