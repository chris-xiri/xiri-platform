{"version":3,"sources":["../src/utils/emailUtils.ts","../src/agents/sodaSourcer.ts","../src/utils/queueUtils.ts","../../shared/src/TaxCertificateService.js","../src/index.ts","../src/utils/firebase.ts","../src/agents/recruiter.ts","../src/utils/googlePlacesEnrichment.ts","../src/agents/sourcer.ts","../src/agents/propertySourcer.ts","../src/triggers/onVendorApproved.ts","../src/utils/websiteScraper.ts","../src/utils/emailVerification.ts","../src/utils/phoneValidation.ts","../src/triggers/outreachWorker.ts","../src/agents/salesOutreach.ts","../src/triggers/onIncomingMessage.ts","../src/agents/outreach.ts","../src/triggers/onDocumentUploaded.ts","../src/agents/documentVerifier.ts","../src/triggers/sendBookingConfirmation.ts","../src/triggers/enrichFromWebsite.ts","../src/triggers/onOnboardingComplete.ts","../src/triggers/dripScheduler.ts","../src/triggers/handleUnsubscribe.ts","../src/triggers/sendOnboardingInvite.ts","../src/triggers/sendQuoteEmail.ts","../../../node_modules/uuid/dist/esm/stringify.js","../../../node_modules/uuid/dist/esm/rng.js","../../../node_modules/uuid/dist/esm/native.js","../../../node_modules/uuid/dist/esm/v4.js","../src/triggers/processMailQueue.ts","../src/triggers/onVendorReady.ts","../src/triggers/onLeadQualified.ts","../src/triggers/commissionTriggers.ts","../src/triggers/commissionScheduled.ts","../src/triggers/onAuditSubmitted.ts","../src/triggers/onAuditFailed.ts","../src/triggers/generateMonthlyInvoices.ts","../src/triggers/resendWebhook.ts","../src/triggers/onLeadUpdated.ts","../src/triggers/aiTemplateOptimizer.ts","../src/utils/facebookApi.ts","../src/triggers/socialContentGenerator.ts","../src/triggers/socialPublisher.ts"],"sourcesContent":["import * as admin from \"firebase-admin\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { Resend } from 'resend';\r\n\r\nconst db = admin.firestore();\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst resend = new Resend(process.env.RESEND_API_KEY || \"re_dummy_key\");\r\n\r\ninterface EmailTemplate {\r\n    subject: string;\r\n    content: string;\r\n    variables: string[];\r\n}\r\n\r\n/**\r\n * Fetch a template from Firestore\r\n */\r\nexport async function getTemplate(templateId: string): Promise<EmailTemplate | null> {\r\n    try {\r\n        const doc = await db.collection(\"templates\").doc(templateId).get();\r\n        if (!doc.exists) {\r\n            console.error(`Template ${templateId} not found`);\r\n            return null;\r\n        }\r\n        return doc.data() as EmailTemplate;\r\n    } catch (error) {\r\n        console.error(\"Error fetching template:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Replace variables in template content\r\n */\r\nexport function replaceVariables(content: string, variables: Record<string, string>): string {\r\n    return content.replace(/\\{\\{(\\w+)\\}\\}/g, (_, key) => variables[key] || `{{${key}}}`);\r\n}\r\n\r\n/**\r\n * Generate personalized email using AI\r\n */\r\nexport async function generatePersonalizedEmail(\r\n    templateId: string,\r\n    variables: Record<string, string>\r\n): Promise<{ subject: string; body: string } | null> {\r\n    try {\r\n        const template = await getTemplate(templateId);\r\n        if (!template) return null;\r\n\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const prompt = `You are a professional email writer for Xiri Facility Solutions.\r\n\r\nTake this email template and personalize it while maintaining the core message:\r\n\r\nSubject: ${template.subject}\r\nBody:\r\n${template.content}\r\n\r\nVariables to use:\r\n${Object.entries(variables).map(([key, val]) => `- ${key}: ${val}`).join('\\n')}\r\n\r\nInstructions:\r\n1. Replace all {{variables}} with the actual values\r\n2. Make the tone warm and professional\r\n3. Keep it concise (under 150 words)\r\n4. Output ONLY the email in this format:\r\nSUBJECT: [subject line]\r\nBODY:\r\n[email body]`;\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n\r\n        const response = result.response.text();\r\n        const subjectMatch = response.match(/SUBJECT:\\s*(.+)/);\r\n        const bodyMatch = response.match(/BODY:\\s*([\\s\\S]+)/);\r\n\r\n        if (!subjectMatch || !bodyMatch) {\r\n            // Fallback to simple variable replacement\r\n            return {\r\n                subject: replaceVariables(template.subject, variables),\r\n                body: replaceVariables(template.content, variables)\r\n            };\r\n        }\r\n\r\n        return {\r\n            subject: subjectMatch[1].trim(),\r\n            body: bodyMatch[1].trim()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating email:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Parse a raw US address string into structured components.\r\n * Handles formats like:\r\n * - \"123 Main St, New Hyde Park, NY 11040\"\r\n * - \"123 Main St, New Hyde Park, NY\"\r\n * - \"New Hyde Park, NY 11040\"\r\n */\r\nexport function parseAddress(raw?: string): {\r\n    streetAddress: string;\r\n    city: string;\r\n    state: string;\r\n    zip: string;\r\n} {\r\n    const empty = { streetAddress: '', city: '', state: '', zip: '' };\r\n    if (!raw || raw === 'Unknown') return empty;\r\n\r\n    // Extract ZIP first\r\n    const zipMatch = raw.match(/\\b(\\d{5})(-\\d{4})?\\b/);\r\n    const zip = zipMatch ? zipMatch[1] : '';\r\n\r\n    // Remove ZIP from string for easier parsing\r\n    let cleaned = raw.replace(/\\b\\d{5}(-\\d{4})?\\b/, '').trim().replace(/,\\s*$/, '');\r\n\r\n    // Split by commas\r\n    const parts = cleaned.split(',').map(p => p.trim()).filter(Boolean);\r\n\r\n    if (parts.length >= 3) {\r\n        // \"123 Main St, New Hyde Park, NY\"\r\n        return {\r\n            streetAddress: parts[0],\r\n            city: parts[1],\r\n            state: parts[2].replace(/[^A-Za-z]/g, '').substring(0, 2).toUpperCase(),\r\n            zip\r\n        };\r\n    } else if (parts.length === 2) {\r\n        // Could be \"123 Main St, New Hyde Park\" or \"New Hyde Park, NY\"\r\n        const stateMatch = parts[1].match(/^([A-Z]{2})\\b/);\r\n        if (stateMatch) {\r\n            // \"New Hyde Park, NY\" — no street\r\n            return { streetAddress: '', city: parts[0], state: stateMatch[1], zip };\r\n        }\r\n        // \"123 Main St, New Hyde Park\" — no state\r\n        return { streetAddress: parts[0], city: parts[1], state: '', zip };\r\n    } else if (parts.length === 1) {\r\n        // Single string — try to extract state\r\n        const stateMatch = parts[0].match(/\\b([A-Z]{2})\\b/);\r\n        if (stateMatch) {\r\n            const beforeState = parts[0].substring(0, parts[0].indexOf(stateMatch[1])).trim();\r\n            return { streetAddress: '', city: beforeState, state: stateMatch[1], zip };\r\n        }\r\n        return { streetAddress: '', city: parts[0], state: '', zip };\r\n    }\r\n\r\n    return empty;\r\n}\r\n\r\n/**\r\n * Extract ZIP code from address string (legacy wrapper)\r\n */\r\nfunction extractZipFromAddress(address?: string): string | null {\r\n    return parseAddress(address).zip || null;\r\n}\r\n\r\n/**\r\n * Send templated email (mock for now)\r\n */\r\nexport async function sendTemplatedEmail(\r\n    vendorId: string,\r\n    templateId: string,\r\n    customVariables?: Record<string, string>\r\n): Promise<void> {\r\n    try {\r\n        // Fetch vendor data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            console.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n\r\n        const vendor = vendorDoc.data();\r\n\r\n        // Build variables\r\n        const variables = {\r\n            vendorName: vendor?.businessName || \"Vendor\",\r\n            zipCode: vendor?.zipCode || extractZipFromAddress(vendor?.address) || \"your area\",\r\n            specialty: vendor?.specialty || \"your trade\",\r\n            portalLink: `https://xiri.ai/vendor/onboarding/${vendorId}`,\r\n            ...customVariables\r\n        };\r\n\r\n        // Generate email\r\n        const email = await generatePersonalizedEmail(templateId, variables);\r\n        if (!email) {\r\n            console.error(\"Failed to generate email\");\r\n            return;\r\n        }\r\n\r\n        // Send email via Resend\r\n        let resendId: string | undefined;\r\n        try {\r\n            const { data } = await resend.emails.send({\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                replyTo: 'chris@xiri.ai',\r\n                to: vendor?.email || '',\r\n                subject: email.subject,\r\n                html: email.body,\r\n            });\r\n            resendId = data?.id;\r\n            console.log(`✅ Email sent to ${vendor?.companyName}: ${email.subject} (Resend ID: ${data?.id})`);\r\n        } catch (error) {\r\n            console.error('❌ Resend API error:', error);\r\n            // Log failure but don't throw - non-blocking\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId,\r\n                type: \"EMAIL_FAILED\",\r\n                description: `Failed to send email: ${email.subject}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                metadata: {\r\n                    templateId,\r\n                    subject: email.subject,\r\n                    to: vendor?.email || \"unknown\",\r\n                    error: String(error)\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Log successful send to vendor_activities\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"EMAIL_SENT\",\r\n            description: `Email sent: ${email.subject}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                templateId,\r\n                subject: email.subject,\r\n                body: email.body,\r\n                to: vendor?.email || \"unknown\",\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                replyTo: 'chris@xiri.ai',\r\n                resendId // NEW: Track Resend email ID\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error sending email:\", error);\r\n    }\r\n}\r\n\r\n/**\r\n * Send a raw email with optional attachments\r\n * Returns { success, resendId } so callers can store the ID for webhook tracking.\r\n */\r\nexport async function sendEmail(\r\n    to: string,\r\n    subject: string,\r\n    html: string,\r\n    attachments?: any[],\r\n    from?: string,\r\n    vendorId?: string,\r\n    templateId?: string\r\n): Promise<{ success: boolean; resendId?: string }> {\r\n    try {\r\n        // Build tags array for webhook tracking\r\n        const tags: { name: string; value: string }[] = [];\r\n        if (vendorId) tags.push({ name: 'vendorId', value: vendorId });\r\n        if (templateId) tags.push({ name: 'templateId', value: templateId });\r\n\r\n        const { data, error } = await resend.emails.send({\r\n            from: from || 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            replyTo: 'chris@xiri.ai',\r\n            to,\r\n            subject,\r\n            html,\r\n            attachments,\r\n            ...(tags.length > 0 ? { tags } : {}),\r\n        });\r\n\r\n        if (error) {\r\n            console.error('❌ Resend API error:', error);\r\n            return { success: false };\r\n        }\r\n\r\n        console.log(`✅ Email sent to ${to}: ${subject} (ID: ${data?.id})`);\r\n        return { success: true, resendId: data?.id };\r\n    } catch (err) {\r\n        console.error('Error sending raw email:', err);\r\n        return { success: false };\r\n    }\r\n}\r\n","import axios from 'axios';\r\nimport { RawVendor } from './sourcer';\r\n\r\n/**\r\n * NYC Open Data Sourcer\r\n * \r\n * Queries two SODA API datasets:\r\n * 1. NYC DCA Issued Licenses (5 boroughs) — dataset: w7w3-xahh\r\n * 2. NY State Active Corporations (state-wide, covers Nassau/Suffolk) — dataset: 7tqb-y2d4\r\n * \r\n * No API key required (public data).\r\n */\r\n\r\n// ─── NYC DCA: Issued Licenses (5 boroughs) ─────────────────────\r\nconst NYC_DCA_ENDPOINT = 'https://data.cityofnewyork.us/resource/w7w3-xahh.json';\r\n\r\n// SODA query: search business names for facility service keywords\r\n// DCA categories don't map well to commercial services, so name search is more effective\r\n\r\nasync function searchNycDca(query: string, location: string, dcaCategory?: string, limit: number = 50): Promise<RawVendor[]> {\r\n    let where = \"license_status='Active'\";\r\n\r\n    if (dcaCategory) {\r\n        // If exact category is selected, filter by it directly\r\n        where += ` AND business_category='${dcaCategory.replace(/'/g, \"''\")}'`;\r\n    } else {\r\n        // Build name keyword filter from the user's search query\r\n        const queryWords = query.toLowerCase().split(/\\s+/).filter(w => w.length > 2);\r\n\r\n        // If no useful keywords from query, use common facility service terms\r\n        const searchTerms = queryWords.length > 0 ? queryWords : ['clean', 'janitor', 'maintenance', 'hvac'];\r\n        const nameFilter = searchTerms\r\n            .map(w => `upper(business_name) like '%${w.toUpperCase()}%'`)\r\n            .join(' OR ');\r\n\r\n        where += ` AND (${nameFilter})`;\r\n    }\r\n\r\n    // Location filter — map common names to boroughs\r\n    const boroughMap: Record<string, string> = {\r\n        'manhattan': 'Manhattan', 'nyc': '', 'new york': '',\r\n        'brooklyn': 'Brooklyn', 'queens': 'Queens',\r\n        'bronx': 'Bronx', 'staten island': 'Staten Island',\r\n    };\r\n    const normalizedLoc = location.toLowerCase().trim();\r\n    const borough = boroughMap[normalizedLoc];\r\n\r\n    if (borough) {\r\n        where += ` AND address_borough='${borough}'`;\r\n    }\r\n\r\n    try {\r\n        const params = new URLSearchParams({\r\n            '$limit': String(limit),\r\n            '$where': where,\r\n            '$select': 'business_name,business_category,contact_phone,address_building,address_street_name,address_city,address_state,address_zip,address_borough,license_status,lic_expir_dd,latitude,longitude',\r\n            '$order': 'business_name ASC',\r\n        });\r\n\r\n        console.log(`[SODA/NYC] Querying DCA: ${where}`);\r\n        const response = await axios.get(`${NYC_DCA_ENDPOINT}?${params}`);\r\n        const results = response.data || [];\r\n        console.log(`[SODA/NYC] Found ${results.length} results from NYC DCA`);\r\n\r\n        return results.map((item: any) => ({\r\n            name: item.business_name,\r\n            description: `NYC DCA Licensed ${item.business_category} (${item.license_status})`,\r\n            location: `${item.address_building} ${item.address_street_name}, ${item.address_city}, ${item.address_state} ${item.address_zip}`,\r\n            phone: item.contact_phone,\r\n            source: 'nyc_open_data',\r\n            dcaCategory: item.business_category,\r\n            rating: undefined,\r\n            user_ratings_total: undefined,\r\n        }));\r\n    } catch (error: any) {\r\n        console.error('[SODA/NYC] Error:', error.message);\r\n        return [];\r\n    }\r\n}\r\n\r\n// ─── NY State: Active Corporations (Nassau/Suffolk/State-wide) ──\r\nconst NYS_CORP_ENDPOINT = 'https://data.ny.gov/resource/n9v6-gdp6.json';\r\n\r\nasync function searchNyState(query: string, location: string, limit: number = 50): Promise<RawVendor[]> {\r\n    // Build keyword filter from query. Split by space, comma, or slash.\r\n    const queryWords = query.toLowerCase().split(/[\\s,\\/]+/).filter(w => w.length > 3);\r\n    const nameFilters = queryWords\r\n        .map(w => `upper(current_entity_name) like '%${w.toUpperCase()}%'`)\r\n        .join(' OR ');\r\n\r\n    // Location filter\r\n    const locationWords = location.toLowerCase().split(/[\\s,\\/]+/).filter(w => w.length > 2);\r\n    let locFilter = '';\r\n    if (locationWords.length > 0) {\r\n        const locConditions = locationWords.map(w =>\r\n            `(upper(dos_process_city) like '%${w.toUpperCase()}%' OR upper(county) like '%${w.toUpperCase()}%')`\r\n        ).join(' OR ');\r\n        locFilter = ` AND (${locConditions})`;\r\n    }\r\n\r\n    const where = `(${nameFilters || \"current_entity_name like '%CLEAN%'\"})${locFilter}`;\r\n\r\n    try {\r\n        const params = new URLSearchParams({\r\n            '$limit': String(limit),\r\n            '$where': where,\r\n            '$order': 'initial_dos_filing_date DESC',\r\n        });\r\n\r\n        console.log(`[SODA/NYS] Querying State Corps: ${where}`);\r\n        const response = await axios.get(`${NYS_CORP_ENDPOINT}?${params}`);\r\n        const results = response.data || [];\r\n        console.log(`[SODA/NYS] Found ${results.length} results from NY State`);\r\n\r\n        return results.map((b: any) => ({\r\n            name: titleCase(b.current_entity_name || ''),\r\n            description: `${b.entity_type_desc || 'Business Entity'} — Registered in NY State. Filed: ${b.initial_dos_filing_date ? new Date(b.initial_dos_filing_date).toLocaleDateString() : 'N/A'}`,\r\n            location: [b.dos_process_address_1, b.dos_process_city, 'NY', b.dos_process_zip].filter(Boolean).join(', '),\r\n            phone: undefined,\r\n            source: 'ny_state_corps',\r\n            rating: undefined,\r\n            user_ratings_total: undefined,\r\n        }));\r\n    } catch (error: any) {\r\n        console.error('[SODA/NYS] Error:', error.message);\r\n        return [];\r\n    }\r\n}\r\n\r\n// ─── Combined SODA Search ───────────────────────────────────────\r\n\r\n/**\r\n * Search SODA open data sources for vendors.\r\n * Combines NYC DCA (5 boroughs) + NY State Corps (state-wide including Nassau/Suffolk).\r\n */\r\nexport async function searchVendorsSoda(query: string, location: string, dcaCategory?: string): Promise<RawVendor[]> {\r\n    const normalizedLoc = location.toLowerCase().trim();\r\n\r\n    // Determine which datasets to query based on location\r\n    const isNycBorough = ['manhattan', 'brooklyn', 'queens', 'bronx', 'staten island', 'nyc', 'new york city', 'new york'].includes(normalizedLoc);\r\n    const isLongIsland = ['nassau', 'suffolk', 'long island', 'garden city', 'mineola', 'hempstead', 'hicksville', 'huntington', 'babylon', 'islip'].includes(normalizedLoc);\r\n\r\n    const results: RawVendor[] = [];\r\n\r\n    if (isNycBorough || (!isLongIsland)) {\r\n        // Query NYC DCA for boroughs (or if location is ambiguous, try both)\r\n        const nycResults = await searchNycDca(query, location, dcaCategory, 25);\r\n        results.push(...nycResults);\r\n    }\r\n\r\n    // Always query NY State for broader coverage (especially Nassau/Suffolk)\r\n    const nysResults = await searchNyState(query, location, 25);\r\n    results.push(...nysResults);\r\n\r\n    // Deduplicate by business name (rough match)\r\n    const seen = new Set<string>();\r\n    const deduped = results.filter(v => {\r\n        const key = v.name.toLowerCase().replace(/[^a-z0-9]/g, '');\r\n        if (seen.has(key)) return false;\r\n        seen.add(key);\r\n        return true;\r\n    });\r\n\r\n    console.log(`[SODA] Total: ${deduped.length} unique vendors (${results.length} before dedup)`);\r\n    return deduped;\r\n}\r\n\r\n// ─── Utility ─────────────────────────────────────────────────────\r\nfunction titleCase(s: string): string {\r\n    return s.toLowerCase().replace(/\\b\\w/g, c => c.toUpperCase());\r\n}\r\n","import * as admin from 'firebase-admin';\r\n\r\nexport type QueueTaskType = 'GENERATE' | 'SEND' | 'FOLLOW_UP';\r\nexport type QueueStatus = 'PENDING' | 'RETRY' | 'COMPLETED' | 'FAILED' | 'CANCELLED';\r\n\r\nexport interface QueueItem {\r\n    id?: string;\r\n    vendorId?: string;    // For vendor outreach\r\n    leadId?: string;      // For sales lead outreach\r\n    type: QueueTaskType;\r\n    status: QueueStatus;\r\n    scheduledAt: admin.firestore.Timestamp;\r\n    createdAt: admin.firestore.Timestamp;\r\n    retryCount: number;\r\n    error?: string;\r\n    metadata?: any; // e.g. drafts for SEND task, sequence number for FOLLOW_UP\r\n}\r\n\r\nconst COLLECTION = 'outreach_queue';\r\n\r\nexport async function enqueueTask(db: admin.firestore.Firestore, task: Omit<QueueItem, 'id' | 'createdAt' | 'retryCount' | 'status'>) {\r\n    return db.collection(COLLECTION).add({\r\n        ...task,\r\n        status: 'PENDING',\r\n        retryCount: 0,\r\n        createdAt: new Date() as any\r\n    });\r\n}\r\n\r\nexport async function fetchPendingTasks(db: admin.firestore.Firestore) {\r\n    const now = admin.firestore.Timestamp.now();\r\n\r\n    // Fetch items that are PENDING or RETRY and scheduled time is past\r\n    // NOTE: Requires composite index if we mix filter + sort on different fields extensively.\r\n    // Simple query: Status IN ['PENDING', 'RETRY'] AND scheduledAt <= now\r\n\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .where('scheduledAt', '<=', now)\r\n        .limit(10) // Process in batches\r\n        .get();\r\n\r\n    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as QueueItem));\r\n}\r\n\r\nexport async function updateTaskStatus(db: admin.firestore.Firestore, taskId: string, status: QueueStatus, updates: Partial<QueueItem> = {}) {\r\n    await db.collection(COLLECTION).doc(taskId).update({\r\n        status,\r\n        ...updates\r\n    });\r\n}\r\n\r\n/**\r\n * Cancel all pending/retry tasks for a vendor (used on unsubscribe/dismiss).\r\n */\r\nexport async function cancelVendorTasks(db: admin.firestore.Firestore, vendorId: string) {\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('vendorId', '==', vendorId)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .get();\r\n\r\n    const batch = db.batch();\r\n    snapshot.docs.forEach(doc => {\r\n        batch.update(doc.ref, { status: 'CANCELLED', cancelledAt: new Date() });\r\n    });\r\n    await batch.commit();\r\n    return snapshot.size;\r\n}\r\n\r\n/**\r\n * Cancel all pending/retry tasks for a lead (used on lead dismissal/loss).\r\n */\r\nexport async function cancelLeadTasks(db: admin.firestore.Firestore, leadId: string) {\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('leadId', '==', leadId)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .get();\r\n\r\n    const batch = db.batch();\r\n    snapshot.docs.forEach(doc => {\r\n        batch.update(doc.ref, { status: 'CANCELLED', cancelledAt: new Date() });\r\n    });\r\n    await batch.commit();\r\n    return snapshot.size;\r\n}\r\n\r\n","\"use strict\";\n/**\n * TaxCertificateService\n *\n * Fills the official NY State ST-120.1 (Contractor Exempt Purchase Certificate)\n * fillable PDF template for a specific project/address when a vendor is assigned\n * to a Work Order.\n *\n * One ST-120.1 per project/address. XIRI holds the certificate.\n * The vendor's Certificate of Authority sales tax ID is required.\n *\n * Flow:\n * 1. Vendor assigned to WO → pull client address + vendor info\n * 2. Fill official ST-120.1 template (Line 2 = project/address/owner)\n * 3. Check Box M (services purchased for resale)\n * 4. Embed XIRI's authorized digital signature\n * 5. Upload to Storage, email to vendor\n */\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.generateST1201 = generateST1201;\nconst pdf_lib_1 = require(\"pdf-lib\");\nconst fs = __importStar(require(\"fs\"));\nconst path = __importStar(require(\"path\"));\n// ─── Constants ────────────────────────────────────────────────\nconst CERT_VALIDITY_YEARS = 3;\n/**\n * Official ST-120.1 fillable form field names (36 fields total).\n *\n * Section 1 — Vendor (seller providing services to XIRI):\n *   \"name of vendor\", \"street address1\", \"city1\", \"state1\", \"zip code 1\"\n *\n * Section 2 — Purchaser (XIRI buying for resale):\n *   \"name of purchasing contractor\", \"street address2\", \"city2\", \"state2\", \"zip code 2\"\n *\n * Vendor's sales tax ID:\n *   \"enter your sales tax vendor id number\"\n *\n * Line 2 — Project details (one ST-120.1 per project):\n *   \"line 2 1\" = project name\n *   \"line 2 2\" = project address\n *   \"line 2 3\" = owner name\n *   \"line 2 4\" = owner address\n *\n * Signature:\n *   \"type or print name and title of owner\"\n *   \"date prepared\"\n *\n * Checkboxes (a-s):\n *   \"box m\" = services purchased for resale ← always checked\n */\n// ─── Service ──────────────────────────────────────────────────\n/**\n * Fill the official NY State ST-120.1 PDF template with vendor, XIRI, and project data.\n *\n * @param vendorData  - Vendor's business info and sales tax ID\n * @param xiriData    - XIRI corporate info and authorized signature\n * @param projectData - Work order location / project owner info\n * @returns           - Result with PDF bytes and validity dates\n */\nasync function generateST1201(vendorData, xiriData, projectData) {\n    // ── Validate vendor has a sales tax ID ──\n    if (!vendorData.salesTaxId || vendorData.salesTaxId.trim().length === 0) {\n        return {\n            success: false,\n            error: 'Vendor does not have a valid Sales Tax ID (Certificate of Authority). Cannot generate ST-120.1.',\n        };\n    }\n    try {\n        // ── Calculate dates ──\n        const now = new Date();\n        const issueDate = now.toLocaleDateString('en-US');\n        const expiry = new Date(now);\n        expiry.setFullYear(expiry.getFullYear() + CERT_VALIDITY_YEARS);\n        const expiryDate = expiry.toISOString().split('T')[0]; // ISO for storage\n        // ── Load official ST-120.1 template ──\n        const templatePath = path.resolve(__dirname, 'templates', 'st120_1_template.pdf');\n        const templateBytes = fs.readFileSync(templatePath);\n        const pdfDoc = await pdf_lib_1.PDFDocument.load(templateBytes);\n        const form = pdfDoc.getForm();\n        // ── Section 1: Vendor (seller) ──\n        form.getTextField('name of vendor').setText(vendorData.businessName);\n        form.getTextField('street address1').setText(vendorData.address || '');\n        form.getTextField('city1').setText(vendorData.city || '');\n        form.getTextField('state1').setText(vendorData.state || '');\n        form.getTextField('zip code 1').setText(vendorData.zip || '');\n        // ── Vendor's sales tax ID ──\n        form.getTextField('enter your sales tax vendor id number').setText(vendorData.salesTaxId);\n        // ── Section 2: Purchaser (XIRI) ──\n        form.getTextField('name of purchasing contractor').setText(xiriData.businessName);\n        form.getTextField('street address2').setText(xiriData.address);\n        form.getTextField('city2').setText(xiriData.city);\n        form.getTextField('state2').setText(xiriData.state);\n        form.getTextField('zip code 2').setText(xiriData.zip);\n        // ── Line 2: Project details ──\n        form.getTextField('line 2 1').setText(projectData.projectName);\n        const fullProjectAddress = [\n            projectData.projectAddress,\n            projectData.projectCity,\n            projectData.projectState,\n            projectData.projectZip,\n        ].filter(Boolean).join(', ');\n        form.getTextField('line 2 2').setText(fullProjectAddress);\n        form.getTextField('line 2 3').setText(projectData.ownerName);\n        form.getTextField('line 2 4').setText(projectData.ownerAddress);\n        // ── Box M: Services purchased for resale ──\n        form.getCheckBox('box m').check();\n        // ── Signature block ──\n        form.getTextField('type or print name and title of owner').setText(`${xiriData.signerName}, ${xiriData.signerTitle}`);\n        form.getTextField('date prepared').setText(issueDate);\n        // ── Embed digital signature image ──\n        if (xiriData.signatureImageBase64) {\n            try {\n                const sigBytes = Buffer.from(xiriData.signatureImageBase64, 'base64');\n                let sigImage;\n                try {\n                    sigImage = await pdfDoc.embedPng(sigBytes);\n                }\n                catch {\n                    sigImage = await pdfDoc.embedJpg(sigBytes);\n                }\n                // Draw signature on the last page near the signature line\n                const pages = pdfDoc.getPages();\n                const lastPage = pages[pages.length - 1];\n                const { height } = lastPage.getSize();\n                // Position near bottom of last page — signature area\n                lastPage.drawImage(sigImage, {\n                    x: 72,\n                    y: height - 720, // near bottom of form\n                    width: 150,\n                    height: 40,\n                });\n            }\n            catch (sigErr) {\n                // Signature embedding failed — form is still valid without it\n                console.warn('Could not embed signature image:', sigErr);\n            }\n        }\n        // ── Flatten form (make fields read-only) ──\n        form.flatten();\n        // ── Serialize ──\n        const pdfBytes = await pdfDoc.save();\n        return {\n            success: true,\n            pdfBytes,\n            issueDate: now.toISOString().split('T')[0], // ISO for storage\n            expiryDate,\n        };\n    }\n    catch (error) {\n        return {\n            success: false,\n            error: `Failed to generate ST-120.1: ${error.message}`,\n        };\n    }\n}\n","import { onCall, onRequest, HttpsError } from \"firebase-functions/v2/https\";\r\nimport { db } from \"./utils/firebase\";\r\nimport { analyzeVendorLeads } from \"./agents/recruiter\";\r\nimport { searchVendors } from \"./agents/sourcer\";\r\nimport { searchProperties } from \"./agents/propertySourcer\";\r\n// import { telegramWebhook, autoApproveVendor, notifyHumanReview, onVendorCreated } from \"./triggers/telegramBot\";\r\nimport { onVendorApproved, onVendorCreated } from \"./triggers/onVendorApproved\";\r\nimport { processOutreachQueue } from \"./triggers/outreachWorker\";\r\nimport { onIncomingMessage } from \"./triggers/onIncomingMessage\";\r\nimport { onDocumentUploaded } from \"./triggers/onDocumentUploaded\";\r\nimport { sendBookingConfirmation } from \"./triggers/sendBookingConfirmation\";\r\nimport { enrichFromWebsite } from \"./triggers/enrichFromWebsite\";\r\nimport { onOnboardingComplete } from \"./triggers/onOnboardingComplete\";\r\nimport { onAwaitingOnboarding } from \"./triggers/dripScheduler\";\r\nimport { handleUnsubscribe } from \"./triggers/handleUnsubscribe\";\r\nimport { sendOnboardingInvite } from \"./triggers/sendOnboardingInvite\";\r\nimport { sendQuoteEmail, respondToQuote } from \"./triggers/sendQuoteEmail\";\r\nimport { processMailQueue } from \"./triggers/processMailQueue\";\r\nimport { onWorkOrderAssigned } from \"./triggers/onVendorReady\";\r\nimport { onLeadQualified } from \"./triggers/onLeadQualified\";\r\nimport { onQuoteAccepted, onInvoicePaid, onWorkOrderHandoff, onClientCancelled } from \"./triggers/commissionTriggers\";\r\nimport { processCommissionPayouts, calculateNrr } from \"./triggers/commissionScheduled\";\r\nimport { onAuditSubmitted } from \"./triggers/onAuditSubmitted\";\r\nimport { onAuditFailed } from \"./triggers/onAuditFailed\";\r\nimport { generateMonthlyInvoices } from \"./triggers/generateMonthlyInvoices\";\r\nimport { resendWebhook } from \"./triggers/resendWebhook\";\r\nimport { onLeadUpdated, onVendorUpdated, onStaffUpdated } from \"./triggers/onLeadUpdated\";\r\nimport { weeklyTemplateOptimizer, optimizeTemplate } from \"./triggers/aiTemplateOptimizer\";\r\n\r\n// Export Bot Functions (Telegram disabled for now)\r\n// export { telegramWebhook, autoApproveVendor, onVendorCreated, onVendorApproved, processOutreachQueue, onIncomingMessage, onDocumentUploaded };\r\nexport { onVendorApproved, onVendorCreated, processOutreachQueue, onIncomingMessage, onDocumentUploaded, sendBookingConfirmation, enrichFromWebsite, onOnboardingComplete, onAwaitingOnboarding, handleUnsubscribe, sendOnboardingInvite, sendQuoteEmail, respondToQuote, processMailQueue, onWorkOrderAssigned, onLeadQualified, onQuoteAccepted, onInvoicePaid, onWorkOrderHandoff, onClientCancelled, processCommissionPayouts, calculateNrr, onAuditSubmitted, onAuditFailed, generateMonthlyInvoices, resendWebhook, onLeadUpdated, onVendorUpdated, onStaffUpdated, weeklyTemplateOptimizer, optimizeTemplate };\r\n\r\n// ─── Admin: Sync Auth Email/Password ─────────────────────────────────────────\r\nimport { getAuth } from \"firebase-admin/auth\";\r\n\r\nconst DASHBOARD_CORS = [\r\n    \"http://localhost:3001\",\r\n    \"http://localhost:3000\",\r\n    \"https://xiri.ai\",\r\n    \"https://www.xiri.ai\",\r\n    \"https://app.xiri.ai\",\r\n    \"https://xiri-dashboard.vercel.app\",\r\n    \"https://xiri-dashboard-git-develop-xiri-facility-solutions.vercel.app\",\r\n    /https:\\/\\/xiri-dashboard-.*\\.vercel\\.app$/,\r\n    \"https://xiri-facility-solutions.web.app\",\r\n    \"https://xiri-facility-solutions.firebaseapp.com\"\r\n];\r\n\r\n/**\r\n * Admin-only: update a user's email and/or password in Firebase Auth\r\n * Called from admin user management when editing a user\r\n */\r\nexport const adminUpdateAuthUser = onCall({\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    // Verify caller is admin\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n    const callerDoc = await db.collection(\"users\").doc(request.auth.uid).get();\r\n    const callerRoles = callerDoc.data()?.roles || [];\r\n    if (!callerRoles.includes(\"admin\")) throw new HttpsError(\"permission-denied\", \"Admin only\");\r\n\r\n    const { uid, email, password, displayName } = request.data;\r\n    if (!uid) throw new HttpsError(\"invalid-argument\", \"uid is required\");\r\n\r\n    const updatePayload: Record<string, string> = {};\r\n    if (email) updatePayload.email = email;\r\n    if (password) updatePayload.password = password;\r\n    if (displayName) updatePayload.displayName = displayName;\r\n\r\n    if (Object.keys(updatePayload).length === 0) {\r\n        throw new HttpsError(\"invalid-argument\", \"Nothing to update\");\r\n    }\r\n\r\n    try {\r\n        await getAuth().updateUser(uid, updatePayload);\r\n        return { success: true, message: `Auth updated for ${uid}` };\r\n    } catch (error: any) {\r\n        console.error(\"adminUpdateAuthUser error:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to update Auth user\");\r\n    }\r\n});\r\n\r\n/**\r\n * Self-service: any authenticated user can change their own password\r\n */\r\nexport const changeMyPassword = onCall({\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { newPassword } = request.data;\r\n    if (!newPassword || newPassword.length < 6) {\r\n        throw new HttpsError(\"invalid-argument\", \"Password must be at least 6 characters\");\r\n    }\r\n\r\n    try {\r\n        await getAuth().updateUser(request.auth.uid, { password: newPassword });\r\n        return { success: true, message: \"Password updated\" };\r\n    } catch (error: any) {\r\n        console.error(\"changeMyPassword error:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to change password\");\r\n    }\r\n});\r\n\r\n// 1. Lead Sourcing Agent Trigger\r\nexport const generateLeads = onCall({\r\n    secrets: [\"SERPER_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\", // Dashboard Dev\r\n        \"http://localhost:3000\", // Public Site Dev\r\n        \"https://xiri.ai\", // Public Site Production\r\n        \"https://www.xiri.ai\", // Public Site WWW\r\n        \"https://app.xiri.ai\", // Dashboard Production\r\n        \"https://xiri-dashboard.vercel.app\", // Dashboard Vercel\r\n        \"https://xiri-dashboard-git-develop-xiri-facility-solutions.vercel.app\", // Vercel develop branch\r\n        /https:\\/\\/xiri-dashboard-.*\\.vercel\\.app$/, // All Vercel preview deployments\r\n        \"https://xiri-facility-solutions.web.app\", // Firebase Hosting\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n    timeoutSeconds: 540\r\n}, async (request) => {\r\n    const data = request.data || {};\r\n    const query = data.query;\r\n    const location = data.location;\r\n    const hasActiveContract = data.hasActiveContract || false; // Default to false (Building Supply)\r\n    const previewOnly = data.previewOnly || false; // Preview mode: don't save to Firestore\r\n    const provider = data.provider || 'google_maps'; // google_maps | nyc_open_data | all\r\n    const dcaCategory = data.dcaCategory;\r\n\r\n    if ((provider === 'google_maps' && !query) || !location) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing required fields in request.\");\r\n    }\r\n\r\n    try {\r\n        console.log(`Analyzing leads for query: ${query}, location: ${location}, provider: ${provider}, category: ${dcaCategory}${previewOnly ? ' (PREVIEW MODE)' : ''}`);\r\n\r\n        // 1. Source Leads (provider determines data source)\r\n        const rawVendors = await searchVendors(query, location, provider, dcaCategory);\r\n        console.log(`Sourced ${rawVendors.length} vendors from ${provider}.`);\r\n\r\n        // 2. Analyze & Qualify (Recruiter Agent)\r\n        // When previewOnly=true, vendors are NOT saved to Firestore\r\n        const result = await analyzeVendorLeads(rawVendors, query, hasActiveContract, previewOnly);\r\n\r\n        return {\r\n            message: \"Lead generation process completed.\",\r\n            sourced: rawVendors.length,\r\n            analysis: result,\r\n            // Include vendor data in response for preview mode\r\n            vendors: previewOnly ? result.vendors : undefined\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"Error in generateLeads:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"An internal error occurred.\");\r\n    }\r\n});\r\n\r\n// 2. Clear Pipeline Tool\r\nexport const clearPipeline = onCall({\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    try {\r\n        const snapshot = await db.collection('vendors').get();\r\n\r\n        if (snapshot.empty) {\r\n            return { message: \"Pipeline already empty.\" };\r\n        }\r\n\r\n        // Firestore batch max is 500. If we have more, we need multiple batches.\r\n        // For safe deletion, we'll do chunks of 500.\r\n        let count = 0;\r\n        const chunks = [];\r\n        let currentBatch = db.batch(); // We can't reuse the outer batch easily if we chunk\r\n\r\n        snapshot.docs.forEach((doc, index) => {\r\n            currentBatch.delete(doc.ref);\r\n            count++;\r\n            if (count % 400 === 0) {\r\n                chunks.push(currentBatch.commit());\r\n                currentBatch = db.batch();\r\n            }\r\n        });\r\n\r\n        chunks.push(currentBatch.commit());\r\n        await Promise.all(chunks);\r\n\r\n        return { message: `Cleared ${count} vendors from pipeline.` };\r\n    } catch (error: any) {\r\n        throw new HttpsError(\"internal\", error.message);\r\n    }\r\n});\r\n\r\n// Test Function to manually trigger recruiter agent\r\nexport const runRecruiterAgent = onRequest({ secrets: [\"GEMINI_API_KEY\"] }, async (req, res) => {\r\n    // Mock data for testing\r\n    const rawVendors = req.body.vendors || [\r\n        { name: \"ABC Cleaning\", services: \"We do medical office cleaning and terminal cleaning.\" },\r\n        { name: \"Joe's Pizza\", services: \"Best pizza in town\" },\r\n        { name: \"Elite HVAC\", services: \"Commercial HVAC systems\" }\r\n    ];\r\n\r\n    const result = await analyzeVendorLeads(rawVendors, \"Commercial Cleaning\");\r\n    res.json(result);\r\n});\r\n\r\n\r\n// Test Function to manually trigger notification (Telegram disabled for now)\r\n/* export const testNotification = onRequest(async (req, res) => {\r\n    const vendorId = req.query.vendorId as any;\r\n    if (vendorId) {\r\n        await notifyHumanReview(vendorId);\r\n        res.send(`Notification sent for ${vendorId}`);\r\n    } else {\r\n        res.status(400).send(\"Provide vendorId query param\");\r\n    }\r\n}); */\r\n\r\nexport const testSendEmail = onCall({\r\n    secrets: [\"RESEND_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    const { sendTemplatedEmail } = await import(\"./utils/emailUtils\");\r\n    const { vendorId, templateId } = request.data;\r\n\r\n    if (!vendorId || !templateId) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing vendorId or templateId\");\r\n    }\r\n\r\n    try {\r\n        await sendTemplatedEmail(vendorId, templateId);\r\n        return { success: true, message: `Email sent to vendor ${vendorId}` };\r\n    } catch (error: any) {\r\n        console.error(\"Error sending test email:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to send email\");\r\n    }\r\n});\r\n\r\n// ── Property Sourcing Agent ──\r\nexport const sourceProperties = onCall({\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\",\r\n        /https:\\/\\/xiri-dashboard-.*\\.vercel\\.app$/,\r\n        \"https://xiri-facility-solutions.web.app\",\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n    timeoutSeconds: 120\r\n}, async (request) => {\r\n    const data = request.data || {};\r\n    const query = data.query;\r\n    const location = data.location;\r\n    const providerName = data.provider || 'mock';\r\n\r\n    if (!query || !location) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing 'query' or 'location' in request.\");\r\n    }\r\n\r\n    try {\r\n        console.log(`[sourceProperties] query=\"${query}\", location=\"${location}\", provider=${providerName}`);\r\n        const properties = await searchProperties(query, location, providerName);\r\n\r\n        return {\r\n            message: 'Property sourcing completed.',\r\n            sourced: properties.length,\r\n            properties,\r\n        };\r\n    } catch (error: any) {\r\n        console.error('[sourceProperties] Error:', error);\r\n        throw new HttpsError('internal', error.message || 'Failed to source properties.');\r\n    }\r\n});\r\n\r\n// ── Facebook Page Management ──\r\nimport { publishPost, schedulePost, getRecentPosts, getPageInsights, deletePost } from \"./utils/facebookApi\";\r\n\r\nexport const publishFacebookPost = onCall({\r\n    secrets: [\"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { message, link, imageUrl, scheduledTime } = request.data;\r\n\r\n    if (!message) {\r\n        throw new HttpsError(\"invalid-argument\", \"Message is required\");\r\n    }\r\n\r\n    try {\r\n        let result;\r\n        if (scheduledTime) {\r\n            result = await schedulePost(message, new Date(scheduledTime), link);\r\n            console.log(`[Facebook] Scheduled post for ${scheduledTime}:`, result);\r\n        } else {\r\n            result = await publishPost(message, link, imageUrl);\r\n            console.log(`[Facebook] Published post:`, result);\r\n        }\r\n\r\n        // Log to Firestore for tracking\r\n        await db.collection('social_posts').add({\r\n            platform: 'facebook',\r\n            message,\r\n            link: link || null,\r\n            imageUrl: imageUrl || null,\r\n            scheduledTime: scheduledTime || null,\r\n            facebookPostId: result.id,\r\n            postUrl: result.postUrl || null,\r\n            success: result.success,\r\n            error: result.error || null,\r\n            postedBy: request.auth.uid,\r\n            createdAt: new Date(),\r\n        });\r\n\r\n        return result;\r\n    } catch (error: any) {\r\n        console.error(\"[Facebook] Publish error:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to publish to Facebook\");\r\n    }\r\n});\r\n\r\nexport const getFacebookPosts = onCall({\r\n    secrets: [\"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { limit } = request.data || {};\r\n\r\n    try {\r\n        const posts = await getRecentPosts(limit || 10);\r\n        const insights = await getPageInsights(\"week\");\r\n\r\n        return { posts, insights };\r\n    } catch (error: any) {\r\n        console.error(\"[Facebook] Get posts error:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to get Facebook posts\");\r\n    }\r\n});\r\n\r\nexport const deleteFacebookPost = onCall({\r\n    secrets: [\"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { postId } = request.data;\r\n    if (!postId) throw new HttpsError(\"invalid-argument\", \"postId is required\");\r\n\r\n    try {\r\n        const success = await deletePost(postId);\r\n\r\n        // Update tracking record\r\n        const snapshot = await db.collection('social_posts')\r\n            .where('facebookPostId', '==', postId)\r\n            .limit(1)\r\n            .get();\r\n\r\n        if (!snapshot.empty) {\r\n            await snapshot.docs[0].ref.update({\r\n                deleted: true,\r\n                deletedAt: new Date(),\r\n                deletedBy: request.auth.uid,\r\n            });\r\n        }\r\n\r\n        return { success };\r\n    } catch (error: any) {\r\n        console.error(\"[Facebook] Delete error:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to delete Facebook post\");\r\n    }\r\n});\r\n\r\n// ── Social Media AI Engine ──\r\nimport { runSocialContentGenerator, generateSocialContent } from \"./triggers/socialContentGenerator\";\r\nimport { runSocialPublisher } from \"./triggers/socialPublisher\";\r\n\r\nexport { runSocialContentGenerator, runSocialPublisher };\r\n\r\n// Manual trigger to generate content now (for testing)\r\nexport const triggerSocialContentGeneration = onCall({\r\n    secrets: [\"GEMINI_API_KEY\", \"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n    await generateSocialContent();\r\n    return { success: true };\r\n});\r\n\r\n// Update social config (cadence, tone, topics, etc.)\r\nexport const updateSocialConfig = onCall({\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { cadence, preferredDays, preferredTime, tone, topics, hashtagSets, enabled } = request.data;\r\n\r\n    const config: Record<string, any> = { updatedAt: new Date() };\r\n    if (cadence !== undefined) config.cadence = cadence;\r\n    if (preferredDays !== undefined) config.preferredDays = preferredDays;\r\n    if (preferredTime !== undefined) config.preferredTime = preferredTime;\r\n    if (tone !== undefined) config.tone = tone;\r\n    if (topics !== undefined) config.topics = topics;\r\n    if (hashtagSets !== undefined) config.hashtagSets = hashtagSets;\r\n    if (enabled !== undefined) config.enabled = enabled;\r\n    config.platform = \"facebook\";\r\n\r\n    await db.collection(\"social_config\").doc(\"facebook\").set(config, { merge: true });\r\n    console.log(\"[Social] Config updated:\", config);\r\n\r\n    return { success: true };\r\n});\r\n\r\n// Review (approve/reject/edit) a social post draft\r\nexport const reviewSocialPost = onCall({\r\n    cors: DASHBOARD_CORS,\r\n}, async (request) => {\r\n    if (!request.auth) throw new HttpsError(\"unauthenticated\", \"Must be logged in\");\r\n\r\n    const { postId, action, editedMessage, rejectionReason, scheduledFor } = request.data;\r\n\r\n    if (!postId || !action) {\r\n        throw new HttpsError(\"invalid-argument\", \"postId and action are required\");\r\n    }\r\n\r\n    const postRef = db.collection(\"social_posts\").doc(postId);\r\n    const postDoc = await postRef.get();\r\n\r\n    if (!postDoc.exists) {\r\n        throw new HttpsError(\"not-found\", \"Post not found\");\r\n    }\r\n\r\n    const update: Record<string, any> = {\r\n        reviewedBy: request.auth.uid,\r\n        reviewedAt: new Date(),\r\n    };\r\n\r\n    switch (action) {\r\n        case \"approve\":\r\n            update.status = \"approved\";\r\n            if (editedMessage) update.message = editedMessage;\r\n            if (scheduledFor) update.scheduledFor = new Date(scheduledFor);\r\n            break;\r\n        case \"reject\":\r\n            update.status = \"rejected\";\r\n            update.rejectionReason = rejectionReason || null;\r\n            break;\r\n        default:\r\n            throw new HttpsError(\"invalid-argument\", \"action must be 'approve' or 'reject'\");\r\n    }\r\n\r\n    await postRef.update(update);\r\n    console.log(`[Social] Post ${postId} ${action}ed by ${request.auth.uid}`);\r\n\r\n    return { success: true, status: update.status };\r\n});\r\n","import * as admin from \"firebase-admin\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\ndotenv.config();\r\n\r\n// Initialize Admin only once\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nexport const db = admin.firestore();\r\n\r\n// Global Firestore Settings\r\n// ignoreUndefinedProperties: true allows us to save objects with undefined fields (e.g. missing optional data)\r\ntry {\r\n    db.settings({ ignoreUndefinedProperties: true });\r\n} catch (error) {\r\n    // Ignore error if settings already applied\r\n    console.log(\"Firestore settings usage note:\", error);\r\n}\r\n\r\nexport { admin };\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { admin, db } from \"../utils/firebase\";\r\nimport { Vendor, RecruitmentAnalysisResult } from \"../utils/types\";\r\nimport { parseAddress } from \"../utils/emailUtils\";\r\nimport { batchEnrichVendors, calculatePlacesSubScores } from \"../utils/googlePlacesEnrichment\";\r\n\r\n// Normalize URL for comparison (strip protocol, www, trailing slash)\r\nfunction normalizeUrl(url: string): string {\r\n    if (!url) return '';\r\n    return url.toLowerCase().replace(/^https?:\\/\\//, '').replace(/^www\\./, '').replace(/\\/+$/, '').trim();\r\n}\r\n\r\n// Initialize Gemini\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\nexport const analyzeVendorLeads = async (rawVendors: any[], jobQuery: string, hasActiveContract: boolean = false, previewOnly: boolean = false): Promise<RecruitmentAnalysisResult> => {\r\n    console.log(\"!!! RECRUITER AGENT UPDATED - V4 (Robust Dedup + Blacklist) !!!\");\r\n    let analyzed = 0;\r\n    let qualified = 0;\r\n    const errors: string[] = [];\r\n    const batch = db.batch();\r\n    const previewVendors: Vendor[] = [];\r\n\r\n    // We process in chunks if rawVendors is huge, but per prompt \"db.batch() ... processing 50+ vendors\"\r\n    // Firestore batch limit is 500. We'll assume rawVendors length < 500 for this iteration or just one batch.\r\n\r\n    // Construct the prompt\r\n    // We will send vendors in a batch to Gemini to save tokens/time if possible, \r\n    // or iterate. The prompt implies \"The function should accept a raw list... and use Gemini to Classify\".\r\n    // Doing it one by one might be slow, doing all at once might hit token limits. \r\n    // Let's do a simple loop for now as it's safer for \"Classify: Identify if the vendor...\". \r\n    // Actually, passing the whole list is better for 50 items.\r\n\r\n    if (rawVendors.length === 0) return { analyzed, qualified, errors };\r\n\r\n    // Determine strictness based on contract status\r\n    // Building Supply (hasActiveContract = false) -> Accept All (0 threshold)\r\n    // Urgent (hasActiveContract = true) -> Strict (50 threshold)\r\n    const threshold = hasActiveContract ? 50 : 0;\r\n    const modeDescription = hasActiveContract\r\n        ? \"URGENT FULFILLMENT: We need high-quality vendors ready to deploy. Be strict.\"\r\n        : \"DATABASE BUILDING: We are building a supply list. ACCEPT ALL VENDORS. Do not filter. Score is for reference only.\";\r\n\r\n    // List to process, defaults to rawVendors if deduplication fails or isn't run\r\n    let vendorsToAnalyze = rawVendors;\r\n    let prompt = \"\";\r\n\r\n    try {\r\n        // Build dismissed vendor identifiers (name, phone, website) for robust blacklist matching\r\n        let dismissedNames = new Set<string>();\r\n        let dismissedPhones = new Set<string>();\r\n        let dismissedWebsites = new Set<string>();\r\n        try {\r\n            const dismissedSnapshot = await db.collection('dismissed_vendors').get();\r\n            if (!dismissedSnapshot.empty) {\r\n                for (const doc of dismissedSnapshot.docs) {\r\n                    const d = doc.data();\r\n                    if (d.businessName) dismissedNames.add(d.businessName.toLowerCase().trim());\r\n                    if (d.phone) dismissedPhones.add(d.phone.replace(/\\D/g, '')); // digits only\r\n                    if (d.website) dismissedWebsites.add(normalizeUrl(d.website));\r\n                }\r\n                console.log(`Loaded ${dismissedNames.size} dismissed vendor names, ${dismissedPhones.size} phones, ${dismissedWebsites.size} websites.`);\r\n            }\r\n        } catch (dismissErr: any) {\r\n            console.warn(\"Could not check dismissed_vendors:\", dismissErr.message);\r\n        }\r\n\r\n        // ─── Pre-process: Dedup against existing vendors + Blacklist ─────────────\r\n        // We check by: (1) case-insensitive name, (2) phone number, (3) website\r\n        const vendorsToProcess: any[] = [];\r\n        const duplicateUpdates: Promise<any>[] = [];\r\n\r\n        // Pre-load ALL existing vendor identifiers for fast matching\r\n        let existingByNameLower = new Map<string, string>(); // normalized name -> docId\r\n        let existingByPhone = new Map<string, string>();     // digits-only phone -> docId\r\n        let existingByWebsite = new Map<string, string>();   // normalized url -> docId\r\n        try {\r\n            const existingSnap = await db.collection('vendors').select('businessName', 'businessNameLower', 'phone', 'website').get();\r\n            for (const doc of existingSnap.docs) {\r\n                const data = doc.data();\r\n                const nameLower = (data.businessNameLower || data.businessName || '').toLowerCase().trim();\r\n                if (nameLower) existingByNameLower.set(nameLower, doc.id);\r\n                if (data.phone) existingByPhone.set(data.phone.replace(/\\D/g, ''), doc.id);\r\n                if (data.website) existingByWebsite.set(normalizeUrl(data.website), doc.id);\r\n            }\r\n            console.log(`Loaded ${existingByNameLower.size} existing vendors for dedup (names: ${existingByNameLower.size}, phones: ${existingByPhone.size}, websites: ${existingByWebsite.size}).`);\r\n        } catch (err: any) {\r\n            console.warn(\"Could not pre-load vendors for dedup:\", err.message);\r\n        }\r\n\r\n        console.log(`Checking ${rawVendors.length} vendors for duplicates and blacklist...`);\r\n\r\n        for (const vendor of rawVendors) {\r\n            const bName = vendor.name || vendor.companyName || vendor.title || '';\r\n            const bNameLower = bName.toLowerCase().trim();\r\n            const bPhone = (vendor.phone || '').replace(/\\D/g, '');\r\n            const bWebsite = normalizeUrl(vendor.website || '');\r\n\r\n            // ── Blacklist check (name, phone, or website) ──\r\n            const isBlacklisted =\r\n                (bNameLower && dismissedNames.has(bNameLower)) ||\r\n                (bPhone && bPhone.length >= 7 && dismissedPhones.has(bPhone)) ||\r\n                (bWebsite && dismissedWebsites.has(bWebsite));\r\n\r\n            if (isBlacklisted) {\r\n                console.log(`⛔ Blacklisted vendor skipped: ${bName}`);\r\n                continue; // Completely skip blacklisted vendors\r\n            }\r\n\r\n            // ── Dedup check (case-insensitive name, phone, or website) ──\r\n            const existingDocId =\r\n                (bNameLower && existingByNameLower.get(bNameLower)) ||\r\n                (bPhone && bPhone.length >= 7 && existingByPhone.get(bPhone)) ||\r\n                (bWebsite && existingByWebsite.get(bWebsite)) ||\r\n                null;\r\n\r\n            if (existingDocId) {\r\n                console.log(`🔁 Duplicate vendor skipped: ${bName} (matches ${existingDocId})`);\r\n                duplicateUpdates.push(\r\n                    db.collection('vendors').doc(existingDocId).update({\r\n                        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                    })\r\n                );\r\n            } else {\r\n                vendorsToProcess.push(vendor);\r\n            }\r\n        }\r\n\r\n        // Execute duplicate updates\r\n        if (duplicateUpdates.length > 0) {\r\n            await Promise.all(duplicateUpdates);\r\n            console.log(`Updated ${duplicateUpdates.length} existing vendors.`);\r\n        }\r\n\r\n        if (vendorsToProcess.length === 0) {\r\n            console.log(\"All vendors were duplicates or blacklisted. Sourcing complete.\");\r\n            return { analyzed, qualified, errors };\r\n        }\r\n\r\n        // Continue with unique vendors\r\n        vendorsToAnalyze = vendorsToProcess;\r\n\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"prompts\").doc(\"recruiter_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Recruiter analysis prompt not found in database (prompts/recruiter_analysis_prompt)\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        // ─── Google Places Enrichment ─────────────────────────────\r\n        const vendorsForEnrichment = vendorsToAnalyze.map((v, i) => ({\r\n            name: v.name || v.companyName || v.title || '',\r\n            address: v.location || v.address || v.vicinity || '',\r\n            index: i,\r\n        }));\r\n\r\n        console.log(`Starting Google Places enrichment for ${vendorsForEnrichment.length} vendors...`);\r\n        const placesData = await batchEnrichVendors(vendorsForEnrichment);\r\n        console.log(`Google Places enrichment complete: ${placesData.size}/${vendorsForEnrichment.length} matched.`);\r\n\r\n        const vendorList = JSON.stringify(vendorsToAnalyze.map((v, i) => {\r\n            const places = placesData.get(i);\r\n            return {\r\n                index: i,\r\n                name: v.name || v.companyName,\r\n                description: v.description || v.services,\r\n                address: v.location || v.address || v.vicinity,\r\n                website: v.website,\r\n                phone: v.phone,\r\n                // Google Places enrichment\r\n                googleRating: places?.rating || null,\r\n                googleReviewCount: places?.ratingCount || null,\r\n                googleTypes: places?.types?.slice(0, 5) || [],\r\n                isEstablished: places?.isEstablished || false,\r\n                isHighlyRated: places?.isHighlyRated || false,\r\n            };\r\n        }));\r\n\r\n        // Replace variables\r\n        prompt = template?.content\r\n            .replace(/\\{\\{query\\}\\}/g, jobQuery)\r\n            .replace(/\\{\\{modeDescription\\}\\}/g, modeDescription)\r\n            .replace(/\\{\\{threshold\\}\\}/g, threshold.toString())\r\n            .replace(/\\{\\{vendorList\\}\\}/g, vendorList);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        console.log(\"Gemini Raw Response:\", text); // Debug log\r\n\r\n        // Naive JSON clean up\r\n        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\r\n        const analysis = JSON.parse(jsonStr) as any[];\r\n\r\n        analyzed = analysis.length;\r\n\r\n        for (const item of analysis) {\r\n            if (item.isQualified || threshold === 0) {\r\n                qualified++;\r\n                // Ensure index matches the filtered list\r\n                const originalVendor = vendorsToAnalyze[item.index];\r\n                if (!originalVendor) {\r\n                    console.warn(`Analysis returned index ${item.index} but we only have ${vendorsToAnalyze.length} vendors.`);\r\n                    continue;\r\n                }\r\n\r\n                // Fallback for business name\r\n                const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n                const vendorRef = db.collection('vendors').doc(); // Auto-ID\r\n                const rawAddr = originalVendor.location || item.address || \"Unknown\";\r\n                const parsed = parseAddress(rawAddr);\r\n                // Build Google Places data for persistence\r\n                const placesEnrichment = placesData.get(item.index);\r\n                const placesSubScores = calculatePlacesSubScores(placesEnrichment || null);\r\n\r\n                const newVendor: Vendor = {\r\n                    id: vendorRef.id,\r\n                    businessName: bName,\r\n                    businessNameLower: bName.toLowerCase().trim(),\r\n                    capabilities: item.services || (item.primarySpecialty ? [item.primarySpecialty] : (item.specialty ? [item.specialty] : [])),\r\n                    specialty: item.primarySpecialty || item.specialty || item.services?.[0] || undefined,\r\n                    contactName: item.contactName || undefined,\r\n                    address: rawAddr,\r\n                    streetAddress: parsed.streetAddress || undefined,\r\n                    city: item.city || parsed.city || undefined,\r\n                    state: item.state || parsed.state || undefined,\r\n                    zip: item.zip || parsed.zip || undefined,\r\n                    country: item.country || \"USA\",\r\n                    phone: placesEnrichment?.phone || originalVendor.phone || item.phone || undefined,\r\n                    email: originalVendor.email || item.email || undefined,\r\n                    website: placesEnrichment?.website || originalVendor.website || item.website || undefined,\r\n                    dcaCategory: originalVendor.dcaCategory || undefined,\r\n                    fitScore: item.fitScore,\r\n                    aiReasoning: item.reasoning || undefined,\r\n                    hasActiveContract: hasActiveContract,\r\n                    onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                    status: 'pending_review',\r\n                    // Google Places enrichment (persisted)\r\n                    googlePlaces: placesEnrichment ? {\r\n                        placeId: placesEnrichment.placeId,\r\n                        name: placesEnrichment.name,\r\n                        rating: placesEnrichment.rating,\r\n                        ratingCount: placesEnrichment.ratingCount,\r\n                        phone: placesEnrichment.phone,\r\n                        website: placesEnrichment.website,\r\n                        types: placesEnrichment.types,\r\n                        openNow: placesEnrichment.openNow,\r\n                        googleMapsUrl: placesEnrichment.googleMapsUrl,\r\n                        enrichedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                    } : undefined,\r\n                    // Fit score breakdown\r\n                    fitScoreBreakdown: {\r\n                        googleReputation: placesSubScores.googleReputation,\r\n                        serviceAlignment: item.serviceAlignmentScore || 50,\r\n                        locationScore: item.locationScore || 50,\r\n                        businessMaturity: placesSubScores.businessMaturity,\r\n                        websiteQuality: placesSubScores.websiteQuality,\r\n                    },\r\n                    rating: placesEnrichment?.rating || undefined,\r\n                    totalRatings: placesEnrichment?.ratingCount || undefined,\r\n                    createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                    updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n                };\r\n\r\n                console.log(`Adding qualified vendor to batch: ${newVendor.businessName}`);\r\n                if (previewOnly) {\r\n                    // Tag as dismissed if in blacklist\r\n                    const isDismissed = dismissedNames.has((newVendor.businessName || '').toLowerCase().trim());\r\n                    previewVendors.push({ ...newVendor, isDismissed } as any);\r\n                } else {\r\n                    batch.set(vendorRef, newVendor);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (qualified > 0 && !previewOnly) {\r\n            console.log(`Committing batch of ${qualified} vendors...`);\r\n            await batch.commit();\r\n            console.log(\"Batch commit successful.\");\r\n        } else if (previewOnly) {\r\n            console.log(`Preview mode: ${qualified} vendors ready for review (not saved).`);\r\n        } else {\r\n            console.log(\"No qualified vendors to commit.\");\r\n        }\r\n\r\n    } catch (err: any) {\r\n        console.error(\"AI Analysis Failed:\", err.message);\r\n        console.error(\"Prompt used:\", prompt); // Log the prompt to debug formatting issues\r\n        errors.push(err.message);\r\n\r\n        // Fallback: Save vendors without analysis if AI fails\r\n        console.log(\"Saving raw vendors with 'pending_review' status due to AI failure...\");\r\n\r\n        for (const originalVendor of vendorsToAnalyze) {\r\n            const vendorRef = db.collection('vendors').doc();\r\n            // Fallback for business name: Use 'name' or 'companyName' or 'title' from raw source\r\n            const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n            const rawAddr = originalVendor.location || originalVendor.address || \"Unknown\";\r\n            const parsed = parseAddress(rawAddr);\r\n            const newVendor: Vendor = {\r\n                id: vendorRef.id,\r\n                businessName: bName,\r\n                capabilities: [],\r\n                address: rawAddr,\r\n                streetAddress: parsed.streetAddress || undefined,\r\n                city: parsed.city || undefined,\r\n                state: parsed.state || undefined,\r\n                zip: parsed.zip || undefined,\r\n                phone: originalVendor.phone || undefined,\r\n                email: originalVendor.email || undefined,\r\n                website: originalVendor.website || undefined,\r\n                dcaCategory: originalVendor.dcaCategory || undefined,\r\n                fitScore: 0,\r\n                status: 'pending_review',\r\n                hasActiveContract: hasActiveContract,\r\n                onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                aiReasoning: `AI Analysis Failed: ${err.message}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n            };\r\n            batch.set(vendorRef, newVendor);\r\n            if (previewOnly) {\r\n                previewVendors.push(newVendor);\r\n            }\r\n            qualified++;\r\n        }\r\n\r\n        if (qualified > 0 && !previewOnly) {\r\n            console.log(`Committing batch of ${qualified} fallback vendors...`);\r\n            await batch.commit();\r\n        }\r\n    }\r\n\r\n    return { analyzed, qualified, errors, vendors: previewOnly ? previewVendors : undefined };\r\n};\r\n","/**\r\n * Google Places Enrichment for Cloud Functions\r\n * \r\n * Uses the Google Places API (New) Text Search to enrich vendor data\r\n * with ratings, reviews, business types, and other signals before\r\n * passing to the AI analysis pipeline.\r\n */\r\n\r\ninterface PlacesEnrichmentResult {\r\n    placeId?: string;\r\n    name?: string;\r\n    rating?: number;\r\n    ratingCount?: number;\r\n    phone?: string;\r\n    website?: string;\r\n    types?: string[];\r\n    openNow?: boolean;\r\n    googleMapsUrl?: string;\r\n    // Scoring helpers\r\n    isEstablished: boolean;  // 20+ reviews\r\n    isHighlyRated: boolean;  // 4.0+ rating\r\n}\r\n\r\nconst PLACES_TEXT_SEARCH_URL = \"https://places.googleapis.com/v1/places:searchText\";\r\n\r\n/**\r\n * Enrich a single vendor with Google Places data using Text Search.\r\n * Uses the vendor name + optional location for best match.\r\n */\r\nexport async function enrichVendorWithPlaces(\r\n    vendorName: string,\r\n    vendorAddress?: string,\r\n    apiKey?: string,\r\n): Promise<PlacesEnrichmentResult | null> {\r\n    const key = apiKey || process.env.GOOGLE_MAPS_API_KEY || \"\";\r\n    if (!key) {\r\n        console.warn(\"GOOGLE_MAPS_API_KEY not set — skipping Places enrichment\");\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        const textQuery = vendorAddress\r\n            ? `${vendorName} near ${vendorAddress}`\r\n            : vendorName;\r\n\r\n        const response = await fetch(PLACES_TEXT_SEARCH_URL, {\r\n            method: \"POST\",\r\n            headers: {\r\n                \"Content-Type\": \"application/json\",\r\n                \"X-Goog-Api-Key\": key,\r\n                \"X-Goog-FieldMask\": \"places.id,places.displayName,places.rating,places.userRatingCount,places.internationalPhoneNumber,places.websiteUri,places.types,places.currentOpeningHours,places.googleMapsUri\",\r\n            },\r\n            body: JSON.stringify({\r\n                textQuery,\r\n                maxResultCount: 1,\r\n                languageCode: \"en\",\r\n            }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errText = await response.text();\r\n            console.warn(`Places API error for \"${vendorName}\": ${response.status} — ${errText}`);\r\n            return null;\r\n        }\r\n\r\n        const data = await response.json();\r\n        const place = data.places?.[0];\r\n        if (!place) return null;\r\n\r\n        const rating = place.rating || 0;\r\n        const ratingCount = place.userRatingCount || 0;\r\n\r\n        return {\r\n            placeId: place.id,\r\n            name: place.displayName?.text || vendorName,\r\n            rating,\r\n            ratingCount,\r\n            phone: place.internationalPhoneNumber || undefined,\r\n            website: place.websiteUri || undefined,\r\n            types: place.types || [],\r\n            openNow: place.currentOpeningHours?.openNow,\r\n            googleMapsUrl: place.googleMapsUri || undefined,\r\n            isEstablished: ratingCount >= 20,\r\n            isHighlyRated: rating >= 4.0,\r\n        };\r\n    } catch (err: any) {\r\n        console.warn(`Places enrichment failed for \"${vendorName}\": ${err.message}`);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Batch enrich multiple vendors with Google Places data.\r\n * Uses parallel requests with a concurrency limit to avoid rate limits.\r\n */\r\nexport async function batchEnrichVendors(\r\n    vendors: Array<{ name: string; address?: string; index: number }>,\r\n    apiKey?: string,\r\n    concurrencyLimit = 5, // Max parallel requests\r\n): Promise<Map<number, PlacesEnrichmentResult>> {\r\n    const results = new Map<number, PlacesEnrichmentResult>();\r\n\r\n    // Process in batches of concurrencyLimit\r\n    for (let i = 0; i < vendors.length; i += concurrencyLimit) {\r\n        const batch = vendors.slice(i, i + concurrencyLimit);\r\n        const batchResults = await Promise.all(\r\n            batch.map(async (v) => {\r\n                const result = await enrichVendorWithPlaces(v.name, v.address, apiKey);\r\n                return { index: v.index, result };\r\n            }),\r\n        );\r\n\r\n        for (const { index, result } of batchResults) {\r\n            if (result) {\r\n                results.set(index, result);\r\n            }\r\n        }\r\n    }\r\n\r\n    console.log(`Places enrichment: ${results.size}/${vendors.length} vendors enriched.`);\r\n    return results;\r\n}\r\n\r\n/**\r\n * Calculate sub-scores from Google Places data for the AI prompt context.\r\n */\r\nexport function calculatePlacesSubScores(places: PlacesEnrichmentResult | null): {\r\n    googleReputation: number;\r\n    businessMaturity: number;\r\n    websiteQuality: number;\r\n} {\r\n    if (!places) {\r\n        return { googleReputation: 30, businessMaturity: 30, websiteQuality: 20 };\r\n    }\r\n\r\n    // Google Reputation (0-100): rating + review volume\r\n    let googleReputation = 30; // Base for having a Places listing\r\n    if (places.rating) {\r\n        if (places.rating >= 4.5) googleReputation = 90;\r\n        else if (places.rating >= 4.0) googleReputation = 75;\r\n        else if (places.rating >= 3.5) googleReputation = 55;\r\n        else if (places.rating >= 3.0) googleReputation = 40;\r\n        else googleReputation = 25; // Below 3.0 = red flag\r\n    }\r\n    // Boost for review volume\r\n    if (places.ratingCount && places.ratingCount >= 50) googleReputation = Math.min(100, googleReputation + 10);\r\n    else if (places.ratingCount && places.ratingCount >= 20) googleReputation = Math.min(100, googleReputation + 5);\r\n\r\n    // Business Maturity (0-100): review count as proxy\r\n    let businessMaturity = 30;\r\n    if (places.ratingCount) {\r\n        if (places.ratingCount >= 100) businessMaturity = 95;\r\n        else if (places.ratingCount >= 50) businessMaturity = 80;\r\n        else if (places.ratingCount >= 20) businessMaturity = 65;\r\n        else if (places.ratingCount >= 5) businessMaturity = 45;\r\n    }\r\n\r\n    // Website Quality (0-100): has website = good\r\n    let websiteQuality = 20; // No website\r\n    if (places.website) websiteQuality = 60; // Has website\r\n    if (places.website && places.ratingCount && places.ratingCount > 10) websiteQuality = 80; // Website + reviews\r\n\r\n    return { googleReputation, businessMaturity, websiteQuality };\r\n}\r\n","import axios from 'axios';\r\n\r\n// Define the shape of a raw vendor outcome\r\nexport interface RawVendor {\r\n    name: string;\r\n    description: string;\r\n    location: string;\r\n    phone?: string;\r\n    website?: string;\r\n    source: string;\r\n    rating?: number;\r\n    user_ratings_total?: number;\r\n    dcaCategory?: string;\r\n}\r\n\r\n/**\r\n * Lead Sourcing Agent\r\n * Supports multiple data providers:\r\n * - google_maps (default): Serper.dev / Google Maps\r\n * - nyc_open_data: NYC DCA + NY State SODA APIs — licensed, verified businesses\r\n * - all: Both sources combined and deduplicated\r\n *\r\n * Requires: process.env.SERPER_API_KEY (for google_maps)\r\n */\r\nexport const searchVendors = async (\r\n    query: string,\r\n    location: string,\r\n    provider: 'google_maps' | 'nyc_open_data' | 'all' = 'google_maps',\r\n    dcaCategory?: string\r\n): Promise<RawVendor[]> => {\r\n    console.log(`Searching for: \"${query}\" in \"${location}\" [provider: ${provider}]`);\r\n\r\n    // ─── NYC Open Data Only ───\r\n    if (provider === 'nyc_open_data') {\r\n        const { searchVendorsSoda } = await import('./sodaSourcer');\r\n        return searchVendorsSoda(query, location, dcaCategory);\r\n    }\r\n\r\n    // ─── Google Maps ───\r\n    const apiKey = process.env.SERPER_API_KEY || \"02ece77ffd27d2929e3e79604cb27e1dfaa40fe7\";\r\n    if (!apiKey) {\r\n        console.warn(\"SERPER_API_KEY is not set. Returning mock data.\");\r\n        return getMockVendors(query, location);\r\n    }\r\n\r\n    const fullQuery = `${query} in ${location}`;\r\n    console.log(`Searching for: ${fullQuery} using Serper (places)...`);\r\n\r\n    let googleResults: RawVendor[] = [];\r\n\r\n    try {\r\n        const response = await axios.post(\r\n            'https://google.serper.dev/places',\r\n            { q: fullQuery },\r\n            { headers: { 'X-API-KEY': apiKey.trim(), 'Content-Type': 'application/json' } }\r\n        );\r\n\r\n        const places = response.data.places || [];\r\n        console.log(`Serper returned ${places.length} raw results.`);\r\n\r\n        const rawVendors = places.map((place: any) => ({\r\n            name: place.title,\r\n            description: `${place.category || ''} - ${place.address || ''}`,\r\n            location: place.address,\r\n            phone: place.phoneNumber,\r\n            website: place.website,\r\n            source: 'google_maps_serper',\r\n            rating: place.rating,\r\n            user_ratings_total: place.userRatingsTotal\r\n        }));\r\n\r\n        // Filter out low-rated vendors immediately\r\n        googleResults = rawVendors.filter((v: any) => v.rating === undefined || v.rating >= 3.5);\r\n        console.log(`Filtered ${rawVendors.length} -> ${googleResults.length} vendors (Rating >= 3.5 or N/A).`);\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error searching vendors via Google:\", error.message);\r\n        if (provider !== 'all') {\r\n            throw new Error(`Failed to source vendors: ${error.message}`);\r\n        }\r\n    }\r\n\r\n    // ─── Combined (All Sources) ───\r\n    if (provider === 'all') {\r\n        const { searchVendorsSoda } = await import('./sodaSourcer');\r\n        const sodaResults = await searchVendorsSoda(query, location, dcaCategory);\r\n\r\n        const combined = [...googleResults, ...sodaResults];\r\n\r\n        // Deduplicate by normalized name\r\n        const seen = new Set<string>();\r\n        const deduped = combined.filter(v => {\r\n            const key = v.name.toLowerCase().replace(/[^a-z0-9]/g, '');\r\n            if (seen.has(key)) return false;\r\n            seen.add(key);\r\n            return true;\r\n        });\r\n\r\n        console.log(`Combined: ${googleResults.length} Google + ${sodaResults.length} SODA = ${deduped.length} unique`);\r\n        return deduped;\r\n    }\r\n\r\n    return googleResults;\r\n};\r\n\r\n// Fallback Mock Data if no API Key\r\nconst getMockVendors = (query: string, location: string): RawVendor[] => {\r\n    return [\r\n        {\r\n            name: \"Mock Cleaning Services \" + location,\r\n            description: \"Deep comercial cleaning and janitorial services.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"Test HVAC Solutions \" + location,\r\n            description: \"HVAC maintenance and repair.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"General Facilities Co\",\r\n            description: \"We do everything including plumbing and electrical.\",\r\n            location: location,\r\n            source: 'mock'\r\n        }\r\n    ];\r\n};\r\n","import { RawProperty } from '@xiri/shared';\r\n\r\n// ── Provider Interface ──\r\n// Swap implementations without touching business logic.\r\n// Each provider normalizes its API response to RawProperty[].\r\n\r\nexport interface PropertyDataProvider {\r\n    name: string;\r\n    search(params: PropertySearchParams): Promise<RawProperty[]>;\r\n}\r\n\r\nexport interface PropertySearchParams {\r\n    query: string;              // e.g. \"urgent care\", \"auto dealership\"\r\n    location: string;           // e.g. \"Williston Park, NY\"\r\n    minSquareFootage?: number;\r\n    maxSquareFootage?: number;\r\n    maxResults?: number;        // default 25\r\n}\r\n\r\n// ── Mock Provider ──\r\n// Returns realistic test data for development.\r\n// Replace with ATTOM / Reonomy when ready.\r\n\r\nclass MockPropertyProvider implements PropertyDataProvider {\r\n    name = 'mock';\r\n\r\n    async search(params: PropertySearchParams): Promise<RawProperty[]> {\r\n        console.log(`[MockPropertyProvider] Searching \"${params.query}\" in \"${params.location}\"...`);\r\n\r\n        // Simulate API delay\r\n        await new Promise(resolve => setTimeout(resolve, 800));\r\n\r\n        const mockProperties: RawProperty[] = [\r\n            {\r\n                name: 'Williston Park Medical Plaza',\r\n                address: '420 Willis Ave',\r\n                city: 'Williston Park',\r\n                state: 'NY',\r\n                zip: '11596',\r\n                propertyType: 'medical_office',\r\n                squareFootage: 8500,\r\n                yearBuilt: 2005,\r\n                ownerName: 'WP Medical Holdings LLC',\r\n                ownerPhone: '(516) 555-0101',\r\n                tenantName: 'CityMD Urgent Care',\r\n                tenantCount: 1,\r\n                lastSalePrice: 2400000,\r\n                lastSaleDate: '2021-06-15',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-001',\r\n            },\r\n            {\r\n                name: 'Mineola Surgical Center',\r\n                address: '155 E 2nd St',\r\n                city: 'Mineola',\r\n                state: 'NY',\r\n                zip: '11501',\r\n                propertyType: 'medical_office',\r\n                squareFootage: 12000,\r\n                yearBuilt: 2010,\r\n                ownerName: 'Mineola Health Properties Inc',\r\n                ownerPhone: '(516) 555-0202',\r\n                tenantName: 'North Shore Ambulatory Surgery',\r\n                tenantCount: 1,\r\n                lastSalePrice: 4200000,\r\n                lastSaleDate: '2019-03-22',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-002',\r\n            },\r\n            {\r\n                name: 'New Hyde Park Dialysis Suite',\r\n                address: '700 Lakeville Rd',\r\n                city: 'New Hyde Park',\r\n                state: 'NY',\r\n                zip: '11040',\r\n                propertyType: 'medical_office',\r\n                squareFootage: 5200,\r\n                yearBuilt: 2015,\r\n                ownerName: 'NHP Realty Corp',\r\n                ownerPhone: '(516) 555-0303',\r\n                tenantName: 'DaVita Kidney Care',\r\n                tenantCount: 1,\r\n                lastSalePrice: 1800000,\r\n                lastSaleDate: '2022-09-10',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-003',\r\n            },\r\n            {\r\n                name: 'Herricks Auto Center',\r\n                address: '200 Herricks Rd',\r\n                city: 'New Hyde Park',\r\n                state: 'NY',\r\n                zip: '11040',\r\n                propertyType: 'auto_dealership',\r\n                squareFootage: 22000,\r\n                yearBuilt: 1998,\r\n                ownerName: 'Herricks Motors LLC',\r\n                ownerPhone: '(516) 555-0404',\r\n                tenantName: 'Herricks Toyota',\r\n                tenantCount: 1,\r\n                lotSize: 45000,\r\n                lastSalePrice: 5500000,\r\n                lastSaleDate: '2018-01-20',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-004',\r\n            },\r\n            {\r\n                name: 'Floral Park Urgent Care',\r\n                address: '265 Jericho Tpke',\r\n                city: 'Floral Park',\r\n                state: 'NY',\r\n                zip: '11001',\r\n                propertyType: 'medical_office',\r\n                squareFootage: 4800,\r\n                yearBuilt: 2012,\r\n                ownerName: 'FP Healthcare Properties',\r\n                ownerPhone: '(516) 555-0505',\r\n                tenantName: 'GoHealth Urgent Care',\r\n                tenantCount: 1,\r\n                lastSalePrice: 1500000,\r\n                lastSaleDate: '2020-07-05',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-005',\r\n            },\r\n            {\r\n                name: 'Garden City Auto Mile',\r\n                address: '500 Stewart Ave',\r\n                city: 'Garden City',\r\n                state: 'NY',\r\n                zip: '11530',\r\n                propertyType: 'auto_dealership',\r\n                squareFootage: 35000,\r\n                yearBuilt: 2001,\r\n                ownerName: 'GC Auto Holdings LLC',\r\n                ownerPhone: '(516) 555-0606',\r\n                tenantName: 'Legacy Honda',\r\n                tenantCount: 1,\r\n                lotSize: 80000,\r\n                lastSalePrice: 8200000,\r\n                lastSaleDate: '2017-11-30',\r\n                source: 'mock',\r\n                sourceId: 'MOCK-006',\r\n            },\r\n        ];\r\n\r\n        // Apply sq ft filters if provided\r\n        let filtered = mockProperties;\r\n        if (params.minSquareFootage) {\r\n            filtered = filtered.filter(p => (p.squareFootage || 0) >= params.minSquareFootage!);\r\n        }\r\n        if (params.maxSquareFootage) {\r\n            filtered = filtered.filter(p => (p.squareFootage || 0) <= params.maxSquareFootage!);\r\n        }\r\n\r\n        // Apply query filter (simple keyword match on propertyType or tenantName)\r\n        const queryLower = params.query.toLowerCase();\r\n        if (queryLower.includes('medical') || queryLower.includes('urgent') || queryLower.includes('surgery') || queryLower.includes('dialysis')) {\r\n            filtered = filtered.filter(p => p.propertyType === 'medical_office');\r\n        } else if (queryLower.includes('auto') || queryLower.includes('dealer')) {\r\n            filtered = filtered.filter(p => p.propertyType === 'auto_dealership');\r\n        }\r\n\r\n        const maxResults = params.maxResults || 25;\r\n        const results = filtered.slice(0, maxResults);\r\n\r\n        console.log(`[MockPropertyProvider] Returning ${results.length} mock properties.`);\r\n        return results;\r\n    }\r\n}\r\n\r\n// ── Future Provider Stubs ──\r\n\r\n// class AttomPropertyProvider implements PropertyDataProvider {\r\n//     name = 'attom';\r\n//     async search(params: PropertySearchParams): Promise<RawProperty[]> {\r\n//         // TODO: Implement ATTOM Data API integration\r\n//         // const apiKey = process.env.ATTOM_API_KEY;\r\n//         // const response = await axios.get('https://api.gateway.attomdata.com/...', { ... });\r\n//         // return normalize(response.data);\r\n//         throw new Error('ATTOM provider not yet implemented');\r\n//     }\r\n// }\r\n\r\n// class ReonomyPropertyProvider implements PropertyDataProvider {\r\n//     name = 'reonomy';\r\n//     async search(params: PropertySearchParams): Promise<RawProperty[]> {\r\n//         // TODO: Implement Reonomy/Altus API integration\r\n//         throw new Error('Reonomy provider not yet implemented');\r\n//     }\r\n// }\r\n\r\n// ── Provider Factory ──\r\n\r\nconst providers: Record<string, () => PropertyDataProvider> = {\r\n    mock: () => new MockPropertyProvider(),\r\n    // attom: () => new AttomPropertyProvider(),\r\n    // reonomy: () => new ReonomyPropertyProvider(),\r\n};\r\n\r\nexport function getPropertyProvider(name: string): PropertyDataProvider {\r\n    const factory = providers[name];\r\n    if (!factory) {\r\n        console.warn(`[PropertySourcer] Unknown provider \"${name}\", falling back to mock.`);\r\n        return new MockPropertyProvider();\r\n    }\r\n    return factory();\r\n}\r\n\r\n// ── Main Search Function ──\r\n// Called by the Cloud Function callable.\r\n\r\nexport const searchProperties = async (\r\n    query: string,\r\n    location: string,\r\n    providerName: string = 'mock',\r\n): Promise<RawProperty[]> => {\r\n    console.log(`[PropertySourcer] Sourcing: \"${query}\" in \"${location}\" via ${providerName}`);\r\n\r\n    const provider = getPropertyProvider(providerName);\r\n\r\n    try {\r\n        const properties = await provider.search({ query, location });\r\n        console.log(`[PropertySourcer] ${provider.name} returned ${properties.length} results.`);\r\n\r\n        // Filter to single-tenant (tenantCount === 1 or undefined/null)\r\n        const singleTenant = properties.filter(p => !p.tenantCount || p.tenantCount === 1);\r\n        console.log(`[PropertySourcer] After single-tenant filter: ${singleTenant.length}`);\r\n\r\n        return singleTenant;\r\n    } catch (error: any) {\r\n        console.error(`[PropertySourcer] Error sourcing properties: ${error.message}`);\r\n        throw new Error(`Failed to source properties: ${error.message}`);\r\n    }\r\n};\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport { defineSecret } from \"firebase-functions/params\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { db } from \"../utils/firebase\";\r\nimport { scrapeWebsite, deepMailtoScan, searchWebForEmail } from \"../utils/websiteScraper\";\r\nimport { verifyEmail, isDisposableEmail, isRoleBasedEmail } from \"../utils/emailVerification\";\r\nimport { validatePhone } from \"../utils/phoneValidation\";\r\nimport { enqueueTask } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst GEMINI_API_KEY = defineSecret(\"GEMINI_API_KEY\");\r\nconst SERPER_API_KEY = defineSecret(\"SERPER_API_KEY\");\r\n\r\nconsole.log(\"Loading vendor enrichment triggers...\");\r\n\r\n// ─── Trigger 1: Vendor status changes to 'qualified' ───\r\nexport const onVendorApproved = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [GEMINI_API_KEY, SERPER_API_KEY],\r\n}, async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const newData = event.data.after.data();\r\n    const oldData = event.data.before.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!newData || !oldData) return;\r\n    if (newData.status !== 'qualified' || oldData.status === 'qualified') return;\r\n\r\n    logger.info(`[UPDATE] Vendor ${vendorId} status changed to qualified.`);\r\n    await runEnrichPipeline(vendorId, newData, oldData.status);\r\n});\r\n\r\n// ─── Trigger 2: New vendor created WITH status 'qualified' ───\r\nexport const onVendorCreated = onDocumentCreated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [GEMINI_API_KEY, SERPER_API_KEY],\r\n}, async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const data = event.data.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!data) return;\r\n    if (data.status !== 'qualified') return;\r\n\r\n    logger.info(`[CREATE] Vendor ${vendorId} created with status qualified.`);\r\n    await runEnrichPipeline(vendorId, data, 'new');\r\n});\r\n\r\n\r\n// ═══════════════════════════════════════════════════════════\r\n//  SHARED PIPELINE LOGIC\r\n// ═══════════════════════════════════════════════════════════\r\n\r\nasync function runEnrichPipeline(vendorId: string, vendorData: any, previousStatus: string) {\r\n    try {\r\n        // 1. Log Activity: \"Vendor Approved\"\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: \"Vendor approved — starting onboarding pipeline.\",\r\n            createdAt: new Date(),\r\n            metadata: {\r\n                oldStatus: previousStatus,\r\n                newStatus: 'qualified',\r\n                onboardingTrack: vendorData.onboardingTrack || 'STANDARD',\r\n            }\r\n        });\r\n\r\n        const vendorEmail = vendorData.email?.trim();\r\n        const vendorWebsite = vendorData.website?.trim();\r\n\r\n        // ─── BRANCH 1: Already has email → go straight to outreach ───\r\n        if (vendorEmail) {\r\n            logger.info(`Vendor ${vendorId} has email (${vendorEmail}). Proceeding to outreach.`);\r\n            await setOutreachPending(vendorId, vendorData);\r\n            return;\r\n        }\r\n\r\n        // ─── BRANCH 2: No email but has website → try enrichment ───\r\n        if (vendorWebsite) {\r\n            logger.info(`Vendor ${vendorId} has no email but has website. Enriching...`);\r\n\r\n            await db.collection(\"vendors\").doc(vendorId).update({\r\n                outreachStatus: 'ENRICHING',\r\n                enrichmentStartedAt: new Date(),\r\n                statusUpdatedAt: new Date(),\r\n            });\r\n\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId,\r\n                type: \"ENRICHMENT\",\r\n                description: `Scraping ${vendorWebsite} for contact info...`,\r\n                createdAt: new Date(),\r\n            });\r\n\r\n            try {\r\n                const scrapedResult = await scrapeWebsite(vendorWebsite, GEMINI_API_KEY.value());\r\n\r\n                if (!scrapedResult.success || !scrapedResult.data) {\r\n                    logger.warn(`Enrichment failed for ${vendorId}: ${scrapedResult.error}`);\r\n                    await markNeedsContact(vendorId, \"Website scrape failed\");\r\n                    return;\r\n                }\r\n\r\n                const scrapedData = scrapedResult.data;\r\n                const updateData: any = { updatedAt: admin.firestore.FieldValue.serverTimestamp() };\r\n                const enrichedFields: string[] = [];\r\n\r\n                // Verify and save email\r\n                let foundEmail: string | undefined;\r\n                if (scrapedData.email) {\r\n                    const emailVerification = await verifyEmail(scrapedData.email);\r\n                    if (emailVerification.valid &&\r\n                        emailVerification.deliverable &&\r\n                        !isDisposableEmail(scrapedData.email) &&\r\n                        !isRoleBasedEmail(scrapedData.email)) {\r\n                        foundEmail = scrapedData.email;\r\n                        updateData.email = foundEmail;\r\n                        enrichedFields.push('email');\r\n                    } else {\r\n                        logger.info(`Scraped email ${scrapedData.email} failed verification.`);\r\n                    }\r\n                }\r\n\r\n                // Validate and save phone\r\n                if (scrapedData.phone && !vendorData.phone) {\r\n                    const phoneValidation = validatePhone(scrapedData.phone);\r\n                    if (phoneValidation.valid) {\r\n                        updateData.phone = phoneValidation.formatted;\r\n                        enrichedFields.push('phone');\r\n                    }\r\n                }\r\n\r\n                // Save address if missing\r\n                if (scrapedData.address && !vendorData.address) {\r\n                    updateData.address = scrapedData.address;\r\n                    enrichedFields.push('address');\r\n                }\r\n\r\n                // Save social media\r\n                if (scrapedData.socialMedia) {\r\n                    const sm: any = {};\r\n                    if (scrapedData.socialMedia.linkedin) { sm.linkedin = scrapedData.socialMedia.linkedin; enrichedFields.push('linkedin'); }\r\n                    if (scrapedData.socialMedia.facebook) { sm.facebook = scrapedData.socialMedia.facebook; enrichedFields.push('facebook'); }\r\n                    if (scrapedData.socialMedia.twitter) { sm.twitter = scrapedData.socialMedia.twitter; enrichedFields.push('twitter'); }\r\n                    if (Object.keys(sm).length > 0) updateData.socialMedia = sm;\r\n                }\r\n\r\n                // Save contact form URL if detected\r\n                if (scrapedData.contactFormUrl) {\r\n                    updateData.contactFormUrl = scrapedData.contactFormUrl;\r\n                    enrichedFields.push('contactFormUrl');\r\n                }\r\n\r\n                // Enrichment metadata\r\n                updateData.enrichment = {\r\n                    lastEnriched: admin.firestore.FieldValue.serverTimestamp(),\r\n                    enrichedFields,\r\n                    enrichmentSource: 'auto_onboarding',\r\n                    scrapedWebsite: vendorWebsite,\r\n                    confidence: scrapedData.confidence,\r\n                };\r\n\r\n                // Update vendor doc with scraped data\r\n                if (enrichedFields.length > 0) {\r\n                    await db.collection(\"vendors\").doc(vendorId).update(updateData);\r\n                }\r\n\r\n                await db.collection(\"vendor_activities\").add({\r\n                    vendorId,\r\n                    type: \"ENRICHMENT\",\r\n                    description: enrichedFields.length > 0\r\n                        ? `Enriched ${enrichedFields.length} field(s): ${enrichedFields.join(', ')}`\r\n                        : \"No new fields found from website.\",\r\n                    createdAt: new Date(),\r\n                    metadata: { enrichedFields, confidence: scrapedData.confidence },\r\n                });\r\n\r\n                // Did we find an email from website scrape?\r\n                if (foundEmail) {\r\n                    logger.info(`Found email ${foundEmail} for vendor ${vendorId} via website scrape. Proceeding to outreach.`);\r\n                    const updatedDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n                    await setOutreachPending(vendorId, updatedDoc.data() || vendorData);\r\n                    return;\r\n                }\r\n\r\n                // ─── FALLBACK LAYER 2: Deep mailto scan ───\r\n                logger.info(`No email from scrape for ${vendorId}. Trying deep mailto scan...`);\r\n                const mailtoResult = await deepMailtoScan(vendorWebsite);\r\n\r\n                if (mailtoResult.email) {\r\n                    const mailtoVerification = await verifyEmail(mailtoResult.email);\r\n                    if (mailtoVerification.valid && mailtoVerification.deliverable) {\r\n                        await db.collection(\"vendors\").doc(vendorId).update({\r\n                            email: mailtoResult.email,\r\n                            'enrichment.enrichedFields': admin.firestore.FieldValue.arrayUnion('email'),\r\n                            'enrichment.enrichmentSource': 'deep_mailto_scan',\r\n                            updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                        });\r\n                        await db.collection(\"vendor_activities\").add({\r\n                            vendorId,\r\n                            type: \"ENRICHMENT\",\r\n                            description: `Deep mailto scan found email (scanned ${mailtoResult.pagesScanned} pages)`,\r\n                            createdAt: new Date(),\r\n                            metadata: { email: mailtoResult.email, pagesScanned: mailtoResult.pagesScanned },\r\n                        });\r\n                        logger.info(`Found email ${mailtoResult.email} via deep mailto for ${vendorId}.`);\r\n                        const updatedDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n                        await setOutreachPending(vendorId, updatedDoc.data() || vendorData);\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // ─── FALLBACK LAYER 3: Serper web search ───\r\n                const vendorName = vendorData.businessName || vendorData.name || '';\r\n                const vendorLocation = vendorData.address || vendorData.location || '';\r\n                let domain: string | undefined;\r\n                try { domain = new URL(vendorWebsite).hostname; } catch { /* ignore */ }\r\n\r\n                logger.info(`No email from mailto scan for ${vendorId}. Trying Serper web search...`);\r\n                const webResult = await searchWebForEmail(vendorName, vendorLocation, domain, SERPER_API_KEY.value());\r\n\r\n                if (webResult.email) {\r\n                    const webVerification = await verifyEmail(webResult.email);\r\n                    if (webVerification.valid && webVerification.deliverable) {\r\n                        await db.collection(\"vendors\").doc(vendorId).update({\r\n                            email: webResult.email,\r\n                            'enrichment.enrichedFields': admin.firestore.FieldValue.arrayUnion('email'),\r\n                            'enrichment.enrichmentSource': webResult.source,\r\n                            updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                        });\r\n                        await db.collection(\"vendor_activities\").add({\r\n                            vendorId,\r\n                            type: \"ENRICHMENT\",\r\n                            description: `Serper web search found email via ${webResult.source}`,\r\n                            createdAt: new Date(),\r\n                            metadata: { email: webResult.email, source: webResult.source },\r\n                        });\r\n                        logger.info(`Found email ${webResult.email} via ${webResult.source} for ${vendorId}.`);\r\n                        const updatedDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n                        await setOutreachPending(vendorId, updatedDoc.data() || vendorData);\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                // ─── ALL SOURCES EXHAUSTED ───\r\n                if (scrapedData.contactFormUrl) {\r\n                    logger.info(`All enrichment failed for ${vendorId}, but found contact form: ${scrapedData.contactFormUrl}`);\r\n                    await db.collection(\"vendors\").doc(vendorId).update({\r\n                        outreachStatus: 'NEEDS_MANUAL_OUTREACH',\r\n                        statusUpdatedAt: new Date(),\r\n                        'enrichment.exhausted': true,\r\n                        'enrichment.sourcesAttempted': ['website_scrape', 'deep_mailto', 'serper_web_search'],\r\n                    });\r\n                    await db.collection(\"vendor_activities\").add({\r\n                        vendorId,\r\n                        type: \"NEEDS_MANUAL_OUTREACH\",\r\n                        description: `No email found after 3-layer enrichment. Contact form: ${scrapedData.contactFormUrl}`,\r\n                        createdAt: new Date(),\r\n                        metadata: { contactFormUrl: scrapedData.contactFormUrl, sourcesAttempted: 3 },\r\n                    });\r\n                } else {\r\n                    await db.collection(\"vendors\").doc(vendorId).update({\r\n                        'enrichment.exhausted': true,\r\n                        'enrichment.sourcesAttempted': ['website_scrape', 'deep_mailto', 'serper_web_search'],\r\n                    });\r\n                    await markNeedsContact(vendorId, \"No email found after 3-layer enrichment (scrape → mailto → web search)\");\r\n                }\r\n\r\n            } catch (enrichError: any) {\r\n                logger.error(`Enrichment error for ${vendorId}:`, enrichError);\r\n                await markNeedsContact(vendorId, `Enrichment error: ${enrichError.message}`);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        // ─── BRANCH 3: No email AND no website → try Serper web search before giving up ───\r\n        logger.info(`Vendor ${vendorId} has no email and no website. Trying Serper web search...`);\r\n\r\n        const vendorName = vendorData.businessName || vendorData.name || '';\r\n        const vendorLocation = vendorData.address || vendorData.location || '';\r\n\r\n        if (vendorName) {\r\n            const webResult = await searchWebForEmail(vendorName, vendorLocation, undefined, SERPER_API_KEY.value());\r\n\r\n            if (webResult.email) {\r\n                const webVerification = await verifyEmail(webResult.email);\r\n                if (webVerification.valid && webVerification.deliverable) {\r\n                    await db.collection(\"vendors\").doc(vendorId).update({\r\n                        email: webResult.email,\r\n                        enrichment: {\r\n                            lastEnriched: admin.firestore.FieldValue.serverTimestamp(),\r\n                            enrichedFields: ['email'],\r\n                            enrichmentSource: webResult.source,\r\n                        },\r\n                        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                    });\r\n                    await db.collection(\"vendor_activities\").add({\r\n                        vendorId,\r\n                        type: \"ENRICHMENT\",\r\n                        description: `Serper web search found email via ${webResult.source} (no website on file)`,\r\n                        createdAt: new Date(),\r\n                        metadata: { email: webResult.email, source: webResult.source },\r\n                    });\r\n                    logger.info(`Found email ${webResult.email} via web search for ${vendorId} (no website).`);\r\n                    const updatedDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n                    await setOutreachPending(vendorId, updatedDoc.data() || vendorData);\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Truly exhausted — no website, no web results\r\n        await db.collection(\"vendors\").doc(vendorId).update({\r\n            'enrichment.exhausted': true,\r\n            'enrichment.sourcesAttempted': vendorName ? ['serper_web_search'] : ['none_available'],\r\n        });\r\n        await markNeedsContact(vendorId, vendorName\r\n            ? \"No email found — web search exhausted, no website on file\"\r\n            : \"No email, no website, no business name — cannot enrich\"\r\n        );\r\n\r\n    } catch (error) {\r\n        logger.error(\"Error in enrich pipeline:\", error);\r\n    }\r\n}\r\n\r\n\r\n// ─── Helper: check profile completeness before outreach ───\r\nasync function checkProfileCompleteness(vendorId: string, vendorData: any): Promise<string[]> {\r\n    const missing: string[] = [];\r\n\r\n    if (!vendorData.businessName) missing.push('businessName');\r\n\r\n    const hasCapabilities = Array.isArray(vendorData.capabilities) && vendorData.capabilities.length > 0;\r\n    const hasSpecialty = !!vendorData.specialty;\r\n    if (!hasCapabilities && !hasSpecialty) missing.push('services/capabilities');\r\n\r\n    // email is already gated by the enrichment pipeline — this is a safety check\r\n    if (!vendorData.email) missing.push('email');\r\n\r\n    return missing;\r\n}\r\n\r\n\r\n// ─── Helper: set outreach pending and enqueue GENERATE task ───\r\nasync function setOutreachPending(vendorId: string, vendorData: any) {\r\n    // Profile completeness gate\r\n    const missingFields = await checkProfileCompleteness(vendorId, vendorData);\r\n\r\n    if (missingFields.length > 0) {\r\n        logger.warn(`Vendor ${vendorId} profile incomplete. Missing: ${missingFields.join(', ')}. Blocking outreach.`);\r\n\r\n        await db.collection(\"vendors\").doc(vendorId).update({\r\n            outreachStatus: 'PROFILE_INCOMPLETE',\r\n            statusUpdatedAt: new Date(),\r\n        });\r\n\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"PROFILE_INCOMPLETE\",\r\n            description: `Outreach blocked — missing: ${missingFields.join(', ')}. Complete the vendor profile to enable outreach.`,\r\n            createdAt: new Date(),\r\n            metadata: { missingFields },\r\n        });\r\n\r\n        return;\r\n    }\r\n\r\n    await db.collection(\"vendors\").doc(vendorId).update({\r\n        outreachStatus: 'PENDING',\r\n        statusUpdatedAt: new Date(),\r\n    });\r\n\r\n    // Pass full vendor profile for AI personalization\r\n    const { enqueueTask } = await import(\"../utils/queueUtils\");\r\n    await enqueueTask(db, {\r\n        vendorId,\r\n        type: 'GENERATE',\r\n        scheduledAt: new Date() as any,\r\n        metadata: {\r\n            companyName: vendorData.businessName,\r\n            specialty: vendorData.specialty || vendorData.capabilities?.[0] || null,\r\n            capabilities: vendorData.capabilities || [],\r\n            contactName: vendorData.contactName || null,\r\n            city: vendorData.city || null,\r\n            state: vendorData.state || null,\r\n            zip: vendorData.zip || null,\r\n            phone: vendorData.phone || null,\r\n            hasActiveContract: vendorData.hasActiveContract || false,\r\n            status: vendorData.status,\r\n        }\r\n    });\r\n\r\n    logger.info(`Outreach GENERATE task enqueued for vendor ${vendorId}`);\r\n}\r\n\r\n\r\n// ─── Helper: mark vendor as NEEDS_CONTACT ───\r\nasync function markNeedsContact(vendorId: string, reason: string) {\r\n    await db.collection(\"vendors\").doc(vendorId).update({\r\n        outreachStatus: 'NEEDS_CONTACT',\r\n        statusUpdatedAt: new Date(),\r\n    });\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"NEEDS_CONTACT\",\r\n        description: `Manual outreach required: ${reason}`,\r\n        createdAt: new Date(),\r\n    });\r\n\r\n    logger.info(`Vendor ${vendorId} marked NEEDS_CONTACT: ${reason}`);\r\n}\r\n","import * as cheerio from 'cheerio';\r\nimport { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\ninterface ScrapedData {\r\n    email?: string;\r\n    phone?: string;\r\n    address?: string;\r\n    businessName?: string;\r\n    contactFormUrl?: string;\r\n    socialMedia?: {\r\n        linkedin?: string;\r\n        facebook?: string;\r\n        twitter?: string;\r\n    };\r\n    confidence: 'high' | 'medium' | 'low';\r\n    source: string;\r\n}\r\n\r\ninterface EnrichmentResult {\r\n    success: boolean;\r\n    data?: ScrapedData;\r\n    error?: string;\r\n}\r\n\r\nconst TIMEOUT_MS = 15000; // 15s for slow small-biz sites\r\nconst USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';\r\n\r\n/**\r\n * Fetch a page with error handling and timeout\r\n */\r\nasync function fetchPage(url: string): Promise<{ html: string; $: cheerio.CheerioAPI } | null> {\r\n    try {\r\n        const response = await fetch(url, {\r\n            headers: { 'User-Agent': USER_AGENT },\r\n            signal: AbortSignal.timeout(TIMEOUT_MS),\r\n        });\r\n        if (!response.ok) return null;\r\n        const html = await response.text();\r\n        return { html, $: cheerio.load(html) };\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Scrapes a website and extracts contact information using multi-page + AI extraction\r\n */\r\nexport async function scrapeWebsite(url: string, geminiApiKey: string): Promise<EnrichmentResult> {\r\n    try {\r\n        // ─── Step 1: Scrape homepage ───\r\n        const homepage = await fetchPage(url);\r\n        if (!homepage) {\r\n            return { success: false, error: `Could not fetch ${url}` };\r\n        }\r\n\r\n        const structuredData = extractStructuredData(homepage.$);\r\n        const patternData = extractFromPatterns(homepage.$, homepage.html);\r\n        const linkData = extractMailtoAndTel(homepage.$);\r\n\r\n        // ─── Step 2: Find and scrape additional pages (contact, about, team) ───\r\n        const additionalPages = findAdditionalPages(homepage.$, url);\r\n        const contactPageResults: Partial<ScrapedData>[] = [];\r\n        let allAdditionalHtml = '';\r\n\r\n        for (const pageUrl of additionalPages.slice(0, 3)) { // max 3 extra pages\r\n            const page = await fetchPage(pageUrl);\r\n            if (!page) continue;\r\n\r\n            const pagePatterns = extractFromPatterns(page.$, page.html);\r\n            const pageLinks = extractMailtoAndTel(page.$);\r\n\r\n            // Detect contact form\r\n            const hasForm = page.$('form').length > 0;\r\n            if (hasForm) pagePatterns.contactFormUrl = pageUrl;\r\n\r\n            contactPageResults.push({\r\n                ...pagePatterns,\r\n                email: pageLinks.email || pagePatterns.email,\r\n                phone: pageLinks.phone || pagePatterns.phone,\r\n            });\r\n\r\n            allAdditionalHtml += page.html + '\\n';\r\n        }\r\n\r\n        // ─── Step 3: Merge all data (priority: structured > mailto/tel > contact pages > homepage patterns) ───\r\n        const mergedContact = mergeContactPages(contactPageResults);\r\n\r\n        const combinedData: ScrapedData = {\r\n            email: structuredData.email || linkData.email || mergedContact.email || patternData.email,\r\n            phone: structuredData.phone || linkData.phone || mergedContact.phone || patternData.phone,\r\n            address: structuredData.address || mergedContact.address || patternData.address,\r\n            businessName: structuredData.businessName || patternData.businessName,\r\n            contactFormUrl: mergedContact.contactFormUrl,\r\n            socialMedia: {\r\n                linkedin: patternData.socialMedia?.linkedin || mergedContact.socialMedia?.linkedin,\r\n                facebook: patternData.socialMedia?.facebook || mergedContact.socialMedia?.facebook,\r\n                twitter: patternData.socialMedia?.twitter || mergedContact.socialMedia?.twitter,\r\n            },\r\n            confidence: 'low',\r\n            source: 'web-scraper',\r\n        };\r\n\r\n        // ─── Step 4: Generic email fallback (info@, contact@) if no personal email found ───\r\n        if (!combinedData.email) {\r\n            const genericEmail = findGenericEmail(homepage.html, allAdditionalHtml);\r\n            if (genericEmail) {\r\n                combinedData.email = genericEmail;\r\n            }\r\n        }\r\n\r\n        // ─── Step 5: AI extraction on the best available HTML ───\r\n        if (!combinedData.email || !combinedData.phone) {\r\n            // Feed AI the contact/about page if available, otherwise homepage\r\n            const aiHtml = allAdditionalHtml.length > 500 ? allAdditionalHtml : homepage.html;\r\n            const aiData = await extractWithAI(aiHtml, geminiApiKey);\r\n            combinedData.email = combinedData.email || aiData.email;\r\n            combinedData.phone = combinedData.phone || aiData.phone;\r\n            combinedData.address = combinedData.address || aiData.address;\r\n            combinedData.businessName = combinedData.businessName || aiData.businessName;\r\n        }\r\n\r\n        // ─── Step 6: Validate and format ───\r\n        if (combinedData.email) {\r\n            combinedData.email = validateEmail(combinedData.email);\r\n        }\r\n        if (combinedData.phone) {\r\n            combinedData.phone = formatPhone(combinedData.phone);\r\n        }\r\n\r\n        combinedData.confidence = determineConfidence(structuredData, patternData, mergedContact, linkData);\r\n\r\n        return { success: true, data: combinedData };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════\r\n// EXTRACTION METHODS\r\n// ═══════════════════════════════════════════════════════\r\n\r\n/**\r\n * Extract mailto: and tel: links — the most reliable source of contact info\r\n */\r\nfunction extractMailtoAndTel($: cheerio.CheerioAPI): { email?: string; phone?: string } {\r\n    let email: string | undefined;\r\n    let phone: string | undefined;\r\n\r\n    // mailto: links\r\n    $('a[href^=\"mailto:\"]').each((_, elem) => {\r\n        if (email) return;\r\n        const href = $(elem).attr('href');\r\n        if (href) {\r\n            const addr = href.replace('mailto:', '').split('?')[0].trim().toLowerCase();\r\n            // Prefer personal emails over generic\r\n            if (!addr.match(/^(noreply|no-reply|support|webmaster)@/i)) {\r\n                email = addr;\r\n            }\r\n        }\r\n    });\r\n\r\n    // tel: links\r\n    $('a[href^=\"tel:\"]').each((_, elem) => {\r\n        if (phone) return;\r\n        const href = $(elem).attr('href');\r\n        if (href) {\r\n            phone = href.replace('tel:', '').replace(/[^\\d+]/g, '').trim();\r\n        }\r\n    });\r\n\r\n    return { email, phone };\r\n}\r\n\r\n/**\r\n * Extract data from structured meta tags and schema.org JSON-LD\r\n */\r\nfunction extractStructuredData($: cheerio.CheerioAPI): Partial<ScrapedData> {\r\n    const data: Partial<ScrapedData> = {};\r\n\r\n    // Meta tags\r\n    data.email = $('meta[property=\"og:email\"]').attr('content') ||\r\n        $('meta[name=\"contact:email\"]').attr('content');\r\n\r\n    data.phone = $('meta[property=\"og:phone_number\"]').attr('content') ||\r\n        $('meta[name=\"contact:phone\"]').attr('content');\r\n\r\n    // Schema.org structured data (check for arrays too)\r\n    $('script[type=\"application/ld+json\"]').each((_, elem) => {\r\n        try {\r\n            let jsonItems = JSON.parse($(elem).html() || '{}');\r\n            // Handle @graph arrays\r\n            if (jsonItems['@graph']) jsonItems = jsonItems['@graph'];\r\n            if (!Array.isArray(jsonItems)) jsonItems = [jsonItems];\r\n\r\n            for (const json of jsonItems) {\r\n                const type = json['@type'];\r\n                if (type === 'Organization' || type === 'LocalBusiness' ||\r\n                    type === 'CleaningService' || type === 'ProfessionalService' ||\r\n                    type === 'HomeAndConstructionBusiness') {\r\n                    data.email = data.email || json.email;\r\n                    data.phone = data.phone || json.telephone;\r\n                    data.businessName = data.businessName || json.name;\r\n                    if (json.address) {\r\n                        data.address = typeof json.address === 'string'\r\n                            ? json.address\r\n                            : [json.address.streetAddress, json.address.addressLocality,\r\n                            json.address.addressRegion, json.address.postalCode]\r\n                                .filter(Boolean).join(', ');\r\n                    }\r\n                }\r\n            }\r\n        } catch {\r\n            // Invalid JSON, skip\r\n        }\r\n    });\r\n\r\n    // Business name fallback from title/h1\r\n    data.businessName = data.businessName ||\r\n        $('meta[property=\"og:site_name\"]').attr('content') ||\r\n        $('title').text().split('|')[0].split('-')[0].split('–')[0].trim() ||\r\n        $('h1').first().text().trim();\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Extract data using regex patterns from HTML\r\n */\r\nfunction extractFromPatterns($: cheerio.CheerioAPI, html: string): Partial<ScrapedData> {\r\n    const data: Partial<ScrapedData> = { socialMedia: {} };\r\n\r\n    // Email regex — exclude common junk but keep business-relevant emails\r\n    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g;\r\n    const emails = html.match(emailRegex) || [];\r\n    const personalEmails = emails.filter(email =>\r\n        !email.match(/^(info|admin|noreply|no-reply|support|hello|contact|webmaster|sales|marketing)@/i) &&\r\n        !email.includes('example.com') &&\r\n        !email.includes('domain.com') &&\r\n        !email.includes('sentry.io') &&\r\n        !email.includes('wixpress.com') &&\r\n        !email.includes('wordpress.') &&\r\n        !email.includes('@e.') // tracking pixels\r\n    );\r\n    data.email = personalEmails[0];\r\n\r\n    // Phone regex (US format) — also check tel: attributes\r\n    const phoneRegex = /(\\+1[-.\\\\s]?)?\\(?\\d{3}\\)?[-.\\\\s]?\\d{3}[-.\\\\s]?\\d{4}/g;\r\n    const phones = html.match(phoneRegex) || [];\r\n    data.phone = phones[0];\r\n\r\n    // Address — look in footer and common containers\r\n    const footerText = $('footer, [class*=\"footer\"], [class*=\"contact\"], [class*=\"address\"], [itemtype*=\"PostalAddress\"]').text();\r\n    const addressRegex = /\\d{1,5}\\s[\\w\\s.]+(?:St|Street|Ave|Avenue|Blvd|Boulevard|Dr|Drive|Rd|Road|Ln|Lane|Way|Ct|Court|Pl|Place|Pkwy|Parkway)[.,]?\\s[\\w\\s]+,\\s*[A-Z]{2}\\s*\\d{5}/gi;\r\n    const addresses = footerText.match(addressRegex) || html.match(addressRegex) || [];\r\n    data.address = data.address || addresses[0]?.trim();\r\n\r\n    // Social media links\r\n    $('a[href*=\"linkedin.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href && (href.includes('/company/') || href.includes('/in/'))) {\r\n            data.socialMedia!.linkedin = href;\r\n        }\r\n    });\r\n\r\n    $('a[href*=\"facebook.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href && !href.includes('sharer') && !href.includes('share.php')) {\r\n            data.socialMedia!.facebook = href;\r\n        }\r\n    });\r\n\r\n    $('a[href*=\"twitter.com\"], a[href*=\"x.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href && !href.includes('intent/tweet')) {\r\n            data.socialMedia!.twitter = href;\r\n        }\r\n    });\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Find all relevant pages to scrape (contact, about, team, locations)\r\n */\r\nfunction findAdditionalPages($: cheerio.CheerioAPI, baseUrl: string): string[] {\r\n    const keywords = [\r\n        'contact', 'about', 'about-us', 'our-team', 'team',\r\n        'location', 'locations', 'reach-us', 'get-in-touch',\r\n        'connect', 'find-us', 'staff', 'leadership'\r\n    ];\r\n\r\n    const found = new Set<string>();\r\n\r\n    $('a').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        const text = $(elem).text().toLowerCase().trim();\r\n        if (!href) return;\r\n\r\n        // Skip external, anchor, tel, mailto links\r\n        if (href.startsWith('#') || href.startsWith('tel:') || href.startsWith('mailto:')) return;\r\n\r\n        const lowerHref = href.toLowerCase();\r\n        const isMatch = keywords.some(kw => lowerHref.includes(kw) || text.includes(kw));\r\n        if (!isMatch) return;\r\n\r\n        try {\r\n            const fullUrl = new URL(href, baseUrl).href;\r\n            // Only same-domain pages\r\n            if (new URL(fullUrl).hostname === new URL(baseUrl).hostname) {\r\n                found.add(fullUrl);\r\n            }\r\n        } catch {\r\n            // Invalid URL\r\n        }\r\n    });\r\n\r\n    return Array.from(found);\r\n}\r\n\r\n/**\r\n * Find generic emails (info@, contact@) as fallback when no personal email found\r\n */\r\nfunction findGenericEmail(...htmlSources: string[]): string | undefined {\r\n    const combined = htmlSources.join(' ');\r\n    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g;\r\n    const allEmails = combined.match(emailRegex) || [];\r\n\r\n    // Now accept generic business emails (info@, contact@, hello@)\r\n    const genericEmails = allEmails.filter(email =>\r\n        email.match(/^(info|contact|hello|office|service|services|team|admin)@/i) &&\r\n        !email.includes('example.com') &&\r\n        !email.includes('domain.com') &&\r\n        !email.includes('wixpress.com')\r\n    );\r\n\r\n    return genericEmails[0]?.toLowerCase();\r\n}\r\n\r\n/**\r\n * Merge results from multiple contact pages\r\n */\r\nfunction mergeContactPages(pages: Partial<ScrapedData>[]): Partial<ScrapedData> {\r\n    const merged: Partial<ScrapedData> = { socialMedia: {} };\r\n    for (const p of pages) {\r\n        merged.email = merged.email || p.email;\r\n        merged.phone = merged.phone || p.phone;\r\n        merged.address = merged.address || p.address;\r\n        merged.contactFormUrl = merged.contactFormUrl || p.contactFormUrl;\r\n        if (p.socialMedia) {\r\n            merged.socialMedia!.linkedin = merged.socialMedia!.linkedin || p.socialMedia.linkedin;\r\n            merged.socialMedia!.facebook = merged.socialMedia!.facebook || p.socialMedia.facebook;\r\n            merged.socialMedia!.twitter = merged.socialMedia!.twitter || p.socialMedia.twitter;\r\n        }\r\n    }\r\n    return merged;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════\r\n// AI EXTRACTION\r\n// ═══════════════════════════════════════════════════════\r\n\r\n/**\r\n * Extract contact info using Gemini AI — runs on the best available HTML\r\n */\r\nasync function extractWithAI(html: string, geminiApiKey: string): Promise<Partial<ScrapedData>> {\r\n    try {\r\n        const genAI = new GoogleGenerativeAI(geminiApiKey);\r\n        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });\r\n\r\n        // Strip HTML to plain text and limit size (use more content for better results)\r\n        const text = html.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').substring(0, 15000);\r\n\r\n        const prompt = `Extract business contact information from this website content. \r\nThis is a commercial cleaning or janitorial company. Find the owner/manager's direct contact info if possible.\r\n\r\nReturn ONLY a JSON object with these fields (use null if not found):\r\n{\r\n  \"email\": \"email address (prefer personal/owner email over generic info@)\",\r\n  \"phone\": \"primary phone number in format (xxx) xxx-xxxx\",\r\n  \"address\": \"full physical address if available\",\r\n  \"businessName\": \"official business name\"\r\n}\r\n\r\nWebsite content:\r\n${text}`;\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response.text();\r\n\r\n        const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n        if (jsonMatch) {\r\n            const data = JSON.parse(jsonMatch[0]);\r\n            return {\r\n                email: data.email && data.email !== 'null' && data.email !== null ? data.email : undefined,\r\n                phone: data.phone && data.phone !== 'null' && data.phone !== null ? data.phone : undefined,\r\n                address: data.address && data.address !== 'null' && data.address !== null ? data.address : undefined,\r\n                businessName: data.businessName && data.businessName !== 'null' && data.businessName !== null ? data.businessName : undefined,\r\n            };\r\n        }\r\n\r\n        return {};\r\n    } catch (error) {\r\n        console.error('AI extraction error:', error);\r\n        return {};\r\n    }\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════\r\n// VALIDATION & HELPERS\r\n// ═══════════════════════════════════════════════════════\r\n\r\n/**\r\n * Determine confidence level based on data sources\r\n */\r\nfunction determineConfidence(\r\n    structured: Partial<ScrapedData>,\r\n    pattern: Partial<ScrapedData>,\r\n    contact: Partial<ScrapedData>,\r\n    links: { email?: string; phone?: string }\r\n): 'high' | 'medium' | 'low' {\r\n    if (structured.email || structured.phone) return 'high';\r\n    if (links.email || links.phone) return 'high'; // mailto/tel are very reliable\r\n    if (contact.email || contact.phone) return 'medium';\r\n    if (pattern.email || pattern.phone) return 'low';\r\n    return 'low';\r\n}\r\n\r\n/**\r\n * Validate email format\r\n */\r\nfunction validateEmail(email: string): string | undefined {\r\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n    if (!emailRegex.test(email)) return undefined;\r\n\r\n    // Only exclude truly useless emails\r\n    if (email.match(/^(noreply|no-reply|donotreply|bounce|mailer-daemon|postmaster)@/i)) {\r\n        return undefined;\r\n    }\r\n\r\n    return email.toLowerCase();\r\n}\r\n\r\n/**\r\n * Format phone number to (xxx) xxx-xxxx\r\n */\r\nfunction formatPhone(phone: string): string | undefined {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    if (digits.length === 10) {\r\n        return `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 10)}`;\r\n    }\r\n    if (digits.length === 11 && digits[0] === '1') {\r\n        return `(${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7, 11)}`;\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════\r\n// DEEP MAILTO SCAN\r\n// ═══════════════════════════════════════════════════════\r\n\r\n/**\r\n * Deep-crawl a website looking for mailto: links across all internal pages.\r\n * This catches emails that are only on sub-pages (e.g., /staff, /team, /careers)\r\n * and are the most reliable email source for small business sites.\r\n */\r\nexport async function deepMailtoScan(baseUrl: string): Promise<{ email?: string; phone?: string; pagesScanned: number }> {\r\n    const visited = new Set<string>();\r\n    let foundEmail: string | undefined;\r\n    let foundPhone: string | undefined;\r\n\r\n    try {\r\n        // Fetch homepage first\r\n        const homepage = await fetchPage(baseUrl);\r\n        if (!homepage) return { pagesScanned: 0 };\r\n\r\n        // Collect ALL internal links from homepage\r\n        const internalLinks = new Set<string>();\r\n        homepage.$('a').each((_, elem) => {\r\n            const href = homepage.$(elem).attr('href');\r\n            if (!href || href.startsWith('#') || href.startsWith('tel:') || href.startsWith('mailto:')) return;\r\n            try {\r\n                const fullUrl = new URL(href, baseUrl).href;\r\n                if (new URL(fullUrl).hostname === new URL(baseUrl).hostname) {\r\n                    internalLinks.add(fullUrl);\r\n                }\r\n            } catch {\r\n                // Invalid URL\r\n            }\r\n        });\r\n\r\n        // Check homepage for mailto/tel first\r\n        const homeResult = extractMailtoAndTel(homepage.$);\r\n        if (homeResult.email) foundEmail = homeResult.email;\r\n        if (homeResult.phone) foundPhone = homeResult.phone;\r\n        visited.add(baseUrl);\r\n\r\n        if (foundEmail) return { email: foundEmail, phone: foundPhone, pagesScanned: 1 };\r\n\r\n        // Crawl up to 5 additional internal pages looking for mailto\r\n        const pagesToCheck = Array.from(internalLinks).slice(0, 5);\r\n        for (const pageUrl of pagesToCheck) {\r\n            if (visited.has(pageUrl)) continue;\r\n            visited.add(pageUrl);\r\n\r\n            const page = await fetchPage(pageUrl);\r\n            if (!page) continue;\r\n\r\n            const pageResult = extractMailtoAndTel(page.$);\r\n            if (pageResult.email && !foundEmail) foundEmail = pageResult.email;\r\n            if (pageResult.phone && !foundPhone) foundPhone = pageResult.phone;\r\n\r\n            // Also check raw HTML for emails in href attributes (obfuscated mailto)\r\n            const obfuscatedEmails = page.html.match(/href\\s*=\\s*[\"']mailto:([^\"'?]+)/gi) || [];\r\n            for (const match of obfuscatedEmails) {\r\n                const email = match.replace(/href\\s*=\\s*[\"']mailto:/i, '').trim().toLowerCase();\r\n                if (email && !email.match(/^(noreply|no-reply|support|webmaster)@/i)) {\r\n                    foundEmail = foundEmail || email;\r\n                }\r\n            }\r\n\r\n            if (foundEmail) break;\r\n        }\r\n\r\n        return { email: foundEmail, phone: foundPhone, pagesScanned: visited.size };\r\n    } catch (error) {\r\n        console.error('Deep mailto scan error:', error);\r\n        return { pagesScanned: visited.size };\r\n    }\r\n}\r\n\r\n// ═══════════════════════════════════════════════════════\r\n// SERPER WEB EMAIL SEARCH\r\n// ═══════════════════════════════════════════════════════\r\n\r\n/**\r\n * Search the web for a business's email using Serper.dev.\r\n * This is the last-resort fallback when website scraping + deep mailto fails.\r\n * \r\n * Strategies:\r\n * 1. Search `\"businessName\" \"location\" email` \r\n * 2. Search `site:domain.com email` (if domain available)\r\n * 3. Extract emails from search result snippets and linked pages\r\n */\r\nexport async function searchWebForEmail(\r\n    businessName: string,\r\n    location: string,\r\n    domain?: string,\r\n    serperApiKey?: string\r\n): Promise<{ email?: string; phone?: string; source: string }> {\r\n    const apiKey = serperApiKey || process.env.SERPER_API_KEY;\r\n    if (!apiKey) {\r\n        console.warn('No SERPER_API_KEY available for web email search.');\r\n        return { source: 'serper_skipped' };\r\n    }\r\n\r\n    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g;\r\n    const phoneRegex = /(\\+1[-.\\\\s]?)?\\(?\\d{3}\\)?[-.\\\\s]?\\d{3}[-.\\\\s]?\\d{4}/g;\r\n\r\n    const queries: string[] = [];\r\n\r\n    // Strategy 1: site-specific search (most targeted)\r\n    if (domain) {\r\n        queries.push(`site:${domain} email OR contact`);\r\n    }\r\n\r\n    // Strategy 2: business name + location search\r\n    queries.push(`\"${businessName}\" ${location} email contact`);\r\n\r\n    for (const query of queries) {\r\n        try {\r\n            const response = await fetch('https://google.serper.dev/search', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'X-API-KEY': apiKey.trim(),\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({ q: query, num: 5 }),\r\n                signal: AbortSignal.timeout(10000),\r\n            });\r\n\r\n            if (!response.ok) continue;\r\n\r\n            const data = await response.json() as any;\r\n            const organic = data.organic || [];\r\n\r\n            // Extract emails from snippets\r\n            for (const result of organic) {\r\n                const text = `${result.snippet || ''} ${result.title || ''}`;\r\n                const emails = text.match(emailRegex) || [];\r\n                const phones = text.match(phoneRegex) || [];\r\n\r\n                // Filter junk emails\r\n                const validEmails = emails.filter((e: string) =>\r\n                    !e.includes('example.com') &&\r\n                    !e.includes('domain.com') &&\r\n                    !e.includes('sentry.io') &&\r\n                    !e.includes('wixpress.com') &&\r\n                    !e.includes('wordpress.') &&\r\n                    !e.match(/^(noreply|no-reply|bounce|mailer-daemon)@/i)\r\n                );\r\n\r\n                if (validEmails.length > 0) {\r\n                    return {\r\n                        email: validEmails[0].toLowerCase(),\r\n                        phone: phones[0],\r\n                        source: 'serper_web_search'\r\n                    };\r\n                }\r\n            }\r\n\r\n            // Check knowledge graph if present\r\n            if (data.knowledgeGraph) {\r\n                const kg = data.knowledgeGraph;\r\n                if (kg.email) {\r\n                    return { email: kg.email.toLowerCase(), phone: kg.phone, source: 'serper_knowledge_graph' };\r\n                }\r\n                if (kg.phone && !data.organic?.length) {\r\n                    return { phone: kg.phone, source: 'serper_knowledge_graph' };\r\n                }\r\n            }\r\n\r\n        } catch (error) {\r\n            console.error(`Serper search error for query \"${query}\":`, error);\r\n        }\r\n    }\r\n\r\n    return { source: 'serper_exhausted' };\r\n}\r\n\r\n","/**\r\n * Email verification utilities\r\n */\r\n\r\ninterface EmailVerificationResult {\r\n    valid: boolean;\r\n    deliverable?: boolean;\r\n    reason?: string;\r\n}\r\n\r\n/**\r\n * Verify email deliverability using DNS MX record lookup\r\n */\r\nexport async function verifyEmail(email: string): Promise<EmailVerificationResult> {\r\n    // Basic format validation\r\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n    if (!emailRegex.test(email)) {\r\n        return { valid: false, reason: 'Invalid email format' };\r\n    }\r\n\r\n    // Extract domain\r\n    const domain = email.split('@')[1];\r\n\r\n    try {\r\n        // Check if domain has MX records (indicates it can receive email)\r\n        const mxRecords = await resolveMX(domain);\r\n\r\n        if (mxRecords && mxRecords.length > 0) {\r\n            return { valid: true, deliverable: true };\r\n        } else {\r\n            return { valid: true, deliverable: false, reason: 'No MX records found' };\r\n        }\r\n    } catch (error) {\r\n        // DNS lookup failed - domain might not exist\r\n        return { valid: true, deliverable: false, reason: 'Domain not found' };\r\n    }\r\n}\r\n\r\n/**\r\n * Resolve MX records for a domain\r\n * Note: This uses Node.js dns module which is available in Cloud Functions\r\n */\r\nasync function resolveMX(domain: string): Promise<any[]> {\r\n    const dns = await import('dns');\r\n    const { promisify } = await import('util');\r\n    const resolveMx = promisify(dns.resolveMx);\r\n\r\n    try {\r\n        return await resolveMx(domain);\r\n    } catch (error) {\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Check if email is a disposable/temporary email service\r\n */\r\nexport function isDisposableEmail(email: string): boolean {\r\n    const disposableDomains = [\r\n        'tempmail.com',\r\n        'guerrillamail.com',\r\n        '10minutemail.com',\r\n        'mailinator.com',\r\n        'throwaway.email',\r\n        'temp-mail.org',\r\n    ];\r\n\r\n    const domain = email.split('@')[1].toLowerCase();\r\n    return disposableDomains.includes(domain);\r\n}\r\n\r\n/**\r\n * Check if email is a role-based email (not a personal contact)\r\n */\r\nexport function isRoleBasedEmail(email: string): boolean {\r\n    const roleBasedPrefixes = [\r\n        'info', 'admin', 'support', 'sales', 'contact',\r\n        'hello', 'help', 'noreply', 'no-reply', 'webmaster',\r\n        'postmaster', 'hostmaster', 'abuse',\r\n    ];\r\n\r\n    const prefix = email.split('@')[0].toLowerCase();\r\n    return roleBasedPrefixes.includes(prefix);\r\n}\r\n","/**\r\n * Phone number validation and formatting utilities\r\n */\r\n\r\ninterface PhoneVerificationResult {\r\n    valid: boolean;\r\n    formatted?: string;\r\n    type?: 'mobile' | 'landline' | 'voip' | 'unknown';\r\n    reason?: string;\r\n}\r\n\r\n/**\r\n * Validate and format US phone number\r\n */\r\nexport function validatePhone(phone: string): PhoneVerificationResult {\r\n    // Extract digits only\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    // Check length\r\n    if (digits.length === 10) {\r\n        // Valid 10-digit US number\r\n        const formatted = `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 10)}`;\r\n        return {\r\n            valid: true,\r\n            formatted,\r\n            type: determinePhoneType(digits),\r\n        };\r\n    } else if (digits.length === 11 && digits[0] === '1') {\r\n        // Valid 11-digit US number with country code\r\n        const formatted = `(${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7, 11)}`;\r\n        return {\r\n            valid: true,\r\n            formatted,\r\n            type: determinePhoneType(digits.substring(1)),\r\n        };\r\n    } else {\r\n        return {\r\n            valid: false,\r\n            reason: `Invalid phone number length: ${digits.length} digits`,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Determine phone type based on area code and prefix\r\n * Note: This is a simplified heuristic. For production, consider using a service like Twilio Lookup API\r\n */\r\nfunction determinePhoneType(digits: string): 'mobile' | 'landline' | 'voip' | 'unknown' {\r\n    const areaCode = digits.substring(0, 3);\r\n    const prefix = digits.substring(3, 6);\r\n\r\n    // Common VoIP area codes\r\n    const voipAreaCodes = ['800', '888', '877', '866', '855', '844', '833'];\r\n    if (voipAreaCodes.includes(areaCode)) {\r\n        return 'voip';\r\n    }\r\n\r\n    // This is a simplified check - in reality, you'd need a comprehensive database\r\n    // or use Twilio Lookup API for accurate mobile vs landline detection\r\n    return 'unknown';\r\n}\r\n\r\n/**\r\n * Check if phone number is likely a valid business number\r\n */\r\nexport function isBusinessPhone(phone: string): boolean {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    // Toll-free numbers are typically business\r\n    const tollFreeAreaCodes = ['800', '888', '877', '866', '855', '844', '833'];\r\n    const areaCode = digits.substring(0, 3);\r\n\r\n    return tollFreeAreaCodes.includes(areaCode);\r\n}\r\n\r\n/**\r\n * Format phone number for display\r\n */\r\nexport function formatPhoneForDisplay(phone: string): string {\r\n    const result = validatePhone(phone);\r\n    return result.formatted || phone;\r\n}\r\n\r\n/**\r\n * Format phone number for storage (E.164 format)\r\n */\r\nexport function formatPhoneForStorage(phone: string): string {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    if (digits.length === 10) {\r\n        return `+1${digits}`;\r\n    } else if (digits.length === 11 && digits[0] === '1') {\r\n        return `+${digits}`;\r\n    }\r\n\r\n    return phone; // Return original if can't format\r\n}\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport * as admin from 'firebase-admin';\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { fetchPendingTasks, updateTaskStatus, enqueueTask, QueueItem } from \"../utils/queueUtils\";\r\n// import { getNextBusinessSlot } from \"../utils/timeUtils\"; // TODO: Re-enable for production\r\n// NOTE: generateOutreachContent is kept as a fallback but no longer used for vendor outreach (templates are used instead)\r\nimport { generateSalesOutreachContent } from \"../agents/salesOutreach\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\n// Run every minute to check for pending tasks\r\n// Region must match project config\r\nexport const processOutreachQueue = onSchedule({\r\n    schedule: \"every 1 minutes\",\r\n    secrets: [\"RESEND_API_KEY\", \"GEMINI_API_KEY\"],\r\n}, async (event) => {\r\n    logger.info(\"Processing outreach queue...\");\r\n\r\n    try {\r\n        const tasks = await fetchPendingTasks(db);\r\n        if (tasks.length === 0) {\r\n            logger.info(\"No pending tasks found.\");\r\n            return;\r\n        }\r\n\r\n        logger.info(`Found ${tasks.length} tasks to process.`);\r\n\r\n        for (const task of tasks) {\r\n            try {\r\n                // Route based on whether task is for a vendor or a lead\r\n                if (task.leadId) {\r\n                    // ── Sales Lead Outreach ──\r\n                    if (task.type === 'GENERATE') {\r\n                        await handleLeadGenerate(task);\r\n                    } else if (task.type === 'FOLLOW_UP') {\r\n                        await handleLeadFollowUp(task);\r\n                    } else if (task.type === 'SEND') {\r\n                        await handleLeadSend(task);\r\n                    }\r\n                } else {\r\n                    // ── Vendor Outreach (existing) ──\r\n                    if (task.type === 'GENERATE') {\r\n                        await handleGenerate(task);\r\n                    } else if (task.type === 'SEND') {\r\n                        await handleSend(task);\r\n                    } else if (task.type === 'FOLLOW_UP') {\r\n                        await handleFollowUp(task);\r\n                    }\r\n                }\r\n            } catch (err) {\r\n                logger.error(`Error processing task ${task.id}:`, err);\r\n                // Simple retry logic: Increment count, set to retry, backoff\r\n                // If > 5 retries, mark FAILED\r\n                const newRetryCount = (task.retryCount || 0) + 1;\r\n                const status = newRetryCount > 5 ? 'FAILED' : 'RETRY';\r\n\r\n                // Exponential backoff for retry (1m, 2m, 4m...)\r\n                const nextAttempt = new Date();\r\n                nextAttempt.setMinutes(nextAttempt.getMinutes() + Math.pow(2, newRetryCount));\r\n\r\n                await updateTaskStatus(db, task.id!, status, {\r\n                    retryCount: newRetryCount,\r\n                    scheduledAt: admin.firestore.Timestamp.fromDate(nextAttempt),\r\n                    error: String(err)\r\n                });\r\n\r\n                // When max retries exhausted, update vendor outreachStatus to FAILED\r\n                if (status === 'FAILED' && task.vendorId) {\r\n                    await db.collection(\"vendors\").doc(task.vendorId).update({\r\n                        outreachStatus: 'FAILED',\r\n                        statusUpdatedAt: new Date(),\r\n                    });\r\n                    await db.collection(\"vendor_activities\").add({\r\n                        vendorId: task.vendorId,\r\n                        type: \"OUTREACH_FAILED\",\r\n                        description: `Outreach failed after ${newRetryCount} attempts: ${String(err).slice(0, 200)}`,\r\n                        createdAt: new Date(),\r\n                        metadata: { error: String(err).slice(0, 500), retryCount: newRetryCount, taskType: task.type },\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    } catch (error) {\r\n        logger.error(\"Fatal error in queue processor:\", error);\r\n    }\r\n});\r\n\r\nasync function handleGenerate(task: QueueItem) {\r\n    logger.info(`Generating content for task ${task.id}`);\r\n\r\n    // Fetch fresh vendor data\r\n    const vendorDoc = await db.collection(\"vendors\").doc(task.vendorId!).get();\r\n    const vendor = vendorDoc.exists ? vendorDoc.data() : task.metadata;\r\n\r\n    const sequence = task.metadata?.sequence || 1;\r\n    const templateId = `vendor_outreach_${sequence}`;\r\n\r\n    // Fetch the email template from Firestore\r\n    const templateDoc = await db.collection(\"templates\").doc(templateId).get();\r\n    if (!templateDoc.exists) {\r\n        throw new Error(`Email template ${templateId} not found in Firestore. Run seed-email-templates.js to create them.`);\r\n    }\r\n\r\n    const template = templateDoc.data()!;\r\n    const onboardingUrl = `https://xiri.ai/contractor?vid=${task.vendorId}`;\r\n\r\n    // Build merge variables from vendor data\r\n    const services = Array.isArray(vendor?.capabilities) && vendor.capabilities.length > 0\r\n        ? vendor.capabilities.join(', ')\r\n        : vendor?.specialty || 'Facility Services';\r\n    const contactName = vendor?.contactName || vendor?.businessName || 'there';\r\n\r\n    const mergeVars: Record<string, string> = {\r\n        vendorName: vendor?.companyName || vendor?.businessName || 'your company',\r\n        contactName,\r\n        city: vendor?.city || 'your area',\r\n        state: vendor?.state || '',\r\n        services,\r\n        specialty: vendor?.specialty || vendor?.capabilities?.[0] || 'Services',\r\n        onboardingUrl,\r\n    };\r\n\r\n    // Merge template fields\r\n    let subject = template.subject || '';\r\n    let body = template.body || '';\r\n    for (const [key, value] of Object.entries(mergeVars)) {\r\n        const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\r\n        subject = subject.replace(regex, value);\r\n        body = body.replace(regex, value);\r\n    }\r\n    // Legacy placeholder\r\n    body = body.replace(/\\[ONBOARDING_LINK\\]/g, onboardingUrl);\r\n\r\n    const emailResult = { subject, body };\r\n\r\n    // 1. Log the draft (Visible in Activity Feed)\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: \"OUTREACH_QUEUED\",\r\n        description: `Outreach email draft generated from template (sequence ${sequence}).`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            email: emailResult,\r\n            preferredChannel: 'EMAIL',\r\n            templateId,\r\n            sequence,\r\n        }\r\n    });\r\n\r\n    // 2. Schedule SEND immediately (next queue cycle ~1 min)\r\n    const scheduledTime = new Date();\r\n\r\n    // 3. Enqueue SEND Task\r\n    await enqueueTask(db, {\r\n        vendorId: task.vendorId,\r\n        type: 'SEND',\r\n        scheduledAt: admin.firestore.Timestamp.fromDate(scheduledTime),\r\n        metadata: {\r\n            email: emailResult,\r\n            channel: 'EMAIL',\r\n            sequence,\r\n            templateId,\r\n        }\r\n    });\r\n\r\n    // 4. Mark GENERATE task complete\r\n    await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n    logger.info(`Task ${task.id} completed (template: ${templateId}). Send scheduled.`);\r\n}\r\n\r\nasync function handleSend(task: QueueItem) {\r\n    logger.info(`Executing SEND for task ${task.id}`);\r\n\r\n    const vendorDoc = await db.collection(\"vendors\").doc(task.vendorId!).get();\r\n    const vendor = vendorDoc.exists ? vendorDoc.data() : null;\r\n    const vendorEmail = vendor?.email || task.metadata?.email?.to;\r\n\r\n    let sendSuccess = false;\r\n    let resendId: string | undefined;\r\n    let htmlBody = '';\r\n\r\n    if (vendorEmail) {\r\n        // ─── Always send via Email until Twilio SMS is integrated ───\r\n        const emailData = task.metadata.email;\r\n        htmlBody = `<div style=\"font-family: sans-serif; line-height: 1.6;\">${(emailData?.body || '').replace(/\\n/g, '<br/>')}</div>`;\r\n\r\n        const result = await sendEmail(\r\n            vendorEmail,\r\n            emailData?.subject || 'Xiri Facility Solutions — Partnership Opportunity',\r\n            htmlBody,\r\n            undefined,   // no attachments\r\n            undefined,   // default from\r\n            task.vendorId ?? undefined,  // tag email with vendorId for webhook tracking\r\n            task.metadata.templateId ?? undefined  // tag with templateId for stats tracking\r\n        );\r\n        sendSuccess = result.success;\r\n        resendId = result.resendId;\r\n\r\n        if (!sendSuccess) {\r\n            logger.error(`Failed to send email to ${vendorEmail} for task ${task.id}`);\r\n            throw new Error(`Resend email failed for vendor ${task.vendorId}`);\r\n        }\r\n    } else {\r\n        logger.warn(`No email for task ${task.id}. Channel: ${task.metadata.channel}`);\r\n        sendSuccess = false;\r\n    }\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: sendSuccess ? \"OUTREACH_SENT\" : \"OUTREACH_FAILED\",\r\n        description: sendSuccess\r\n            ? `Automated ${task.metadata.channel} sent to ${vendorEmail || 'vendor'}.`\r\n            : `Failed to send ${task.metadata.channel} to vendor.`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            channel: task.metadata.channel,\r\n            to: vendorEmail || 'unknown',\r\n            from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            replyTo: 'chris@xiri.ai',\r\n            // Full email fields for activity feed preview\r\n            subject: task.metadata.channel === 'SMS' ? null : task.metadata.email?.subject,\r\n            body: task.metadata.channel === 'SMS' ? task.metadata.sms : task.metadata.email?.body,\r\n            html: task.metadata.channel === 'SMS' ? null : htmlBody,\r\n            templateId: task.metadata.templateId || null,\r\n            resendId: resendId || null,\r\n        }\r\n    });\r\n\r\n    await updateTaskStatus(db, task.id!, sendSuccess ? 'COMPLETED' : 'FAILED');\r\n\r\n    // Update Vendor Record\r\n    if (sendSuccess) {\r\n        await db.collection(\"vendors\").doc(task.vendorId!).update({\r\n            status: 'awaiting_onboarding',\r\n            outreachStatus: 'SENT',\r\n            outreachChannel: task.metadata.channel,\r\n            outreachSentAt: new Date(),\r\n            statusUpdatedAt: new Date()\r\n        });\r\n\r\n        // Increment template stats.sent\r\n        if (task.metadata.templateId) {\r\n            try {\r\n                await db.collection('templates').doc(task.metadata.templateId).update({\r\n                    'stats.sent': admin.firestore.FieldValue.increment(1),\r\n                    'stats.lastUpdated': new Date(),\r\n                });\r\n                logger.info(`Template ${task.metadata.templateId}: stats.sent incremented`);\r\n            } catch (statsErr) {\r\n                logger.warn('Template stats.sent update failed:', statsErr);\r\n            }\r\n        }\r\n\r\n        // Log status transition\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: task.vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: `Pipeline advanced: qualified → awaiting_onboarding (outreach ${task.metadata.channel} delivered)`,\r\n            createdAt: new Date(),\r\n            metadata: { from: 'qualified', to: 'awaiting_onboarding', trigger: 'outreach_sent' }\r\n        });\r\n    } else {\r\n        await db.collection(\"vendors\").doc(task.vendorId!).update({\r\n            outreachStatus: 'PENDING',\r\n            outreachChannel: task.metadata.channel,\r\n            outreachTime: new Date()\r\n        });\r\n    }\r\n}\r\n\r\nasync function handleFollowUp(task: QueueItem) {\r\n    logger.info(`Processing FOLLOW_UP task ${task.id} (sequence ${task.metadata?.sequence})`);\r\n\r\n    const vendorDoc = await db.collection(\"vendors\").doc(task.vendorId!).get();\r\n    const vendor = vendorDoc.exists ? vendorDoc.data() : null;\r\n\r\n    if (!vendor) {\r\n        logger.warn(`Vendor ${task.vendorId} not found, marking task completed.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    // Skip if vendor has already progressed past awaiting_onboarding\r\n    if (vendor.status !== 'awaiting_onboarding') {\r\n        logger.info(`Vendor ${task.vendorId} is now '${vendor.status}', skipping follow-up.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const vendorEmail = vendor.email || task.metadata?.email;\r\n    if (!vendorEmail) {\r\n        logger.warn(`No email for vendor ${task.vendorId}, skipping follow-up.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    // ─── Engagement-Based Routing ───────────────────────────────────\r\n    const engagement = vendor.emailEngagement?.lastEvent;\r\n    const sequence = task.metadata?.sequence || 1;\r\n    let variantSuffix = '';  // standard (no suffix)\r\n    let variantId = 'standard';\r\n\r\n    if (engagement === 'bounced') {\r\n        // Email bounced — don't send, flag for manual outreach\r\n        logger.info(`Vendor ${task.vendorId} email bounced, flagging for manual outreach.`);\r\n        await db.collection(\"vendors\").doc(task.vendorId!).update({\r\n            outreachStatus: 'NEEDS_MANUAL',\r\n            statusUpdatedAt: new Date(),\r\n        });\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: task.vendorId,\r\n            type: \"NEEDS_MANUAL_OUTREACH\",\r\n            description: `Follow-up #${sequence} skipped — previous email bounced. Manual outreach needed.`,\r\n            createdAt: new Date(),\r\n            metadata: { sequence, reason: 'bounce' },\r\n        });\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    } else if (engagement === 'opened' || engagement === 'clicked') {\r\n        variantSuffix = '_warm';\r\n        variantId = 'warm';\r\n    } else if (engagement === 'delivered') {\r\n        variantSuffix = '_cold';\r\n        variantId = 'cold';\r\n    }\r\n\r\n    // Try engagement variant first, fall back to standard template\r\n    const baseTemplateId = `vendor_outreach_${sequence + 1}`;\r\n    let templateId = `${baseTemplateId}${variantSuffix}`;\r\n    let templateDoc = await db.collection(\"templates\").doc(templateId).get();\r\n\r\n    if (!templateDoc.exists && variantSuffix) {\r\n        // Fall back to standard template if variant doesn't exist yet\r\n        templateId = baseTemplateId;\r\n        variantId = 'standard';\r\n        templateDoc = await db.collection(\"templates\").doc(templateId).get();\r\n    }\r\n    if (!templateDoc.exists) {\r\n        // No more templates in the sequence — we're done\r\n        logger.info(`No template ${templateId} found. Follow-up sequence complete for vendor ${task.vendorId}.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const template = templateDoc.data()!;\r\n    const onboardingUrl = `https://xiri.ai/contractor?vid=${task.vendorId}`;\r\n\r\n    // Merge vendor data\r\n    const services = Array.isArray(vendor.capabilities) && vendor.capabilities.length > 0\r\n        ? vendor.capabilities.join(', ')\r\n        : vendor.specialty || 'Facility Services';\r\n    const contactName = vendor.contactName || vendor.businessName || 'there';\r\n\r\n    const mergeVars: Record<string, string> = {\r\n        vendorName: vendor.companyName || vendor.businessName || 'your company',\r\n        contactName,\r\n        city: vendor.city || 'your area',\r\n        state: vendor.state || '',\r\n        services,\r\n        specialty: vendor.specialty || vendor.capabilities?.[0] || 'Services',\r\n        onboardingUrl,\r\n    };\r\n\r\n    let subject = template.subject || '';\r\n    let body = template.body || '';\r\n    for (const [key, value] of Object.entries(mergeVars)) {\r\n        const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\r\n        subject = subject.replace(regex, value);\r\n        body = body.replace(regex, value);\r\n    }\r\n    body = body.replace(/\\[ONBOARDING_LINK\\]/g, onboardingUrl);\r\n\r\n    const htmlBody = `<div style=\"font-family: sans-serif; line-height: 1.6;\">${body.replace(/\\n/g, '<br/>')}</div>`;\r\n\r\n    const { success: sendSuccess, resendId } = await sendEmail(\r\n        vendorEmail, subject, htmlBody,\r\n        undefined, undefined, task.vendorId ?? undefined, templateId\r\n    );\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: sendSuccess ? \"FOLLOW_UP_SENT\" : \"OUTREACH_FAILED\",\r\n        description: sendSuccess\r\n            ? `Follow-up #${sequence} sent to ${vendorEmail}`\r\n            : `Failed to send follow-up #${sequence} to ${vendorEmail}`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            sequence,\r\n            channel: 'EMAIL',\r\n            to: vendorEmail,\r\n            from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            subject,\r\n            body,\r\n            html: htmlBody,\r\n            templateId,\r\n            variantId,\r\n            resendId: resendId || null,\r\n        }\r\n    });\r\n\r\n    if (sendSuccess) {\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        logger.info(`Follow-up #${sequence} sent to ${vendorEmail} (template: ${templateId})`);\r\n\r\n        // Increment template stats.sent\r\n        try {\r\n            await db.collection('templates').doc(templateId).update({\r\n                'stats.sent': admin.firestore.FieldValue.increment(1),\r\n                'stats.lastUpdated': new Date(),\r\n            });\r\n            logger.info(`Template ${templateId}: stats.sent incremented`);\r\n        } catch (statsErr) {\r\n            logger.warn('Template stats.sent update failed:', statsErr);\r\n        }\r\n    } else {\r\n        throw new Error(`Failed to send follow-up #${sequence} to ${vendorEmail}`);\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n// ═══════════════════════════════════════════════════════════\r\n// ── SALES LEAD OUTREACH HANDLERS ──\r\n// ═══════════════════════════════════════════════════════════\r\n\r\nasync function handleLeadGenerate(task: QueueItem) {\r\n    logger.info(`[SalesOutreach] Generating intro email for lead ${task.leadId}`);\r\n\r\n    const leadData = task.metadata;\r\n    const outreachResult = await generateSalesOutreachContent(leadData, 0);\r\n\r\n    if (outreachResult.error) {\r\n        throw new Error(\"AI Generation Failed for sales outreach\");\r\n    }\r\n\r\n    // Log draft\r\n    await db.collection(\"lead_activities\").add({\r\n        leadId: task.leadId,\r\n        type: \"OUTREACH_QUEUED\",\r\n        description: `Sales outreach email generated for ${leadData.businessName || 'lead'}.`,\r\n        createdAt: new Date(),\r\n        metadata: { email: outreachResult.email },\r\n    });\r\n\r\n    // Enqueue SEND immediately\r\n    await enqueueTask(db, {\r\n        leadId: task.leadId,\r\n        type: 'SEND',\r\n        scheduledAt: admin.firestore.Timestamp.fromDate(new Date()),\r\n        metadata: {\r\n            email: outreachResult.email,\r\n            toEmail: leadData.email,\r\n            businessName: leadData.businessName,\r\n        }\r\n    });\r\n\r\n    await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n    logger.info(`[SalesOutreach] Lead ${task.leadId} intro email generated, SEND queued.`);\r\n}\r\n\r\nasync function handleLeadSend(task: QueueItem) {\r\n    logger.info(`[SalesOutreach] Sending email for lead ${task.leadId}`);\r\n\r\n    const toEmail = task.metadata?.toEmail;\r\n    if (!toEmail) {\r\n        logger.warn(`[SalesOutreach] No email for lead ${task.leadId}, skipping.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const emailData = task.metadata.email;\r\n    const htmlBody = `<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1e293b; line-height: 1.7;\">${(emailData?.body || '').replace(/\\n/g, '<br/>')}</div>`;\r\n\r\n    const sendSuccess = await sendEmail(\r\n        toEmail,\r\n        emailData?.subject || 'Xiri Facility Solutions — Simplify Your Facility Management',\r\n        htmlBody\r\n    );\r\n\r\n    await db.collection(\"lead_activities\").add({\r\n        leadId: task.leadId,\r\n        type: sendSuccess ? \"OUTREACH_SENT\" : \"OUTREACH_FAILED\",\r\n        description: sendSuccess\r\n            ? `Sales email sent to ${toEmail}.`\r\n            : `Failed to send sales email to ${toEmail}.`,\r\n        createdAt: new Date(),\r\n        metadata: { to: toEmail, subject: emailData?.subject },\r\n    });\r\n\r\n    await updateTaskStatus(db, task.id!, sendSuccess ? 'COMPLETED' : 'FAILED');\r\n\r\n    if (sendSuccess) {\r\n        await db.collection(\"leads\").doc(task.leadId!).update({\r\n            outreachStatus: 'SENT',\r\n            outreachSentAt: new Date(),\r\n        });\r\n    }\r\n}\r\n\r\nasync function handleLeadFollowUp(task: QueueItem) {\r\n    const sequence = task.metadata?.sequence || 1;\r\n    logger.info(`[SalesOutreach] Processing follow-up #${sequence} for lead ${task.leadId}`);\r\n\r\n    // Check if lead is still qualified (hasn't progressed or been lost)\r\n    const leadDoc = await db.collection(\"leads\").doc(task.leadId!).get();\r\n    const leadData = leadDoc.exists ? leadDoc.data() : null;\r\n\r\n    if (!leadData) {\r\n        logger.warn(`[SalesOutreach] Lead ${task.leadId} not found, skipping.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    // Skip if lead has already replied or been lost\r\n    if (leadData.outreachStatus === 'REPLIED' || leadData.status === 'lost') {\r\n        logger.info(`[SalesOutreach] Lead ${task.leadId} status is '${leadData.outreachStatus || leadData.status}', skipping follow-up.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const toEmail = task.metadata?.email || leadData.email;\r\n    if (!toEmail) {\r\n        logger.warn(`[SalesOutreach] No email for lead ${task.leadId}, skipping.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    // Generate follow-up content via AI\r\n    const outreachResult = await generateSalesOutreachContent({\r\n        ...leadData,\r\n        ...task.metadata,\r\n    }, sequence);\r\n\r\n    if (outreachResult.error) {\r\n        throw new Error(`AI generation failed for sales follow-up #${sequence}`);\r\n    }\r\n\r\n    const emailData = outreachResult.email;\r\n    const htmlBody = buildSalesFollowUpEmail(\r\n        sequence,\r\n        task.metadata?.businessName || leadData.businessName || 'there',\r\n        task.metadata?.contactName || leadData.contactName || '',\r\n        emailData?.body || '',\r\n    );\r\n\r\n    const subject = emailData?.subject || task.metadata?.subject || `Follow-up: ${task.metadata?.businessName || 'Your facility'}`;\r\n    const sendSuccess = await sendEmail(toEmail, subject, htmlBody);\r\n\r\n    if (sendSuccess) {\r\n        await db.collection(\"lead_activities\").add({\r\n            leadId: task.leadId,\r\n            type: \"FOLLOW_UP_SENT\",\r\n            description: `Sales follow-up #${sequence} sent to ${toEmail}`,\r\n            createdAt: new Date(),\r\n            metadata: { sequence, email: toEmail },\r\n        });\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        logger.info(`[SalesOutreach] Follow-up #${sequence} sent to ${toEmail} for lead ${task.leadId}`);\r\n    } else {\r\n        throw new Error(`Failed to send sales follow-up #${sequence} to ${toEmail}`);\r\n    }\r\n}\r\n\r\nfunction buildSalesFollowUpEmail(sequence: number, businessName: string, contactName: string, aiBody: string): string {\r\n    const greeting = contactName ? `Hi ${contactName},` : `Hello,`;\r\n    const signoff = sequence >= 3 ? 'Best regards' : 'Best';\r\n\r\n    return `\r\n    <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1e293b;\">\r\n        <div style=\"background: linear-gradient(135deg, #0c4a6e, #0369a1); padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 20px;\">Xiri Facility Solutions</h1>\r\n            <p style=\"color: #bae6fd; margin: 4px 0 0; font-size: 13px;\">Your Single-Source Facility Partner</p>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p style=\"font-size: 15px;\">${greeting}</p>\r\n            <div style=\"font-size: 15px; line-height: 1.7;\">${aiBody.replace(/\\n/g, '<br/>')}</div>\r\n            <div style=\"text-align: center; margin: 32px 0;\">\r\n                <a href=\"https://xiri.ai/contact?ref=outreach\" style=\"display: inline-block; padding: 14px 32px; background: #0369a1; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 15px;\">\r\n                    Schedule a Free Walkthrough\r\n                </a>\r\n            </div>\r\n            <p style=\"font-size: 14px; color: #64748b;\">Have questions? Simply reply to this email.</p>\r\n            <p style=\"margin-top: 24px; font-size: 14px;\">${signoff},<br/><strong>Xiri Facility Solutions</strong></p>\r\n        </div>\r\n    </div>`;\r\n}\r\n\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Generate a sales outreach email for a business owner or property manager.\r\n * \r\n * Unlike vendor outreach (blue-collar, simple language), this is B2B executive-grade:\r\n * - Professional, consultative tone\r\n * - Focuses on pain points: vendor chaos, multiple invoices, compliance burden\r\n * - Value prop: one point of contact, consolidated invoicing, quality audits\r\n * \r\n * @param lead - The lead data from Firestore\r\n * @param sequence - Which email in the drip (0 = intro, 1-3 = follow-ups)\r\n */\r\nexport const generateSalesOutreachContent = async (lead: any, sequence: number = 0) => {\r\n    try {\r\n        // Fetch the appropriate prompt template\r\n        const templateId = sequence === 0 ? 'sales_outreach_prompt' : 'sales_followup_prompt';\r\n        const templateDoc = await db.collection(\"templates\").doc(templateId).get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(`Template '${templateId}' not found in database`);\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n\r\n        // Build context for the prompt\r\n        const facilityType = lead.facilityType || 'commercial facility';\r\n        const prettyFacilityType = facilityType.replace(/_/g, ' ').replace(/\\b\\w/g, (c: string) => c.toUpperCase());\r\n        const sqft = lead.propertySourcing?.squareFootage;\r\n        const sqftStr = sqft ? `${sqft.toLocaleString()} sq ft` : 'N/A';\r\n\r\n        // Replace template variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{businessName\\}\\}/g, lead.businessName || 'your practice')\r\n            .replace(/\\{\\{contactName\\}\\}/g, lead.contactName || 'there')\r\n            .replace(/\\{\\{facilityType\\}\\}/g, prettyFacilityType)\r\n            .replace(/\\{\\{squareFootage\\}\\}/g, sqftStr)\r\n            .replace(/\\{\\{address\\}\\}/g, lead.address || '')\r\n            .replace(/\\{\\{sequence\\}\\}/g, String(sequence))\r\n            .replace(/\\{\\{tenantName\\}\\}/g, lead.propertySourcing?.tenantName || lead.businessName || '')\r\n            .replace(/\\{\\{ownerName\\}\\}/g, lead.propertySourcing?.ownerName || '');\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n\r\n        // Sanitize code blocks\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n\r\n        const jsonContent = JSON.parse(text);\r\n\r\n        return {\r\n            email: jsonContent.email,\r\n            generatedAt: new Date(),\r\n        };\r\n    } catch (error) {\r\n        console.error(\"[SalesOutreach] Error generating content:\", error);\r\n        return {\r\n            email: {\r\n                subject: \"Error\",\r\n                body: \"Error generating content. Please draft manually.\"\r\n            },\r\n            error: true,\r\n        };\r\n    }\r\n};\r\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { analyzeIncomingMessage } from \"../agents/outreach\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\nexport const onIncomingMessage = onDocumentCreated(\"vendor_activities/{activityId}\", async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const activity = event.data.data();\r\n    const vendorId = activity.vendorId;\r\n\r\n    // Only process INBOUND_REPLY type\r\n    if (activity.type !== 'INBOUND_REPLY') return;\r\n\r\n    logger.info(`Processing inbound message from vendor ${vendorId}`);\r\n\r\n    try {\r\n        // 1. Fetch Vendor Data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            logger.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n        const vendor = vendorDoc.data();\r\n\r\n        // 2. Fetch Previous Context (Last Outreach Sent)\r\n        // Ideally query for the last OUTREACH_SENT activity\r\n        const lastOutreachSnapshot = await db.collection(\"vendor_activities\")\r\n            .where(\"vendorId\", \"==\", vendorId)\r\n            .where(\"type\", \"==\", \"OUTREACH_SENT\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(1)\r\n            .get();\r\n\r\n        const previousContext = !lastOutreachSnapshot.empty ?\r\n            lastOutreachSnapshot.docs[0].data().description :\r\n            \"Initial outreach sent.\";\r\n\r\n        // 3. Analyze Message\r\n        const analysis = await analyzeIncomingMessage(vendor, activity.description, previousContext);\r\n\r\n        logger.info(`Analysis result for ${vendorId}: ${JSON.stringify(analysis)}`);\r\n\r\n        // 4. Take Action based on Intent\r\n        let newStatus = vendor?.status;\r\n        let actionDescription = \"\";\r\n\r\n        if (analysis.intent === 'INTERESTED') {\r\n            newStatus = 'NEGOTIATING';\r\n            actionDescription = \"Vendor expressed interest. Status updated to NEGOTIATING.\";\r\n        } else if (analysis.intent === 'NOT_INTERESTED') {\r\n            newStatus = 'REJECTED';\r\n            actionDescription = \"Vendor not interested. Status updated to REJECTED.\";\r\n        } else if (analysis.intent === 'QUESTION') {\r\n            newStatus = 'NEGOTIATING'; // Move to negotiating so we handle the Q\r\n            actionDescription = \"Vendor has a question.\";\r\n        } else {\r\n            actionDescription = \"AI could not determine clear intent.\";\r\n        }\r\n\r\n        // 5. Update Status if changed\r\n        if (newStatus && newStatus !== vendor?.status) {\r\n            await db.collection(\"vendors\").doc(vendorId).update({\r\n                status: newStatus,\r\n                statusUpdatedAt: new Date()\r\n            });\r\n            // Log the status change\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId: vendorId,\r\n                type: 'STATUS_CHANGE',\r\n                description: actionDescription,\r\n                createdAt: new Date(),\r\n                metadata: {\r\n                    oldStatus: vendor?.status,\r\n                    newStatus: newStatus,\r\n                    aiIntent: analysis.intent\r\n                }\r\n            });\r\n        }\r\n\r\n        // 6. Draft/Send Reply (Log as AI_REPLY)\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: vendorId,\r\n            type: 'AI_REPLY',\r\n            description: analysis.reply,\r\n            createdAt: new Date(), // Slightly after the inbound\r\n            metadata: {\r\n                intent: analysis.intent,\r\n                inReplyTo: event.params.activityId\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        logger.error(\"Error processing inbound message:\", error);\r\n    }\r\n});\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\nconst db = admin.firestore();\r\n\r\nexport const generateOutreachContent = async (vendor: any, preferredChannel: 'SMS' | 'EMAIL') => {\r\n    const channel = preferredChannel;\r\n\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"outreach_generation_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Outreach generation prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n\r\n        // Build location string from available data\r\n        const locationParts = [vendor.city, vendor.state].filter(Boolean);\r\n        const location = locationParts.length > 0 ? locationParts.join(', ') : 'your area';\r\n\r\n        // Build services string from capabilities array\r\n        const services = Array.isArray(vendor.capabilities) && vendor.capabilities.length > 0\r\n            ? vendor.capabilities.join(', ')\r\n            : vendor.specialty || 'Facility Services';\r\n\r\n        // Replace template variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName || vendor.businessName || 'your company')\r\n            .replace(/\\{\\{specialty\\}\\}/g, vendor.specialty || vendor.capabilities?.[0] || 'Services')\r\n            .replace(/\\{\\{services\\}\\}/g, services)\r\n            .replace(/\\{\\{contactName\\}\\}/g, vendor.contactName || 'not available')\r\n            .replace(/\\{\\{location\\}\\}/g, location)\r\n            // Legacy variable fallback (in case old prompt is still in Firestore)\r\n            .replace(/\\{\\{campaignContext\\}\\}/g, vendor.hasActiveContract\r\n                ? \"URGENT JOB OPPORTUNITY (We have a contract ready)\"\r\n                : \"Building Supply Network (Partnership Opportunity)\");\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n\r\n        // Sanitize code blocks if present\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n\r\n        const jsonContent = JSON.parse(text);\r\n\r\n        return {\r\n            channel,\r\n            email: jsonContent.email,\r\n            generatedAt: new Date()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating outreach content:\", error);\r\n        return {\r\n            channel,\r\n            email: { subject: \"Error\", body: \"Error generating content. Please draft manually.\" },\r\n            error: true\r\n        };\r\n    }\r\n};\r\n\r\n\r\nexport const analyzeIncomingMessage = async (vendor: any, messageContent: string, previousContext: string) => {\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"message_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Message analysis prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName)\r\n            .replace(/\\{\\{messageContent\\}\\}/g, messageContent)\r\n            .replace(/\\{\\{previousContext\\}\\}/g, previousContext)\r\n            .replace(/\\{\\{vendorId\\}\\}/g, vendor.id);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n        const jsonContent = JSON.parse(text);\r\n        return jsonContent;\r\n    } catch (error) {\r\n        console.error(\"Error analyzing message:\", error);\r\n        return { intent: \"OTHER\", reply: \"Error analyzing message.\" };\r\n    }\r\n};\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { verifyDocument, verifyAcord25 } from \"../agents/documentVerifier\";\r\n\r\nconst db = admin.firestore();\r\n\r\nexport const onDocumentUploaded = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"GEMINI_API_KEY\", \"RESEND_API_KEY\"]\r\n}, async (event) => {\r\n    const before = event.data?.before.data();\r\n    const after = event.data?.after.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!before || !after) return;\r\n\r\n    // ─── ACORD 25 Verification ───\r\n    const acord25Before = before.compliance?.acord25?.status;\r\n    const acord25After = after.compliance?.acord25?.status;\r\n\r\n    if (acord25After === 'PENDING' && acord25Before !== 'PENDING') {\r\n        logger.info(`Processing ACORD 25 for vendor ${vendorId}`);\r\n\r\n        const fileUrl = after.compliance?.acord25?.url;\r\n        if (!fileUrl) {\r\n            logger.error(`No ACORD 25 URL found for vendor ${vendorId}`);\r\n            return;\r\n        }\r\n\r\n        const vendorName = after.businessName || after.companyName || \"Vendor\";\r\n        const attestations = {\r\n            hasGL: after.compliance?.generalLiability?.hasInsurance || false,\r\n            hasWC: after.compliance?.workersComp?.hasInsurance || false,\r\n            hasAuto: after.compliance?.autoInsurance?.hasInsurance || false,\r\n            hasEntity: after.compliance?.hasBusinessEntity || false\r\n        };\r\n\r\n        try {\r\n            const result = await verifyAcord25(fileUrl, vendorName, attestations);\r\n\r\n            // Determine status: VERIFIED, FLAGGED, or REJECTED\r\n            const status = result.valid ? 'VERIFIED' : (result.flags.length > 0 ? 'FLAGGED' : 'REJECTED');\r\n\r\n            // Update the vendor document\r\n            await db.doc(`vendors/${vendorId}`).update({\r\n                'compliance.acord25.status': status,\r\n                'compliance.acord25.verifiedAt': admin.firestore.FieldValue.serverTimestamp(),\r\n                'compliance.acord25.aiAnalysis': {\r\n                    valid: result.valid,\r\n                    reasoning: result.reasoning,\r\n                    extracted: result.extracted\r\n                },\r\n                'compliance.acord25.extractedData': result.extracted,\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp()\r\n            });\r\n\r\n            // Log activity\r\n            await db.collection('vendor_activities').add({\r\n                vendorId,\r\n                type: 'AI_VERIFICATION',\r\n                description: `AI ${status === 'VERIFIED' ? 'Verified' : 'Flagged'} ACORD 25: ${result.reasoning}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                metadata: {\r\n                    docType: 'ACORD_25',\r\n                    status,\r\n                    valid: result.valid,\r\n                    flags: result.flags,\r\n                    extracted: result.extracted\r\n                }\r\n            });\r\n\r\n            logger.info(`ACORD 25 verification complete for ${vendorId}: ${status}`);\r\n\r\n            // If flagged, notify admin\r\n            if (status === 'FLAGGED') {\r\n                await sendFlagNotification(vendorId, vendorName, result.flags, result.reasoning);\r\n            }\r\n\r\n        } catch (error) {\r\n            logger.error(`ACORD 25 verification failed for ${vendorId}:`, error);\r\n\r\n            await db.doc(`vendors/${vendorId}`).update({\r\n                'compliance.acord25.status': 'FLAGGED',\r\n                'compliance.acord25.aiAnalysis': {\r\n                    valid: false,\r\n                    reasoning: `Verification error: ${error}`,\r\n                    extracted: {}\r\n                },\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp()\r\n            });\r\n        }\r\n\r\n        return; // Don't process legacy triggers for ACORD 25 uploads\r\n    }\r\n\r\n    // ─── Legacy: COI Verification ───\r\n    if (after.compliance?.coi?.status === 'PENDING' && before.compliance?.coi?.status !== 'PENDING') {\r\n        logger.info(`Processing COI for ${vendorId}`);\r\n        await runLegacyVerification(vendorId, 'COI', after);\r\n    }\r\n\r\n    // ─── Legacy: W9 Verification ───\r\n    if (after.compliance?.w9?.status === 'PENDING' && before.compliance?.w9?.status !== 'PENDING') {\r\n        logger.info(`Processing W9 for ${vendorId}`);\r\n        await runLegacyVerification(vendorId, 'W9', after);\r\n    }\r\n});\r\n\r\n// ─── Legacy Verification Runner ───\r\nasync function runLegacyVerification(vendorId: string, docType: 'COI' | 'W9', vendorData: any) {\r\n    try {\r\n        const result = await verifyDocument(docType, vendorData.companyName || \"Vendor\", vendorData.specialty || \"General\");\r\n\r\n        const fieldPath = docType === 'COI' ? 'compliance.coi' : 'compliance.w9';\r\n        await db.doc(`vendors/${vendorId}`).update({\r\n            [`${fieldPath}.status`]: result.valid ? 'VERIFIED' : 'REJECTED',\r\n            [`${fieldPath}.aiAnalysis`]: {\r\n                valid: result.valid,\r\n                reasoning: result.reasoning,\r\n                extracted: result.extracted\r\n            },\r\n            [`${fieldPath}.verifiedAt`]: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n\r\n        await db.collection('vendor_activities').add({\r\n            vendorId,\r\n            type: 'AI_VERIFICATION',\r\n            description: `AI ${result.valid ? 'Verified' : 'Rejected'} ${docType}: ${result.reasoning}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                docType,\r\n                valid: result.valid,\r\n                extracted: result.extracted\r\n            }\r\n        });\r\n\r\n        if (result.valid) {\r\n            const { sendTemplatedEmail } = await import('../utils/emailUtils');\r\n            await sendTemplatedEmail(vendorId, 'doc_upload_notification', {\r\n                documentType: docType === 'COI' ? 'Certificate of Insurance' : 'W-9 Form'\r\n            });\r\n        }\r\n\r\n    } catch (error) {\r\n        logger.error(`Verification failed for ${docType}:`, error);\r\n    }\r\n}\r\n\r\n// ─── Flag Notification Email ───\r\nasync function sendFlagNotification(vendorId: string, vendorName: string, flags: string[], reasoning: string) {\r\n    try {\r\n        const { Resend } = await import('resend');\r\n        const resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\n        const flagList = flags.map(f => `<li style=\"color: #b45309;\">${f}</li>`).join('');\r\n        const dashboardLink = `https://app.xiri.ai/supply/crm/${vendorId}`;\r\n\r\n        await resend.emails.send({\r\n            from: 'Xiri Compliance <compliance@xiri.ai>',\r\n            to: 'chris@xiri.ai',\r\n            subject: `⚠️ ACORD 25 Flagged: ${vendorName}`,\r\n            html: `\r\n            <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px;\">\r\n                <h2 style=\"color: #b45309;\">⚠️ ACORD 25 Flagged for Review</h2>\r\n                <p><strong>${vendorName}</strong>'s ACORD 25 has been flagged by AI verification.</p>\r\n                \r\n                <h3 style=\"margin-top: 16px;\">Issues Found:</h3>\r\n                <ul>${flagList}</ul>\r\n                \r\n                <p style=\"margin-top: 16px;\"><strong>AI Summary:</strong> ${reasoning}</p>\r\n                \r\n                <div style=\"margin-top: 24px;\">\r\n                    <a href=\"${dashboardLink}\" style=\"display: inline-block; padding: 12px 24px; background: #b45309; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;\">\r\n                        Review in CRM →\r\n                    </a>\r\n                </div>\r\n                \r\n                <p style=\"margin-top: 32px; font-size: 12px; color: #94a3b8;\">\r\n                    Vendor ID: ${vendorId}\r\n                </p>\r\n            </div>`\r\n        });\r\n\r\n        logger.info(`Flag notification sent for vendor ${vendorId}`);\r\n    } catch (error) {\r\n        logger.error('Failed to send flag notification:', error);\r\n    }\r\n}\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport * as https from \"https\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst db = admin.firestore();\r\n\r\n// ─── Download file from URL as Buffer (native Node.js, no deps) ───\r\nfunction downloadFileAsBuffer(url: string): Promise<Buffer> {\r\n    return new Promise((resolve, reject) => {\r\n        https.get(url, (res) => {\r\n            // Follow redirects\r\n            if (res.statusCode && res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {\r\n                return downloadFileAsBuffer(res.headers.location).then(resolve).catch(reject);\r\n            }\r\n            if (res.statusCode !== 200) {\r\n                return reject(new Error(`Download failed with status ${res.statusCode}`));\r\n            }\r\n            const chunks: Buffer[] = [];\r\n            res.on('data', (chunk: Buffer) => chunks.push(chunk));\r\n            res.on('end', () => resolve(Buffer.concat(chunks)));\r\n            res.on('error', reject);\r\n        }).on('error', reject);\r\n    });\r\n}\r\n\r\n// ─── Legacy Interface ───\r\ninterface VerificationResult {\r\n    valid: boolean;\r\n    reasoning: string;\r\n    extracted: Record<string, any>;\r\n}\r\n\r\n// ─── ACORD 25 Extracted Data ───\r\nexport interface AcordExtracted {\r\n    insuredName?: string;\r\n    glPerOccurrence?: number;\r\n    glAggregate?: number;\r\n    wcActive?: boolean;\r\n    wcPolicyNumber?: string;\r\n    autoActive?: boolean;\r\n    expirationDates?: Array<{ policy: string; expires: string }>;\r\n    certificateHolder?: string;\r\n}\r\n\r\nexport interface Acord25VerificationResult {\r\n    valid: boolean;\r\n    reasoning: string;\r\n    extracted: AcordExtracted;\r\n    flags: string[];  // specific issues found\r\n}\r\n\r\n// ─── Legacy: Simulated Document Verification ───\r\nexport async function verifyDocument(docType: 'COI' | 'W9', vendorName: string, specialty: string): Promise<VerificationResult> {\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n    let simulatedOcrText = \"\";\r\n\r\n    if (docType === 'COI') {\r\n        const today = new Date();\r\n        const nextYear = new Date(today);\r\n        nextYear.setFullYear(today.getFullYear() + 1);\r\n\r\n        simulatedOcrText = `\r\n            CERTIFICATE OF LIABILITY INSURANCE\r\n            PRODUCER: State Farm Insurance\r\n            INSURED: ${vendorName}\r\n            \r\n            COVERAGES:\r\n            COMMERCIAL GENERAL LIABILITY\r\n            EACH OCCURRENCE: $2,000,000\r\n            GENERAL AGGREGATE: $4,000,000\r\n            \r\n            WORKERS COMPENSATION\r\n            STATUTORY LIMITS: YES\r\n            E.L. EACH ACCIDENT: $1,000,000\r\n            \r\n            POLICY EFF: 01/01/2024\r\n            POLICY EXP: ${nextYear.toLocaleDateString()}\r\n        `;\r\n    } else if (docType === 'W9') {\r\n        simulatedOcrText = `\r\n            Form W-9\r\n            Name: ${vendorName}\r\n            Business Name: ${vendorName} LLC\r\n            Federal Tax Classification: Limited Liability Company\r\n            TIN: XX-XXX1234\r\n            Signed: JS\r\n            Date: 01/15/2024\r\n        `;\r\n    }\r\n\r\n    try {\r\n        const templateDoc = await db.collection(\"templates\").doc(\"document_verifier_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Document verifier prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const requirements = docType === 'COI'\r\n            ? 'Must have General Liability > $1,000,000 and valid dates.'\r\n            : 'Must be signed and have a TIN.';\r\n\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{documentType\\}\\}/g, docType)\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendorName)\r\n            .replace(/\\{\\{specialty\\}\\}/g, specialty)\r\n            .replace(/\\{\\{requirements\\}\\}/g, requirements)\r\n            .replace(/\\{\\{ocrText\\}\\}/g, simulatedOcrText);\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n        const responseText = result.response.text();\r\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) throw new Error(\"No JSON found in response\");\r\n\r\n        return JSON.parse(jsonMatch[0]) as VerificationResult;\r\n    } catch (error) {\r\n        console.error(\"AI Verification Failed:\", error);\r\n        return {\r\n            valid: false,\r\n            reasoning: \"AI Verification Failed: \" + error,\r\n            extracted: {}\r\n        };\r\n    }\r\n}\r\n\r\n// ─── NEW: ACORD 25 Real PDF Verification ───\r\nexport async function verifyAcord25(\r\n    fileUrl: string,\r\n    vendorName: string,\r\n    attestations: {\r\n        hasGL: boolean;\r\n        hasWC: boolean;\r\n        hasAuto: boolean;\r\n        hasEntity: boolean;\r\n    }\r\n): Promise<Acord25VerificationResult> {\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n    try {\r\n        // 1. Download the PDF/image from Firebase Storage\r\n        logger.info(`Downloading ACORD 25 from: ${fileUrl}`);\r\n\r\n        const buffer = await downloadFileAsBuffer(fileUrl);\r\n        // Detect content type from URL or default to PDF\r\n        const isPdf = fileUrl.toLowerCase().includes('.pdf');\r\n        const isJpg = fileUrl.toLowerCase().includes('.jpg') || fileUrl.toLowerCase().includes('.jpeg');\r\n        const isPng = fileUrl.toLowerCase().includes('.png');\r\n        const contentType = isPdf ? 'application/pdf' : isJpg ? 'image/jpeg' : isPng ? 'image/png' : 'application/pdf';\r\n        const base64Data = buffer.toString('base64');\r\n\r\n        // 2. Build the structured extraction prompt\r\n        const prompt = `You are an insurance compliance verification agent for Xiri Facility Solutions.\r\n\r\nAnalyze this ACORD 25 Certificate of Liability Insurance and extract the following data in JSON format.\r\n\r\n**The vendor's name on file is: \"${vendorName}\"**\r\n\r\n**The vendor attested to having the following coverage:**\r\n- General Liability: ${attestations.hasGL ? 'YES' : 'NO'}\r\n- Workers' Compensation: ${attestations.hasWC ? 'YES' : 'NO'}\r\n- Auto Insurance: ${attestations.hasAuto ? 'YES' : 'NO'}\r\n- Business Entity (LLC/Corp): ${attestations.hasEntity ? 'YES' : 'NO'}\r\n\r\n**Minimum requirements to PASS:**\r\n- General Liability: ≥ $1,000,000 per occurrence AND ≥ $2,000,000 aggregate\r\n- Workers' Compensation: Must have active policy if attested\r\n- Auto Insurance: Must have active policy if attested\r\n- All policies must NOT be expired (check against today's date: ${new Date().toISOString().split('T')[0]})\r\n- Insured name should reasonably match vendor name on file\r\n\r\n**Cross-reference the vendor's attestations against the actual document.**\r\nIf the vendor attested to having coverage but the document does NOT show it, flag it.\r\nIf limits are below minimums, flag it.\r\nIf any policy is expired, flag it.\r\n\r\nReturn ONLY valid JSON in this exact format:\r\n{\r\n    \"valid\": true/false,\r\n    \"reasoning\": \"Brief explanation of the verification result\",\r\n    \"flags\": [\"list of specific issues found, empty array if none\"],\r\n    \"extracted\": {\r\n        \"insuredName\": \"Name as shown on certificate\",\r\n        \"glPerOccurrence\": 1000000,\r\n        \"glAggregate\": 2000000,\r\n        \"wcActive\": true/false,\r\n        \"wcPolicyNumber\": \"policy number or null\",\r\n        \"autoActive\": true/false,\r\n        \"expirationDates\": [\r\n            { \"policy\": \"General Liability\", \"expires\": \"2025-01-15\" },\r\n            { \"policy\": \"Workers Comp\", \"expires\": \"2025-06-30\" }\r\n        ],\r\n        \"certificateHolder\": \"Name if listed, or null\"\r\n    }\r\n}`;\r\n\r\n        // 3. Send to Gemini with the file as inline data\r\n        const result = await model.generateContent({\r\n            contents: [{\r\n                role: \"user\",\r\n                parts: [\r\n                    {\r\n                        inlineData: {\r\n                            mimeType: contentType,\r\n                            data: base64Data\r\n                        }\r\n                    },\r\n                    { text: prompt }\r\n                ]\r\n            }]\r\n        });\r\n\r\n        const responseText = result.response.text();\r\n        logger.info(`Gemini ACORD 25 response length: ${responseText.length}`);\r\n\r\n        // 4. Parse the structured response\r\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) {\r\n            throw new Error(\"No JSON found in Gemini response\");\r\n        }\r\n\r\n        const parsed = JSON.parse(jsonMatch[0]) as Acord25VerificationResult;\r\n\r\n        // Ensure flags array exists\r\n        if (!parsed.flags) {\r\n            parsed.flags = [];\r\n        }\r\n\r\n        logger.info(`ACORD 25 verification result: valid=${parsed.valid}, flags=${parsed.flags.length}`);\r\n        return parsed;\r\n\r\n    } catch (error) {\r\n        logger.error(\"ACORD 25 verification failed:\", error);\r\n        return {\r\n            valid: false,\r\n            reasoning: `AI verification failed: ${error}`,\r\n            extracted: {},\r\n            flags: [\"AI_PROCESSING_ERROR\"]\r\n        };\r\n    }\r\n}\r\n","import { onDocumentWritten } from \"firebase-functions/v2/firestore\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\nimport { addMinutes, format } from \"date-fns\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst db = admin.firestore();\r\nconst TIMEOUT_SECONDS = 300;\r\n\r\nexport const sendBookingConfirmation = onDocumentWritten({\r\n    document: \"leads/{leadId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n    timeoutSeconds: TIMEOUT_SECONDS\r\n}, async (event) => {\r\n    // 1. Validate Event\r\n    if (!event.data) return; // Deletion\r\n\r\n    const before = event.data.before.data();\r\n    const after = event.data.after.data();\r\n\r\n    // 2. Check Triggers\r\n    // - Status changed to 'new' (Completed Wizard)\r\n    // - OR Times changed on an existing 'new' lead (Rescheduling)\r\n    const statusChangedToNew = (before?.status !== 'new' && after?.status === 'new');\r\n    const timesChanged = (JSON.stringify(before?.preferredAuditTimes) !== JSON.stringify(after?.preferredAuditTimes));\r\n\r\n    // Only proceed if status is 'new' AND (it just became new OR times changed)\r\n    const shouldSend = after?.status === 'new' && (statusChangedToNew || timesChanged);\r\n\r\n    if (!shouldSend) return;\r\n\r\n    // 3. Validate Data for Email\r\n    const { email, contactName, preferredAuditTimes, meetingType, meetingDuration, businessName } = after;\r\n\r\n    if (!email || !preferredAuditTimes || preferredAuditTimes.length === 0) {\r\n        console.log(\"Missing email or times for lead\", event.params.leadId);\r\n        return;\r\n    }\r\n\r\n    // 4. Prepare Meeting Details\r\n    const startTimeStr = preferredAuditTimes[0]; // ISO String\r\n    const startTime = new Date(startTimeStr);\r\n    const duration = meetingDuration || 60; // Default 60 mins\r\n    const endTime = addMinutes(startTime, duration);\r\n    const type = meetingType === 'intro' ? 'Intro Call' : 'Internal Audit';\r\n\r\n    // 5. Generate ICS File\r\n    const icsContent = generateICS({\r\n        start: startTime,\r\n        end: endTime,\r\n        summary: `Xiri ${type}: ${businessName || 'Facility Audit'}`,\r\n        description: `Meeting with ${contactName || 'Client'}.\\n\\nType: ${type}\\nDuration: ${duration} mins\\n\\nPower to the Facilities!`,\r\n        location: type === 'intro' ? 'Phone Call' : (after.address || after.zipCode || 'On Site'),\r\n        organizer: { name: \"Xiri Facility Solutions\", email: \"onboarding@xiri.ai\" }\r\n    });\r\n\r\n    // 6. Send Email\r\n    const subject = `Confirmed: Your Xini ${type}`;\r\n    const htmlBody = `\r\n        <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\r\n            <h1 style=\"color: #0ea5e9;\">You're booked!</h1>\r\n            <p>Hi ${contactName || 'there'},</p>\r\n            <p>We've confirmed your <strong>${type}</strong> for:</p>\r\n            <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n                <p style=\"margin: 0; font-size: 18px; font-weight: bold;\">\r\n                    ${format(startTime, \"EEEE, MMMM do 'at' h:mm a\")}\r\n                </p>\r\n                <p style=\"margin: 5px 0 0; color: #6b7280;\">Duration: ${duration} mins</p>\r\n            </div>\r\n            <p>A calendar invitation has been attached to this email.</p>\r\n            <p>Best,<br/>The Xiri Team</p>\r\n        </div>\r\n    `;\r\n\r\n    const sendSuccess = await sendEmail(email, subject, htmlBody, [\r\n        {\r\n            filename: 'invite.ics',\r\n            content: icsContent,\r\n        },\r\n    ]);\r\n\r\n    // Log to activity_logs for audit trail\r\n    await db.collection(\"activity_logs\").add({\r\n        entityType: 'lead',\r\n        entityId: event.params.leadId,\r\n        type: sendSuccess ? 'EMAIL_SENT' : 'EMAIL_FAILED',\r\n        description: `Booking confirmation ${sendSuccess ? 'sent' : 'failed'}: ${subject}`,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        metadata: {\r\n            to: email,\r\n            subject,\r\n            meetingType: type,\r\n            meetingTime: startTimeStr,\r\n            channel: 'EMAIL'\r\n        }\r\n    });\r\n});\r\n\r\n// Helper: Generate ICS String\r\nfunction generateICS(event: {\r\n    start: Date;\r\n    end: Date;\r\n    summary: string;\r\n    description: string;\r\n    location: string;\r\n    organizer: { name: string; email: string };\r\n}) {\r\n    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\r\n\r\n    return `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Xiri//Facility Solutions//EN\r\nCALSCALE:GREGORIAN\r\nMETHOD:REQUEST\r\nBEGIN:VEVENT\r\nUID:${Date.now()}@xiri.ai\r\nDTSTAMP:${formatDate(new Date())}\r\nDTSTART:${formatDate(event.start)}\r\nDTEND:${formatDate(event.end)}\r\nSUMMARY:${event.summary}\r\nDESCRIPTION:${event.description.replace(/\\n/g, '\\\\n')}\r\nLOCATION:${event.location}\r\nORGANIZER;CN=${event.organizer.name}:mailto:${event.organizer.email}\r\nSTATUS:CONFIRMED\r\nsequence:0\r\nEND:VEVENT\r\nEND:VCALENDAR`;\r\n}\r\n","import { onCall, HttpsError } from 'firebase-functions/v2/https';\r\nimport { getFirestore, FieldValue } from 'firebase-admin/firestore';\r\nimport { scrapeWebsite } from '../utils/websiteScraper';\r\nimport { verifyEmail, isDisposableEmail, isRoleBasedEmail } from '../utils/emailVerification';\r\nimport { validatePhone, isBusinessPhone } from '../utils/phoneValidation';\r\nimport { defineSecret } from 'firebase-functions/params';\r\n\r\nconst GEMINI_API_KEY = defineSecret('GEMINI_API_KEY');\r\n\r\ninterface EnrichRequest {\r\n    collection: 'leads' | 'vendors';\r\n    documentId: string;\r\n    website: string;\r\n    previewOnly?: boolean;\r\n}\r\n\r\ninterface EnrichResponse {\r\n    success: boolean;\r\n    enrichedFields: string[];\r\n    data?: any;\r\n    error?: string;\r\n}\r\n\r\nexport const enrichFromWebsite = onCall<EnrichRequest, Promise<EnrichResponse>>({\r\n    secrets: [GEMINI_API_KEY],\r\n    timeoutSeconds: 60,\r\n    memory: '512MiB',\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\",\r\n        \"https://xiri-facility-solutions.web.app\",\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n}, async (request) => {\r\n    // 1. Validate request\r\n    if (!request.auth) {\r\n        throw new HttpsError('unauthenticated', 'User must be authenticated');\r\n    }\r\n\r\n    const { collection, documentId, website, previewOnly } = request.data;\r\n\r\n    if (!website) {\r\n        throw new HttpsError('invalid-argument', 'Missing website URL');\r\n    }\r\n\r\n    if (!previewOnly && (!collection || !documentId)) {\r\n        throw new HttpsError('invalid-argument', 'Missing required fields');\r\n    }\r\n\r\n    if (!previewOnly && !['leads', 'vendors'].includes(collection)) {\r\n        throw new HttpsError('invalid-argument', 'Invalid collection');\r\n    }\r\n\r\n    try {\r\n        // 2. Scrape website\r\n        console.log(`Enriching ${collection}/${documentId} from ${website}`);\r\n        const scrapedResult = await scrapeWebsite(website, GEMINI_API_KEY.value());\r\n\r\n        if (!scrapedResult.success) {\r\n            throw new HttpsError('internal', `Scraping failed: ${scrapedResult.error}`);\r\n        }\r\n\r\n        const scrapedData = scrapedResult.data!;\r\n\r\n        // 3. Verify email if found\r\n        let verifiedEmail: string | undefined;\r\n        if (scrapedData.email) {\r\n            const emailVerification = await verifyEmail(scrapedData.email);\r\n\r\n            if (emailVerification.valid &&\r\n                emailVerification.deliverable &&\r\n                !isDisposableEmail(scrapedData.email) &&\r\n                !isRoleBasedEmail(scrapedData.email)) {\r\n                verifiedEmail = scrapedData.email;\r\n            } else {\r\n                console.log(`Email ${scrapedData.email} failed verification:`, emailVerification.reason);\r\n            }\r\n        }\r\n\r\n        // 4. Validate phone if found\r\n        let validatedPhone: string | undefined;\r\n        if (scrapedData.phone) {\r\n            const phoneValidation = validatePhone(scrapedData.phone);\r\n\r\n            if (phoneValidation.valid) {\r\n                validatedPhone = phoneValidation.formatted;\r\n            } else {\r\n                console.log(`Phone ${scrapedData.phone} failed validation:`, phoneValidation.reason);\r\n            }\r\n        }\r\n\r\n        // 4b. If preview only, return scraped data without updating Firestore\r\n        if (previewOnly) {\r\n            return {\r\n                success: true,\r\n                enrichedFields: [\r\n                    ...(verifiedEmail ? ['email'] : []),\r\n                    ...(validatedPhone ? ['phone'] : []),\r\n                    ...(scrapedData.address ? ['address'] : []),\r\n                    ...(scrapedData.businessName ? ['businessName'] : []),\r\n                    ...(scrapedData.socialMedia?.linkedin ? ['linkedin'] : []),\r\n                    ...(scrapedData.socialMedia?.facebook ? ['facebook'] : []),\r\n                    ...(scrapedData.socialMedia?.twitter ? ['twitter'] : []),\r\n                ],\r\n                data: {\r\n                    email: verifiedEmail,\r\n                    phone: validatedPhone,\r\n                    address: scrapedData.address,\r\n                    businessName: scrapedData.businessName,\r\n                    socialMedia: scrapedData.socialMedia,\r\n                    confidence: scrapedData.confidence,\r\n                },\r\n            };\r\n        }\r\n\r\n        // 5. Prepare update data\r\n        const db = getFirestore();\r\n        const docRef = db.collection(collection).doc(documentId);\r\n        const docSnap = await docRef.get();\r\n\r\n        if (!docSnap.exists) {\r\n            throw new HttpsError('not-found', 'Document not found');\r\n        }\r\n\r\n        const existingData = docSnap.data()!;\r\n        const enrichedFields: string[] = [];\r\n        const updateData: any = {\r\n            updatedAt: FieldValue.serverTimestamp(),\r\n        };\r\n\r\n        // Only update fields that are missing or empty\r\n        if (verifiedEmail && !existingData.email) {\r\n            updateData.email = verifiedEmail;\r\n            enrichedFields.push('email');\r\n        }\r\n\r\n        if (validatedPhone && !existingData.phone) {\r\n            updateData.phone = validatedPhone;\r\n            enrichedFields.push('phone');\r\n        }\r\n\r\n        if (scrapedData.address && !existingData.address) {\r\n            updateData.address = scrapedData.address;\r\n            enrichedFields.push('address');\r\n        }\r\n\r\n        if (scrapedData.businessName && !existingData.businessName) {\r\n            updateData.businessName = scrapedData.businessName;\r\n            enrichedFields.push('businessName');\r\n        }\r\n\r\n        // Add social media links if found\r\n        if (scrapedData.socialMedia) {\r\n            const socialMedia: any = {};\r\n            if (scrapedData.socialMedia.linkedin) {\r\n                socialMedia.linkedin = scrapedData.socialMedia.linkedin;\r\n                enrichedFields.push('linkedin');\r\n            }\r\n            if (scrapedData.socialMedia.facebook) {\r\n                socialMedia.facebook = scrapedData.socialMedia.facebook;\r\n                enrichedFields.push('facebook');\r\n            }\r\n            if (scrapedData.socialMedia.twitter) {\r\n                socialMedia.twitter = scrapedData.socialMedia.twitter;\r\n                enrichedFields.push('twitter');\r\n            }\r\n\r\n            if (Object.keys(socialMedia).length > 0) {\r\n                updateData.socialMedia = socialMedia;\r\n            }\r\n        }\r\n\r\n        // Add enrichment metadata\r\n        updateData.enrichment = {\r\n            lastEnriched: FieldValue.serverTimestamp(),\r\n            enrichedFields,\r\n            enrichmentSource: 'manual',\r\n            scrapedWebsite: website,\r\n            confidence: scrapedData.confidence,\r\n        };\r\n\r\n        // 6. Update Firestore\r\n        if (enrichedFields.length > 0) {\r\n            await docRef.update(updateData);\r\n            console.log(`Successfully enriched ${enrichedFields.length} fields for ${collection}/${documentId}`);\r\n        } else {\r\n            console.log(`No new fields to enrich for ${collection}/${documentId}`);\r\n        }\r\n\r\n        // 7. Return result\r\n        return {\r\n            success: true,\r\n            enrichedFields,\r\n            data: {\r\n                email: verifiedEmail,\r\n                phone: validatedPhone,\r\n                address: scrapedData.address,\r\n                businessName: scrapedData.businessName,\r\n                socialMedia: scrapedData.socialMedia,\r\n                confidence: scrapedData.confidence,\r\n            },\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Enrichment error:', error);\r\n\r\n        if (error instanceof HttpsError) {\r\n            throw error;\r\n        }\r\n\r\n        throw new HttpsError('internal', `Enrichment failed: ${error.message}`);\r\n    }\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { Resend } from \"resend\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\n/**\r\n * Sends a notification email to chris@xiri.ai when a vendor\r\n * completes the onboarding form (status → compliance_review).\r\n */\r\nexport const onOnboardingComplete = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'compliance_review'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'compliance_review') return;\r\n\r\n    const vendorId = event.params.vendorId;\r\n    const businessName = after.businessName || 'Unknown Vendor';\r\n    const email = after.email || 'N/A';\r\n    const phone = after.phone || 'N/A';\r\n    const track = after.onboardingTrack || 'STANDARD';\r\n    const lang = after.preferredLanguage || 'en';\r\n\r\n    logger.info(`Vendor ${vendorId} (${businessName}) completed onboarding. Sending notification.`);\r\n\r\n    const resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\n    // Build compliance summary\r\n    const compliance = after.compliance || {};\r\n    const complianceLines = [\r\n        `Business Entity: ${compliance.hasBusinessEntity ? '✅ Yes' : '❌ No'}`,\r\n        `General Liability: ${compliance.generalLiability?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `Workers Comp: ${compliance.workersComp?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `Auto Insurance: ${compliance.autoInsurance?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `W-9 Collected: ${compliance.w9Collected ? '✅ Yes' : '⏳ Pending'}`,\r\n    ].join('<br/>');\r\n\r\n    const dashboardLink = `https://app.xiri.ai/supply/crm/${vendorId}`;\r\n\r\n    const html = `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px;\">\r\n        <h2 style=\"color: #0c4a6e;\">🏗️ Vendor Onboarding Complete</h2>\r\n        <p><strong>${businessName}</strong> has completed the onboarding form and is ready for compliance review.</p>\r\n        \r\n        <table style=\"width: 100%; border-collapse: collapse; margin: 16px 0;\">\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Email</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${email}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Phone</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${phone}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Track</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${track === 'FAST_TRACK' ? '⚡ Express Contract' : '🤝 Partner Network'}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Language</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${lang === 'es' ? '🇪🇸 Spanish' : '🇺🇸 English'}</td></tr>\r\n        </table>\r\n\r\n        <h3 style=\"color: #0c4a6e; margin-top: 24px;\">Compliance Self-Report</h3>\r\n        <div style=\"background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; font-size: 14px;\">\r\n            ${complianceLines}\r\n        </div>\r\n\r\n        <div style=\"margin-top: 24px;\">\r\n            <a href=\"${dashboardLink}\" style=\"display: inline-block; padding: 12px 24px; background: #0369a1; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;\">\r\n                Review in CRM →\r\n            </a>\r\n        </div>\r\n\r\n        <p style=\"margin-top: 32px; font-size: 12px; color: #94a3b8;\">\r\n            Vendor ID: ${vendorId}\r\n        </p>\r\n    </div>`;\r\n\r\n    try {\r\n        const { data, error } = await resend.emails.send({\r\n            from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            to: 'chris@xiri.ai',\r\n            subject: `🏗️ Vendor Onboarded: ${businessName}`,\r\n            html,\r\n        });\r\n\r\n        if (error) {\r\n            logger.error('Failed to send onboarding notification:', error);\r\n        } else {\r\n            logger.info(`Notification sent to chris@xiri.ai (Resend ID: ${data?.id})`);\r\n        }\r\n    } catch (err) {\r\n        logger.error('Error sending onboarding notification:', err);\r\n    }\r\n\r\n    // ─── Vendor Confirmation Email ───\r\n    if (email && email !== 'N/A') {\r\n        const isSpanish = lang === 'es';\r\n\r\n        const vendorHtml = isSpanish ? `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px; color: #1e293b;\">\r\n        <div style=\"background: #0c4a6e; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 22px;\">¡Recibimos su solicitud!</h1>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p>Hola <strong>${businessName}</strong>,</p>\r\n            <p>Gracias por completar su solicitud para unirse a la Red de Contratistas de Xiri. Hemos recibido su información y nuestro equipo la revisará en breve.</p>\r\n\r\n            <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin: 20px 0;\">\r\n                <h3 style=\"margin: 0 0 12px 0; color: #0c4a6e; font-size: 15px;\">Lo que recibimos:</h3>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📧 Email: ${email}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📞 Teléfono: ${phone}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📋 Modalidad: ${track === 'FAST_TRACK' ? '⚡ Contrato Express' : '🤝 Red de Socios'}</p>\r\n            </div>\r\n\r\n            <h3 style=\"color: #0c4a6e; font-size: 15px;\">Próximos Pasos:</h3>\r\n            <ol style=\"font-size: 14px; padding-left: 20px;\">\r\n                <li>Nuestro equipo revisará sus documentos e información</li>\r\n                <li>Recibirá una confirmación cuando su cuenta esté verificada</li>\r\n                <li>Una vez aprobado, comenzará a recibir oportunidades de trabajo</li>\r\n            </ol>\r\n\r\n            <p style=\"font-size: 14px; color: #64748b;\">Si tiene alguna pregunta, simplemente responda a este correo.</p>\r\n\r\n            <p style=\"margin-top: 24px;\">Saludos cordiales,<br/><strong>Equipo Xiri Facility Solutions</strong></p>\r\n        </div>\r\n    </div>` : `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px; color: #1e293b;\">\r\n        <div style=\"background: #0c4a6e; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 22px;\">We've received your application!</h1>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p>Hi <strong>${businessName}</strong>,</p>\r\n            <p>Thank you for completing your application to join the Xiri Contractor Network. We've received your information and our team will review it shortly.</p>\r\n\r\n            <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin: 20px 0;\">\r\n                <h3 style=\"margin: 0 0 12px 0; color: #0c4a6e; font-size: 15px;\">What we received:</h3>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📧 Email: ${email}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📞 Phone: ${phone}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📋 Track: ${track === 'FAST_TRACK' ? '⚡ Express Contract' : '🤝 Partner Network'}</p>\r\n            </div>\r\n\r\n            <h3 style=\"color: #0c4a6e; font-size: 15px;\">What happens next:</h3>\r\n            <ol style=\"font-size: 14px; padding-left: 20px;\">\r\n                <li>Our team will review your documents and information</li>\r\n                <li>You'll receive a confirmation once your account is verified</li>\r\n                <li>Once approved, you'll start receiving work opportunities</li>\r\n            </ol>\r\n\r\n            <p style=\"font-size: 14px; color: #64748b;\">If you have any questions, just reply to this email.</p>\r\n\r\n            <p style=\"margin-top: 24px;\">Best regards,<br/><strong>Xiri Facility Solutions Team</strong></p>\r\n        </div>\r\n    </div>`;\r\n\r\n        const vendorSubject = isSpanish\r\n            ? `✅ Solicitud recibida — ${businessName}`\r\n            : `✅ Application received — ${businessName}`;\r\n\r\n        try {\r\n            const { error: vendorError } = await resend.emails.send({\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                replyTo: 'chris@xiri.ai',\r\n                to: email,\r\n                subject: vendorSubject,\r\n                html: vendorHtml,\r\n            });\r\n\r\n            if (vendorError) {\r\n                logger.error('Failed to send vendor confirmation:', vendorError);\r\n            } else {\r\n                logger.info(`Vendor confirmation sent to ${email}`);\r\n            }\r\n        } catch (err) {\r\n            logger.error('Error sending vendor confirmation:', err);\r\n        }\r\n    }\r\n\r\n    // ─── Compliance Score Calculation ───\r\n    const db = admin.firestore();\r\n    const hasEntity = !!compliance.hasBusinessEntity;\r\n    const hasGL = !!compliance.generalLiability?.hasInsurance;\r\n    const hasWC = !!compliance.workersComp?.hasInsurance;\r\n    const hasAuto = !!compliance.autoInsurance?.hasInsurance;\r\n    const hasW9 = !!compliance.w9Collected;\r\n\r\n    // Attestation: up to 50 points (10 per item)\r\n    const attestationItems = [hasEntity, hasGL, hasWC, hasAuto, hasW9];\r\n    const attestationScore = attestationItems.filter(Boolean).length * 10;\r\n\r\n    // Doc uploads: up to 30 points\r\n    const uploads = compliance.uploadedDocs || {};\r\n    const hasAcord25 = !!compliance.acord25?.url;\r\n    const legacyDocsCount = [uploads.coi, uploads.llc, uploads.w9].filter(Boolean).length;\r\n    // ACORD 25 = 30 points (replaces 3 individual docs), legacy = 10 per doc\r\n    const docsUploadedScore = hasAcord25 ? 30 : Math.min(legacyDocsCount * 10, 30);\r\n\r\n    // AI verification: up to 20 points\r\n    const acord25Verified = compliance.acord25?.status === 'VERIFIED';\r\n    const docsVerifiedScore = acord25Verified ? 20 : 0;\r\n\r\n    const totalScore = attestationScore + docsUploadedScore + docsVerifiedScore;\r\n\r\n    const complianceUpdate: Record<string, any> = {\r\n        complianceScore: totalScore,\r\n        complianceBreakdown: {\r\n            attestation: attestationScore,\r\n            docsUploaded: docsUploadedScore,\r\n            docsVerified: docsVerifiedScore,\r\n        },\r\n        statusUpdatedAt: new Date(),\r\n    };\r\n\r\n    // Auto-advance: skip pending_verification, go straight to onboarding call\r\n    // Doc verification happens later in the \"ready\" stage\r\n    if (totalScore >= 80) {\r\n        complianceUpdate.status = 'onboarding_scheduled';\r\n    }\r\n\r\n    await db.collection(\"vendors\").doc(vendorId).update(complianceUpdate);\r\n\r\n    logger.info(`Vendor ${vendorId} compliance score: ${totalScore}/100 (attest=${attestationScore}, docs=${docsUploadedScore}, verified=${docsVerifiedScore})`);\r\n\r\n    // Log activity\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"ONBOARDING_COMPLETE\",\r\n        description: `${businessName} completed onboarding form (${track}). Compliance score: ${totalScore}/100.`,\r\n        createdAt: new Date(),\r\n        metadata: { track, email, phone, lang, complianceScore: totalScore }\r\n    });\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { enqueueTask } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Drip Campaign Scheduler\r\n * \r\n * When a vendor's status changes to 'awaiting_onboarding',\r\n * schedule follow-up emails at Day 3, Day 7, and Day 14.\r\n * \r\n * Each follow-up reminds them to complete the onboarding form.\r\n * After Day 14 with no response, the vendor is auto-dismissed at Day 21.\r\n */\r\nexport const onAwaitingOnboarding = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'awaiting_onboarding'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'awaiting_onboarding') return;\r\n\r\n    const vendorId = event.params.vendorId;\r\n    const businessName = after.businessName || 'Unknown';\r\n\r\n    logger.info(`Scheduling drip campaign for vendor ${vendorId} (${businessName})`);\r\n\r\n    const now = new Date();\r\n\r\n    // Schedule follow-ups: Day 3, 7, 14, 21\r\n    const followUps = [\r\n        { dayOffset: 3, sequence: 1, subject: 'Quick reminder — complete your XIRI profile' },\r\n        { dayOffset: 7, sequence: 2, subject: 'Just checking in — your XIRI application' },\r\n        { dayOffset: 14, sequence: 3, subject: 'Final follow-up — don\\'t miss out on work opportunities' },\r\n        { dayOffset: 21, sequence: 4, subject: 'Last chance — XIRI partnership closing soon' },\r\n    ];\r\n\r\n    for (const fu of followUps) {\r\n        const scheduledDate = new Date(now);\r\n        scheduledDate.setDate(scheduledDate.getDate() + fu.dayOffset);\r\n        // Schedule at 10am ET\r\n        scheduledDate.setHours(15, 0, 0, 0); // 15:00 UTC = 10:00 ET\r\n\r\n        await enqueueTask(db, {\r\n            vendorId,\r\n            type: 'FOLLOW_UP',\r\n            scheduledAt: admin.firestore.Timestamp.fromDate(scheduledDate),\r\n            metadata: {\r\n                sequence: fu.sequence,\r\n                subject: fu.subject,\r\n                businessName,\r\n                email: after.email,\r\n                preferredLanguage: after.preferredLanguage || 'en',\r\n            }\r\n        });\r\n    }\r\n\r\n    // Log each follow-up as a separate activity for timeline visibility\r\n    for (const fu of followUps) {\r\n        const scheduledDate = new Date(now);\r\n        scheduledDate.setDate(scheduledDate.getDate() + fu.dayOffset);\r\n        scheduledDate.setHours(15, 0, 0, 0);\r\n\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"DRIP_SCHEDULED\",\r\n            description: `Follow-up #${fu.sequence} scheduled: \"${fu.subject}\"`,\r\n            createdAt: new Date(),\r\n            scheduledFor: scheduledDate,\r\n            metadata: { sequence: fu.sequence, dayOffset: fu.dayOffset, subject: fu.subject }\r\n        });\r\n    }\r\n\r\n    logger.info(`Drip campaign scheduled for ${vendorId}: 4 follow-ups at days 3, 7, 14, 21`);\r\n});\r\n","import { onRequest } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { cancelVendorTasks } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Unsubscribe Handler\r\n * \r\n * HTTP endpoint that handles vendor unsubscribe requests.\r\n * Called when a vendor clicks the unsubscribe link in their email.\r\n * \r\n * GET /handleUnsubscribe?vendorId=xxx&token=yyy\r\n * \r\n * - Sets vendor status to 'dismissed'\r\n * - Cancels all pending drip/outreach tasks\r\n * - Shows a confirmation page\r\n */\r\nexport const handleUnsubscribe = onRequest({\r\n    cors: true,\r\n}, async (req, res) => {\r\n    const vendorId = req.query.vendorId as string;\r\n\r\n    if (!vendorId) {\r\n        res.status(400).send(renderPage(\r\n            'Invalid Request',\r\n            'Missing vendor identifier. If you clicked a link from an email, please try again.',\r\n            false\r\n        ));\r\n        return;\r\n    }\r\n\r\n    try {\r\n        // Verify vendor exists\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            res.status(404).send(renderPage(\r\n                'Not Found',\r\n                'We couldn\\'t find your record. You may have already been unsubscribed.',\r\n                false\r\n            ));\r\n            return;\r\n        }\r\n\r\n        const vendor = vendorDoc.data()!;\r\n        const businessName = vendor.businessName || 'Vendor';\r\n\r\n        // Already dismissed?\r\n        if (vendor.status === 'dismissed') {\r\n            res.status(200).send(renderPage(\r\n                'Already Unsubscribed',\r\n                `${businessName} has already been removed from our outreach list. You won't receive any more emails.`,\r\n                true\r\n            ));\r\n            return;\r\n        }\r\n\r\n        // Update vendor status to dismissed\r\n        await db.collection(\"vendors\").doc(vendorId).update({\r\n            status: 'dismissed',\r\n            statusUpdatedAt: new Date(),\r\n            dismissReason: 'unsubscribed',\r\n            unsubscribedAt: new Date(),\r\n        });\r\n\r\n        // Cancel all pending tasks\r\n        const cancelledCount = await cancelVendorTasks(db, vendorId);\r\n\r\n        // Log activity\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: `${businessName} unsubscribed via email link. ${cancelledCount} pending tasks cancelled.`,\r\n            createdAt: new Date(),\r\n            metadata: {\r\n                from: vendor.status,\r\n                to: 'dismissed',\r\n                trigger: 'unsubscribe_link',\r\n                cancelledTasks: cancelledCount,\r\n            }\r\n        });\r\n\r\n        logger.info(`Vendor ${vendorId} (${businessName}) unsubscribed. ${cancelledCount} tasks cancelled.`);\r\n\r\n        res.status(200).send(renderPage(\r\n            'Unsubscribed Successfully',\r\n            `${businessName} has been removed from our outreach list. You won't receive any more emails from Xiri Facility Solutions.<br/><br/>If this was a mistake, please contact us at <a href=\"mailto:chris@xiri.ai\" style=\"color: #0369a1;\">chris@xiri.ai</a>.`,\r\n            true\r\n        ));\r\n\r\n    } catch (err) {\r\n        logger.error(`Error processing unsubscribe for ${vendorId}:`, err);\r\n        res.status(500).send(renderPage(\r\n            'Something Went Wrong',\r\n            'We encountered an error processing your request. Please try again or contact us at <a href=\"mailto:chris@xiri.ai\" style=\"color: #0369a1;\">chris@xiri.ai</a>.',\r\n            false\r\n        ));\r\n    }\r\n});\r\n\r\nfunction renderPage(title: string, message: string, success: boolean): string {\r\n    const icon = success ? '✅' : '⚠️';\r\n    const color = success ? '#059669' : '#dc2626';\r\n\r\n    return `<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>${title} — Xiri Facility Solutions</title>\r\n    <style>\r\n        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8fafc; }\r\n        .card { background: white; border-radius: 16px; padding: 48px; max-width: 480px; text-align: center; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }\r\n        .icon { font-size: 48px; margin-bottom: 16px; }\r\n        h1 { color: ${color}; font-size: 24px; margin: 0 0 16px 0; }\r\n        p { color: #475569; line-height: 1.6; font-size: 15px; margin: 0; }\r\n        .footer { margin-top: 32px; font-size: 12px; color: #94a3b8; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div class=\"card\">\r\n        <div class=\"icon\">${icon}</div>\r\n        <h1>${title}</h1>\r\n        <p>${message}</p>\r\n        <div class=\"footer\">Xiri Facility Solutions</div>\r\n    </div>\r\n</body>\r\n</html>`;\r\n}\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\nimport { addMinutes } from \"date-fns\";\r\nimport { formatInTimeZone } from \"date-fns-tz\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\nconst ADMIN_EMAIL = \"chris@xiri.ai\";\r\nconst EASTERN_TZ = \"America/New_York\";\r\n\r\n/**\r\n * Sends a calendar invite (.ics) to both the vendor and admin\r\n * when a vendor's status changes to 'onboarding_scheduled'\r\n * and they have an onboardingCallTime set.\r\n */\r\nexport const sendOnboardingInvite = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'onboarding_scheduled'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'onboarding_scheduled') return;\r\n\r\n    // Must have a call time and email\r\n    const callTime = after.onboardingCallTime;\r\n    const vendorEmail = after.email;\r\n    const businessName = after.businessName || 'Vendor';\r\n    const contactName = after.contactName || businessName;\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!callTime) {\r\n        logger.warn(`Vendor ${vendorId} moved to onboarding_scheduled but no onboardingCallTime set.`);\r\n        return;\r\n    }\r\n\r\n    if (!vendorEmail) {\r\n        logger.warn(`Vendor ${vendorId} has no email. Skipping invite.`);\r\n        return;\r\n    }\r\n\r\n    logger.info(`Sending onboarding invite for vendor ${vendorId} (${businessName}) at ${callTime}`);\r\n\r\n    const startTime = new Date(callTime);\r\n    const duration = 30; // 30-minute call\r\n    const endTime = addMinutes(startTime, duration);\r\n\r\n    // Generate ICS\r\n    const icsContent = generateICS({\r\n        start: startTime,\r\n        end: endTime,\r\n        summary: `Xiri Onboarding Call: ${businessName}`,\r\n        description: `Onboarding call with ${contactName} from ${businessName}.\\n\\nWe'll cover:\\n- Service capabilities & coverage areas\\n- Insurance & compliance verification\\n- Account setup & next steps\\n\\nPower to the Facilities!`,\r\n        location: 'Phone Call',\r\n        organizer: { name: \"Xiri Facility Solutions\", email: \"onboarding@xiri.ai\" },\r\n        attendees: [\r\n            { name: contactName, email: vendorEmail },\r\n            { name: \"Xiri Team\", email: ADMIN_EMAIL }\r\n        ]\r\n    });\r\n\r\n    // Format in Eastern timezone so the email matches what the user selected\r\n    const formattedTime = formatInTimeZone(startTime, EASTERN_TZ, \"EEEE, MMMM do 'at' h:mm a zzz\");\r\n\r\n    const htmlBody = `\r\n    <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\r\n        <h1 style=\"color: #0ea5e9;\">Onboarding Call Confirmed!</h1>\r\n        <p>Hi ${contactName},</p>\r\n        <p>Your onboarding call with Xiri Facility Solutions has been scheduled:</p>\r\n        <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n            <p style=\"margin: 0; font-size: 18px; font-weight: bold;\">\r\n                ${formattedTime}\r\n            </p>\r\n            <p style=\"margin: 5px 0 0; color: #6b7280;\">Duration: ${duration} minutes • Phone Call</p>\r\n        </div>\r\n        <p><strong>What to expect:</strong></p>\r\n        <ul>\r\n            <li>Quick review of your service capabilities</li>\r\n            <li>Insurance & compliance verification</li>\r\n            <li>Account setup and next steps</li>\r\n        </ul>\r\n        <p>A calendar invitation has been attached to this email.</p>\r\n        <p>Best,<br/>The Xiri Team</p>\r\n    </div>\r\n    `;\r\n\r\n    const subject = `Confirmed: Xiri Onboarding Call — ${formattedTime}`;\r\n\r\n    // Send to vendor\r\n    const vendorSent = await sendEmail(vendorEmail, subject, htmlBody, [\r\n        { filename: 'onboarding-call.ics', content: icsContent }\r\n    ]);\r\n\r\n    // Send to admin\r\n    const adminHtml = `\r\n    <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\r\n        <h1 style=\"color: #0ea5e9;\">New Onboarding Call Booked</h1>\r\n        <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n            <p style=\"margin: 0; font-size: 18px; font-weight: bold;\">${businessName}</p>\r\n            <p style=\"margin: 5px 0 0; color: #6b7280;\">${formattedTime} • ${duration} min</p>\r\n            <p style=\"margin: 5px 0 0; color: #6b7280;\">Contact: ${contactName} (${vendorEmail})</p>\r\n        </div>\r\n        <p><a href=\"https://app.xiri.ai/supply/crm/${vendorId}\" style=\"color: #0ea5e9;\">View in CRM →</a></p>\r\n    </div>\r\n    `;\r\n\r\n    await sendEmail(ADMIN_EMAIL, `Onboarding Call: ${businessName} — ${formattedTime}`, adminHtml, [\r\n        { filename: 'onboarding-call.ics', content: icsContent }\r\n    ]);\r\n\r\n    // Log activity\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"ONBOARDING_CALL_SCHEDULED\",\r\n        description: `Onboarding call scheduled for ${formattedTime}`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            callTime,\r\n            vendorEmail,\r\n            adminEmail: ADMIN_EMAIL,\r\n            emailSent: vendorSent\r\n        }\r\n    });\r\n\r\n    logger.info(`Onboarding invite sent for vendor ${vendorId}. Vendor: ${vendorSent ? '✅' : '❌'}`);\r\n});\r\n\r\n\r\n// Helper: Generate ICS String with attendees\r\nfunction generateICS(event: {\r\n    start: Date;\r\n    end: Date;\r\n    summary: string;\r\n    description: string;\r\n    location: string;\r\n    organizer: { name: string; email: string };\r\n    attendees?: Array<{ name: string; email: string }>;\r\n}) {\r\n    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\r\n\r\n    let attendeeLines = '';\r\n    if (event.attendees) {\r\n        attendeeLines = event.attendees\r\n            .map(a => `ATTENDEE;CN=${a.name};RSVP=TRUE:mailto:${a.email}`)\r\n            .join('\\r\\n');\r\n    }\r\n\r\n    return `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Xiri//Facility Solutions//EN\r\nCALSCALE:GREGORIAN\r\nMETHOD:REQUEST\r\nBEGIN:VEVENT\r\nUID:onboarding-${Date.now()}@xiri.ai\r\nDTSTAMP:${formatDate(new Date())}\r\nDTSTART:${formatDate(event.start)}\r\nDTEND:${formatDate(event.end)}\r\nSUMMARY:${event.summary}\r\nDESCRIPTION:${event.description.replace(/\\n/g, '\\\\n')}\r\nLOCATION:${event.location}\r\nORGANIZER;CN=${event.organizer.name}:mailto:${event.organizer.email}\r\n${attendeeLines}\r\nSTATUS:CONFIRMED\r\nSEQUENCE:0\r\nEND:VEVENT\r\nEND:VCALENDAR`;\r\n}\r\n","import { onCall, HttpsError } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Cloud Function: sendQuoteEmail\r\n * Called from the dashboard when Sales clicks \"Send to Client\"\r\n * \r\n * Generates a reviewToken, updates the quote, and sends a branded email\r\n * with a link to the public review page.\r\n */\r\nexport const sendQuoteEmail = onCall({\r\n    secrets: [\"RESEND_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\",\r\n        \"https://xiri-dashboard-git-develop-xiri-facility-solutions.vercel.app\",\r\n        /https:\\/\\/xiri-dashboard-.*\\.vercel\\.app$/,\r\n        \"https://xiri-facility-solutions.web.app\",\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n}, async (request) => {\r\n    // Validate auth\r\n    if (!request.auth) {\r\n        throw new HttpsError(\"unauthenticated\", \"Must be authenticated\");\r\n    }\r\n\r\n    const { quoteId, clientEmail, clientName } = request.data;\r\n\r\n    if (!quoteId || !clientEmail) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing quoteId or clientEmail\");\r\n    }\r\n\r\n    // Fetch the quote\r\n    const quoteRef = db.collection(\"quotes\").doc(quoteId);\r\n    const quoteSnap = await quoteRef.get();\r\n\r\n    if (!quoteSnap.exists) {\r\n        throw new HttpsError(\"not-found\", \"Quote not found\");\r\n    }\r\n\r\n    const quote = quoteSnap.data()!;\r\n\r\n    // Generate review token\r\n    const reviewToken = uuidv4();\r\n\r\n    // Update quote with token and email info\r\n    await quoteRef.update({\r\n        reviewToken,\r\n        clientEmail,\r\n        status: \"sent\",\r\n        sentAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // Build the review URL\r\n    const reviewUrl = `https://xiri.ai/quote/review/${reviewToken}`;\r\n\r\n    // Build branded HTML email\r\n    const formatCurrency = (n: number) =>\r\n        new Intl.NumberFormat(\"en-US\", { style: \"currency\", currency: \"USD\", minimumFractionDigits: 0 }).format(n);\r\n\r\n    const DAY_NAMES = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\r\n    const formatFrequency = (freq: string, daysOfWeek?: boolean[]) => {\r\n        if (freq === \"custom_days\" && daysOfWeek) {\r\n            const days = daysOfWeek.map((on: boolean, i: number) => on ? DAY_NAMES[i] : null).filter(Boolean);\r\n            const monFri = [false, true, true, true, true, true, false];\r\n            if (JSON.stringify(daysOfWeek) === JSON.stringify(monFri)) return \"Mon–Fri\";\r\n            return days.join(\", \") || \"Custom\";\r\n        }\r\n        const labels: Record<string, string> = { nightly: \"Nightly\", weekly: \"Weekly\", biweekly: \"Bi-Weekly\", monthly: \"Monthly\", quarterly: \"Quarterly\", custom_days: \"Custom\" };\r\n        return labels[freq] || freq;\r\n    };\r\n\r\n    const lineItemCards = (quote.lineItems || []).map((item: any) =>\r\n        `<div style=\"padding: 16px; border-bottom: 1px solid #e5e7eb;\">\r\n            <div style=\"font-weight: 600; color: #111827; margin-bottom: 4px;\">${item.locationName}</div>\r\n            <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n                <div>\r\n                    <span style=\"color: #6b7280; font-size: 14px;\">${item.serviceType}</span>\r\n                    <span style=\"color: #9ca3af; font-size: 13px;\"> · ${formatFrequency(item.frequency, item.daysOfWeek)}</span>\r\n                </div>\r\n                <span style=\"font-weight: 700; color: #0369a1; font-size: 16px; white-space: nowrap;\">${formatCurrency(item.clientRate)}/mo</span>\r\n            </div>\r\n        </div>`\r\n    ).join(\"\");\r\n\r\n    const html = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n        <meta charset=\"utf-8\">\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    </head>\r\n    <body style=\"margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; -webkit-text-size-adjust: 100%;\">\r\n        <div style=\"max-width: 560px; margin: 0 auto; padding: 24px 12px;\">\r\n            <!-- Header -->\r\n            <div style=\"background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%); border-radius: 12px 12px 0 0; padding: 24px;\">\r\n                <div style=\"display: flex; align-items: baseline; justify-content: center; gap: 10px;\">\r\n                    <span style=\"color: white; font-size: 26px; font-weight: 700; letter-spacing: -0.5px;\">XIRI</span>\r\n                    <span style=\"color: rgba(255,255,255,0.8); font-size: 12px; text-transform: uppercase; letter-spacing: 2px;\">FACILITY SOLUTIONS</span>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- Body -->\r\n            <div style=\"background: white; padding: 24px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);\">\r\n                <h2 style=\"color: #111827; margin: 0 0 8px; font-size: 20px;\">Your Service Proposal</h2>\r\n                <p style=\"color: #6b7280; margin: 0 0 20px; font-size: 14px; line-height: 1.5;\">\r\n                    Hi${clientName ? ` ${clientName}` : \"\"},<br/>\r\n                    Thank you for considering XIRI Facility Solutions. Below is a summary of the proposed services for <strong>${quote.leadBusinessName}</strong>.\r\n                </p>\r\n\r\n                <!-- Service Cards -->\r\n                <div style=\"border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-bottom: 20px;\">\r\n                    ${lineItemCards}\r\n                </div>\r\n\r\n                <!-- Total -->\r\n                <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; text-align: center; margin-bottom: 28px;\">\r\n                    <p style=\"color: #6b7280; margin: 0; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;\">Total Monthly Investment</p>\r\n                    <p style=\"color: #0369a1; margin: 4px 0 0; font-size: 28px; font-weight: 700;\">${formatCurrency(quote.totalMonthlyRate)}<span style=\"font-size: 14px; font-weight: 400; color: #6b7280;\">/month</span></p>\r\n                    <p style=\"color: #6b7280; margin: 4px 0 0; font-size: 13px;\">${quote.contractTenure}-month agreement · ${quote.paymentTerms}</p>\r\n                </div>\r\n\r\n                <!-- CTA Button -->\r\n                <div style=\"text-align: center; margin-bottom: 16px;\">\r\n                    <a href=\"${reviewUrl}\" style=\"display: inline-block; background: #0369a1; color: white; text-decoration: none; padding: 14px 36px; border-radius: 8px; font-weight: 600; font-size: 16px;\">Review & Respond</a>\r\n                </div>\r\n                <p style=\"text-align: center; color: #9ca3af; font-size: 12px; margin: 0;\">\r\n                    Click the button above to accept or request changes to this proposal.\r\n                </p>\r\n            </div>\r\n\r\n            <!-- Footer -->\r\n            <div style=\"text-align: center; padding: 20px 0;\">\r\n                <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\r\n                    XIRI Facility Solutions · Professional Facility Management<br/>\r\n                    <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a>\r\n                </p>\r\n            </div>\r\n        </div>\r\n    </body>\r\n    </html>`;\r\n\r\n    // Send the email\r\n    const sent = await sendEmail(\r\n        clientEmail,\r\n        `Service Proposal for ${quote.leadBusinessName} — XIRI Facility Solutions`,\r\n        html,\r\n        undefined,\r\n        'Xiri Facility Solutions <quotes@xiri.ai>'\r\n    );\r\n\r\n    if (!sent) {\r\n        throw new HttpsError(\"internal\", \"Failed to send email\");\r\n    }\r\n\r\n    // Log activity\r\n    await db.collection(\"activity_logs\").add({\r\n        type: \"QUOTE_SENT\",\r\n        quoteId,\r\n        leadId: quote.leadId,\r\n        clientEmail,\r\n        sentBy: request.auth.uid,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    return { success: true, reviewToken };\r\n});\r\n\r\n/**\r\n * Cloud Function: respondToQuote\r\n * Called from the public review page when a client clicks Accept or Request Changes.\r\n * No auth required — secured by the reviewToken.\r\n */\r\nexport const respondToQuote = onCall({\r\n    secrets: [\"RESEND_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n    ],\r\n}, async (request) => {\r\n    const { reviewToken, action, notes } = request.data;\r\n\r\n    if (!reviewToken || !action) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing reviewToken or action\");\r\n    }\r\n\r\n    if (![\"accept\", \"request_changes\"].includes(action)) {\r\n        throw new HttpsError(\"invalid-argument\", \"Invalid action\");\r\n    }\r\n\r\n    // Find quote by reviewToken\r\n    const quotesSnap = await db.collection(\"quotes\")\r\n        .where(\"reviewToken\", \"==\", reviewToken)\r\n        .limit(1)\r\n        .get();\r\n\r\n    if (quotesSnap.empty) {\r\n        throw new HttpsError(\"not-found\", \"Invalid or expired quote link\");\r\n    }\r\n\r\n    const quoteDoc = quotesSnap.docs[0];\r\n    const quote = quoteDoc.data();\r\n\r\n    if (quote.status !== \"sent\") {\r\n        throw new HttpsError(\"failed-precondition\", `This quote has already been ${quote.status}`);\r\n    }\r\n\r\n    const now = admin.firestore.FieldValue.serverTimestamp();\r\n\r\n    if (action === \"accept\") {\r\n        // 1. Create Contract\r\n        const contractRef = await db.collection(\"contracts\").add({\r\n            leadId: quote.leadId,\r\n            quoteId: quoteDoc.id,\r\n            clientBusinessName: quote.leadBusinessName,\r\n            clientAddress: \"\",\r\n            signerName: \"\",\r\n            signerTitle: \"\",\r\n            totalMonthlyRate: quote.totalMonthlyRate,\r\n            contractTenure: quote.contractTenure,\r\n            startDate: now,\r\n            endDate: new Date(Date.now() + (quote.contractTenure * 30 * 24 * 60 * 60 * 1000)),\r\n            paymentTerms: quote.paymentTerms,\r\n            exitClause: quote.exitClause || \"30-day written notice\",\r\n            status: \"active\",\r\n            createdBy: \"client_accepted\",\r\n            createdAt: now,\r\n            updatedAt: now,\r\n        });\r\n\r\n        // 2. Create Work Orders\r\n        for (const item of (quote.lineItems || [])) {\r\n            await db.collection(\"work_orders\").add({\r\n                leadId: quote.leadId,\r\n                contractId: contractRef.id,\r\n                quoteLineItemId: item.id,\r\n                locationId: item.locationId,\r\n                locationName: item.locationName,\r\n                serviceType: item.serviceType,\r\n                scopeTemplateId: item.scopeTemplateId || null,\r\n                tasks: [],\r\n                vendorId: null,\r\n                vendorRate: null,\r\n                vendorHistory: [],\r\n                schedule: {\r\n                    daysOfWeek: [false, true, true, true, true, true, false],\r\n                    startTime: \"21:00\",\r\n                    frequency: item.frequency,\r\n                },\r\n                qrCodeSecret: uuidv4(),\r\n                clientRate: item.clientRate,\r\n                margin: null,\r\n                status: \"pending_assignment\",\r\n                assignedFsmId: quote.assignedFsmId || null,\r\n                assignedBy: null,\r\n                notes: \"\",\r\n                createdAt: now,\r\n                updatedAt: now,\r\n            });\r\n        }\r\n\r\n        // 3. Update Quote\r\n        await quoteDoc.ref.update({\r\n            status: \"accepted\",\r\n            acceptedAt: now,\r\n            clientResponseAt: now,\r\n            clientResponseNotes: notes || null,\r\n            updatedAt: now,\r\n        });\r\n\r\n        // 4. Update Lead\r\n        await db.collection(\"leads\").doc(quote.leadId).update({\r\n            status: \"won\",\r\n            contractId: contractRef.id,\r\n            wonAt: now,\r\n        });\r\n\r\n        // 5. Send confirmation email to client\r\n        if (quote.clientEmail) {\r\n            await sendEmail(\r\n                quote.clientEmail,\r\n                `Proposal Accepted — Welcome to XIRI Facility Solutions`,\r\n                `<div style=\"font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 32px;\">\r\n                    <h2 style=\"color: #0369a1;\">Thank you!</h2>\r\n                    <p>Your service agreement for <strong>${quote.leadBusinessName}</strong> has been confirmed.</p>\r\n                    <p>Your dedicated Facility Solutions Manager will be in touch shortly to coordinate getting started.</p>\r\n                    <p style=\"color: #6b7280; font-size: 13px;\">— XIRI Facility Solutions</p>\r\n                </div>`\r\n            );\r\n        }\r\n\r\n        // 6. Log\r\n        await db.collection(\"activity_logs\").add({\r\n            type: \"QUOTE_ACCEPTED_BY_CLIENT\",\r\n            quoteId: quoteDoc.id,\r\n            leadId: quote.leadId,\r\n            contractId: contractRef.id,\r\n            clientEmail: quote.clientEmail,\r\n            createdAt: now,\r\n        });\r\n\r\n        return { success: true, action: \"accepted\" };\r\n\r\n    } else {\r\n        // Request changes\r\n        await quoteDoc.ref.update({\r\n            clientResponseAt: now,\r\n            clientResponseNotes: notes || \"Client requested changes\",\r\n            updatedAt: now,\r\n        });\r\n\r\n        // Log\r\n        await db.collection(\"activity_logs\").add({\r\n            type: \"QUOTE_CHANGES_REQUESTED\",\r\n            quoteId: quoteDoc.id,\r\n            leadId: quote.leadId,\r\n            clientEmail: quote.clientEmail,\r\n            notes: notes || \"\",\r\n            createdAt: now,\r\n        });\r\n\r\n        return { success: true, action: \"changes_requested\" };\r\n    }\r\n});\r\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","import { randomFillSync } from 'crypto';\nconst rnds8Pool = new Uint8Array(256);\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n    if (poolPtr > rnds8Pool.length - 16) {\n        randomFillSync(rnds8Pool);\n        poolPtr = 0;\n    }\n    return rnds8Pool.slice(poolPtr, (poolPtr += 16));\n}\n","import { randomUUID } from 'crypto';\nexport default { randomUUID };\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    options = options || {};\n    const rnds = options.random ?? options.rng?.() ?? rng();\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nexport default v4;\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * processMailQueue — Firestore Trigger\r\n * \r\n * Triggered when a new document is created in the `mail_queue` collection.\r\n * Processes the email and sends it via Resend.\r\n * \r\n * NOTE: This is a Firestore trigger, not an HTTP function, so CORS is not applicable.\r\n * The dashboard writes to `mail_queue` and this function picks it up server-side.\r\n * \r\n * Supported templateTypes:\r\n * - `client_invoice` — Invoice email sent to clients with a payment link\r\n * - `vendor_remittance` — Remittance statement sent to vendors\r\n * - `quote` — Quote email (handled by existing sendQuoteEmail)\r\n */\r\nexport const processMailQueue = onDocumentCreated({\r\n    document: \"mail_queue/{docId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n}, async (event) => {\r\n    const snap = event.data;\r\n    if (!snap) {\r\n        console.error(\"No data in mail_queue document\");\r\n        return;\r\n    }\r\n\r\n    const data = snap.data();\r\n    const docRef = snap.ref;\r\n\r\n    try {\r\n        // Mark as processing\r\n        await docRef.update({ status: \"processing\", processedAt: admin.firestore.FieldValue.serverTimestamp() });\r\n\r\n        const { to, subject, templateType, templateData } = data;\r\n\r\n        if (!to || !subject) {\r\n            throw new Error(\"Missing 'to' or 'subject' in mail_queue document\");\r\n        }\r\n\r\n        // Build HTML based on template type\r\n        let html = \"\";\r\n\r\n        switch (templateType) {\r\n            case \"client_invoice\":\r\n                html = buildClientInvoiceEmail(templateData);\r\n                break;\r\n            case \"vendor_remittance\":\r\n                html = buildVendorRemittanceEmail(templateData);\r\n                break;\r\n            default:\r\n                // Generic email — use subject and any provided HTML body\r\n                html = templateData?.html || `<p>${subject}</p>`;\r\n                break;\r\n        }\r\n\r\n        // Send via Resend\r\n        const success = await sendEmail(\r\n            to,\r\n            subject,\r\n            html,\r\n            undefined, // attachments\r\n            \"Xiri Facility Solutions <billing@xiri.ai>\"\r\n        );\r\n\r\n        if (success) {\r\n            await docRef.update({ status: \"sent\", sentAt: admin.firestore.FieldValue.serverTimestamp() });\r\n            console.log(`✅ Mail sent: ${templateType} → ${to}`);\r\n        } else {\r\n            await docRef.update({ status: \"failed\", error: \"Resend API returned failure\" });\r\n            console.error(`❌ Mail failed: ${templateType} → ${to}`);\r\n        }\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error processing mail_queue:\", error);\r\n        await docRef.update({\r\n            status: \"failed\",\r\n            error: error.message || \"Unknown error\",\r\n            failedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n    }\r\n});\r\n\r\n\r\n// ─── Email Template Builders ──────────────────────────────────────────\r\n\r\nfunction buildClientInvoiceEmail(data: any): string {\r\n    const { clientBusinessName, clientContactName, totalAmount, paymentLink, billingPeriod } = data || {};\r\n\r\n    const formattedAmount = new Intl.NumberFormat(\"en-US\", { style: \"currency\", currency: \"USD\", minimumFractionDigits: 0 }).format(totalAmount || 0);\r\n    const periodText = billingPeriod ? `${billingPeriod.start} — ${billingPeriod.end}` : \"Current Period\";\r\n\r\n    return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n</head>\r\n<body style=\"margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 40px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);\">\r\n    <!-- Header -->\r\n    <div style=\"background: linear-gradient(135deg, #0369a1, #0284c7); padding: 32px 24px; text-align: center;\">\r\n      <h1 style=\"color: #ffffff; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">XIRI</h1>\r\n      <p style=\"color: rgba(255,255,255,0.85); margin: 4px 0 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;\">Facility Solutions</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div style=\"padding: 32px 24px;\">\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        Hi ${clientContactName || \"there\"},\r\n      </p>\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        Your invoice for <strong>${clientBusinessName || \"your facility\"}</strong> is ready.\r\n      </p>\r\n\r\n      <!-- Amount Box -->\r\n      <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; text-align: center; margin: 24px 0;\">\r\n        <p style=\"color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 8px;\">Amount Due</p>\r\n        <p style=\"color: #0369a1; font-size: 32px; font-weight: 700; margin: 0;\">${formattedAmount}</p>\r\n        <p style=\"color: #94a3b8; font-size: 13px; margin: 8px 0 0;\">Billing Period: ${periodText}</p>\r\n      </div>\r\n\r\n      ${paymentLink ? `\r\n      <!-- CTA -->\r\n      <div style=\"text-align: center; margin: 28px 0;\">\r\n        <a href=\"${paymentLink}\" style=\"display: inline-block; background: #0369a1; color: #ffffff; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px;\">View Invoice & Pay</a>\r\n      </div>\r\n      ` : \"\"}\r\n\r\n      <p style=\"color: #6b7280; font-size: 13px; line-height: 1.6; margin: 24px 0 0;\">\r\n        If you have any questions about this invoice, please reply to this email or contact your Facility Solutions Manager.\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div style=\"border-top: 1px solid #e5e7eb; padding: 16px 24px; background: #f9fafb;\">\r\n      <p style=\"color: #9ca3af; font-size: 11px; text-align: center; margin: 0;\">\r\n        Xiri Facility Solutions • <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a>\r\n      </p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n}\r\n\r\n\r\nfunction buildVendorRemittanceEmail(data: any): string {\r\n    const { vendorName, totalAmount, billingPeriod, lineItems } = data || {};\r\n\r\n    const formattedAmount = new Intl.NumberFormat(\"en-US\", { style: \"currency\", currency: \"USD\", minimumFractionDigits: 0 }).format(totalAmount || 0);\r\n    const periodText = billingPeriod ? `${billingPeriod.start} — ${billingPeriod.end}` : \"Current Period\";\r\n\r\n    const lineItemsHtml = (lineItems || []).map((li: any) =>\r\n        `<tr>\r\n            <td style=\"padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #374151;\">${li.serviceType || \"—\"}</td>\r\n            <td style=\"padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #6b7280;\">${li.locationName || \"—\"}</td>\r\n            <td style=\"padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: #374151; text-align: right; font-weight: 500;\">$${(li.amount || 0).toLocaleString()}</td>\r\n        </tr>`\r\n    ).join(\"\");\r\n\r\n    return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n</head>\r\n<body style=\"margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 40px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);\">\r\n    <!-- Header -->\r\n    <div style=\"background: linear-gradient(135deg, #0369a1, #0284c7); padding: 32px 24px; text-align: center;\">\r\n      <h1 style=\"color: #ffffff; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">XIRI</h1>\r\n      <p style=\"color: rgba(255,255,255,0.85); margin: 4px 0 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;\">Remittance Statement</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div style=\"padding: 32px 24px;\">\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        Hi ${vendorName || \"Partner\"},\r\n      </p>\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        Here is your remittance statement for <strong>${periodText}</strong>. This details the services you provided and the payment owed to you.\r\n      </p>\r\n\r\n      <!-- Line Items Table -->\r\n      <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\r\n        <thead>\r\n          <tr style=\"background: #f8fafc;\">\r\n            <th style=\"padding: 10px 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0;\">Service</th>\r\n            <th style=\"padding: 10px 12px; text-align: left; font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0;\">Location</th>\r\n            <th style=\"padding: 10px 12px; text-align: right; font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0;\">Amount</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          ${lineItemsHtml}\r\n        </tbody>\r\n      </table>\r\n\r\n      <!-- Total -->\r\n      <div style=\"background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; text-align: center; margin: 20px 0;\">\r\n        <p style=\"color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 6px;\">Total Owed to You</p>\r\n        <p style=\"color: #16a34a; font-size: 28px; font-weight: 700; margin: 0;\">${formattedAmount}</p>\r\n      </div>\r\n\r\n      <p style=\"color: #6b7280; font-size: 13px; line-height: 1.6; margin: 20px 0 0;\">\r\n        Payment will be processed according to your agreed terms. If you have any questions, please reply to this email.\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div style=\"border-top: 1px solid #e5e7eb; padding: 16px 24px; background: #f9fafb;\">\r\n      <p style=\"color: #9ca3af; font-size: 11px; text-align: center; margin: 0;\">\r\n        Xiri Facility Solutions • <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a>\r\n      </p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n}\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport {\r\n    generateST1201,\r\n    XiriCorporateData,\r\n    VendorCertData,\r\n    ProjectData,\r\n} from \"@xiri/shared/src/TaxCertificateService\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst STORAGE_PATH = 'tax-certificates/st-120-1';\r\n\r\n/**\r\n * Fires when a Work Order is updated.\r\n * If a vendor was just assigned (vendorId changed from empty to a value),\r\n * and the vendor has a valid salesTaxId, generate a per-project ST-120.1\r\n * and email it to the vendor.\r\n */\r\nexport const onWorkOrderAssigned = onDocumentUpdated({\r\n    document: \"work_orders/{workOrderId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // ── Guard: only fire when vendorId is newly set ──\r\n    const oldVendorId = before.vendorId || null;\r\n    const newVendorId = after.vendorId || null;\r\n\r\n    if (!newVendorId || oldVendorId === newVendorId) return;\r\n\r\n    const workOrderId = event.params.workOrderId;\r\n    logger.info(`[ST-120.1] Vendor ${newVendorId} assigned to work order ${workOrderId}.`);\r\n\r\n    const db = admin.firestore();\r\n\r\n    // ── Load vendor data ──\r\n    let vendorData: any;\r\n    try {\r\n        const vendorSnap = await db.collection('vendors').doc(newVendorId).get();\r\n        if (!vendorSnap.exists) {\r\n            logger.error(`[ST-120.1] Vendor ${newVendorId} not found.`);\r\n            return;\r\n        }\r\n        vendorData = vendorSnap.data();\r\n    } catch (err) {\r\n        logger.error(`[ST-120.1] Error loading vendor ${newVendorId}:`, err);\r\n        return;\r\n    }\r\n\r\n    // ── Guard: vendor must have salesTaxId ──\r\n    const salesTaxId = vendorData.compliance?.salesTaxId?.trim();\r\n    if (!salesTaxId) {\r\n        logger.info(`[ST-120.1] Vendor ${newVendorId} has no salesTaxId — skipping certificate.`);\r\n\r\n        await db.collection('vendor_activities').add({\r\n            vendorId: newVendorId,\r\n            type: 'TAX_CERTIFICATE_SKIPPED',\r\n            description: `ST-120.1 not generated for WO ${workOrderId} — vendor has no Sales Tax ID on file.`,\r\n            createdAt: new Date(),\r\n            metadata: { workOrderId },\r\n        });\r\n        return;\r\n    }\r\n\r\n    // ── Load client/lead data for project owner info ──\r\n    let leadData: any = {};\r\n    if (after.leadId) {\r\n        try {\r\n            const leadSnap = await db.collection('leads').doc(after.leadId).get();\r\n            if (leadSnap.exists) {\r\n                leadData = leadSnap.data();\r\n            }\r\n        } catch (err) {\r\n            logger.warn(`[ST-120.1] Could not load lead ${after.leadId}:`, err);\r\n        }\r\n    }\r\n\r\n    // ── Load XIRI corporate settings ──\r\n    let xiriData: XiriCorporateData;\r\n    try {\r\n        const settingsSnap = await db.collection('settings').doc('corporate').get();\r\n        const settings = settingsSnap.data();\r\n\r\n        if (!settings?.salesTaxId) {\r\n            logger.error('[ST-120.1] XIRI corporate settings missing or no salesTaxId configured.');\r\n            return;\r\n        }\r\n\r\n        xiriData = {\r\n            businessName: settings.businessName || 'XIRI Facility Solutions LLC',\r\n            address: settings.address || '',\r\n            city: settings.city || '',\r\n            state: settings.state || 'NY',\r\n            zip: settings.zip || '',\r\n            salesTaxId: settings.salesTaxId,\r\n            signatureImageBase64: settings.signatureImageBase64 || '',\r\n            signerName: settings.signerName || '',\r\n            signerTitle: settings.signerTitle || '',\r\n        };\r\n    } catch (err) {\r\n        logger.error('[ST-120.1] Error loading corporate settings:', err);\r\n        return;\r\n    }\r\n\r\n    // ── Build inputs ──\r\n    const vendorCertData: VendorCertData = {\r\n        vendorId: newVendorId,\r\n        businessName: vendorData.businessName || 'Unknown Vendor',\r\n        address: vendorData.address || vendorData.streetAddress || '',\r\n        city: vendorData.city,\r\n        state: vendorData.state,\r\n        zip: vendorData.zip,\r\n        email: vendorData.email || '',\r\n        salesTaxId,\r\n    };\r\n\r\n    const ownerName = leadData.businessName || after.locationName || 'Project Owner';\r\n    const ownerAddress = leadData.address || '';\r\n\r\n    const projectDataInput: ProjectData = {\r\n        workOrderId,\r\n        projectName: after.locationName || leadData.businessName || 'Project',\r\n        projectAddress: after.locationAddress || '',\r\n        projectCity: after.locationCity,\r\n        projectState: after.locationState,\r\n        projectZip: after.locationZip,\r\n        ownerName,\r\n        ownerAddress,\r\n    };\r\n\r\n    // ── Generate the ST-120.1 ──\r\n    const result = await generateST1201(vendorCertData, xiriData, projectDataInput);\r\n\r\n    if (!result.success || !result.pdfBytes) {\r\n        logger.error(`[ST-120.1] Generation failed for WO ${workOrderId}: ${result.error}`);\r\n        await db.collection('vendor_activities').add({\r\n            vendorId: newVendorId,\r\n            type: 'TAX_CERTIFICATE_ERROR',\r\n            description: `ST-120.1 generation failed for WO ${workOrderId}: ${result.error}`,\r\n            createdAt: new Date(),\r\n            metadata: { workOrderId },\r\n        });\r\n        return;\r\n    }\r\n\r\n    // ── Upload to Firebase Storage ──\r\n    let pdfUrl: string;\r\n    try {\r\n        const bucket = admin.storage().bucket();\r\n        const fileName = `${STORAGE_PATH}/${workOrderId}_${newVendorId}_${result.issueDate}.pdf`;\r\n        const file = bucket.file(fileName);\r\n\r\n        await file.save(Buffer.from(result.pdfBytes), {\r\n            metadata: {\r\n                contentType: 'application/pdf',\r\n                metadata: {\r\n                    workOrderId,\r\n                    vendorId: newVendorId,\r\n                    issueDate: result.issueDate!,\r\n                    expiryDate: result.expiryDate!,\r\n                },\r\n            },\r\n        });\r\n\r\n        const [signedUrl] = await file.getSignedUrl({\r\n            action: 'read',\r\n            expires: new Date(Date.now() + 10 * 365 * 24 * 60 * 60 * 1000),\r\n        });\r\n        pdfUrl = signedUrl;\r\n    } catch (err) {\r\n        logger.error(`[ST-120.1] Storage upload failed for WO ${workOrderId}:`, err);\r\n        return;\r\n    }\r\n\r\n    // ── Update work order with certificate URL ──\r\n    await db.collection('work_orders').doc(workOrderId).update({\r\n        st1201CertificateUrl: pdfUrl,\r\n        st1201IssueDate: result.issueDate,\r\n        st1201ExpiryDate: result.expiryDate,\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // ── Email to vendor ──\r\n    if (vendorCertData.email) {\r\n        const vendorName = vendorCertData.businessName;\r\n        const projectName = projectDataInput.projectName;\r\n\r\n        await db.collection('mail_queue').add({\r\n            to: vendorCertData.email,\r\n            subject: `ST-120.1 Exempt Purchase Certificate — ${projectName}`,\r\n            templateType: 'st_120_1_certificate',\r\n            templateData: {\r\n                vendorName,\r\n                purchaserName: xiriData.businessName,\r\n                projectName,\r\n                projectAddress: projectDataInput.projectAddress,\r\n                issueDate: result.issueDate,\r\n                expiryDate: result.expiryDate,\r\n            },\r\n            attachments: [{\r\n                filename: `ST-120.1_${projectName.replace(/\\s+/g, '_')}.pdf`,\r\n                path: pdfUrl,\r\n            }],\r\n            status: 'pending',\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n    }\r\n\r\n    // ── Log activity ──\r\n    await db.collection('vendor_activities').add({\r\n        vendorId: newVendorId,\r\n        type: 'TAX_CERTIFICATE_ISSUED',\r\n        description: `ST-120.1 generated for project \"${projectDataInput.projectName}\" (WO ${workOrderId}) and emailed to ${vendorCertData.email || 'vendor'}.`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            workOrderId,\r\n            certificateType: 'ST-120.1',\r\n            issueDate: result.issueDate,\r\n            expiryDate: result.expiryDate,\r\n            projectName: projectDataInput.projectName,\r\n            projectAddress: projectDataInput.projectAddress,\r\n            pdfUrl,\r\n        },\r\n    });\r\n\r\n    logger.info(`[ST-120.1] Certificate generated and emailed for WO ${workOrderId}, vendor ${newVendorId}.`);\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { enqueueTask } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Sales Lead Drip Campaign Scheduler\r\n * \r\n * When a lead's status changes to 'qualified', schedule a 4-step\r\n * outreach email sequence targeting the business owner or property manager.\r\n * \r\n * Sequence:\r\n *   Day 0  — Intro: \"One call for all your facility needs\"\r\n *   Day 3  — Value Prop: \"Here's how we save you 15+ hours/month\"\r\n *   Day 7  — Social Proof: Case study from similar facility\r\n *   Day 14 — Final follow-up: \"Schedule a walkthrough?\"\r\n */\r\nexport const onLeadQualified = onDocumentUpdated({\r\n    document: \"leads/{leadId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'qualified'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'qualified') return;\r\n\r\n    const leadId = event.params.leadId;\r\n    const businessName = after.businessName || 'Unknown';\r\n    const contactEmail = after.email;\r\n\r\n    // Guard: need an email to send to\r\n    if (!contactEmail || contactEmail.trim().length === 0) {\r\n        logger.warn(`[SalesOutreach] Lead ${leadId} (${businessName}) has no email — marking NEEDS_MANUAL.`);\r\n        await db.collection(\"leads\").doc(leadId).update({\r\n            outreachStatus: 'NEEDS_MANUAL',\r\n        });\r\n        await db.collection(\"lead_activities\").add({\r\n            leadId,\r\n            type: \"OUTREACH_NEEDS_MANUAL\",\r\n            description: `No email found for ${businessName}. Manual outreach required.`,\r\n            createdAt: new Date(),\r\n        });\r\n        return;\r\n    }\r\n\r\n    logger.info(`[SalesOutreach] Scheduling drip campaign for lead ${leadId} (${businessName})`);\r\n\r\n    const now = new Date();\r\n\r\n    // Schedule 4-step drip: Day 0, Day 3, Day 7, Day 14\r\n    const steps = [\r\n        { dayOffset: 0, sequence: 0, subject: 'Simplify your facility management' },\r\n        { dayOffset: 3, sequence: 1, subject: 'How we save you 15+ hours/month' },\r\n        { dayOffset: 7, sequence: 2, subject: 'How practices like yours made the switch' },\r\n        { dayOffset: 14, sequence: 3, subject: 'Last check in — free walkthrough offer' },\r\n    ];\r\n\r\n    for (const step of steps) {\r\n        const scheduledDate = new Date(now);\r\n        scheduledDate.setDate(scheduledDate.getDate() + step.dayOffset);\r\n        // Schedule at 9am ET (14:00 UTC)\r\n        scheduledDate.setHours(14, 0, 0, 0);\r\n\r\n        // Day 0 sends immediately (or at next 9am if past)\r\n        const sendAt = step.dayOffset === 0 ? now : scheduledDate;\r\n\r\n        await enqueueTask(db, {\r\n            leadId,\r\n            type: step.sequence === 0 ? 'GENERATE' : 'FOLLOW_UP',\r\n            scheduledAt: admin.firestore.Timestamp.fromDate(sendAt),\r\n            metadata: {\r\n                sequence: step.sequence,\r\n                subject: step.subject,\r\n                businessName,\r\n                email: contactEmail,\r\n                contactName: after.contactName || '',\r\n                facilityType: after.facilityType || '',\r\n                address: after.address || '',\r\n                propertySourcing: after.propertySourcing || null,\r\n            }\r\n        });\r\n    }\r\n\r\n    // Update lead outreach status\r\n    await db.collection(\"leads\").doc(leadId).update({\r\n        outreachStatus: 'PENDING',\r\n    });\r\n\r\n    // Log activity\r\n    await db.collection(\"lead_activities\").add({\r\n        leadId,\r\n        type: \"DRIP_SCHEDULED\",\r\n        description: `Sales drip campaign scheduled: 4 emails over 14 days for ${businessName}.`,\r\n        createdAt: new Date(),\r\n        metadata: { followUpCount: 4, schedule: 'Day 0/3/7/14' }\r\n    });\r\n\r\n    logger.info(`[SalesOutreach] Drip campaign scheduled for lead ${leadId}: 4 emails at days 0, 3, 7, 14`);\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n// ─── Commission Defaults (overridden by Firestore settings/commissions) ───\r\nconst DEFAULTS = {\r\n    mrrThreshold: 3000,\r\n    rateStandard: 0.05,\r\n    ratePremium: 0.075,\r\n    fsmUpsellRate: 0.05,\r\n    clawbackMonths: 6,\r\n    payoutSplit: [50, 25, 25],\r\n};\r\n\r\nasync function getCommissionConfig() {\r\n    const snap = await db.collection('settings').doc('commissions').get();\r\n    if (snap.exists) {\r\n        const data = snap.data()!;\r\n        return {\r\n            mrrThreshold: data.mrrThreshold ?? DEFAULTS.mrrThreshold,\r\n            rateStandard: data.rateStandard ?? DEFAULTS.rateStandard,\r\n            ratePremium: data.ratePremium ?? DEFAULTS.ratePremium,\r\n            fsmUpsellRate: data.fsmUpsellRate ?? DEFAULTS.fsmUpsellRate,\r\n            clawbackMonths: data.clawbackMonths ?? DEFAULTS.clawbackMonths,\r\n            payoutSplit: data.payoutSplit ?? DEFAULTS.payoutSplit,\r\n        };\r\n    }\r\n    return DEFAULTS;\r\n}\r\n\r\n/**\r\n * Fires when a Quote's status changes to 'accepted'.\r\n * Calculates the sales commission and schedules the 3-month payout.\r\n *\r\n * Payout clock starts when FIRST INVOICE IS PAID — so we create the\r\n * commission record as PENDING here, and activate it in onInvoicePaid.\r\n */\r\nexport const onQuoteAccepted = onDocumentUpdated({\r\n    document: \"quotes/{quoteId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Guard: only fire when status changes TO 'accepted'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'accepted') return;\r\n\r\n    const quoteId = event.params.quoteId;\r\n\r\n    // ─── Idempotency Guard: prevent duplicate commissions ───\r\n    const existingComm = await db.collection('commissions')\r\n        .where('quoteId', '==', quoteId)\r\n        .limit(1)\r\n        .get();\r\n    if (!existingComm.empty) {\r\n        logger.info(`[Commission] Commission already exists for quote ${quoteId} — skipping duplicate`);\r\n        return;\r\n    }\r\n\r\n    // Load configurable rates from Firestore\r\n    const cfg = await getCommissionConfig();\r\n\r\n    const leadId = after.leadId;\r\n    const assignedTo = after.assignedTo || after.createdBy;\r\n    const isUpsell = after.isUpsell === true;\r\n\r\n    // Calculate MRR and ACV\r\n    const mrr = after.totalMonthlyRate || 0;\r\n    const acv = mrr * 12;\r\n\r\n    // Determine commission rate and type\r\n    let rate: number;\r\n    let type: string;\r\n\r\n    if (isUpsell) {\r\n        rate = cfg.fsmUpsellRate;\r\n        type = 'FSM_UPSELL';\r\n    } else {\r\n        rate = mrr > cfg.mrrThreshold ? cfg.ratePremium : cfg.rateStandard;\r\n        type = 'SALES_NEW';\r\n    }\r\n\r\n    const totalCommission = acv * rate;\r\n\r\n    // Build payout schedule (payouts start when first invoice is paid)\r\n    const payoutSchedule = cfg.payoutSplit.map((pct: number, month: number) => ({\r\n        month,\r\n        amount: Math.round((totalCommission * pct / 100) * 100) / 100, // Round to cents\r\n        percentage: pct,\r\n        status: 'PENDING' as const,\r\n        scheduledAt: null, // Will be set when first invoice is paid\r\n    }));\r\n\r\n    // For FSM upsells, single payout (100% at once)\r\n    const fsmPayoutSchedule = [{\r\n        month: 0,\r\n        amount: totalCommission,\r\n        percentage: 100,\r\n        status: 'PENDING' as const,\r\n        scheduledAt: null,\r\n    }];\r\n\r\n    const now = new Date();\r\n    const clawbackEnd = new Date(now);\r\n    clawbackEnd.setMonth(clawbackEnd.getMonth() + cfg.clawbackMonths);\r\n\r\n    // Determine staffRole\r\n    const staffRole = isUpsell ? 'fsm' : 'sales';\r\n\r\n    // Create commission record\r\n    const commissionRef = await db.collection('commissions').add({\r\n        staffId: assignedTo,\r\n        staffRole,\r\n        quoteId,\r\n        leadId,\r\n        type,\r\n        mrr,\r\n        acv,\r\n        rate,\r\n        totalCommission,\r\n        payoutSchedule: isUpsell ? fsmPayoutSchedule : payoutSchedule,\r\n        clawbackWindowEnd: clawbackEnd,\r\n        status: 'PENDING', // Activates when first invoice is paid\r\n        createdAt: now,\r\n        updatedAt: now,\r\n    });\r\n\r\n    // Log to commission ledger\r\n    await db.collection('commission_ledger').add({\r\n        commissionId: commissionRef.id,\r\n        type: 'PAYOUT_SCHEDULED',\r\n        amount: totalCommission,\r\n        staffId: assignedTo,\r\n        description: `${type === 'FSM_UPSELL' ? 'Upsell' : 'New deal'} commission: ${(rate * 100).toFixed(0)}% of $${acv.toLocaleString()} ACV = $${totalCommission.toLocaleString()}`,\r\n        createdAt: now,\r\n    });\r\n\r\n    // Log activity\r\n    await db.collection('activity_logs').add({\r\n        type: 'COMMISSION_CREATED',\r\n        quoteId,\r\n        leadId,\r\n        staffId: assignedTo,\r\n        commissionId: commissionRef.id,\r\n        totalCommission,\r\n        rate,\r\n        acv,\r\n        mrr,\r\n        commissionType: type,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    logger.info(`[Commission] Created ${type} commission for staff ${assignedTo}: $${totalCommission} (${(rate * 100).toFixed(0)}% of $${acv} ACV) — quote ${quoteId}`);\r\n\r\n    // NOTE: Contract creation is handled by handleAccept() in the quote detail page.\r\n    // Do NOT create a duplicate contract here — work orders reference the inline-created contract ID.\r\n});\r\n\r\n\r\n/**\r\n * Fires when an invoice status changes to 'paid'.\r\n * If the commission is still PENDING, this activates it and triggers Payout 1 (50%).\r\n * For subsequent payouts, the scheduled function handles them monthly.\r\n */\r\nexport const onInvoicePaid = onDocumentUpdated({\r\n    document: \"invoices/{invoiceId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Guard: only fire when status changes TO 'paid'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'paid') return;\r\n\r\n    const quoteId = after.quoteId;\r\n    if (!quoteId) return;\r\n\r\n    // Find PENDING commissions for this quote\r\n    const commSnap = await db.collection('commissions')\r\n        .where('quoteId', '==', quoteId)\r\n        .where('status', '==', 'PENDING')\r\n        .get();\r\n\r\n    if (commSnap.empty) return;\r\n\r\n    const now = new Date();\r\n\r\n    for (const commDoc of commSnap.docs) {\r\n        // ─── Transaction Lock: prevent double-activation ───\r\n        // If two invoices are paid simultaneously, only one will activate the commission.\r\n        try {\r\n            await db.runTransaction(async (txn) => {\r\n                const freshDoc = await txn.get(commDoc.ref);\r\n                const freshData = freshDoc.data();\r\n                if (!freshData || freshData.status !== 'PENDING') {\r\n                    logger.info(`[Commission] Commission ${commDoc.id} already activated (status: ${freshData?.status}) — skipping`);\r\n                    return;\r\n                }\r\n\r\n                const schedule = [...freshData.payoutSchedule];\r\n\r\n                // Set payout dates: Month 0 = now, Month 1 = +30 days, Month 2 = +60 days\r\n                schedule.forEach((entry: any, i: number) => {\r\n                    const payDate = new Date(now);\r\n                    payDate.setDate(payDate.getDate() + (i * 30));\r\n                    entry.scheduledAt = payDate;\r\n                });\r\n\r\n                // Mark Payout 0 as PAID immediately\r\n                schedule[0].status = 'PAID';\r\n                schedule[0].paidAt = now;\r\n\r\n                txn.update(commDoc.ref, {\r\n                    status: 'ACTIVE',\r\n                    payoutSchedule: schedule,\r\n                    updatedAt: now,\r\n                });\r\n            });\r\n\r\n            // Log payout outside transaction (ledger is append-only, safe)\r\n            const commission = commDoc.data();\r\n            const schedule = commission.payoutSchedule;\r\n            await db.collection('commission_ledger').add({\r\n                commissionId: commDoc.id,\r\n                type: 'PAYOUT_PAID',\r\n                amount: schedule[0].amount,\r\n                staffId: commission.staffId,\r\n                description: `Payout 1 of ${schedule.length}: $${schedule[0].amount.toFixed(2)} (${schedule[0].percentage}%) — triggered by invoice payment`,\r\n                createdAt: now,\r\n            });\r\n\r\n            logger.info(`[Commission] Activated commission ${commDoc.id}: Payout 1 of $${schedule[0].amount} paid`);\r\n        } catch (txnErr: any) {\r\n            logger.error(`[Commission] Transaction failed for commission ${commDoc.id}:`, txnErr.message);\r\n        }\r\n    }\r\n});\r\n\r\n\r\n/**\r\n * Fires when a Work Order is updated.\r\n * If a vendorId was just assigned AND the lead hasn't been handed off yet,\r\n * mark the Sales → FSM handoff on the lead.\r\n */\r\nexport const onWorkOrderHandoff = onDocumentUpdated({\r\n    document: \"work_orders/{workOrderId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Guard: only fire when vendorId is newly set\r\n    const hadVendor = before.vendorId && before.vendorId.length > 0;\r\n    const hasVendor = after.vendorId && after.vendorId.length > 0;\r\n    if (hadVendor || !hasVendor) return;\r\n\r\n    const leadId = after.leadId;\r\n    const fsmId = after.assignedFsmId || after.createdBy;\r\n    if (!leadId) return;\r\n\r\n    // Check if lead already has a handoff\r\n    const leadDoc = await db.collection('leads').doc(leadId).get();\r\n    if (!leadDoc.exists) return;\r\n\r\n    const leadData = leadDoc.data();\r\n    if (leadData?.handedOffToFsm) return; // Already handed off\r\n\r\n    // Mark the handoff\r\n    await db.collection('leads').doc(leadId).update({\r\n        handedOffToFsm: fsmId,\r\n        handoffDate: new Date(),\r\n    });\r\n\r\n    await db.collection('activity_logs').add({\r\n        type: 'SALES_TO_FSM_HANDOFF',\r\n        leadId,\r\n        fsmId,\r\n        workOrderId: event.params.workOrderId,\r\n        description: `Account handed off from Sales to FSM (first work order assigned)`,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    logger.info(`[Handoff] Lead ${leadId} handed off to FSM ${fsmId} via work order ${event.params.workOrderId}`);\r\n\r\n    // ─── Item 8: Email FSM about new client assignment ────────────────\r\n    try {\r\n        // Get FSM email\r\n        const fsmDoc = await db.collection('users').doc(fsmId).get();\r\n        const fsmEmail = fsmDoc.data()?.email || 'chris@xiri.ai';\r\n        const fsmName = fsmDoc.data()?.displayName || 'FSM';\r\n\r\n        // Get lead/client details  \r\n        const clientName = leadData?.businessName || leadData?.companyName || leadData?.name || 'New Client';\r\n        const clientEmail = leadData?.email || leadData?.contactEmail || '';\r\n        const clientPhone = leadData?.phone || leadData?.contactPhone || '';\r\n        const clientAddress = leadData?.address || leadData?.location || '';\r\n        const services = after.serviceType || after.description || 'Facility Maintenance';\r\n\r\n        await db.collection('mail_queue').add({\r\n            to: fsmEmail,\r\n            subject: `📋 New Client Assigned: ${clientName}`,\r\n            templateType: 'fsm_handoff',\r\n            templateData: {\r\n                html: `\r\n<!DOCTYPE html>\r\n<html>\r\n<body style=\"margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 40px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);\">\r\n    <div style=\"background: linear-gradient(135deg, #0369a1, #0284c7); padding: 32px 24px; text-align: center;\">\r\n      <h1 style=\"color: #ffffff; margin: 0; font-size: 28px; font-weight: 700;\">XIRI</h1>\r\n      <p style=\"color: rgba(255,255,255,0.85); margin: 8px 0 0; font-size: 14px;\">New Client Assignment</p>\r\n    </div>\r\n    <div style=\"padding: 32px 24px;\">\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">Hi ${fsmName},</p>\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">A new client has been assigned to you. Here are the details:</p>\r\n      <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin: 24px 0;\">\r\n        <table style=\"width: 100%; font-size: 14px; color: #374151;\">\r\n          <tr><td style=\"padding: 6px 0; color: #6b7280; width: 120px;\">Business:</td><td style=\"padding: 6px 0; font-weight: 600;\">${clientName}</td></tr>\r\n          <tr><td style=\"padding: 6px 0; color: #6b7280;\">Contact:</td><td style=\"padding: 6px 0;\">${clientEmail}${clientPhone ? ' • ' + clientPhone : ''}</td></tr>\r\n          <tr><td style=\"padding: 6px 0; color: #6b7280;\">Address:</td><td style=\"padding: 6px 0;\">${clientAddress || 'See dashboard'}</td></tr>\r\n          <tr><td style=\"padding: 6px 0; color: #6b7280;\">Services:</td><td style=\"padding: 6px 0;\">${services}</td></tr>\r\n        </table>\r\n      </div>\r\n      <div style=\"text-align: center; margin: 24px 0;\">\r\n        <a href=\"https://app.xiri.ai/sales/crm/${leadId}\" style=\"display: inline-block; background: #0369a1; color: #ffffff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px;\">View Client Details →</a>\r\n      </div>\r\n    </div>\r\n    <div style=\"border-top: 1px solid #e5e7eb; padding: 16px 24px; background: #f9fafb;\">\r\n      <p style=\"color: #9ca3af; font-size: 11px; text-align: center; margin: 0;\">Xiri Facility Solutions • <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a></p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`,\r\n            },\r\n            status: 'pending',\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        logger.info(`[Handoff] FSM notification email queued to ${fsmEmail} for client ${clientName}`);\r\n    } catch (emailErr: any) {\r\n        logger.error(`[Handoff] Failed to send FSM email:`, emailErr.message);\r\n    }\r\n});\r\n\r\n\r\n/**\r\n * Fires when a lead status changes to 'churned'.\r\n * Cancels any unpaid commission payouts within the 6-month clawback window.\r\n */\r\nexport const onClientCancelled = onDocumentUpdated({\r\n    document: \"leads/{leadId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Guard: only fire when status changes TO 'churned'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'churned') return;\r\n\r\n    const leadId = event.params.leadId;\r\n    const now = new Date();\r\n\r\n    // Find active commissions for this lead within clawback window\r\n    const commSnap = await db.collection('commissions')\r\n        .where('leadId', '==', leadId)\r\n        .where('status', 'in', ['PENDING', 'ACTIVE'])\r\n        .get();\r\n\r\n    if (commSnap.empty) return;\r\n\r\n    for (const commDoc of commSnap.docs) {\r\n        const commission = commDoc.data();\r\n\r\n        // Check if still within clawback window\r\n        const clawbackEnd = commission.clawbackWindowEnd?.toDate?.() || commission.clawbackWindowEnd;\r\n        if (!clawbackEnd || now > new Date(clawbackEnd)) {\r\n            logger.info(`[Clawback] Commission ${commDoc.id} past clawback window — no action`);\r\n            continue;\r\n        }\r\n\r\n        // Cancel unpaid portions only (already-paid amounts stay)\r\n        const schedule = [...commission.payoutSchedule];\r\n        let cancelledAmount = 0;\r\n\r\n        schedule.forEach((entry: any) => {\r\n            if (entry.status === 'PENDING') {\r\n                entry.status = 'CANCELLED';\r\n                cancelledAmount += entry.amount;\r\n            }\r\n        });\r\n\r\n        if (cancelledAmount === 0) continue;\r\n\r\n        await commDoc.ref.update({\r\n            status: 'PARTIALLY_CANCELLED',\r\n            payoutSchedule: schedule,\r\n            updatedAt: now,\r\n        });\r\n\r\n        // Log clawback\r\n        await db.collection('commission_ledger').add({\r\n            commissionId: commDoc.id,\r\n            type: 'CLAWBACK',\r\n            amount: -cancelledAmount,\r\n            staffId: commission.staffId,\r\n            description: `Client churned within clawback window. $${cancelledAmount.toFixed(2)} in unpaid payouts cancelled.`,\r\n            createdAt: now,\r\n        });\r\n\r\n        logger.info(`[Clawback] Commission ${commDoc.id}: $${cancelledAmount} in unpaid payouts cancelled (client churn)`);\r\n    }\r\n});\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n// NRR bonus tiers\r\nconst NRR_TIERS = [\r\n    { min: 1.10, rate: 0.02 },   // > 110% NRR → 2% of portfolio ACV\r\n    { min: 1.00, rate: 0.01 },   // 100–110% → 1%\r\n    { min: 0.90, rate: 0.005 },  // 90–100% → 0.5%\r\n    { min: 0, rate: 0 },      // < 90% → $0\r\n];\r\n\r\n/**\r\n * Runs daily at 9 AM UTC.\r\n * Checks for commission payouts that are scheduled and due today.\r\n * Verifies the client is still active before marking as PAID.\r\n */\r\nexport const processCommissionPayouts = onSchedule({\r\n    schedule: \"0 9 * * *\",  // Daily at 9 AM UTC\r\n    timeZone: \"America/New_York\",\r\n}, async () => {\r\n    const now = new Date();\r\n    logger.info(`[CommissionPayouts] Processing scheduled payouts for ${now.toISOString()}`);\r\n\r\n    // Find all ACTIVE commissions that have PENDING payouts\r\n    const commSnap = await db.collection('commissions')\r\n        .where('status', '==', 'ACTIVE')\r\n        .get();\r\n\r\n    let processed = 0;\r\n    let paid = 0;\r\n\r\n    for (const commDoc of commSnap.docs) {\r\n        const commission = commDoc.data();\r\n        const schedule = [...commission.payoutSchedule];\r\n        let changed = false;\r\n\r\n        for (const entry of schedule) {\r\n            if (entry.status !== 'PENDING') continue;\r\n\r\n            // Check if payout is due\r\n            const scheduledAt = entry.scheduledAt?.toDate?.() || new Date(entry.scheduledAt);\r\n            if (scheduledAt > now) continue;\r\n\r\n            // Verify client is still active (not churned)\r\n            const leadDoc = await db.collection('leads').doc(commission.leadId).get();\r\n            const leadData = leadDoc.data();\r\n            if (leadData?.status === 'churned' || leadData?.status === 'lost') {\r\n                entry.status = 'CANCELLED';\r\n                changed = true;\r\n                logger.info(`[CommissionPayouts] Skipping payout — client ${commission.leadId} is ${leadData?.status}`);\r\n                continue;\r\n            }\r\n\r\n            // Pay it\r\n            entry.status = 'PAID';\r\n            entry.paidAt = now;\r\n            changed = true;\r\n            paid++;\r\n\r\n            // Log payout\r\n            await db.collection('commission_ledger').add({\r\n                commissionId: commDoc.id,\r\n                type: 'PAYOUT_PAID',\r\n                amount: entry.amount,\r\n                staffId: commission.staffId,\r\n                description: `Scheduled payout: $${entry.amount.toFixed(2)} (${entry.percentage}%)`,\r\n                createdAt: now,\r\n            });\r\n\r\n            logger.info(`[CommissionPayouts] Paid $${entry.amount} to ${commission.staffId} (commission ${commDoc.id})`);\r\n        }\r\n\r\n        if (changed) {\r\n            // Check if all payouts are complete\r\n            const allDone = schedule.every((e: any) => e.status === 'PAID' || e.status === 'CANCELLED');\r\n            const anyPaidExist = schedule.some((e: any) => e.status === 'PAID');\r\n            const anyCancelled = schedule.some((e: any) => e.status === 'CANCELLED');\r\n\r\n            let newStatus = commission.status;\r\n            if (allDone && anyPaidExist && !anyCancelled) {\r\n                newStatus = 'COMPLETED';\r\n            } else if (allDone && anyCancelled) {\r\n                newStatus = 'PARTIALLY_CANCELLED';\r\n            }\r\n\r\n            await commDoc.ref.update({\r\n                payoutSchedule: schedule,\r\n                status: newStatus,\r\n                updatedAt: now,\r\n            });\r\n            processed++;\r\n        }\r\n    }\r\n\r\n    logger.info(`[CommissionPayouts] Done: ${processed} commissions processed, ${paid} payouts made`);\r\n});\r\n\r\n\r\n/**\r\n * Runs quarterly (1st of Jan, Apr, Jul, Oct) at midnight UTC.\r\n * Calculates Net Revenue Retention for each FSM and creates retention bonuses.\r\n */\r\nexport const calculateNrr = onSchedule({\r\n    schedule: \"0 0 1 1,4,7,10 *\",  // Quarterly: 1st of Jan, Apr, Jul, Oct\r\n    timeZone: \"America/New_York\",\r\n}, async () => {\r\n    const now = new Date();\r\n    const currentMonth = now.getMonth(); // 0-indexed\r\n    const currentYear = now.getFullYear();\r\n\r\n    // Determine the quarter we're calculating for (previous quarter)\r\n    const quarterMap: Record<number, string> = {\r\n        0: `${currentYear - 1}-Q4`,  // Jan → calc Q4 of prev year\r\n        3: `${currentYear}-Q1`,       // Apr → calc Q1\r\n        6: `${currentYear}-Q2`,       // Jul → calc Q2\r\n        9: `${currentYear}-Q3`,       // Oct → calc Q3\r\n    };\r\n    const quarter = quarterMap[currentMonth] || `${currentYear}-Q${Math.ceil((currentMonth + 1) / 3)}`;\r\n\r\n    logger.info(`[NRR] Calculating Net Revenue Retention for ${quarter}`);\r\n\r\n    // Get all leads that have been handed off to an FSM\r\n    const leadsSnap = await db.collection('leads')\r\n        .where('handedOffToFsm', '!=', null)\r\n        .get();\r\n\r\n    // Group leads by FSM\r\n    const fsmPortfolios: Map<string, {\r\n        leadIds: string[];\r\n        startingMrr: number;\r\n        currentMrr: number;\r\n        upsells: number;\r\n        downgrades: number;\r\n        churn: number;\r\n    }> = new Map();\r\n\r\n    for (const leadDoc of leadsSnap.docs) {\r\n        const lead = leadDoc.data();\r\n        const fsmId = lead.handedOffToFsm;\r\n        if (!fsmId) continue;\r\n\r\n        if (!fsmPortfolios.has(fsmId)) {\r\n            fsmPortfolios.set(fsmId, {\r\n                leadIds: [],\r\n                startingMrr: 0,\r\n                currentMrr: 0,\r\n                upsells: 0,\r\n                downgrades: 0,\r\n                churn: 0,\r\n            });\r\n        }\r\n\r\n        const portfolio = fsmPortfolios.get(fsmId)!;\r\n        portfolio.leadIds.push(leadDoc.id);\r\n\r\n        // Get quotes for this lead to determine MRR\r\n        const quotesSnap = await db.collection('quotes')\r\n            .where('leadId', '==', leadDoc.id)\r\n            .where('status', '==', 'accepted')\r\n            .get();\r\n\r\n        let leadMrr = 0;\r\n        for (const quoteDoc of quotesSnap.docs) {\r\n            leadMrr += quoteDoc.data().totalMonthlyRate || 0;\r\n        }\r\n\r\n        if (lead.status === 'churned') {\r\n            portfolio.churn += leadMrr;\r\n        } else {\r\n            portfolio.currentMrr += leadMrr;\r\n        }\r\n\r\n        // Tally upsells (quotes marked as upsells for this FSM)\r\n        const upsellSnap = await db.collection('quotes')\r\n            .where('leadId', '==', leadDoc.id)\r\n            .where('isUpsell', '==', true)\r\n            .where('status', '==', 'accepted')\r\n            .get();\r\n\r\n        for (const upsellDoc of upsellSnap.docs) {\r\n            portfolio.upsells += upsellDoc.data().totalMonthlyRate || 0;\r\n        }\r\n    }\r\n\r\n    // Calculate NRR and bonuses for each FSM\r\n    for (const [fsmId, portfolio] of fsmPortfolios) {\r\n        // Starting MRR = current + churn - upsells (what they started the quarter with)\r\n        const startingMrr = portfolio.currentMrr + portfolio.churn - portfolio.upsells;\r\n        if (startingMrr <= 0) continue; // Skip if no starting portfolio\r\n\r\n        const nrr = (startingMrr + portfolio.upsells - portfolio.downgrades - portfolio.churn) / startingMrr;\r\n\r\n        // Determine bonus rate from tiers\r\n        let bonusRate = 0;\r\n        for (const tier of NRR_TIERS) {\r\n            if (nrr >= tier.min) {\r\n                bonusRate = tier.rate;\r\n                break;\r\n            }\r\n        }\r\n\r\n        const portfolioAcv = portfolio.currentMrr * 12;\r\n        const bonusAmount = Math.round(portfolioAcv * bonusRate / 4 * 100) / 100; // Quarterly portion\r\n\r\n        // Save NRR snapshot\r\n        await db.collection('nrr_snapshots').add({\r\n            fsmId,\r\n            quarter,\r\n            startingMrr,\r\n            endingMrr: portfolio.currentMrr,\r\n            upsells: portfolio.upsells,\r\n            downgrades: portfolio.downgrades,\r\n            churn: portfolio.churn,\r\n            nrr: Math.round(nrr * 10000) / 100, // Store as percentage (e.g., 105.5)\r\n            bonusRate,\r\n            bonusAmount,\r\n            calculatedAt: now,\r\n        });\r\n\r\n        // If bonus > 0, create a retention commission\r\n        if (bonusAmount > 0) {\r\n            const commRef = await db.collection('commissions').add({\r\n                staffId: fsmId,\r\n                staffRole: 'fsm',\r\n                quoteId: '',  // N/A for retention\r\n                leadId: '',   // N/A for retention (portfolio-level)\r\n                type: 'FSM_RETENTION',\r\n                mrr: portfolio.currentMrr,\r\n                acv: portfolioAcv,\r\n                rate: bonusRate,\r\n                totalCommission: bonusAmount,\r\n                payoutSchedule: [{\r\n                    month: 0,\r\n                    amount: bonusAmount,\r\n                    percentage: 100,\r\n                    status: 'PENDING',\r\n                    scheduledAt: now, // Pay immediately\r\n                }],\r\n                clawbackWindowEnd: now, // No clawback for retention bonuses\r\n                status: 'ACTIVE',\r\n                createdAt: now,\r\n                updatedAt: now,\r\n            });\r\n\r\n            await db.collection('commission_ledger').add({\r\n                commissionId: commRef.id,\r\n                type: 'PAYOUT_SCHEDULED',\r\n                amount: bonusAmount,\r\n                staffId: fsmId,\r\n                description: `${quarter} NRR retention bonus: ${(nrr * 100).toFixed(1)}% NRR → ${(bonusRate * 100).toFixed(1)}% rate → $${bonusAmount.toFixed(2)}`,\r\n                createdAt: now,\r\n            });\r\n        }\r\n\r\n        logger.info(`[NRR] FSM ${fsmId}: NRR=${(nrr * 100).toFixed(1)}%, portfolio=$${portfolio.currentMrr}/mo, bonus=$${bonusAmount}`);\r\n    }\r\n\r\n    logger.info(`[NRR] Completed NRR calculation for ${quarter}: ${fsmPortfolios.size} FSMs processed`);\r\n});\r\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\nconst INTERNAL_NOTIFY_EMAIL = \"chris@xiri.ai\";\r\n\r\n/**\r\n * Fires when a new lead is created from the audit wizard.\r\n * \r\n * Actions:\r\n * 1. Send confirmation email to the lead\r\n * 2. Send internal notification to chris@xiri.ai\r\n * 3. Log to activity_logs\r\n */\r\nexport const onAuditSubmitted = onDocumentCreated({\r\n    document: \"leads/{leadId}\",\r\n}, async (event) => {\r\n    const snap = event.data;\r\n    if (!snap) return;\r\n\r\n    const data = snap.data();\r\n    const leadId = event.params.leadId;\r\n\r\n    // Only fire for audit wizard leads\r\n    if (data.source !== 'audit_wizard') return;\r\n\r\n    const businessName = data.businessName || data.companyName || 'Your Facility';\r\n    const contactName = data.contactName || data.name || '';\r\n    const contactEmail = data.email || data.contactEmail;\r\n    const address = data.address || data.location || '';\r\n\r\n    if (!contactEmail) {\r\n        logger.warn(`[AuditSubmitted] Lead ${leadId} has no email — skipping confirmation`);\r\n        return;\r\n    }\r\n\r\n    // 1. Send confirmation email to the lead\r\n    await db.collection('mail_queue').add({\r\n        to: contactEmail,\r\n        subject: `We received your audit request — ${businessName}`,\r\n        templateType: 'audit_confirmation',\r\n        templateData: {\r\n            html: buildAuditConfirmationEmail(contactName, businessName),\r\n        },\r\n        status: 'pending',\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // 2. Send internal notification\r\n    await db.collection('mail_queue').add({\r\n        to: INTERNAL_NOTIFY_EMAIL,\r\n        subject: `🔔 New Audit Lead: ${businessName}`,\r\n        templateType: 'internal_notification',\r\n        templateData: {\r\n            html: buildInternalNotificationEmail(leadId, contactName, contactEmail, businessName, address, data),\r\n        },\r\n        status: 'pending',\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // 3. Log activity\r\n    await db.collection('activity_logs').add({\r\n        type: 'AUDIT_SUBMITTED',\r\n        leadId,\r\n        email: contactEmail,\r\n        businessName,\r\n        description: `New audit lead from ${businessName} (${contactEmail})`,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    logger.info(`[AuditSubmitted] Confirmation + internal alert sent for lead ${leadId} (${businessName})`);\r\n});\r\n\r\n\r\n// ─── Email Builders ───────────────────────────────────────────────────\r\n\r\nfunction buildAuditConfirmationEmail(contactName: string, businessName: string): string {\r\n    const greeting = contactName ? `Hi ${contactName}` : 'Hello';\r\n\r\n    return `\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n</head>\r\n<body style=\"margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 40px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);\">\r\n    <!-- Header -->\r\n    <div style=\"background: linear-gradient(135deg, #0369a1, #0284c7); padding: 32px 24px; text-align: center;\">\r\n      <h1 style=\"color: #ffffff; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">XIRI</h1>\r\n      <p style=\"color: rgba(255,255,255,0.85); margin: 4px 0 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;\">Facility Solutions</p>\r\n    </div>\r\n\r\n    <!-- Content -->\r\n    <div style=\"padding: 32px 24px;\">\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        ${greeting},\r\n      </p>\r\n      <p style=\"color: #374151; font-size: 15px; line-height: 1.6; margin: 0 0 20px;\">\r\n        Thank you for requesting a facility audit for <strong>${businessName}</strong>. We've received your information and a member of our team will reach out within <strong>24 hours</strong> to schedule your complimentary assessment.\r\n      </p>\r\n\r\n      <!-- What's Next -->\r\n      <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin: 24px 0;\">\r\n        <p style=\"color: #0369a1; font-size: 14px; font-weight: 600; margin: 0 0 12px;\">What happens next?</p>\r\n        <ol style=\"color: #374151; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 18px;\">\r\n          <li>A Facility Solutions Manager will contact you</li>\r\n          <li>We'll schedule a walkthrough of your facility</li>\r\n          <li>You'll receive a custom maintenance plan & quote</li>\r\n        </ol>\r\n      </div>\r\n\r\n      <p style=\"color: #6b7280; font-size: 13px; line-height: 1.6; margin: 24px 0 0;\">\r\n        Questions in the meantime? Reply to this email — we're happy to help.\r\n      </p>\r\n    </div>\r\n\r\n    <!-- Footer -->\r\n    <div style=\"border-top: 1px solid #e5e7eb; padding: 16px 24px; background: #f9fafb;\">\r\n      <p style=\"color: #9ca3af; font-size: 11px; text-align: center; margin: 0;\">\r\n        Xiri Facility Solutions • <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a>\r\n      </p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n}\r\n\r\n\r\nfunction buildInternalNotificationEmail(\r\n    leadId: string,\r\n    contactName: string,\r\n    contactEmail: string,\r\n    businessName: string,\r\n    address: string,\r\n    data: any,\r\n): string {\r\n    const facilityType = data.facilityType || data.propertyType || 'Not specified';\r\n    const sqft = data.squareFootage || data.sqft || 'Not specified';\r\n    const services = data.services?.join(', ') || data.selectedServices?.join(', ') || 'Not specified';\r\n\r\n    return `\r\n<!DOCTYPE html>\r\n<html>\r\n<body style=\"margin:0; padding:20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 0 auto; background: #ffffff; border-radius: 8px; padding: 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.1);\">\r\n    <h2 style=\"margin: 0 0 16px; color: #111827;\">🔔 New Audit Lead</h2>\r\n    \r\n    <table style=\"width: 100%; font-size: 14px; color: #374151;\">\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Business:</td><td style=\"padding: 6px 0; font-weight: 600;\">${businessName}</td></tr>\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Contact:</td><td style=\"padding: 6px 0;\">${contactName || 'N/A'} — ${contactEmail}</td></tr>\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Address:</td><td style=\"padding: 6px 0;\">${address || 'N/A'}</td></tr>\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Facility Type:</td><td style=\"padding: 6px 0;\">${facilityType}</td></tr>\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Sq Ft:</td><td style=\"padding: 6px 0;\">${sqft}</td></tr>\r\n      <tr><td style=\"padding: 6px 0; color: #6b7280;\">Services:</td><td style=\"padding: 6px 0;\">${services}</td></tr>\r\n    </table>\r\n\r\n    <div style=\"margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;\">\r\n      <a href=\"https://app.xiri.ai/sales/crm/${leadId}\" style=\"display: inline-block; background: #0369a1; color: #ffffff; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600;\">View in Dashboard →</a>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n}\r\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\nconst FAIL_THRESHOLD = 70; // Score below this = failed audit\r\nconst SUSPENSION_THRESHOLD = 3; // Auto-suspend after this many failures\r\nconst INTERNAL_NOTIFY_EMAIL = \"chris@xiri.ai\";\r\n\r\n/**\r\n * Fires when a new audit is created.\r\n * If the overall score is below the threshold, triggers escalation.\r\n *\r\n * Actions:\r\n * 1. Flag the work order as needs_remediation\r\n * 2. Create a remediation work order\r\n * 3. Increment vendor failedAuditCount\r\n * 4. Email FSM about failed audit\r\n * 5. If vendor hits 3+ failures → auto-suspend + notify\r\n * 6. Log to activity_logs\r\n */\r\nexport const onAuditFailed = onDocumentCreated({\r\n    document: \"audits/{auditId}\",\r\n}, async (event) => {\r\n    const snap = event.data;\r\n    if (!snap) return;\r\n\r\n    const data = snap.data();\r\n    const auditId = event.params.auditId;\r\n\r\n    const overallScore = data.overallScore ?? data.score ?? 100;\r\n\r\n    // Only fire for failing audits\r\n    if (overallScore >= FAIL_THRESHOLD) return;\r\n\r\n    const workOrderId = data.workOrderId;\r\n    const vendorId = data.vendorId;\r\n    const locationName = data.locationName || data.location || 'Unknown Location';\r\n    const clientName = data.clientName || data.businessName || '';\r\n\r\n    logger.info(`[AuditFailed] Audit ${auditId} scored ${overallScore}% (threshold: ${FAIL_THRESHOLD}%)`);\r\n\r\n    // ─── 1. Flag work order ──────────────────────────────────────────────\r\n\r\n    if (workOrderId) {\r\n        await db.collection('work_orders').doc(workOrderId).update({\r\n            status: 'needs_remediation',\r\n            failedAuditId: auditId,\r\n            failedAuditScore: overallScore,\r\n            updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n    }\r\n\r\n    // ─── 2. Create remediation work order ────────────────────────────────\r\n\r\n    let remediationId: string | null = null;\r\n    if (workOrderId) {\r\n        // Fetch original work order to copy details\r\n        const woDoc = await db.collection('work_orders').doc(workOrderId).get();\r\n        const woData = woDoc.exists ? woDoc.data() : null;\r\n\r\n        const remRef = await db.collection('work_orders').add({\r\n            type: 'remediation',\r\n            originalWorkOrderId: workOrderId,\r\n            auditId,\r\n            leadId: woData?.leadId || data.leadId || null,\r\n            vendorId: vendorId || null,\r\n            assignedFsmId: woData?.assignedFsmId || null,\r\n            locationName,\r\n            description: `Remediation required: Audit scored ${overallScore}% at ${locationName}. Issues: ${data.failureNotes || data.notes || 'See audit report.'}`,\r\n            status: 'pending',\r\n            priority: 'high',\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n        remediationId = remRef.id;\r\n    }\r\n\r\n    // ─── 3. Increment vendor failure count ───────────────────────────────\r\n\r\n    let vendorFailCount = 0;\r\n    let vendorName = 'Unknown Vendor';\r\n    let vendorSuspended = false;\r\n\r\n    if (vendorId) {\r\n        const vendorRef = db.collection('vendors').doc(vendorId);\r\n        const vendorDoc = await vendorRef.get();\r\n\r\n        if (vendorDoc.exists) {\r\n            const vendorData = vendorDoc.data()!;\r\n            vendorName = vendorData.businessName || vendorData.name || vendorName;\r\n            vendorFailCount = (vendorData.failedAuditCount || 0) + 1;\r\n\r\n            const updateData: Record<string, any> = {\r\n                failedAuditCount: vendorFailCount,\r\n                lastFailedAuditId: auditId,\r\n                lastFailedAuditDate: admin.firestore.FieldValue.serverTimestamp(),\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            };\r\n\r\n            // ─── 5. Auto-suspend if threshold reached ────────────────\r\n            if (vendorFailCount >= SUSPENSION_THRESHOLD) {\r\n                updateData.status = 'suspended';\r\n                updateData.suspensionReason = `Auto-suspended after ${vendorFailCount} failed audits`;\r\n                vendorSuspended = true;\r\n            }\r\n\r\n            await vendorRef.update(updateData);\r\n        }\r\n    }\r\n\r\n    // ─── 4. Email FSM ────────────────────────────────────────────────────\r\n\r\n    // Find FSM email — check work order assignedFsmId or fall back to internal\r\n    let fsmEmail = INTERNAL_NOTIFY_EMAIL;\r\n    if (workOrderId) {\r\n        const woDoc = await db.collection('work_orders').doc(workOrderId).get();\r\n        const fsmId = woDoc.data()?.assignedFsmId;\r\n        if (fsmId) {\r\n            const fsmDoc = await db.collection('users').doc(fsmId).get();\r\n            fsmEmail = fsmDoc.data()?.email || INTERNAL_NOTIFY_EMAIL;\r\n        }\r\n    }\r\n\r\n    await db.collection('mail_queue').add({\r\n        to: fsmEmail,\r\n        subject: `⚠️ Audit Failed: ${locationName} — ${overallScore}%`,\r\n        templateType: 'audit_failed',\r\n        templateData: {\r\n            html: buildAuditFailedEmail({\r\n                locationName,\r\n                clientName,\r\n                overallScore,\r\n                vendorName,\r\n                failureNotes: data.failureNotes || data.notes || 'See audit details in dashboard.',\r\n                remediationId,\r\n                auditId,\r\n            }),\r\n        },\r\n        status: 'pending',\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    // ─── 5b. Notify about vendor suspension ──────────────────────────────\r\n\r\n    if (vendorSuspended) {\r\n        await db.collection('mail_queue').add({\r\n            to: INTERNAL_NOTIFY_EMAIL,\r\n            subject: `🚫 Vendor Suspended: ${vendorName} (${vendorFailCount} failed audits)`,\r\n            templateType: 'vendor_suspended',\r\n            templateData: {\r\n                html: `\r\n                <div style=\"font-family: -apple-system, sans-serif; padding: 24px;\">\r\n                    <h2 style=\"color: #dc2626;\">🚫 Vendor Auto-Suspended</h2>\r\n                    <p><strong>${vendorName}</strong> has been automatically suspended after <strong>${vendorFailCount}</strong> failed audits.</p>\r\n                    <p>Last failure: ${locationName} — Score: ${overallScore}%</p>\r\n                    <p>Action required: Review vendor and decide whether to reinstate or terminate.</p>\r\n                    <a href=\"https://app.xiri.ai/supply/crm/${vendorId}\" style=\"display: inline-block; background: #dc2626; color: #ffffff; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 12px;\">View Vendor →</a>\r\n                </div>`,\r\n            },\r\n            status: 'pending',\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n    }\r\n\r\n    // ─── 6. Activity log ─────────────────────────────────────────────────\r\n\r\n    await db.collection('activity_logs').add({\r\n        type: 'AUDIT_FAILED',\r\n        auditId,\r\n        workOrderId: workOrderId || null,\r\n        vendorId: vendorId || null,\r\n        remediationWorkOrderId: remediationId,\r\n        overallScore,\r\n        vendorFailCount,\r\n        vendorSuspended,\r\n        description: `Audit failed at ${locationName} (${overallScore}%). Vendor: ${vendorName}. ${vendorSuspended ? 'VENDOR AUTO-SUSPENDED.' : ''}`,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    });\r\n\r\n    logger.info(`[AuditFailed] Escalation complete: audit ${auditId}, score ${overallScore}%, vendor ${vendorName} (failures: ${vendorFailCount})${vendorSuspended ? ' — SUSPENDED' : ''}`);\r\n});\r\n\r\n\r\n// ─── Email Builder ────────────────────────────────────────────────────\r\n\r\nfunction buildAuditFailedEmail(data: {\r\n    locationName: string;\r\n    clientName: string;\r\n    overallScore: number;\r\n    vendorName: string;\r\n    failureNotes: string;\r\n    remediationId: string | null;\r\n    auditId: string;\r\n}): string {\r\n    return `\r\n<!DOCTYPE html>\r\n<html>\r\n<body style=\"margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f6f8;\">\r\n  <div style=\"max-width: 560px; margin: 40px auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08);\">\r\n    <!-- Header -->\r\n    <div style=\"background: linear-gradient(135deg, #dc2626, #ef4444); padding: 32px 24px; text-align: center;\">\r\n      <h1 style=\"color: #ffffff; margin: 0; font-size: 28px; font-weight: 700;\">⚠️ Audit Failed</h1>\r\n      <p style=\"color: rgba(255,255,255,0.85); margin: 8px 0 0; font-size: 14px;\">${data.locationName}</p>\r\n    </div>\r\n\r\n    <div style=\"padding: 32px 24px;\">\r\n      <!-- Score -->\r\n      <div style=\"background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; text-align: center; margin: 0 0 24px;\">\r\n        <p style=\"color: #991b1b; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 6px;\">Overall Score</p>\r\n        <p style=\"color: #dc2626; font-size: 36px; font-weight: 700; margin: 0;\">${data.overallScore}%</p>\r\n      </div>\r\n\r\n      <table style=\"width: 100%; font-size: 14px; color: #374151; margin-bottom: 20px;\">\r\n        <tr><td style=\"padding: 6px 0; color: #6b7280;\">Client:</td><td style=\"padding: 6px 0; font-weight: 500;\">${data.clientName || 'N/A'}</td></tr>\r\n        <tr><td style=\"padding: 6px 0; color: #6b7280;\">Vendor:</td><td style=\"padding: 6px 0; font-weight: 500;\">${data.vendorName}</td></tr>\r\n        <tr><td style=\"padding: 6px 0; color: #6b7280;\">Issues:</td><td style=\"padding: 6px 0;\">${data.failureNotes}</td></tr>\r\n      </table>\r\n\r\n      <p style=\"color: #374151; font-size: 14px; line-height: 1.6;\">\r\n        A <strong>remediation work order</strong> has been auto-created. Please review and assign a follow-up.\r\n      </p>\r\n\r\n      <div style=\"text-align: center; margin: 24px 0;\">\r\n        <a href=\"https://app.xiri.ai/operations/audits\" style=\"display: inline-block; background: #0369a1; color: #ffffff; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px;\">View in Dashboard →</a>\r\n      </div>\r\n    </div>\r\n\r\n    <div style=\"border-top: 1px solid #e5e7eb; padding: 16px 24px; background: #f9fafb;\">\r\n      <p style=\"color: #9ca3af; font-size: 11px; text-align: center; margin: 0;\">\r\n        Xiri Facility Solutions • <a href=\"https://xiri.ai\" style=\"color: #0369a1; text-decoration: none;\">xiri.ai</a>\r\n      </p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n}\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Runs on the 1st of every month at 6:00 AM EST.\r\n * \r\n * For each active contract:\r\n * 1. Gathers completed work orders from the previous month\r\n * 2. Creates a consolidated draft invoice\r\n * 3. Logs to activity_logs\r\n * \r\n * Invoices are created as 'draft' — Accounting reviews, then marks as 'sent'.\r\n */\r\nexport const generateMonthlyInvoices = onSchedule({\r\n    schedule: \"0 6 1 * *\", // 6 AM on 1st of every month\r\n    timeZone: \"America/New_York\",\r\n}, async () => {\r\n    logger.info(\"[MonthlyInvoices] Starting monthly invoice generation...\");\r\n\r\n    // Calculate billing period (previous full month)\r\n    const now = new Date();\r\n    const periodEnd = new Date(now.getFullYear(), now.getMonth(), 0); // Last day of prev month\r\n    const periodStart = new Date(periodEnd.getFullYear(), periodEnd.getMonth(), 1); // 1st of prev month\r\n\r\n    const periodLabel = periodStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });\r\n\r\n    // Find all active contracts\r\n    const contractsSnap = await db.collection('contracts')\r\n        .where('status', '==', 'active')\r\n        .get();\r\n\r\n    if (contractsSnap.empty) {\r\n        logger.info(\"[MonthlyInvoices] No active contracts found. Done.\");\r\n        return;\r\n    }\r\n\r\n    let invoicesCreated = 0;\r\n    let invoicesSkipped = 0;\r\n\r\n    // Helper: determine if a service frequency is recurring (belongs on every monthly invoice)\r\n    const isRecurring = (freq: string) => !['one_time', 'quarterly'].includes(freq);\r\n\r\n    for (const contractDoc of contractsSnap.docs) {\r\n        const contract = contractDoc.data();\r\n        const contractId = contractDoc.id;\r\n        const leadId = contract.leadId;\r\n        const clientName = contract.clientBusinessName || contract.clientName || contract.businessName || 'Client';\r\n        const clientEmail = contract.contactEmail || contract.clientEmail || '';\r\n        const contractLineItems: any[] = contract.lineItems || [];\r\n\r\n        // Fetch completed work orders for this contract in the billing period\r\n        let workOrdersQuery = db.collection('work_orders')\r\n            .where('status', '==', 'completed');\r\n\r\n        if (contract.leadId) {\r\n            workOrdersQuery = workOrdersQuery.where('leadId', '==', contract.leadId);\r\n        }\r\n\r\n        const woSnap = await workOrdersQuery.get();\r\n\r\n        // Filter to previous month's completions\r\n        const periodWOs = woSnap.docs.filter(doc => {\r\n            const woData = doc.data();\r\n            const completedAt = woData.completedAt?.toDate?.() || woData.completedAt;\r\n            if (!completedAt) return false;\r\n            const d = new Date(completedAt);\r\n            return d >= periodStart && d <= periodEnd;\r\n        });\r\n\r\n        // Track completed one-time WO line item IDs\r\n        const completedLineItemIds = new Set(\r\n            periodWOs.map(doc => doc.data().quoteLineItemId).filter(Boolean)\r\n        );\r\n\r\n        let invoiceLineItems: any[] = [];\r\n\r\n        if (contractLineItems.length > 0) {\r\n            // ─── New billing cadence logic ───\r\n            // 1. Recurring services → always on invoice\r\n            const recurringItems = contractLineItems\r\n                .filter((li: any) => isRecurring(li.frequency))\r\n                .map((li: any) => ({\r\n                    lineItemId: li.id,\r\n                    locationName: li.locationName || 'Service Location',\r\n                    serviceType: li.serviceType || 'Facility Maintenance',\r\n                    description: li.description || '',\r\n                    rate: li.clientRate || 0,\r\n                    billingType: 'recurring' as const,\r\n                    frequency: li.frequency,\r\n                }));\r\n\r\n            // 2. One-time / quarterly → only if completed in billing period\r\n            const oneTimeItems = contractLineItems\r\n                .filter((li: any) => !isRecurring(li.frequency) && completedLineItemIds.has(li.id))\r\n                .map((li: any) => ({\r\n                    lineItemId: li.id,\r\n                    locationName: li.locationName || 'Service Location',\r\n                    serviceType: li.serviceType || 'Facility Maintenance',\r\n                    description: li.description || '',\r\n                    rate: li.clientRate || 0,\r\n                    billingType: 'one_time' as const,\r\n                    frequency: li.frequency,\r\n                }));\r\n\r\n            invoiceLineItems = [...recurringItems, ...oneTimeItems];\r\n        } else {\r\n            // Fallback: legacy contracts without lineItems — use work orders\r\n            invoiceLineItems = periodWOs.map(woDoc => {\r\n                const wo = woDoc.data();\r\n                return {\r\n                    workOrderId: woDoc.id,\r\n                    locationName: wo.locationName || wo.location || 'Service Location',\r\n                    serviceType: wo.serviceType || wo.type || 'Facility Maintenance',\r\n                    description: wo.description || '',\r\n                    rate: wo.rate || wo.amount || 0,\r\n                    billingType: 'legacy' as const,\r\n                };\r\n            });\r\n        }\r\n\r\n        if (invoiceLineItems.length === 0) {\r\n            invoicesSkipped++;\r\n            continue;\r\n        }\r\n\r\n        const totalAmount = invoiceLineItems.reduce((sum, li) => sum + li.rate, 0);\r\n\r\n        // Create draft invoice\r\n        const dueDate = new Date(now);\r\n        dueDate.setDate(dueDate.getDate() + 30); // Net 30\r\n\r\n        const invoiceRef = await db.collection('invoices').add({\r\n            contractId,\r\n            leadId: leadId || null,\r\n            clientName,\r\n            clientEmail,\r\n            lineItems: invoiceLineItems,\r\n            totalAmount,\r\n            billingPeriod: {\r\n                start: periodStart.toISOString().split('T')[0],\r\n                end: periodEnd.toISOString().split('T')[0],\r\n                label: periodLabel,\r\n            },\r\n            workOrderCount: periodWOs.length,\r\n            recurringItemCount: invoiceLineItems.filter(i => i.billingType === 'recurring').length,\r\n            oneTimeItemCount: invoiceLineItems.filter(i => i.billingType === 'one_time').length,\r\n            status: 'draft',\r\n            dueDate,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        // Log activity\r\n        await db.collection('activity_logs').add({\r\n            type: 'INVOICE_AUTO_GENERATED',\r\n            invoiceId: invoiceRef.id,\r\n            contractId,\r\n            leadId: leadId || null,\r\n            clientName,\r\n            totalAmount,\r\n            billingPeriod: periodLabel,\r\n            workOrderCount: periodWOs.length,\r\n            description: `Auto-generated draft invoice for ${clientName}: $${totalAmount.toLocaleString()} (${periodLabel}, ${invoiceLineItems.length} items)`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        });\r\n\r\n        invoicesCreated++;\r\n        logger.info(`[MonthlyInvoices] Created invoice ${invoiceRef.id} for ${clientName}: $${totalAmount} (${invoiceLineItems.length} items: ${invoiceLineItems.filter(i => i.billingType === 'recurring').length} recurring, ${invoiceLineItems.filter(i => i.billingType === 'one_time').length} one-time)`);\r\n    }\r\n\r\n    logger.info(`[MonthlyInvoices] Complete: ${invoicesCreated} invoices created, ${invoicesSkipped} contracts skipped`);\r\n});\r\n","import { onRequest } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { logger } from \"firebase-functions/v2\";\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Resend Webhook Handler\r\n * \r\n * Receives email events from Resend (delivered, opened, clicked, bounced, complained)\r\n * and updates the corresponding vendor_activities record with delivery status.\r\n * \r\n * Webhook URL: https://us-central1-xiri-facility-solutions.cloudfunctions.net/resendWebhook\r\n * Configure in Resend Dashboard → Webhooks → Add Endpoint\r\n * Events to subscribe: email.delivered, email.opened, email.clicked, email.bounced, email.complained\r\n */\r\nexport const resendWebhook = onRequest({\r\n    cors: true,\r\n    timeoutSeconds: 30,\r\n    memory: '256MiB',\r\n}, async (req, res) => {\r\n    // Only accept POST\r\n    if (req.method !== 'POST') {\r\n        res.status(405).send('Method Not Allowed');\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const event = req.body;\r\n\r\n        // Resend webhook payload structure:\r\n        // { type: \"email.delivered\", created_at: \"...\", data: { email_id: \"...\", to: [...], ... } }\r\n        const eventType = event?.type;\r\n        const emailId = event?.data?.email_id;\r\n\r\n        if (!eventType || !emailId) {\r\n            logger.warn('Resend webhook: missing type or email_id', { body: JSON.stringify(event).substring(0, 500) });\r\n            res.status(400).json({ error: 'Missing type or email_id' });\r\n            return;\r\n        }\r\n\r\n        logger.info(`Resend webhook: ${eventType} for email ${emailId}`);\r\n\r\n        // Map Resend event types to our delivery status\r\n        const statusMap: Record<string, { deliveryStatus: string; activityType: string; description: string }> = {\r\n            'email.delivered': {\r\n                deliveryStatus: 'delivered',\r\n                activityType: 'EMAIL_DELIVERED',\r\n                description: 'Email successfully delivered to inbox.'\r\n            },\r\n            'email.opened': {\r\n                deliveryStatus: 'opened',\r\n                activityType: 'EMAIL_OPENED',\r\n                description: 'Recipient opened the email.'\r\n            },\r\n            'email.clicked': {\r\n                deliveryStatus: 'clicked',\r\n                activityType: 'EMAIL_CLICKED',\r\n                description: 'Recipient clicked a link in the email.'\r\n            },\r\n            'email.bounced': {\r\n                deliveryStatus: 'bounced',\r\n                activityType: 'EMAIL_BOUNCED',\r\n                description: `Email bounced: ${event?.data?.bounce_type || 'unknown'} — ${event?.data?.error_message || 'no details'}.`\r\n            },\r\n            'email.complained': {\r\n                deliveryStatus: 'spam',\r\n                activityType: 'EMAIL_COMPLAINED',\r\n                description: 'Recipient marked email as spam.'\r\n            },\r\n        };\r\n\r\n        const mapping = statusMap[eventType];\r\n        if (!mapping) {\r\n            logger.info(`Resend webhook: unhandled event type ${eventType}`);\r\n            res.status(200).json({ ok: true, skipped: true });\r\n            return;\r\n        }\r\n\r\n        // ─── Resolve vendorId ───────────────────────────────────────────\r\n        // Path 1: Resend tags — handle both object ({vendorId:\"xxx\"}) and array ([{name,value}]) formats\r\n        let vendorId: string | null = null;\r\n        const tags = event?.data?.tags;\r\n        if (tags) {\r\n            if (typeof tags === 'object' && !Array.isArray(tags) && tags.vendorId) {\r\n                // Object format: { vendorId: \"xxx\" }\r\n                vendorId = tags.vendorId;\r\n            } else if (Array.isArray(tags)) {\r\n                // Array format: [{ name: \"vendorId\", value: \"xxx\" }]\r\n                const vendorTag = tags.find((t: any) => t.name === 'vendorId');\r\n                if (vendorTag?.value) vendorId = vendorTag.value;\r\n            }\r\n            if (vendorId) {\r\n                logger.info(`Resend webhook: resolved vendorId=${vendorId} from tag`);\r\n            }\r\n        }\r\n\r\n        // Path 2: Activity lookup fallback — for emails that predate the tagging fix\r\n        if (!vendorId) {\r\n            const activitiesSnapshot = await db.collection('vendor_activities')\r\n                .where('metadata.resendId', '==', emailId)\r\n                .limit(1)\r\n                .get();\r\n\r\n            if (!activitiesSnapshot.empty) {\r\n                vendorId = activitiesSnapshot.docs[0].data().vendorId;\r\n                logger.info(`Resend webhook: resolved vendorId=${vendorId} from activity lookup`);\r\n            }\r\n        }\r\n\r\n        if (!vendorId) {\r\n            logger.warn(`Resend webhook: could not resolve vendorId for emailId ${emailId}`);\r\n            res.status(200).json({ ok: true, notFound: true });\r\n            return;\r\n        }\r\n\r\n        // Create a new activity entry for this event (so it shows in timeline)\r\n        await db.collection('vendor_activities').add({\r\n            vendorId,\r\n            type: mapping.activityType,\r\n            description: mapping.description,\r\n            createdAt: new Date(),\r\n            metadata: {\r\n                resendId: emailId,\r\n                deliveryStatus: mapping.deliveryStatus,\r\n                rawEvent: eventType,\r\n                to: event?.data?.to?.[0] || undefined,\r\n            }\r\n        });\r\n\r\n        // ─── Update vendor doc engagement cache ───\r\n        if (vendorId) {\r\n            const engagementUpdate: Record<string, any> = {\r\n                'emailEngagement.lastEvent': mapping.deliveryStatus,\r\n                'emailEngagement.lastEventAt': new Date(),\r\n            };\r\n\r\n            if (eventType === 'email.opened') {\r\n                engagementUpdate['emailEngagement.openCount'] = admin.firestore.FieldValue.increment(1);\r\n            } else if (eventType === 'email.clicked') {\r\n                engagementUpdate['emailEngagement.clickCount'] = admin.firestore.FieldValue.increment(1);\r\n            }\r\n\r\n            // If bounced, also update outreach status\r\n            if (eventType === 'email.bounced') {\r\n                engagementUpdate['outreachStatus'] = 'FAILED';\r\n                engagementUpdate['outreachMeta.bounced'] = true;\r\n                engagementUpdate['outreachMeta.bounceType'] = event?.data?.bounce_type || 'unknown';\r\n                engagementUpdate['outreachMeta.bounceError'] = event?.data?.error_message || 'Email bounced';\r\n            }\r\n\r\n            engagementUpdate['updatedAt'] = new Date();\r\n\r\n            await db.collection('vendors').doc(vendorId).update(engagementUpdate);\r\n            logger.info(`Vendor ${vendorId}: emailEngagement updated (${mapping.deliveryStatus})`);\r\n        }\r\n\r\n        // ─── Template Stats Tracking (for A/B testing analytics) ───\r\n        try {\r\n            // Path 1: Read templateId directly from Resend tags (preferred - no Firestore query needed)\r\n            let templateId: string | null = null;\r\n            if (tags) {\r\n                if (typeof tags === 'object' && !Array.isArray(tags) && tags.templateId) {\r\n                    templateId = tags.templateId;\r\n                } else if (Array.isArray(tags)) {\r\n                    const templateTag = tags.find((t: any) => t.name === 'templateId');\r\n                    if (templateTag?.value) templateId = templateTag.value;\r\n                }\r\n            }\r\n\r\n            // Path 2: Fallback — query activity to find templateId (legacy emails without tag)\r\n            if (!templateId) {\r\n                const sentActivity = await db.collection('vendor_activities')\r\n                    .where('metadata.resendId', '==', emailId)\r\n                    .limit(1)\r\n                    .get();\r\n\r\n                if (!sentActivity.empty) {\r\n                    templateId = sentActivity.docs[0].data().metadata?.templateId || null;\r\n                }\r\n            }\r\n\r\n            if (templateId) {\r\n                const statsField = mapping.deliveryStatus; // delivered, opened, clicked, bounced\r\n                await db.collection('templates').doc(templateId).update({\r\n                    [`stats.${statsField}`]: admin.firestore.FieldValue.increment(1),\r\n                    'stats.lastUpdated': new Date(),\r\n                });\r\n                logger.info(`Template ${templateId}: stats.${statsField} incremented`);\r\n            }\r\n        } catch (statsErr) {\r\n            // Non-critical — don't fail the webhook over stats\r\n            logger.warn('Template stats update failed:', statsErr);\r\n        }\r\n\r\n        logger.info(`Resend webhook: processed ${eventType} for vendor ${vendorId}`);\r\n        res.status(200).json({ ok: true, processed: eventType });\r\n\r\n    } catch (error) {\r\n        logger.error('Resend webhook error:', error);\r\n        res.status(500).json({ error: 'Internal error' });\r\n    }\r\n});\r\n","/**\r\n * Cascade triggers — propagate denormalized field changes across collections.\r\n *\r\n * PATTERN: When adding new denormalized fields in the future, add their\r\n * cascade logic to the appropriate trigger below. Search for \"CASCADE POINT\"\r\n * to find where to add new field cascades.\r\n *\r\n * onLeadUpdated:   businessName, email, contactName\r\n * onVendorUpdated: businessName, email\r\n * onStaffUpdated:  displayName (FSM name, Night Manager name)\r\n */\r\n\r\nimport { onDocumentUpdated } from 'firebase-functions/v2/firestore';\r\nimport { logger } from 'firebase-functions/v2';\r\nimport { db } from '../utils/firebase';\r\n\r\n/** Helper: returns true if a field changed */\r\nconst changed = (before: any, after: any, field: string) =>\r\n    after[field] && before[field] !== after[field];\r\n\r\n/* ─── Lead cascade ─────────────────────────────────────────────────── */\r\n\r\nexport const onLeadUpdated = onDocumentUpdated('leads/{leadId}', async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    const leadId = event.params.leadId;\r\n\r\n    // Collect all changed fields and their target mappings\r\n    // ── CASCADE POINT: Lead fields ──────────────────────────\r\n    const nameChanged = changed(before, after, 'businessName');\r\n    const emailChanged = changed(before, after, 'email');\r\n    const contactChanged = changed(before, after, 'contactName');\r\n\r\n    if (!nameChanged && !emailChanged && !contactChanged) return;\r\n\r\n    logger.info(`[Cascade:Lead] ${leadId} — name:${nameChanged} email:${emailChanged} contact:${contactChanged}`);\r\n\r\n    const batch = db.batch();\r\n    let count = 0;\r\n\r\n    // Quotes — leadBusinessName\r\n    if (nameChanged) {\r\n        const snap = await db.collection('quotes').where('leadId', '==', leadId).get();\r\n        for (const d of snap.docs) { batch.update(d.ref, { leadBusinessName: after.businessName }); count++; }\r\n    }\r\n\r\n    // Contracts — clientBusinessName\r\n    if (nameChanged) {\r\n        const snap = await db.collection('contracts').where('leadId', '==', leadId).get();\r\n        for (const d of snap.docs) { batch.update(d.ref, { clientBusinessName: after.businessName }); count++; }\r\n    }\r\n\r\n    // Work Orders — businessName + companyName\r\n    if (nameChanged) {\r\n        const snap = await db.collection('work_orders').where('leadId', '==', leadId).get();\r\n        for (const d of snap.docs) { batch.update(d.ref, { businessName: after.businessName, companyName: after.businessName }); count++; }\r\n    }\r\n\r\n    // Invoices — clientBusinessName, clientEmail, clientContactName\r\n    {\r\n        const patch: Record<string, any> = {};\r\n        if (nameChanged) patch.clientBusinessName = after.businessName;\r\n        if (emailChanged) patch.clientEmail = after.email;\r\n        if (contactChanged) patch.clientContactName = after.contactName;\r\n\r\n        if (Object.keys(patch).length > 0) {\r\n            const snap = await db.collection('invoices').where('leadId', '==', leadId).get();\r\n            for (const d of snap.docs) { batch.update(d.ref, patch); count++; }\r\n        }\r\n    }\r\n\r\n    // Site Visits — clientBusinessName\r\n    if (nameChanged) {\r\n        const snap = await db.collection('site_visits').where('leadId', '==', leadId).get();\r\n        for (const d of snap.docs) { batch.update(d.ref, { clientBusinessName: after.businessName }); count++; }\r\n    }\r\n\r\n    if (count > 0) {\r\n        await batch.commit();\r\n        logger.info(`[Cascade:Lead] Updated ${count} docs for \"${after.businessName}\"`);\r\n    }\r\n});\r\n\r\n/* ─── Vendor cascade ───────────────────────────────────────────────── */\r\n\r\nexport const onVendorUpdated = onDocumentUpdated('vendors/{vendorId}', async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    const vendorId = event.params.vendorId;\r\n\r\n    // ── CASCADE POINT: Vendor fields ────────────────────────\r\n    const nameChanged = changed(before, after, 'businessName');\r\n    const emailChanged = changed(before, after, 'email');\r\n\r\n    if (!nameChanged && !emailChanged) return;\r\n\r\n    logger.info(`[Cascade:Vendor] ${vendorId} — name:${nameChanged} email:${emailChanged}`);\r\n\r\n    const batch = db.batch();\r\n    let count = 0;\r\n\r\n    // Vendor Remittances — vendorName, vendorEmail\r\n    {\r\n        const patch: Record<string, any> = {};\r\n        if (nameChanged) patch.vendorName = after.businessName;\r\n        if (emailChanged) patch.vendorEmail = after.email;\r\n\r\n        if (Object.keys(patch).length > 0) {\r\n            const snap = await db.collection('vendor_remittances').where('vendorId', '==', vendorId).get();\r\n            for (const d of snap.docs) { batch.update(d.ref, patch); count++; }\r\n        }\r\n    }\r\n\r\n    // Work Orders — vendorHistory[].vendorName (array rewrite)\r\n    if (nameChanged) {\r\n        const snap = await db.collection('work_orders').where('assignedVendorId', '==', vendorId).get();\r\n        for (const d of snap.docs) {\r\n            const data = d.data();\r\n            if (data.vendorHistory && Array.isArray(data.vendorHistory)) {\r\n                const updated = data.vendorHistory.map((entry: any) =>\r\n                    entry.vendorId === vendorId ? { ...entry, vendorName: after.businessName } : entry\r\n                );\r\n                batch.update(d.ref, { vendorHistory: updated });\r\n                count++;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Check-Ins — vendorName\r\n    if (nameChanged) {\r\n        const snap = await db.collection('check_ins').where('vendorId', '==', vendorId).get();\r\n        for (const d of snap.docs) { batch.update(d.ref, { vendorName: after.businessName }); count++; }\r\n    }\r\n\r\n    if (count > 0) {\r\n        await batch.commit();\r\n        logger.info(`[Cascade:Vendor] Updated ${count} docs for \"${after.businessName}\"`);\r\n    }\r\n});\r\n\r\n/* ─── Staff cascade (users) ────────────────────────────────────────── */\r\n\r\nexport const onStaffUpdated = onDocumentUpdated('users/{userId}', async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    const userId = event.params.userId;\r\n\r\n    // ── CASCADE POINT: Staff fields ─────────────────────────\r\n    const nameChanged = changed(before, after, 'displayName');\r\n    if (!nameChanged) return;\r\n\r\n    const newName = after.displayName;\r\n    const roles: string[] = after.roles || [];\r\n\r\n    logger.info(`[Cascade:Staff] ${userId} displayName → \"${newName}\" (roles: ${roles.join(',')})`);\r\n\r\n    const batch = db.batch();\r\n    let count = 0;\r\n\r\n    // FSM name → quotes, site_visits\r\n    if (roles.includes('fsm') || roles.includes('admin')) {\r\n        // Quotes — assignedFsmName\r\n        const quotesSnap = await db.collection('quotes').where('assignedFsmId', '==', userId).get();\r\n        for (const d of quotesSnap.docs) { batch.update(d.ref, { assignedFsmName: newName }); count++; }\r\n\r\n        // Site Visits — fsmName\r\n        const svSnap = await db.collection('site_visits').where('fsmId', '==', userId).get();\r\n        for (const d of svSnap.docs) { batch.update(d.ref, { fsmName: newName }); count++; }\r\n    }\r\n\r\n    // Night Manager name → check_ins, work_orders\r\n    if (roles.includes('night_manager') || roles.includes('night_mgr') || roles.includes('admin')) {\r\n        // Check-Ins — nightManagerName\r\n        const ciSnap = await db.collection('check_ins').where('nightManagerId', '==', userId).get();\r\n        for (const d of ciSnap.docs) { batch.update(d.ref, { nightManagerName: newName }); count++; }\r\n\r\n        // Work Orders — assignedNightManagerName\r\n        const woSnap = await db.collection('work_orders').where('assignedNightManagerId', '==', userId).get();\r\n        for (const d of woSnap.docs) { batch.update(d.ref, { assignedNightManagerName: newName }); count++; }\r\n    }\r\n\r\n    if (count > 0) {\r\n        await batch.commit();\r\n        logger.info(`[Cascade:Staff] Updated ${count} docs for \"${newName}\"`);\r\n    }\r\n});\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport { onCall, HttpsError } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * AI Template Optimizer\r\n *\r\n * Analyzes email template performance stats and uses Gemini\r\n * to suggest improved subject lines and body copy.\r\n *\r\n * Can be triggered:\r\n * 1. On a weekly schedule (auto-checks underperformers)\r\n * 2. On-demand via callable from admin UI\r\n */\r\n\r\n// ─── Weekly Auto-Check ───────────────────────────────────────────\r\nexport const weeklyTemplateOptimizer = onSchedule({\r\n    schedule: \"every monday 09:00\",\r\n    timeZone: \"America/New_York\",\r\n    secrets: [\"GEMINI_API_KEY\"],\r\n    memory: '512MiB',\r\n}, async () => {\r\n    logger.info(\"Running weekly template optimization check...\");\r\n    await optimizeUnderperformingTemplates();\r\n});\r\n\r\n// ─── On-Demand from Admin ────────────────────────────────────────\r\nexport const optimizeTemplate = onCall({\r\n    secrets: [\"GEMINI_API_KEY\"],\r\n    memory: '512MiB',\r\n}, async (request) => {\r\n    // Only admins can trigger this\r\n    if (!request.auth) {\r\n        throw new HttpsError('unauthenticated', 'Must be logged in');\r\n    }\r\n\r\n    const templateId = request.data?.templateId;\r\n\r\n    if (templateId) {\r\n        // Optimize specific template\r\n        const result = await optimizeSingleTemplate(templateId);\r\n        return result;\r\n    } else {\r\n        // Optimize all underperformers\r\n        const results = await optimizeUnderperformingTemplates();\r\n        return { optimized: results };\r\n    }\r\n});\r\n\r\n// ─── Core Logic ──────────────────────────────────────────────────\r\n\r\nconst MIN_SENDS_FOR_ANALYSIS = 10; // Need at least 10 sends for meaningful data\r\nconst LOW_OPEN_RATE_THRESHOLD = 0.30; // < 30% = underperforming\r\n\r\nasync function optimizeUnderperformingTemplates(): Promise<string[]> {\r\n    const templatesSnap = await db.collection('templates')\r\n        .where('category', '==', 'vendor')\r\n        .get();\r\n\r\n    const optimized: string[] = [];\r\n\r\n    for (const doc of templatesSnap.docs) {\r\n        const template = doc.data();\r\n        const stats = template.stats;\r\n\r\n        if (!stats || stats.sent < MIN_SENDS_FOR_ANALYSIS) continue;\r\n\r\n        const openRate = stats.sent > 0 ? stats.opened / stats.sent : 0;\r\n\r\n        if (openRate < LOW_OPEN_RATE_THRESHOLD) {\r\n            logger.info(`Template ${doc.id}: ${(openRate * 100).toFixed(1)}% open rate — optimizing`);\r\n            await optimizeSingleTemplate(doc.id);\r\n            optimized.push(doc.id);\r\n        }\r\n    }\r\n\r\n    if (optimized.length === 0) {\r\n        logger.info(\"No underperforming templates found.\");\r\n    }\r\n\r\n    return optimized;\r\n}\r\n\r\nasync function optimizeSingleTemplate(templateId: string) {\r\n    const templateDoc = await db.collection('templates').doc(templateId).get();\r\n    if (!templateDoc.exists) {\r\n        throw new HttpsError('not-found', `Template ${templateId} not found`);\r\n    }\r\n\r\n    const template = templateDoc.data()!;\r\n    const stats = template.stats || { sent: 0, delivered: 0, opened: 0, clicked: 0, bounced: 0 };\r\n    const openRate = stats.sent > 0 ? ((stats.opened / stats.sent) * 100).toFixed(1) : 'N/A';\r\n    const clickRate = stats.opened > 0 ? ((stats.clicked / stats.opened) * 100).toFixed(1) : 'N/A';\r\n    const bounceRate = stats.sent > 0 ? ((stats.bounced / stats.sent) * 100).toFixed(1) : 'N/A';\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new HttpsError('failed-precondition', 'GEMINI_API_KEY not set');\r\n    }\r\n\r\n    const prompt = `You are an email marketing expert specializing in B2B contractor outreach for facility management companies.\r\n\r\n## Current Template Performance\r\n- Template: \"${template.name}\" (${templateId})\r\n- Sent: ${stats.sent} | Delivered: ${stats.delivered} | Opened: ${stats.opened} | Clicked: ${stats.clicked}\r\n- Open Rate: ${openRate}% | Click Rate: ${clickRate}% | Bounce Rate: ${bounceRate}%\r\n\r\n## Current Subject Line\r\n\"${template.subject}\"\r\n\r\n## Current Email Body\r\n${template.body}\r\n\r\n## Context\r\nThis email targets independent contractors (janitorial, HVAC, cleaning, etc.) to join a facility management network. The CTA is to click a link and complete an onboarding profile. These are small business owners or independent operators — keep tone professional but blue-collar-friendly.\r\n\r\n## Available Merge Variables\r\n{{vendorName}}, {{contactName}}, {{city}}, {{state}}, {{services}}, {{specialty}}, {{onboardingUrl}}\r\n\r\n## Instructions\r\nBased on the performance data, suggest improvements. Return your response as JSON:\r\n{\r\n  \"analysis\": \"Brief analysis of why this template may be underperforming\",\r\n  \"suggestions\": [\r\n    {\r\n      \"subject\": \"Improved subject line option 1\",\r\n      \"body\": \"Improved email body option 1 (keep merge variables, keep it concise)\",\r\n      \"rationale\": \"Why this version should perform better\"\r\n    },\r\n    {\r\n      \"subject\": \"Improved subject line option 2\",\r\n      \"body\": \"Improved email body option 2\",\r\n      \"rationale\": \"Why this version should perform better\"\r\n    }\r\n  ],\r\n  \"shortUrlTest\": {\r\n    \"recommendation\": \"Whether to test short vs long onboarding URL display\",\r\n    \"shortVariant\": \"Suggested short CTA text and link format if applicable\"\r\n  }\r\n}\r\n\r\nReturn ONLY valid JSON, no markdown fences.`;\r\n\r\n    try {\r\n        const response = await fetch(\r\n            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,\r\n            {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    contents: [{ parts: [{ text: prompt }] }],\r\n                    generationConfig: {\r\n                        temperature: 0.7,\r\n                        maxOutputTokens: 2000,\r\n                    },\r\n                }),\r\n            }\r\n        );\r\n\r\n        const result = await response.json();\r\n        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;\r\n\r\n        if (!text) {\r\n            logger.error('No response from Gemini for template optimization');\r\n            throw new HttpsError('internal', 'Gemini returned empty response');\r\n        }\r\n\r\n        // Parse JSON (strip markdown fences if present)\r\n        const cleanText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\r\n        const suggestions = JSON.parse(cleanText);\r\n\r\n        // Store suggestions on the template\r\n        await db.collection('templates').doc(templateId).update({\r\n            aiSuggestions: admin.firestore.FieldValue.arrayUnion({\r\n                ...suggestions,\r\n                generatedAt: new Date(),\r\n                performanceSnapshot: stats,\r\n            }),\r\n            lastOptimizedAt: new Date(),\r\n        });\r\n\r\n        logger.info(`Template ${templateId}: AI suggestions stored (${suggestions.suggestions?.length || 0} variants)`);\r\n\r\n        return {\r\n            templateId,\r\n            analysis: suggestions.analysis,\r\n            suggestionsCount: suggestions.suggestions?.length || 0,\r\n            shortUrlTest: suggestions.shortUrlTest,\r\n        };\r\n    } catch (err) {\r\n        logger.error(`AI optimization failed for ${templateId}:`, err);\r\n        throw new HttpsError('internal', `AI optimization failed: ${err}`);\r\n    }\r\n}\r\n","/**\r\n * Facebook Graph API Utility\r\n * Manages posting and insights for the XIRI Facility Solutions Facebook Business Page.\r\n * Uses a never-expiring System User token stored in Secret Manager.\r\n */\r\n\r\nconst GRAPH_API_VERSION = \"v21.0\";\r\nconst GRAPH_BASE_URL = `https://graph.facebook.com/${GRAPH_API_VERSION}`;\r\n\r\n// Page ID for XIRI Facility Solutions\r\nconst PAGE_ID = \"946781681862472\";\r\n\r\nexport interface FacebookPostResult {\r\n    id: string;\r\n    success: boolean;\r\n    postUrl?: string;\r\n    error?: string;\r\n}\r\n\r\nexport interface FacebookPost {\r\n    id: string;\r\n    message?: string;\r\n    created_time: string;\r\n    full_picture?: string;\r\n    permalink_url?: string;\r\n    likes?: { summary: { total_count: number } };\r\n    comments?: { summary: { total_count: number } };\r\n    shares?: { count: number };\r\n}\r\n\r\nexport interface FacebookInsights {\r\n    page_impressions?: number;\r\n    page_engaged_users?: number;\r\n    page_fans?: number;\r\n    page_post_engagements?: number;\r\n}\r\n\r\n/**\r\n * Get the Facebook Page Access Token from environment (set via Secret Manager)\r\n */\r\nfunction getAccessToken(): string {\r\n    const token = process.env.FACEBOOK_PAGE_ACCESS_TOKEN;\r\n    if (!token) {\r\n        throw new Error(\"FACEBOOK_PAGE_ACCESS_TOKEN not found in environment.\");\r\n    }\r\n    return token;\r\n}\r\n\r\n/**\r\n * Publish a text post to the Facebook Page\r\n */\r\nexport async function publishPost(\r\n    message: string,\r\n    link?: string,\r\n    imageUrl?: string\r\n): Promise<FacebookPostResult> {\r\n    const token = getAccessToken();\r\n\r\n    try {\r\n        let endpoint = `${GRAPH_BASE_URL}/${PAGE_ID}/feed`;\r\n        const body: Record<string, string> = {\r\n            message,\r\n            access_token: token,\r\n        };\r\n\r\n        if (link) {\r\n            body.link = link;\r\n        }\r\n\r\n        // If image URL provided, use /photos endpoint instead\r\n        if (imageUrl) {\r\n            endpoint = `${GRAPH_BASE_URL}/${PAGE_ID}/photos`;\r\n            body.url = imageUrl;\r\n        }\r\n\r\n        const response = await fetch(endpoint, {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify(body),\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.error) {\r\n            console.error(\"Facebook API error:\", data.error);\r\n            return {\r\n                id: \"\",\r\n                success: false,\r\n                error: data.error.message || \"Unknown Facebook API error\",\r\n            };\r\n        }\r\n\r\n        const postId = data.id || data.post_id;\r\n        return {\r\n            id: postId,\r\n            success: true,\r\n            postUrl: `https://facebook.com/${postId}`,\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"Facebook publish error:\", error);\r\n        return {\r\n            id: \"\",\r\n            success: false,\r\n            error: error.message || \"Failed to publish to Facebook\",\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Schedule a post for future publication\r\n */\r\nexport async function schedulePost(\r\n    message: string,\r\n    scheduledTime: Date,\r\n    link?: string\r\n): Promise<FacebookPostResult> {\r\n    const token = getAccessToken();\r\n\r\n    // Facebook requires timestamps to be at least 10 minutes in the future\r\n    // and at most 75 days out\r\n    const unixTimestamp = Math.floor(scheduledTime.getTime() / 1000);\r\n\r\n    try {\r\n        const body: Record<string, string | number | boolean> = {\r\n            message,\r\n            access_token: token,\r\n            published: false,\r\n            scheduled_publish_time: unixTimestamp,\r\n        };\r\n\r\n        if (link) {\r\n            body.link = link;\r\n        }\r\n\r\n        const response = await fetch(`${GRAPH_BASE_URL}/${PAGE_ID}/feed`, {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify(body),\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.error) {\r\n            console.error(\"Facebook schedule error:\", data.error);\r\n            return {\r\n                id: \"\",\r\n                success: false,\r\n                error: data.error.message || \"Failed to schedule post\",\r\n            };\r\n        }\r\n\r\n        return {\r\n            id: data.id,\r\n            success: true,\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"Facebook schedule error:\", error);\r\n        return {\r\n            id: \"\",\r\n            success: false,\r\n            error: error.message || \"Failed to schedule post\",\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get recent posts from the page with engagement metrics\r\n */\r\nexport async function getRecentPosts(limit: number = 10): Promise<FacebookPost[]> {\r\n    const token = getAccessToken();\r\n\r\n    try {\r\n        const fields = \"id,message,created_time,full_picture,permalink_url,likes.summary(true),comments.summary(true),shares\";\r\n        const response = await fetch(\r\n            `${GRAPH_BASE_URL}/${PAGE_ID}/feed?fields=${fields}&limit=${limit}&access_token=${token}`\r\n        );\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.error) {\r\n            console.error(\"Facebook get posts error:\", data.error);\r\n            return [];\r\n        }\r\n\r\n        return data.data || [];\r\n    } catch (error: any) {\r\n        console.error(\"Facebook get posts error:\", error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Get page insights for a given period\r\n */\r\nexport async function getPageInsights(\r\n    period: \"day\" | \"week\" | \"days_28\" = \"week\"\r\n): Promise<FacebookInsights> {\r\n    const token = getAccessToken();\r\n\r\n    try {\r\n        const metrics = \"page_impressions,page_engaged_users,page_fans,page_post_engagements\";\r\n        const response = await fetch(\r\n            `${GRAPH_BASE_URL}/${PAGE_ID}/insights?metric=${metrics}&period=${period}&access_token=${token}`\r\n        );\r\n\r\n        const data = await response.json();\r\n\r\n        if (data.error) {\r\n            console.error(\"Facebook insights error:\", data.error);\r\n            return {};\r\n        }\r\n\r\n        const insights: FacebookInsights = {};\r\n        for (const metric of data.data || []) {\r\n            const key = metric.name as keyof FacebookInsights;\r\n            const value = metric.values?.[0]?.value;\r\n            if (value !== undefined) {\r\n                insights[key] = value;\r\n            }\r\n        }\r\n\r\n        return insights;\r\n    } catch (error: any) {\r\n        console.error(\"Facebook insights error:\", error);\r\n        return {};\r\n    }\r\n}\r\n\r\n/**\r\n * Delete a post from the page\r\n */\r\nexport async function deletePost(postId: string): Promise<boolean> {\r\n    const token = getAccessToken();\r\n\r\n    try {\r\n        const response = await fetch(\r\n            `${GRAPH_BASE_URL}/${postId}?access_token=${token}`,\r\n            { method: \"DELETE\" }\r\n        );\r\n\r\n        const data = await response.json();\r\n        return data.success === true;\r\n    } catch (error: any) {\r\n        console.error(\"Facebook delete post error:\", error);\r\n        return false;\r\n    }\r\n}\r\n","/**\r\n * AI Social Content Generator\r\n * Runs on a schedule, fetches Facebook engagement data, \r\n * and uses Gemini to generate draft posts for review.\r\n */\r\n\r\nimport { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { db } from \"../utils/firebase\";\r\nimport { getRecentPosts } from \"../utils/facebookApi\";\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\n\r\ninterface SocialConfig {\r\n    platform: string;\r\n    cadence: \"daily\" | \"3x_week\" | \"2x_week\" | \"weekly\";\r\n    preferredDays: string[];\r\n    preferredTime: string;\r\n    tone: string;\r\n    topics: string[];\r\n    hashtagSets: string[];\r\n    enabled: boolean;\r\n}\r\n\r\nconst DAY_MAP: Record<string, number> = {\r\n    sunday: 0, monday: 1, tuesday: 2, wednesday: 3,\r\n    thursday: 4, friday: 5, saturday: 6,\r\n};\r\n\r\n/**\r\n * Build the Gemini prompt using engagement data and config\r\n */\r\nfunction buildPrompt(\r\n    config: SocialConfig,\r\n    engagementSummary: string,\r\n    recentPostSummaries: string[]\r\n): string {\r\n    return `You are the social media manager for XIRI Facility Solutions, a facility management company based in New York that services commercial and medical buildings across Queens, Nassau, and Suffolk County.\r\n\r\n## BUSINESS CONTEXT\r\n- XIRI hires independent sub-contractors (cleaning, HVAC, maintenance, specialty trades) to fulfill contracts XIRI holds with medical offices, urgent care clinics, auto dealerships, and commercial facilities.\r\n- For CONTRACTORS: We offer steady contract work, one point of contact, fast payouts (10th of the month), no franchise fees.\r\n- For CLIENTS: We are their single point of contact for all facility maintenance — one call, one invoice, audit-ready standards.\r\n- Website: xiri.ai\r\n- Service Areas: Queens, Nassau County, Suffolk County, Long Island\r\n\r\n## ENGAGEMENT DATA (Last 20 Posts)\r\n${engagementSummary}\r\n\r\n## RECENT POST THEMES (avoid repeating these)\r\n${recentPostSummaries.length > 0 ? recentPostSummaries.map((s, i) => `${i + 1}. ${s}`).join(\"\\n\") : \"No recent posts yet.\"}\r\n\r\n## CONTENT PREFERENCES\r\n- Tone: ${config.tone || \"Professional, bold, blue-collar-friendly but executive-grade\"}\r\n- Topics to focus on: ${config.topics.length > 0 ? config.topics.join(\", \") : \"contractor recruitment, client success, industry tips, behind-the-scenes, company culture\"}\r\n- Hashtags to include: ${config.hashtagSets.length > 0 ? config.hashtagSets.join(\" \") : \"#FacilityManagement #CommercialCleaning #LongIsland #Queens #NYContractors\"}\r\n\r\n## YOUR TASK\r\nGenerate exactly 1 Facebook post for XIRI Facility Solutions. The post should:\r\n\r\n1. Be formatted for Facebook (use emoji as paragraph-style bullets, not checkmarks)\r\n2. Be 100-250 words\r\n3. Include a clear call-to-action\r\n4. Include relevant hashtags at the end\r\n5. Be different from the recent posts listed above\r\n6. Drive engagement (likes, comments, shares) based on what performed well in the engagement data\r\n7. Alternate between targeting CONTRACTORS (recruitment) and CLIENTS (lead gen) — choose whichever was NOT the focus of the most recent posts\r\n8. Be written in a natural, human voice — not corporate jargon\r\n9. If targeting contractors, emphasize: steady work, fast pay, no admin hassle\r\n10. If targeting clients, emphasize: one-call solution, audit-ready, quality assurance, consolidated billing\r\n\r\nRespond with ONLY the post text. No introductions, no explanations, just the ready-to-publish Facebook post.`;\r\n}\r\n\r\n/**\r\n * Analyze engagement data from recent posts\r\n */\r\nfunction summarizeEngagement(posts: any[]): {\r\n    summary: string;\r\n    themes: string[];\r\n    avgLikes: number;\r\n    avgComments: number;\r\n    avgShares: number;\r\n} {\r\n    if (posts.length === 0) {\r\n        return {\r\n            summary: \"No previous posts to analyze.\",\r\n            themes: [],\r\n            avgLikes: 0,\r\n            avgComments: 0,\r\n            avgShares: 0,\r\n        };\r\n    }\r\n\r\n    const totalLikes = posts.reduce(\r\n        (sum: number, p: any) => sum + (p.likes?.summary?.total_count || 0), 0\r\n    );\r\n    const totalComments = posts.reduce(\r\n        (sum: number, p: any) => sum + (p.comments?.summary?.total_count || 0), 0\r\n    );\r\n    const totalShares = posts.reduce(\r\n        (sum: number, p: any) => sum + (p.shares?.count || 0), 0\r\n    );\r\n\r\n    const avgLikes = Math.round(totalLikes / posts.length);\r\n    const avgComments = Math.round(totalComments / posts.length);\r\n    const avgShares = Math.round(totalShares / posts.length);\r\n\r\n    // Find top performing posts\r\n    const sorted = [...posts].sort((a: any, b: any) => {\r\n        const aScore = (a.likes?.summary?.total_count || 0) + (a.comments?.summary?.total_count || 0) * 3 + (a.shares?.count || 0) * 5;\r\n        const bScore = (b.likes?.summary?.total_count || 0) + (b.comments?.summary?.total_count || 0) * 3 + (b.shares?.count || 0) * 5;\r\n        return bScore - aScore;\r\n    });\r\n\r\n    const topPost = sorted[0];\r\n    const topTheme = topPost?.message?.slice(0, 80) || \"N/A\";\r\n\r\n    const themes = posts\r\n        .filter((p: any) => p.message)\r\n        .map((p: any) => p.message!.split(\"\\n\")[0].slice(0, 60));\r\n\r\n    const summary = `\r\n- Total posts analyzed: ${posts.length}\r\n- Average likes per post: ${avgLikes}\r\n- Average comments per post: ${avgComments}\r\n- Average shares per post: ${avgShares}\r\n- Top performing post theme: \"${topTheme}...\"\r\n- Best engagement driver: ${avgShares > avgComments ? \"Shares\" : avgComments > avgLikes ? \"Comments\" : \"Likes\"}\r\n    `.trim();\r\n\r\n    return { summary, themes, avgLikes, avgComments, avgShares };\r\n}\r\n\r\n/**\r\n * Calculate the next N posting dates based on cadence config\r\n */\r\nfunction getNextPostingDates(config: SocialConfig, count: number): Date[] {\r\n    const dates: Date[] = [];\r\n    const [hours, minutes] = (config.preferredTime || \"10:00\").split(\":\").map(Number);\r\n    const now = new Date();\r\n    let cursor = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n\r\n    // If today's posting time hasn't passed yet, include today\r\n    const todayPost = new Date(cursor.getTime());\r\n    todayPost.setHours(hours, minutes, 0, 0);\r\n\r\n    // Start from today if time hasn't passed, otherwise tomorrow\r\n    if (now >= todayPost) {\r\n        cursor.setDate(cursor.getDate() + 1);\r\n    }\r\n\r\n    let safety = 0;\r\n    while (dates.length < count && safety < 30) {\r\n        safety++;\r\n        const dayOfWeek = cursor.getDay();\r\n\r\n        let isPostingDay = false;\r\n        if (config.cadence === \"daily\") {\r\n            isPostingDay = true;\r\n        } else {\r\n            isPostingDay = config.preferredDays.some(\r\n                (day) => DAY_MAP[day.toLowerCase()] === dayOfWeek\r\n            );\r\n        }\r\n\r\n        if (isPostingDay) {\r\n            const postDate = new Date(cursor.getTime());\r\n            postDate.setHours(hours, minutes, 0, 0);\r\n            dates.push(postDate);\r\n        }\r\n\r\n        cursor.setDate(cursor.getDate() + 1);\r\n    }\r\n\r\n    return dates;\r\n}\r\n\r\n/**\r\n * Main function: Ensure 3 upcoming drafts are always queued\r\n */\r\nexport async function generateSocialContent(): Promise<void> {\r\n    console.log(\"[SocialGenerator] Starting content generation...\");\r\n\r\n    // 1. Read config\r\n    const configDoc = await db.collection(\"social_config\").doc(\"facebook\").get();\r\n    if (!configDoc.exists) {\r\n        console.log(\"[SocialGenerator] No social config found. Skipping.\");\r\n        return;\r\n    }\r\n\r\n    const config = configDoc.data() as SocialConfig;\r\n    if (!config.enabled) {\r\n        console.log(\"[SocialGenerator] Social posting is disabled. Skipping.\");\r\n        return;\r\n    }\r\n\r\n    // 2. Get the next 3 posting dates\r\n    const TARGET_QUEUE_SIZE = 3;\r\n    const upcomingDates = getNextPostingDates(config, TARGET_QUEUE_SIZE);\r\n    console.log(`[SocialGenerator] Next ${TARGET_QUEUE_SIZE} posting dates:`, upcomingDates.map(d => d.toISOString()));\r\n\r\n    // 3. Check which dates already have drafts\r\n    const now = new Date();\r\n    const pendingDrafts = await db.collection(\"social_posts\")\r\n        .where(\"status\", \"in\", [\"draft\", \"approved\"])\r\n        .where(\"scheduledFor\", \">\", now)\r\n        .get();\r\n\r\n    const existingScheduledTimes = new Set(\r\n        pendingDrafts.docs.map(d => {\r\n            const sf = d.data().scheduledFor;\r\n            return sf?.toDate ? sf.toDate().toISOString() : new Date(sf).toISOString();\r\n        })\r\n    );\r\n\r\n    const datesToGenerate = upcomingDates.filter(\r\n        (d) => !existingScheduledTimes.has(d.toISOString())\r\n    );\r\n\r\n    const currentQueueSize = pendingDrafts.size;\r\n    const slotsToFill = Math.max(0, TARGET_QUEUE_SIZE - currentQueueSize);\r\n\r\n    if (slotsToFill === 0) {\r\n        console.log(`[SocialGenerator] Queue is full (${currentQueueSize}/${TARGET_QUEUE_SIZE}). Skipping.`);\r\n        return;\r\n    }\r\n\r\n    const toGenerate = datesToGenerate.slice(0, slotsToFill);\r\n    if (toGenerate.length === 0) {\r\n        console.log(\"[SocialGenerator] All upcoming dates already have drafts. Skipping.\");\r\n        return;\r\n    }\r\n\r\n    // 4. Fetch engagement data once\r\n    console.log(\"[SocialGenerator] Fetching recent posts for analysis...\");\r\n    const recentPosts = await getRecentPosts(20);\r\n    const { summary, themes, avgLikes, avgComments, avgShares } = summarizeEngagement(recentPosts);\r\n\r\n    // 5. Generate content for each missing slot\r\n    const genAI = new GoogleGenerativeAI(API_KEY);\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n    for (const scheduledFor of toGenerate) {\r\n        try {\r\n            console.log(`[SocialGenerator] Generating draft for ${scheduledFor.toISOString()}...`);\r\n            const prompt = buildPrompt(config, summary, themes);\r\n            const result = await model.generateContent(prompt);\r\n            const generatedMessage = result.response.text().trim();\r\n\r\n            if (!generatedMessage) {\r\n                console.error(\"[SocialGenerator] Gemini returned empty response. Skipping slot.\");\r\n                continue;\r\n            }\r\n\r\n            await db.collection(\"social_posts\").add({\r\n                platform: \"facebook\",\r\n                message: generatedMessage,\r\n                status: \"draft\",\r\n                generatedBy: \"ai\",\r\n                scheduledFor,\r\n                engagementContext: {\r\n                    avgLikes,\r\n                    avgComments,\r\n                    avgShares,\r\n                    topPostThemes: themes.slice(0, 5),\r\n                },\r\n                reviewedBy: null,\r\n                reviewedAt: null,\r\n                rejectionReason: null,\r\n                createdAt: new Date(),\r\n            });\r\n\r\n            // Add the generated message to themes so the next draft in this batch avoids repeating it\r\n            themes.push(generatedMessage.split(\"\\n\")[0].slice(0, 60));\r\n\r\n            console.log(`[SocialGenerator] Draft created for ${scheduledFor.toISOString()}`);\r\n        } catch (err: any) {\r\n            console.error(`[SocialGenerator] Error generating for ${scheduledFor.toISOString()}:`, err.message);\r\n        }\r\n    }\r\n\r\n    console.log(`[SocialGenerator] Done. Generated ${toGenerate.length} draft(s).`);\r\n}\r\n\r\n// Scheduled export: Runs daily at 6 AM ET (11 AM UTC)\r\nexport const runSocialContentGenerator = onSchedule({\r\n    schedule: \"every day 11:00\",\r\n    secrets: [\"GEMINI_API_KEY\", \"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n}, async () => {\r\n    await generateSocialContent();\r\n});\r\n","/**\r\n * Social Publisher\r\n * Runs on a schedule, finds approved posts whose scheduledFor time has passed,\r\n * and publishes them to Facebook via the Graph API.\r\n */\r\n\r\nimport { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport { db } from \"../utils/firebase\";\r\nimport { publishPost } from \"../utils/facebookApi\";\r\n\r\n/**\r\n * Find posts due for publishing:\r\n * - \"approved\" posts past their scheduledFor time\r\n * - \"draft\" posts past their scheduledFor (auto-publish: review window expired)\r\n */\r\nexport async function publishScheduledPosts(): Promise<void> {\r\n    console.log(\"[SocialPublisher] Checking for posts to publish...\");\r\n\r\n    const now = new Date();\r\n\r\n    // Get both approved AND unreviewed drafts past their deadline\r\n    const duePosts = await db.collection(\"social_posts\")\r\n        .where(\"status\", \"in\", [\"approved\", \"draft\"])\r\n        .where(\"scheduledFor\", \"<=\", now)\r\n        .limit(5)\r\n        .get();\r\n\r\n    if (duePosts.empty) {\r\n        console.log(\"[SocialPublisher] No posts due for publishing.\");\r\n        return;\r\n    }\r\n\r\n    console.log(`[SocialPublisher] Found ${duePosts.size} post(s) to publish.`);\r\n\r\n    for (const doc of duePosts.docs) {\r\n        const post = doc.data();\r\n        const wasAutoPublished = post.status === \"draft\"; // Not reviewed by the human\r\n\r\n        try {\r\n            const result = await publishPost(\r\n                post.message,\r\n                post.link || undefined,\r\n                post.imageUrl || undefined\r\n            );\r\n\r\n            if (result.success) {\r\n                await doc.ref.update({\r\n                    status: \"published\",\r\n                    facebookPostId: result.id,\r\n                    postUrl: result.postUrl || null,\r\n                    publishedAt: new Date(),\r\n                    autoPublished: wasAutoPublished,\r\n                });\r\n                console.log(`[SocialPublisher] ${wasAutoPublished ? \"AUTO-\" : \"\"}Published post ${doc.id} -> FB ID: ${result.id}`);\r\n            } else {\r\n                await doc.ref.update({\r\n                    status: \"failed\",\r\n                    error: result.error || \"Unknown publishing error\",\r\n                    failedAt: new Date(),\r\n                });\r\n                console.error(`[SocialPublisher] Failed to publish ${doc.id}: ${result.error}`);\r\n            }\r\n        } catch (error: any) {\r\n            console.error(`[SocialPublisher] Error publishing ${doc.id}:`, error);\r\n            await doc.ref.update({\r\n                status: \"failed\",\r\n                error: error.message || \"Unexpected error\",\r\n                failedAt: new Date(),\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n// Scheduled export: Runs every 30 min to publish approved posts\r\nexport const runSocialPublisher = onSchedule({\r\n    schedule: \"every 30 minutes\",\r\n    secrets: [\"FACEBOOK_PAGE_ACCESS_TOKEN\"],\r\n}, async () => {\r\n    await publishScheduledPosts();\r\n});\r\n"],"mappings":"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","names":["db","error","model","admin","axios","error","db","admin","exports","o","generateST1201","error","import_https","error","import_generative_ai","genAI","import_axios","searchVendorsSoda","axios","error","error","import_firestore","admin","import_generative_ai","error","genAI","model","error","vendorName","vendorLocation","error","enqueueTask","admin","logger","import_generative_ai","admin","API_KEY","genAI","model","db","error","db","error","import_firestore","admin","logger","import_generative_ai","admin","API_KEY","genAI","model","db","db","model","error","db","error","import_firestore","admin","logger","import_generative_ai","admin","logger","genAI","db","model","error","db","error","sendTemplatedEmail","Resend","resend","import_firestore","admin","db","import_firestore","import_params","GEMINI_API_KEY","db","error","import_firestore","admin","logger","import_resend","resend","error","db","import_firestore","admin","logger","db","import_https","admin","logger","db","import_firestore","admin","logger","import_date_fns","db","generateICS","import_https","admin","import_crypto","db","import_firestore","admin","db","error","import_firestore","admin","logger","db","import_firestore","admin","logger","db","import_firestore","admin","logger","db","schedule","import_scheduler","admin","logger","db","changed","import_firestore","admin","logger","db","import_firestore","admin","logger","db","INTERNAL_NOTIFY_EMAIL","import_scheduler","admin","logger","db","import_https","admin","db","error","import_firestore","import_v2","import_scheduler","import_https","admin","logger","db","error","import_scheduler","import_generative_ai","API_KEY","config","genAI","model","import_scheduler","error","error","sendTemplatedEmail","config"]}