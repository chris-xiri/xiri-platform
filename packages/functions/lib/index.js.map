{"version":3,"sources":["../src/utils/queueUtils.ts","../src/utils/emailUtils.ts","../src/index.ts","../src/agents/recruiter.ts","../src/agents/sourcer.ts","../src/triggers/onVendorApproved.ts","../src/triggers/outreachWorker.ts","../src/utils/timeUtils.ts","../src/agents/outreach.ts","../src/triggers/onIncomingMessage.ts","../src/triggers/onDocumentUploaded.ts","../src/agents/documentVerifier.ts"],"sourcesContent":["import * as admin from 'firebase-admin';\r\n\r\nexport type QueueTaskType = 'GENERATE' | 'SEND';\r\nexport type QueueStatus = 'PENDING' | 'RETRY' | 'COMPLETED' | 'FAILED';\r\n\r\nexport interface QueueItem {\r\n    id?: string;\r\n    vendorId: string;\r\n    type: QueueTaskType;\r\n    status: QueueStatus;\r\n    scheduledAt: admin.firestore.Timestamp;\r\n    createdAt: admin.firestore.Timestamp;\r\n    retryCount: number;\r\n    error?: string;\r\n    metadata?: any; // e.g. drafts for SEND task\r\n}\r\n\r\nconst COLLECTION = 'outreach_queue';\r\n\r\nexport async function enqueueTask(db: admin.firestore.Firestore, task: Omit<QueueItem, 'id' | 'createdAt' | 'retryCount' | 'status'>) {\r\n    return db.collection(COLLECTION).add({\r\n        ...task,\r\n        status: 'PENDING',\r\n        retryCount: 0,\r\n        createdAt: new Date() as any\r\n    });\r\n}\r\n\r\nexport async function fetchPendingTasks(db: admin.firestore.Firestore) {\r\n    const now = admin.firestore.Timestamp.now();\r\n\r\n    // Fetch items that are PENDING or RETRY and scheduled time is past\r\n    // NOTE: Requires composite index if we mix filter + sort on different fields extensively.\r\n    // Simple query: Status IN ['PENDING', 'RETRY'] AND scheduledAt <= now\r\n\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .where('scheduledAt', '<=', now)\r\n        .limit(10) // Process in batches\r\n        .get();\r\n\r\n    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as QueueItem));\r\n}\r\n\r\nexport async function updateTaskStatus(db: admin.firestore.Firestore, taskId: string, status: QueueStatus, updates: Partial<QueueItem> = {}) {\r\n    await db.collection(COLLECTION).doc(taskId).update({\r\n        status,\r\n        ...updates\r\n    });\r\n}\r\n","import * as admin from \"firebase-admin\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { Resend } from 'resend';\r\n\r\nconst db = admin.firestore();\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\ninterface EmailTemplate {\r\n    subject: string;\r\n    content: string;\r\n    variables: string[];\r\n}\r\n\r\n/**\r\n * Fetch a template from Firestore\r\n */\r\nexport async function getTemplate(templateId: string): Promise<EmailTemplate | null> {\r\n    try {\r\n        const doc = await db.collection(\"templates\").doc(templateId).get();\r\n        if (!doc.exists) {\r\n            console.error(`Template ${templateId} not found`);\r\n            return null;\r\n        }\r\n        return doc.data() as EmailTemplate;\r\n    } catch (error) {\r\n        console.error(\"Error fetching template:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Replace variables in template content\r\n */\r\nexport function replaceVariables(content: string, variables: Record<string, string>): string {\r\n    return content.replace(/\\{\\{(\\w+)\\}\\}/g, (_, key) => variables[key] || `{{${key}}}`);\r\n}\r\n\r\n/**\r\n * Generate personalized email using AI\r\n */\r\nexport async function generatePersonalizedEmail(\r\n    templateId: string,\r\n    variables: Record<string, string>\r\n): Promise<{ subject: string; body: string } | null> {\r\n    try {\r\n        const template = await getTemplate(templateId);\r\n        if (!template) return null;\r\n\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const prompt = `You are a professional email writer for Xiri Facility Solutions.\r\n\r\nTake this email template and personalize it while maintaining the core message:\r\n\r\nSubject: ${template.subject}\r\nBody:\r\n${template.content}\r\n\r\nVariables to use:\r\n${Object.entries(variables).map(([key, val]) => `- ${key}: ${val}`).join('\\n')}\r\n\r\nInstructions:\r\n1. Replace all {{variables}} with the actual values\r\n2. Make the tone warm and professional\r\n3. Keep it concise (under 150 words)\r\n4. Output ONLY the email in this format:\r\nSUBJECT: [subject line]\r\nBODY:\r\n[email body]`;\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n\r\n        const response = result.response.text();\r\n        const subjectMatch = response.match(/SUBJECT:\\s*(.+)/);\r\n        const bodyMatch = response.match(/BODY:\\s*([\\s\\S]+)/);\r\n\r\n        if (!subjectMatch || !bodyMatch) {\r\n            // Fallback to simple variable replacement\r\n            return {\r\n                subject: replaceVariables(template.subject, variables),\r\n                body: replaceVariables(template.content, variables)\r\n            };\r\n        }\r\n\r\n        return {\r\n            subject: subjectMatch[1].trim(),\r\n            body: bodyMatch[1].trim()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating email:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Extract ZIP code from address string\r\n */\r\nfunction extractZipFromAddress(address?: string): string | null {\r\n    if (!address) return null;\r\n    const zipMatch = address.match(/\\b\\d{5}\\b/);\r\n    return zipMatch ? zipMatch[0] : null;\r\n}\r\n\r\n/**\r\n * Send templated email (mock for now)\r\n */\r\nexport async function sendTemplatedEmail(\r\n    vendorId: string,\r\n    templateId: string,\r\n    customVariables?: Record<string, string>\r\n): Promise<void> {\r\n    try {\r\n        // Fetch vendor data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            console.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n\r\n        const vendor = vendorDoc.data();\r\n\r\n        // Build variables\r\n        const variables = {\r\n            vendorName: vendor?.businessName || \"Vendor\",\r\n            zipCode: vendor?.zipCode || extractZipFromAddress(vendor?.address) || \"your area\",\r\n            specialty: vendor?.specialty || \"your trade\",\r\n            portalLink: `https://xiri.ai/vendor/onboarding/${vendorId}`,\r\n            ...customVariables\r\n        };\r\n\r\n        // Generate email\r\n        const email = await generatePersonalizedEmail(templateId, variables);\r\n        if (!email) {\r\n            console.error(\"Failed to generate email\");\r\n            return;\r\n        }\r\n\r\n        // Send email via Resend\r\n        let resendId: string | undefined;\r\n        try {\r\n            const { data } = await resend.emails.send({\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                to: vendor?.email || '',\r\n                subject: email.subject,\r\n                html: email.body,\r\n            });\r\n            resendId = data?.id;\r\n            console.log(`✅ Email sent to ${vendor?.companyName}: ${email.subject} (Resend ID: ${data?.id})`);\r\n        } catch (error) {\r\n            console.error('❌ Resend API error:', error);\r\n            // Log failure but don't throw - non-blocking\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId,\r\n                type: \"EMAIL_FAILED\",\r\n                description: `Failed to send email: ${email.subject}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                metadata: {\r\n                    templateId,\r\n                    subject: email.subject,\r\n                    to: vendor?.email || \"unknown\",\r\n                    error: String(error)\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Log successful send to vendor_activities\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"EMAIL_SENT\",\r\n            description: `Email sent: ${email.subject}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                templateId,\r\n                subject: email.subject,\r\n                body: email.body,\r\n                to: vendor?.email || \"unknown\",\r\n                resendId // NEW: Track Resend email ID\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error sending email:\", error);\r\n    }\r\n}\r\n","import { onCall, onRequest, HttpsError } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { analyzeVendorLeads } from \"./agents/recruiter\";\r\nimport { searchVendors } from \"./agents/sourcer\";\r\n// import { telegramWebhook, autoApproveVendor, notifyHumanReview, onVendorCreated } from \"./triggers/telegramBot\";\r\nimport { onVendorApproved } from \"./triggers/onVendorApproved\";\r\nimport { processOutreachQueue } from \"./triggers/outreachWorker\";\r\nimport { onIncomingMessage } from \"./triggers/onIncomingMessage\";\r\nimport { onDocumentUploaded } from \"./triggers/onDocumentUploaded\";\r\n\r\n// Load environment variables from .env file\r\nimport * as dotenv from \"dotenv\";\r\ndotenv.config();\r\n\r\n// Initialize Admin only once\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\n// Export Bot Functions (Telegram disabled for now)\r\n// export { telegramWebhook, autoApproveVendor, onVendorCreated, onVendorApproved, processOutreachQueue, onIncomingMessage, onDocumentUploaded };\r\nexport { onVendorApproved, processOutreachQueue, onIncomingMessage, onDocumentUploaded };\r\n\r\n// 1. Lead Sourcing Agent Trigger\r\nexport const generateLeads = onCall({\r\n    secrets: [\"SERPER_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\", // Dashboard Dev\r\n        \"http://localhost:3000\", // Public Site Dev\r\n        \"https://xiri.ai\", // Public Site Production\r\n        \"https://www.xiri.ai\", // Public Site WWW\r\n        \"https://app.xiri.ai\", // Dashboard Production\r\n        \"https://xiri-dashboard.vercel.app\", // Dashboard Vercel\r\n        \"https://xiri-facility-solutions.web.app\", // Firebase Hosting\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n    timeoutSeconds: 540\r\n}, async (request) => {\r\n    const data = request.data || {};\r\n    const query = data.query;\r\n    const location = data.location;\r\n    const hasActiveContract = data.hasActiveContract || false; // Default to false (Building Supply)\r\n\r\n    if (!query || !location) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing 'query' or 'location' in request.\");\r\n    }\r\n\r\n    try {\r\n        console.log(`Analyzing leads for query: ${query}, location: ${location}`);\r\n\r\n        // 1. Source Leads\r\n        const rawVendors = await searchVendors(query, location);\r\n        console.log(`Sourced ${rawVendors.length} vendors.`);\r\n\r\n        // 2. Analyze & Qualify (Recruiter Agent)\r\n        // This function automatically saves qualified vendors to Firestore\r\n        const result = await analyzeVendorLeads(rawVendors, query, hasActiveContract);\r\n\r\n        return {\r\n            message: \"Lead generation process completed.\",\r\n            sourced: rawVendors.length,\r\n            analysis: result\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"Error in generateLeads:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"An internal error occurred.\");\r\n    }\r\n});\r\n\r\n// 2. Clear Pipeline Tool\r\nexport const clearPipeline = onCall({\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    try {\r\n        const snapshot = await db.collection('vendors').get();\r\n\r\n        if (snapshot.empty) {\r\n            return { message: \"Pipeline already empty.\" };\r\n        }\r\n\r\n        // Firestore batch max is 500. If we have more, we need multiple batches.\r\n        // For safe deletion, we'll do chunks of 500.\r\n        let count = 0;\r\n        const chunks = [];\r\n        let currentBatch = db.batch(); // We can't reuse the outer batch easily if we chunk\r\n\r\n        snapshot.docs.forEach((doc, index) => {\r\n            currentBatch.delete(doc.ref);\r\n            count++;\r\n            if (count % 400 === 0) {\r\n                chunks.push(currentBatch.commit());\r\n                currentBatch = db.batch();\r\n            }\r\n        });\r\n\r\n        chunks.push(currentBatch.commit());\r\n        await Promise.all(chunks);\r\n\r\n        return { message: `Cleared ${count} vendors from pipeline.` };\r\n    } catch (error: any) {\r\n        throw new HttpsError(\"internal\", error.message);\r\n    }\r\n});\r\n\r\n// Test Function to manually trigger recruiter agent\r\nexport const runRecruiterAgent = onRequest({ secrets: [\"GEMINI_API_KEY\"] }, async (req, res) => {\r\n    // Mock data for testing\r\n    const rawVendors = req.body.vendors || [\r\n        { name: \"ABC Cleaning\", services: \"We do medical office cleaning and terminal cleaning.\" },\r\n        { name: \"Joe's Pizza\", services: \"Best pizza in town\" },\r\n        { name: \"Elite HVAC\", services: \"Commercial HVAC systems\" }\r\n    ];\r\n\r\n    const result = await analyzeVendorLeads(rawVendors, \"Commercial Cleaning\");\r\n    res.json(result);\r\n});\r\n\r\n\r\n// Test Function to manually trigger notification (Telegram disabled for now)\r\n/* export const testNotification = onRequest(async (req, res) => {\r\n    const vendorId = req.query.vendorId as any;\r\n    if (vendorId) {\r\n        await notifyHumanReview(vendorId);\r\n        res.send(`Notification sent for ${vendorId}`);\r\n    } else {\r\n        res.status(400).send(\"Provide vendorId query param\");\r\n    }\r\n}); */\r\n\r\nexport const testSendEmail = onCall({\r\n    secrets: [\"RESEND_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    const { sendTemplatedEmail } = await import(\"./utils/emailUtils\");\r\n    const { vendorId, templateId } = request.data;\r\n\r\n    if (!vendorId || !templateId) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing vendorId or templateId\");\r\n    }\r\n\r\n    try {\r\n        await sendTemplatedEmail(vendorId, templateId);\r\n        return { success: true, message: `Email sent to vendor ${vendorId}` };\r\n    } catch (error: any) {\r\n        console.error(\"Error sending test email:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to send email\");\r\n    }\r\n});\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { Vendor, RecruitmentAnalysisResult } from \"../utils/types\";\r\n\r\n// Initialize Gemini\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"AIzaSyCSmKaZsBUm4SIrxouk3tAmhHZUY0jClUw\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\nexport const analyzeVendorLeads = async (rawVendors: any[], jobQuery: string, hasActiveContract: boolean = false): Promise<RecruitmentAnalysisResult> => {\r\n    console.log(\"!!! RECRUITER AGENT UPDATED - V3 (Deduplication) !!!\");\r\n    let analyzed = 0;\r\n    let qualified = 0;\r\n    const errors: string[] = [];\r\n    const batch = db.batch();\r\n\r\n    // We process in chunks if rawVendors is huge, but per prompt \"db.batch() ... processing 50+ vendors\"\r\n    // Firestore batch limit is 500. We'll assume rawVendors length < 500 for this iteration or just one batch.\r\n\r\n    // Construct the prompt\r\n    // We will send vendors in a batch to Gemini to save tokens/time if possible, \r\n    // or iterate. The prompt implies \"The function should accept a raw list... and use Gemini to Classify\".\r\n    // Doing it one by one might be slow, doing all at once might hit token limits. \r\n    // Let's do a simple loop for now as it's safer for \"Classify: Identify if the vendor...\". \r\n    // Actually, passing the whole list is better for 50 items.\r\n\r\n    if (rawVendors.length === 0) return { analyzed, qualified, errors };\r\n\r\n    // Determine strictness based on contract status\r\n    // Building Supply (hasActiveContract = false) -> Accept All (0 threshold)\r\n    // Urgent (hasActiveContract = true) -> Strict (50 threshold)\r\n    const threshold = hasActiveContract ? 50 : 0;\r\n    const modeDescription = hasActiveContract\r\n        ? \"URGENT FULFILLMENT: We need high-quality vendors ready to deploy. Be strict.\"\r\n        : \"DATABASE BUILDING: We are building a supply list. ACCEPT ALL VENDORS. Do not filter. Score is for reference only.\";\r\n\r\n    // List to process, defaults to rawVendors if deduplication fails or isn't run\r\n    let vendorsToAnalyze = rawVendors;\r\n\r\n    try {\r\n        // Pre-process for duplicates\r\n        const vendorsToProcess: any[] = [];\r\n        const duplicateUpdates: Promise<any>[] = [];\r\n\r\n        console.log(`Checking ${rawVendors.length} vendors for duplicates...`);\r\n\r\n        for (const vendor of rawVendors) {\r\n            const bName = vendor.name || vendor.companyName || vendor.title;\r\n            if (!bName) {\r\n                vendorsToProcess.push(vendor);\r\n                continue;\r\n            }\r\n\r\n            // Check if exists\r\n            const existingSnapshot = await db.collection('vendors')\r\n                .where('businessName', '==', bName)\r\n                .limit(1)\r\n                .get();\r\n\r\n            if (!existingSnapshot.empty) {\r\n                const docId = existingSnapshot.docs[0].id;\r\n                console.log(`Found existing vendor: ${bName} (${docId}). Updating timestamp.`);\r\n                duplicateUpdates.push(\r\n                    db.collection('vendors').doc(docId).update({\r\n                        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                        // Optional: Add a note or campaign ID if we were tracking campaigns strictly\r\n                        // 'metadata.lastSourcedAt': admin.firestore.FieldValue.serverTimestamp() \r\n                    })\r\n                );\r\n            } else {\r\n                vendorsToProcess.push(vendor);\r\n            }\r\n        }\r\n\r\n        // Execute duplicate updates\r\n        if (duplicateUpdates.length > 0) {\r\n            await Promise.all(duplicateUpdates);\r\n            console.log(`Updated ${duplicateUpdates.length} existing vendors.`);\r\n        }\r\n\r\n        if (vendorsToProcess.length === 0) {\r\n            console.log(\"All vendors were duplicates. Sourcing complete.\");\r\n            return { analyzed, qualified, errors };\r\n        }\r\n\r\n        // Continue with unique vendors\r\n        vendorsToAnalyze = vendorsToProcess;\r\n\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"recruiter_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Recruiter analysis prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const vendorList = JSON.stringify(vendorsToAnalyze.map((v, i) => ({\r\n            index: i,\r\n            name: v.name || v.companyName,\r\n            description: v.description || v.services,\r\n            address: v.location || v.address || v.vicinity, // Google Places often uses 'vicinity'\r\n            website: v.website,\r\n            phone: v.phone\r\n        })));\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{query\\}\\}/g, jobQuery)\r\n            .replace(/\\{\\{modeDescription\\}\\}/g, modeDescription)\r\n            .replace(/\\{\\{threshold\\}\\}/g, threshold.toString())\r\n            .replace(/\\{\\{vendorList\\}\\}/g, vendorList);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        console.log(\"Gemini Raw Response:\", text); // Debug log\r\n\r\n        // Naive JSON clean up\r\n        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\r\n        const analysis = JSON.parse(jsonStr) as any[];\r\n\r\n        analyzed = analysis.length;\r\n\r\n        for (const item of analysis) {\r\n            if (item.isQualified) {\r\n                qualified++;\r\n                // Ensure index matches the filtered list\r\n                const originalVendor = vendorsToAnalyze[item.index];\r\n                if (!originalVendor) {\r\n                    console.warn(`Analysis returned index ${item.index} but we only have ${vendorsToAnalyze.length} vendors.`);\r\n                    continue;\r\n                }\r\n\r\n                // Fallback for business name\r\n                const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n                const vendorRef = db.collection('vendors').doc(); // Auto-ID\r\n                const newVendor: Vendor = {\r\n                    id: vendorRef.id,\r\n                    businessName: bName,\r\n                    capabilities: item.specialty ? [item.specialty] : [],\r\n                    address: originalVendor.location || item.address || \"Unknown\",\r\n                    city: item.city || undefined,\r\n                    state: item.state || undefined,\r\n                    zip: item.zip || undefined,\r\n                    country: item.country || \"USA\",\r\n                    phone: originalVendor.phone || item.phone || undefined,\r\n                    email: originalVendor.email || item.email || undefined,\r\n                    website: originalVendor.website || item.website || undefined,\r\n                    // businessType: item.businessType || \"Unknown\", // Removing as it's not in shared Vendor? Wait, checking shared\r\n                    fitScore: item.fitScore,\r\n                    hasActiveContract: hasActiveContract,\r\n                    onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                    status: 'pending_review',\r\n                    createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                    updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n                };\r\n\r\n                console.log(`Adding qualified vendor to batch: ${newVendor.businessName}`);\r\n                batch.set(vendorRef, newVendor);\r\n            }\r\n        }\r\n\r\n        if (qualified > 0) {\r\n            console.log(`Committing batch of ${qualified} vendors...`);\r\n            await batch.commit();\r\n            console.log(\"Batch commit successful.\");\r\n        } else {\r\n            console.log(\"No qualified vendors to commit.\");\r\n        }\r\n\r\n    } catch (err: any) {\r\n        console.error(\"AI Analysis Failed:\", err.message);\r\n        console.error(\"Prompt used:\", prompt); // Log the prompt to debug formatting issues\r\n        errors.push(err.message);\r\n\r\n        // Fallback: Save vendors without analysis if AI fails\r\n        console.log(\"Saving raw vendors with 'pending_review' status due to AI failure...\");\r\n\r\n        for (const originalVendor of vendorsToAnalyze) {\r\n            const vendorRef = db.collection('vendors').doc();\r\n            // Fallback for business name: Use 'name' or 'companyName' or 'title' from raw source\r\n            const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n            const newVendor: Vendor = {\r\n                id: vendorRef.id,\r\n                businessName: bName,\r\n                capabilities: [],\r\n                address: originalVendor.location || originalVendor.address || \"Unknown\",\r\n                phone: originalVendor.phone || undefined,\r\n                email: originalVendor.email || undefined,\r\n                website: originalVendor.website || undefined,\r\n                fitScore: 0,\r\n                status: 'pending_review',\r\n                hasActiveContract: hasActiveContract,\r\n                onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                aiReasoning: `AI Analysis Failed: ${err.message}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n            };\r\n            batch.set(vendorRef, newVendor);\r\n            qualified++;\r\n        }\r\n\r\n        if (qualified > 0) {\r\n            console.log(`Committing batch of ${qualified} fallback vendors...`);\r\n            await batch.commit();\r\n        }\r\n    }\r\n\r\n    return { analyzed, qualified, errors };\r\n};\r\n","import axios from 'axios';\r\n\r\n// Define the shape of a raw vendor outcome\r\nexport interface RawVendor {\r\n    name: string;\r\n    description: string;\r\n    location: string;\r\n    phone?: string;\r\n    website?: string;\r\n    source: string;\r\n    rating?: number;\r\n    user_ratings_total?: number;\r\n}\r\n\r\n/**\r\n * Lead Sourcing Agent\r\n * Uses Serper.dev (Google Maps) to find vendors.\r\n * \r\n * Requires: process.env.SERPER_API_KEY\r\n */\r\nexport const searchVendors = async (query: string, location: string): Promise<RawVendor[]> => {\r\n    const apiKey = process.env.SERPER_API_KEY || \"02ece77ffd27d2929e3e79604cb27e1dfaa40fe7\";\r\n    if (!apiKey) {\r\n        console.warn(\"SERPER_API_KEY is not set. Returning mock data.\");\r\n        return getMockVendors(query, location);\r\n    }\r\n\r\n    const fullQuery = `${query} in ${location}`;\r\n    console.log(`Searching for: ${fullQuery} using Serper (places)...`);\r\n\r\n    try {\r\n        const response = await axios.post(\r\n            'https://google.serper.dev/places',\r\n            { q: fullQuery },\r\n            { headers: { 'X-API-KEY': apiKey.trim(), 'Content-Type': 'application/json' } }\r\n        );\r\n\r\n        const places = response.data.places || [];\r\n        console.log(`Serper returned ${places.length} raw results.`);\r\n\r\n        // Return results directly from Serper without strict string matching on the city\r\n        // This allows \"NYC\" -> \"New York\" matches to persist.\r\n        const rawVendors = places.map((place: any) => ({\r\n            name: place.title,\r\n            description: `${place.category || ''} - ${place.address || ''}`,\r\n            location: place.address,\r\n            phone: place.phoneNumber,\r\n            website: place.website,\r\n            source: 'google_maps_serper',\r\n            rating: place.rating,\r\n            user_ratings_total: place.userRatingsTotal\r\n        }));\r\n\r\n        // Filter out low-rated vendors immediately\r\n        const filteredVendors = rawVendors.filter((v: any) => v.rating === undefined || v.rating >= 3.5);\r\n        console.log(`Filtered ${rawVendors.length} -> ${filteredVendors.length} vendors (Rating >= 3.5 or N/A).`);\r\n\r\n        return filteredVendors;\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error searching vendors:\", error.message);\r\n        throw new Error(`Failed to source vendors: ${error.message}`);\r\n    }\r\n};\r\n\r\n// Fallback Mock Data if no API Key\r\nconst getMockVendors = (query: string, location: string): RawVendor[] => {\r\n    return [\r\n        {\r\n            name: \"Mock Cleaning Services \" + location,\r\n            description: \"Deep comercial cleaning and janitorial services.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"Test HVAC Solutions \" + location,\r\n            description: \"HVAC maintenance and repair.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"General Facilities Co\",\r\n            description: \"We do everything including plumbing and electrical.\",\r\n            location: location,\r\n            source: 'mock'\r\n        }\r\n    ];\r\n};\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\n\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\nconsole.log(\"Loading onVendorApproved trigger...\");\r\n\r\nexport const onVendorApproved = onDocumentUpdated(\"vendors/{vendorId}\", async (event) => {\r\n    console.log(\"onVendorApproved triggered!\");\r\n    if (!event.data) {\r\n        console.log(\"No event data.\");\r\n        return;\r\n    }\r\n\r\n    const newData = event.data.after.data();\r\n    const oldData = event.data.before.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!newData || !oldData) return;\r\n\r\n    // Check if status changed to qualified (Human Approval)\r\n    if (newData.status === 'qualified' && oldData.status !== 'qualified') {\r\n        logger.info(`Vendor ${vendorId} approved. Triggering CRM workflow.`);\r\n\r\n        try {\r\n            // 1. Log Activity: \"Vendor Approved\"\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId: vendorId,\r\n                type: \"STATUS_CHANGE\",\r\n                description: \"Vendor status updated to APPROVED by user.\",\r\n                createdAt: new Date(),\r\n                metadata: {\r\n                    oldStatus: oldData.status,\r\n                    newStatus: newData.status\r\n                }\r\n            });\r\n\r\n            // 1b. Update Vendor Document with Outreach Status\r\n            await event.data.after.ref.update({\r\n                outreachStatus: 'PENDING',\r\n                statusUpdatedAt: new Date()\r\n            });\r\n\r\n            // 2. Enqueue Outreach Generation Task\r\n            // Decoupled for resilience (429 retries) and smart scheduling\r\n            const { enqueueTask } = await import(\"../utils/queueUtils\");\r\n\r\n            await enqueueTask(db, {\r\n                vendorId: vendorId,\r\n                type: 'GENERATE',\r\n                scheduledAt: new Date() as any, // Process immediately\r\n                metadata: {\r\n                    status: newData.status,\r\n                    hasActiveContract: newData.hasActiveContract,\r\n                    phone: newData.phone,\r\n                    companyName: newData.businessName, // Updated to match schema\r\n                    specialty: newData.specialty || newData.capabilities?.[0]\r\n                }\r\n            });\r\n\r\n            logger.info(`Outreach generation task enqueued for vendor ${vendorId}`);\r\n        } catch (error) {\r\n            logger.error(\"Error in onVendorApproved workflow:\", error);\r\n        }\r\n    }\r\n});\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport * as admin from 'firebase-admin';\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { fetchPendingTasks, updateTaskStatus, enqueueTask, QueueItem } from \"../utils/queueUtils\";\r\nimport { getNextBusinessSlot } from \"../utils/timeUtils\";\r\nimport { generateOutreachContent } from \"../agents/outreach\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\n// Run every minute to check for pending tasks\r\n// Region must match project config\r\nexport const processOutreachQueue = onSchedule(\"every 1 minutes\", async (event) => {\r\n    logger.info(\"Processing outreach queue...\");\r\n\r\n    try {\r\n        const tasks = await fetchPendingTasks(db);\r\n        if (tasks.length === 0) {\r\n            logger.info(\"No pending tasks found.\");\r\n            return;\r\n        }\r\n\r\n        logger.info(`Found ${tasks.length} tasks to process.`);\r\n\r\n        for (const task of tasks) {\r\n            try {\r\n                if (task.type === 'GENERATE') {\r\n                    await handleGenerate(task);\r\n                } else if (task.type === 'SEND') {\r\n                    await handleSend(task);\r\n                }\r\n            } catch (err) {\r\n                logger.error(`Error processing task ${task.id}:`, err);\r\n                // Simple retry logic: Increment count, set to retry, backoff\r\n                // If > 5 retries, mark FAILED\r\n                const newRetryCount = (task.retryCount || 0) + 1;\r\n                const status = newRetryCount > 5 ? 'FAILED' : 'RETRY';\r\n\r\n                // Exponential backoff for retry (1m, 2m, 4m...)\r\n                const nextAttempt = new Date();\r\n                nextAttempt.setMinutes(nextAttempt.getMinutes() + Math.pow(2, newRetryCount));\r\n\r\n                await updateTaskStatus(db, task.id!, status, {\r\n                    retryCount: newRetryCount,\r\n                    scheduledAt: admin.firestore.Timestamp.fromDate(nextAttempt),\r\n                    error: String(err)\r\n                });\r\n            }\r\n        }\r\n    } catch (error) {\r\n        logger.error(\"Fatal error in queue processor:\", error);\r\n    }\r\n});\r\n\r\nasync function handleGenerate(task: QueueItem) {\r\n    logger.info(`Generating content for task ${task.id}`);\r\n\r\n    // Reconstruct vendor object from metadata\r\n    // In production, might be better to fetch fresh vendor data\r\n    const vendorData = task.metadata;\r\n\r\n    const outreachResult = await generateOutreachContent(vendorData, vendorData.phone ? 'SMS' : 'EMAIL');\r\n\r\n    if (outreachResult.error) {\r\n        throw new Error(\"AI Generation Failed: \" + (outreachResult.sms || \"Unknown Error\"));\r\n    }\r\n\r\n    // 1. Log the drafts (Visible to User)\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: \"OUTREACH_QUEUED\", // Using same type for UI compatibility\r\n        description: `Outreach drafts generated (waiting to send).`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            sms: outreachResult.sms,\r\n            email: outreachResult.email,\r\n            preferredChannel: outreachResult.channel,\r\n            campaignUrgency: vendorData.hasActiveContract ? \"URGENT\" : \"SUPPLY\"\r\n        }\r\n    });\r\n\r\n    // 2. Calculate Schedule\r\n    const scheduledTime = getNextBusinessSlot(vendorData.hasActiveContract ? \"URGENT\" : \"SUPPLY\");\r\n\r\n    // 3. Enqueue SEND Task\r\n    await enqueueTask(db, {\r\n        vendorId: task.vendorId,\r\n        type: 'SEND',\r\n        scheduledAt: admin.firestore.Timestamp.fromDate(scheduledTime),\r\n        metadata: {\r\n            // Pass the generated content along\r\n            sms: outreachResult.sms,\r\n            email: outreachResult.email,\r\n            channel: outreachResult.channel\r\n        }\r\n    });\r\n\r\n    // 4. Mark GENERATE task complete\r\n    await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n    logger.info(`Task ${task.id} completed. Send scheduled for ${scheduledTime.toISOString()}`);\r\n}\r\n\r\nasync function handleSend(task: QueueItem) {\r\n    logger.info(`Executing SEND for task ${task.id}`);\r\n\r\n    // In a real system, call Twilio/SendGrid here.\r\n    // For now, we log the \"Simulated Send\".\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: \"OUTREACH_SENT\",\r\n        description: `Automated ${task.metadata.channel} sent to vendor.`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            channel: task.metadata.channel,\r\n            content: task.metadata.channel === 'SMS' ? task.metadata.sms : task.metadata.email.subject\r\n        }\r\n    });\r\n\r\n    await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n\r\n    // Update Vendor Record\r\n    await db.collection(\"vendors\").doc(task.vendorId).update({\r\n        outreachStatus: 'SENT',\r\n        outreachChannel: task.metadata.channel,\r\n        outreachTime: new Date()\r\n    });\r\n}\r\n","\r\n// Business Hours Config\r\nconst START_HOUR = 9; // 9 AM\r\nconst END_HOUR = 17; // 5 PM\r\n// Timezone offset for Austin, TX (CST)\r\n// const TIMEZONE_OFFSET = -6; // CST (approximate for Austin demo)\r\n\r\nexport function getNextBusinessSlot(urgency: 'URGENT' | 'SUPPLY'): Date {\r\n    const now = new Date();\r\n    // Adjust to target timezone if needed, simple version for demo uses server time (UTC)\r\n    // For robust production, use minimal-timezone or date-fns-tz\r\n\r\n    // Simple logic:\r\n    // If Urgent and within Mon-Fri 9-5: Send in 10 mins.\r\n    // Else: Next Business Day at 9 AM (Urgent) or 10 AM (Supply).\r\n\r\n    const day = now.getDay(); // 0 = Sun, 6 = Sat\r\n    const hour = now.getHours();\r\n\r\n    const isWeekend = day === 0 || day === 6;\r\n    const isBusinessHours = !isWeekend && hour >= START_HOUR && hour < END_HOUR;\r\n\r\n    if (urgency === 'URGENT' && isBusinessHours) {\r\n        // Schedule for 10 minutes from now\r\n        return new Date(now.getTime() + 10 * 60000);\r\n    }\r\n\r\n    // Calculate next business day\r\n    let nextDate = new Date(now);\r\n\r\n    if (day === 5) { // Friday -> Monday\r\n        nextDate.setDate(now.getDate() + 3);\r\n    } else if (day === 6) { // Saturday -> Monday\r\n        nextDate.setDate(now.getDate() + 2);\r\n    } else { // Sun-Thu -> Next Day\r\n        nextDate.setDate(now.getDate() + 1);\r\n    }\r\n\r\n    // Set Time\r\n    nextDate.setHours(urgency === 'URGENT' ? START_HOUR : START_HOUR + 1, 0, 0, 0);\r\n\r\n    // If today is Sunday, we just moved to Monday, which is correct.\r\n    // If today is Friday after 5pm, we moved to Monday, correct.\r\n    // If today is Monday after 5pm, we move to Tuesday, correct.\r\n\r\n    return nextDate;\r\n}\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"AIzaSyCSmKaZsBUm4SIrxouk3tAmhHZUY0jClUw\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\nconst db = admin.firestore();\r\n\r\nexport const generateOutreachContent = async (vendor: any, preferredChannel: 'SMS' | 'EMAIL') => {\r\n    const isUrgent = vendor.hasActiveContract;\r\n    const channel = preferredChannel;\r\n\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"outreach_generation_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Outreach generation prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const campaignContext = isUrgent\r\n            ? \"URGENT JOB OPPORTUNITY (We have a contract ready)\"\r\n            : \"Building Supply Network (Partnership Opportunity)\";\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName)\r\n            .replace(/\\{\\{specialty\\}\\}/g, vendor.specialty || \"Services\")\r\n            .replace(/\\{\\{campaignContext\\}\\}/g, campaignContext);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n\r\n        // Sanitize code blocks if present\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n\r\n        const jsonContent = JSON.parse(text);\r\n\r\n        return {\r\n            channel,\r\n            sms: jsonContent.sms,\r\n            email: jsonContent.email,\r\n            generatedAt: new Date()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating outreach content:\", error);\r\n        return {\r\n            channel,\r\n            sms: \"Error generating SMS.\",\r\n            email: { subject: \"Error\", body: \"Error generating content. Please draft manually.\" },\r\n            error: true\r\n        };\r\n    }\r\n};\r\n\r\n\r\nexport const analyzeIncomingMessage = async (vendor: any, messageContent: string, previousContext: string) => {\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"message_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Message analysis prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName)\r\n            .replace(/\\{\\{messageContent\\}\\}/g, messageContent)\r\n            .replace(/\\{\\{previousContext\\}\\}/g, previousContext)\r\n            .replace(/\\{\\{vendorId\\}\\}/g, vendor.id);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n        const jsonContent = JSON.parse(text);\r\n        return jsonContent;\r\n    } catch (error) {\r\n        console.error(\"Error analyzing message:\", error);\r\n        return { intent: \"OTHER\", reply: \"Error analyzing message.\" };\r\n    }\r\n};\r\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { analyzeIncomingMessage } from \"../agents/outreach\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\nexport const onIncomingMessage = onDocumentCreated(\"vendor_activities/{activityId}\", async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const activity = event.data.data();\r\n    const vendorId = activity.vendorId;\r\n\r\n    // Only process INBOUND_REPLY type\r\n    if (activity.type !== 'INBOUND_REPLY') return;\r\n\r\n    logger.info(`Processing inbound message from vendor ${vendorId}`);\r\n\r\n    try {\r\n        // 1. Fetch Vendor Data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            logger.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n        const vendor = vendorDoc.data();\r\n\r\n        // 2. Fetch Previous Context (Last Outreach Sent)\r\n        // Ideally query for the last OUTREACH_SENT activity\r\n        const lastOutreachSnapshot = await db.collection(\"vendor_activities\")\r\n            .where(\"vendorId\", \"==\", vendorId)\r\n            .where(\"type\", \"==\", \"OUTREACH_SENT\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(1)\r\n            .get();\r\n\r\n        const previousContext = !lastOutreachSnapshot.empty ?\r\n            lastOutreachSnapshot.docs[0].data().description :\r\n            \"Initial outreach sent.\";\r\n\r\n        // 3. Analyze Message\r\n        const analysis = await analyzeIncomingMessage(vendor, activity.description, previousContext);\r\n\r\n        logger.info(`Analysis result for ${vendorId}: ${JSON.stringify(analysis)}`);\r\n\r\n        // 4. Take Action based on Intent\r\n        let newStatus = vendor?.status;\r\n        let actionDescription = \"\";\r\n\r\n        if (analysis.intent === 'INTERESTED') {\r\n            newStatus = 'NEGOTIATING';\r\n            actionDescription = \"Vendor expressed interest. Status updated to NEGOTIATING.\";\r\n        } else if (analysis.intent === 'NOT_INTERESTED') {\r\n            newStatus = 'REJECTED';\r\n            actionDescription = \"Vendor not interested. Status updated to REJECTED.\";\r\n        } else if (analysis.intent === 'QUESTION') {\r\n            newStatus = 'NEGOTIATING'; // Move to negotiating so we handle the Q\r\n            actionDescription = \"Vendor has a question.\";\r\n        } else {\r\n            actionDescription = \"AI could not determine clear intent.\";\r\n        }\r\n\r\n        // 5. Update Status if changed\r\n        if (newStatus && newStatus !== vendor?.status) {\r\n            await db.collection(\"vendors\").doc(vendorId).update({\r\n                status: newStatus,\r\n                statusUpdatedAt: new Date()\r\n            });\r\n            // Log the status change\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId: vendorId,\r\n                type: 'STATUS_CHANGE',\r\n                description: actionDescription,\r\n                createdAt: new Date(),\r\n                metadata: {\r\n                    oldStatus: vendor?.status,\r\n                    newStatus: newStatus,\r\n                    aiIntent: analysis.intent\r\n                }\r\n            });\r\n        }\r\n\r\n        // 6. Draft/Send Reply (Log as AI_REPLY)\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: vendorId,\r\n            type: 'AI_REPLY',\r\n            description: analysis.reply,\r\n            createdAt: new Date(), // Slightly after the inbound\r\n            metadata: {\r\n                intent: analysis.intent,\r\n                inReplyTo: event.params.activityId\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        logger.error(\"Error processing inbound message:\", error);\r\n    }\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { verifyDocument } from \"../agents/documentVerifier\";\r\n\r\nconst db = admin.firestore();\r\n\r\nexport const onDocumentUploaded = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"GEMINI_API_KEY\"]\r\n}, async (event) => {\r\n    const before = event.data?.before.data();\r\n    const after = event.data?.after.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!before || !after) return;\r\n\r\n    // Check COI\r\n    if (after.compliance?.coi?.status === 'PENDING' && before.compliance?.coi?.status !== 'PENDING') {\r\n        console.log(`Processing COI for ${vendorId}`);\r\n        await runVerification(vendorId, 'COI', after);\r\n    }\r\n\r\n    // Check W9\r\n    if (after.compliance?.w9?.status === 'PENDING' && before.compliance?.w9?.status !== 'PENDING') {\r\n        console.log(`Processing W9 for ${vendorId}`);\r\n        await runVerification(vendorId, 'W9', after);\r\n    }\r\n});\r\n\r\nasync function runVerification(vendorId: string, docType: 'COI' | 'W9', vendorData: any) {\r\n    try {\r\n        const result = await verifyDocument(docType, vendorData.companyName || \"Vendor\", vendorData.specialty || \"General\");\r\n\r\n        // Update Vendor\r\n        const fieldPath = docType === 'COI' ? 'compliance.coi' : 'compliance.w9';\r\n        await db.doc(`vendors/${vendorId}`).update({\r\n            [`${fieldPath}.status`]: result.valid ? 'VERIFIED' : 'REJECTED',\r\n            [`${fieldPath}.aiAnalysis`]: {\r\n                valid: result.valid,\r\n                reasoning: result.reasoning,\r\n                extracted: result.extracted\r\n            },\r\n            [`${fieldPath}.verifiedAt`]: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n\r\n        // Log Activity\r\n        await db.collection('vendor_activities').add({\r\n            vendorId: vendorId,\r\n            type: 'AI_VERIFICATION', // New type\r\n            description: `AI ${result.valid ? 'Verified' : 'Rejected'} ${docType}: ${result.reasoning}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                docType,\r\n                valid: result.valid,\r\n                extracted: result.extracted\r\n            }\r\n        });\r\n\r\n        // Send email notification\r\n        if (result.valid) {\r\n            const { sendTemplatedEmail } = await import('../utils/emailUtils');\r\n            await sendTemplatedEmail(vendorId, 'doc_upload_notification', {\r\n                documentType: docType === 'COI' ? 'Certificate of Insurance' : 'W-9 Form'\r\n            });\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(`Verification failed for ${docType}:`, error);\r\n    }\r\n}\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst db = admin.firestore();\r\n\r\ninterface VerificationResult {\r\n    valid: boolean;\r\n    reasoning: string;\r\n    extracted: Record<string, any>;\r\n}\r\n\r\nexport async function verifyDocument(docType: 'COI' | 'W9', vendorName: string, specialty: string): Promise<VerificationResult> {\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n    // Simulate OCR extraction based on the doc type\r\n    // In a real app, this would be the output of a Vision API\r\n    let simulatedOcrText = \"\";\r\n\r\n    if (docType === 'COI') {\r\n        const today = new Date();\r\n        const nextYear = new Date(today);\r\n        nextYear.setFullYear(today.getFullYear() + 1);\r\n\r\n        simulatedOcrText = `\r\n            CERTIFICATE OF LIABILITY INSURANCE\r\n            PRODUCER: State Farm Insurance\r\n            INSURED: ${vendorName}\r\n            \r\n            COVERAGES:\r\n            COMMERCIAL GENERAL LIABILITY\r\n            EACH OCCURRENCE: $2,000,000\r\n            DAMAGE TO RENTED PREMISES: $100,000\r\n            MED EXP: $5,000\r\n            PERSONAL & ADV INJURY: $2,000,000\r\n            GENERAL AGGREGATE: $4,000,000\r\n            \r\n            WORKERS COMPENSATION\r\n            STATUTORY LIMITS: YES\r\n            E.L. EACH ACCIDENT: $1,000,000\r\n            \r\n            POLICY EFF: 01/01/2024\r\n            POLICY EXP: ${nextYear.toLocaleDateString()}\r\n        `;\r\n    } else if (docType === 'W9') {\r\n        simulatedOcrText = `\r\n            Form W-9\r\n            Name: ${vendorName}\r\n            Business Name: ${vendorName} LLC\r\n            Federal Tax Classification: Limited Liability Company\r\n            Address: 123 Main St\r\n            TIN: XX-XXX1234\r\n            Signed: JS\r\n            Date: 01/15/2024\r\n        `;\r\n    }\r\n\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"document_verifier_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Document verifier prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const requirements = docType === 'COI'\r\n            ? 'Must have General Liability > $1,000,000 and valid dates.'\r\n            : 'Must be signed and have a TIN.';\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{documentType\\}\\}/g, docType)\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendorName)\r\n            .replace(/\\{\\{specialty\\}\\}/g, specialty)\r\n            .replace(/\\{\\{requirements\\}\\}/g, requirements)\r\n            .replace(/\\{\\{ocrText\\}\\}/g, simulatedOcrText);\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n        const responseText = result.response.text();\r\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) throw new Error(\"No JSON found in response\");\r\n\r\n        return JSON.parse(jsonMatch[0]) as VerificationResult;\r\n    } catch (error) {\r\n        console.error(\"AI Verification Failed:\", error);\r\n        return {\r\n            valid: false,\r\n            reasoning: \"AI Verification Failed: \" + error,\r\n            extracted: {}\r\n        };\r\n    }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAmBA,eAAsB,YAAYA,MAA+B,MAAqE;AAClI,SAAOA,KAAG,WAAW,UAAU,EAAE,IAAI;AAAA,IACjC,GAAG;AAAA,IACH,QAAQ;AAAA,IACR,YAAY;AAAA,IACZ,WAAW,oBAAI,KAAK;AAAA,EACxB,CAAC;AACL;AAEA,eAAsB,kBAAkBA,MAA+B;AACnE,QAAM,MAAY,iBAAU,UAAU,IAAI;AAM1C,QAAM,WAAW,MAAMA,KAAG,WAAW,UAAU,EAC1C,MAAM,UAAU,MAAM,CAAC,WAAW,OAAO,CAAC,EAC1C,MAAM,eAAe,MAAM,GAAG,EAC9B,MAAM,EAAE,EACR,IAAI;AAET,SAAO,SAAS,KAAK,IAAI,UAAQ,EAAE,IAAI,IAAI,IAAI,GAAG,IAAI,KAAK,EAAE,EAAe;AAChF;AAEA,eAAsB,iBAAiBA,MAA+B,QAAgB,QAAqB,UAA8B,CAAC,GAAG;AACzI,QAAMA,KAAG,WAAW,UAAU,EAAE,IAAI,MAAM,EAAE,OAAO;AAAA,IAC/C;AAAA,IACA,GAAG;AAAA,EACP,CAAC;AACL;AAjDA,IAAAC,QAiBM;AAjBN;AAAA;AAAA;AAAA,IAAAA,SAAuB;AAiBvB,IAAM,aAAa;AAAA;AAAA;;;ACjBnB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAiBA,eAAsB,YAAY,YAAmD;AACjF,MAAI;AACA,UAAM,MAAM,MAAMC,IAAG,WAAW,WAAW,EAAE,IAAI,UAAU,EAAE,IAAI;AACjE,QAAI,CAAC,IAAI,QAAQ;AACb,cAAQ,MAAM,YAAY,UAAU,YAAY;AAChD,aAAO;AAAA,IACX;AACA,WAAO,IAAI,KAAK;AAAA,EACpB,SAASC,QAAO;AACZ,YAAQ,MAAM,4BAA4BA,MAAK;AAC/C,WAAO;AAAA,EACX;AACJ;AAKO,SAAS,iBAAiB,SAAiB,WAA2C;AACzF,SAAO,QAAQ,QAAQ,kBAAkB,CAAC,GAAG,QAAQ,UAAU,GAAG,KAAK,KAAK,GAAG,IAAI;AACvF;AAKA,eAAsB,0BAClB,YACA,WACiD;AACjD,MAAI;AACA,UAAM,WAAW,MAAM,YAAY,UAAU;AAC7C,QAAI,CAAC,SAAU,QAAO;AAEtB,UAAMC,SAAQC,OAAM,mBAAmB,EAAE,OAAO,mBAAmB,CAAC;AAEpE,UAAMC,UAAS;AAAA;AAAA;AAAA;AAAA,WAIZ,SAAS,OAAO;AAAA;AAAA,EAEzB,SAAS,OAAO;AAAA;AAAA;AAAA,EAGhB,OAAO,QAAQ,SAAS,EAAE,IAAI,CAAC,CAAC,KAAK,GAAG,MAAM,KAAK,GAAG,KAAK,GAAG,EAAE,EAAE,KAAK,IAAI,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWtE,UAAM,SAAS,MAAMF,OAAM,gBAAgB;AAAA,MACvC,UAAU,CAAC,EAAE,MAAM,QAAQ,OAAO,CAAC,EAAE,MAAME,QAAO,CAAC,EAAE,CAAC;AAAA,IAC1D,CAAC;AAED,UAAM,WAAW,OAAO,SAAS,KAAK;AACtC,UAAM,eAAe,SAAS,MAAM,iBAAiB;AACrD,UAAM,YAAY,SAAS,MAAM,mBAAmB;AAEpD,QAAI,CAAC,gBAAgB,CAAC,WAAW;AAE7B,aAAO;AAAA,QACH,SAAS,iBAAiB,SAAS,SAAS,SAAS;AAAA,QACrD,MAAM,iBAAiB,SAAS,SAAS,SAAS;AAAA,MACtD;AAAA,IACJ;AAEA,WAAO;AAAA,MACH,SAAS,aAAa,CAAC,EAAE,KAAK;AAAA,MAC9B,MAAM,UAAU,CAAC,EAAE,KAAK;AAAA,IAC5B;AAAA,EACJ,SAASH,QAAO;AACZ,YAAQ,MAAM,2BAA2BA,MAAK;AAC9C,WAAO;AAAA,EACX;AACJ;AAKA,SAAS,sBAAsB,SAAiC;AAC5D,MAAI,CAAC,QAAS,QAAO;AACrB,QAAM,WAAW,QAAQ,MAAM,WAAW;AAC1C,SAAO,WAAW,SAAS,CAAC,IAAI;AACpC;AAKA,eAAsB,mBAClB,UACA,YACA,iBACa;AACb,MAAI;AAEA,UAAM,YAAY,MAAMD,IAAG,WAAW,SAAS,EAAE,IAAI,QAAQ,EAAE,IAAI;AACnE,QAAI,CAAC,UAAU,QAAQ;AACnB,cAAQ,MAAM,UAAU,QAAQ,YAAY;AAC5C;AAAA,IACJ;AAEA,UAAM,SAAS,UAAU,KAAK;AAG9B,UAAM,YAAY;AAAA,MACd,YAAY,QAAQ,gBAAgB;AAAA,MACpC,SAAS,QAAQ,WAAW,sBAAsB,QAAQ,OAAO,KAAK;AAAA,MACtE,WAAW,QAAQ,aAAa;AAAA,MAChC,YAAY,qCAAqC,QAAQ;AAAA,MACzD,GAAG;AAAA,IACP;AAGA,UAAM,QAAQ,MAAM,0BAA0B,YAAY,SAAS;AACnE,QAAI,CAAC,OAAO;AACR,cAAQ,MAAM,0BAA0B;AACxC;AAAA,IACJ;AAGA,QAAI;AACJ,QAAI;AACA,YAAM,EAAE,KAAK,IAAI,MAAM,OAAO,OAAO,KAAK;AAAA,QACtC,MAAM;AAAA,QACN,IAAI,QAAQ,SAAS;AAAA,QACrB,SAAS,MAAM;AAAA,QACf,MAAM,MAAM;AAAA,MAChB,CAAC;AACD,iBAAW,MAAM;AACjB,cAAQ,IAAI,wBAAmB,QAAQ,WAAW,KAAK,MAAM,OAAO,gBAAgB,MAAM,EAAE,GAAG;AAAA,IACnG,SAASC,QAAO;AACZ,cAAQ,MAAM,4BAAuBA,MAAK;AAE1C,YAAMD,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,QACzC;AAAA,QACA,MAAM;AAAA,QACN,aAAa,yBAAyB,MAAM,OAAO;AAAA,QACnD,WAAiB,iBAAU,WAAW,gBAAgB;AAAA,QACtD,UAAU;AAAA,UACN;AAAA,UACA,SAAS,MAAM;AAAA,UACf,IAAI,QAAQ,SAAS;AAAA,UACrB,OAAO,OAAOC,MAAK;AAAA,QACvB;AAAA,MACJ,CAAC;AACD;AAAA,IACJ;AAGA,UAAMD,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,MACzC;AAAA,MACA,MAAM;AAAA,MACN,aAAa,eAAe,MAAM,OAAO;AAAA,MACzC,WAAiB,iBAAU,WAAW,gBAAgB;AAAA,MACtD,UAAU;AAAA,QACN;AAAA,QACA,SAAS,MAAM;AAAA,QACf,MAAM,MAAM;AAAA,QACZ,IAAI,QAAQ,SAAS;AAAA,QACrB;AAAA;AAAA,MACJ;AAAA,IACJ,CAAC;AAAA,EACL,SAASC,QAAO;AACZ,YAAQ,MAAM,wBAAwBA,MAAK;AAAA,EAC/C;AACJ;AA1LA,IAAAI,QACAC,uBACA,eAEMN,KACAG,QACA;AANN;AAAA;AAAA;AAAA,IAAAE,SAAuB;AACvB,IAAAC,wBAAmC;AACnC,oBAAuB;AAEvB,IAAMN,MAAW,iBAAU;AAC3B,IAAMG,SAAQ,IAAI,yCAAmB,QAAQ,IAAI,kBAAkB,EAAE;AACrE,IAAM,SAAS,IAAI,qBAAO,QAAQ,IAAI,cAAc;AAAA;AAAA;;;ACNpD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAA8C;AAC9C,IAAAI,UAAuB;;;ACDvB,2BAAmC;AACnC,YAAuB;AAIvB,IAAM,UAAU,QAAQ,IAAI,kBAAkB;AAC9C,IAAM,QAAQ,IAAI,wCAAmB,OAAO;AAC5C,IAAM,QAAQ,MAAM,mBAAmB,EAAE,OAAO,mBAAmB,CAAC;AAEpE,IAAI,CAAO,WAAK,QAAQ;AACpB,EAAM,oBAAc;AACxB;AAEA,IAAM,KAAW,gBAAU;AAEpB,IAAM,qBAAqB,OAAO,YAAmB,UAAkB,oBAA6B,UAA8C;AACrJ,UAAQ,IAAI,sDAAsD;AAClE,MAAI,WAAW;AACf,MAAI,YAAY;AAChB,QAAM,SAAmB,CAAC;AAC1B,QAAM,QAAQ,GAAG,MAAM;AAYvB,MAAI,WAAW,WAAW,EAAG,QAAO,EAAE,UAAU,WAAW,OAAO;AAKlE,QAAM,YAAY,oBAAoB,KAAK;AAC3C,QAAM,kBAAkB,oBAClB,iFACA;AAGN,MAAI,mBAAmB;AAEvB,MAAI;AAEA,UAAM,mBAA0B,CAAC;AACjC,UAAM,mBAAmC,CAAC;AAE1C,YAAQ,IAAI,YAAY,WAAW,MAAM,4BAA4B;AAErE,eAAW,UAAU,YAAY;AAC7B,YAAM,QAAQ,OAAO,QAAQ,OAAO,eAAe,OAAO;AAC1D,UAAI,CAAC,OAAO;AACR,yBAAiB,KAAK,MAAM;AAC5B;AAAA,MACJ;AAGA,YAAM,mBAAmB,MAAM,GAAG,WAAW,SAAS,EACjD,MAAM,gBAAgB,MAAM,KAAK,EACjC,MAAM,CAAC,EACP,IAAI;AAET,UAAI,CAAC,iBAAiB,OAAO;AACzB,cAAM,QAAQ,iBAAiB,KAAK,CAAC,EAAE;AACvC,gBAAQ,IAAI,0BAA0B,KAAK,KAAK,KAAK,wBAAwB;AAC7E,yBAAiB;AAAA,UACb,GAAG,WAAW,SAAS,EAAE,IAAI,KAAK,EAAE,OAAO;AAAA,YACvC,WAAiB,gBAAU,WAAW,gBAAgB;AAAA;AAAA;AAAA,UAG1D,CAAC;AAAA,QACL;AAAA,MACJ,OAAO;AACH,yBAAiB,KAAK,MAAM;AAAA,MAChC;AAAA,IACJ;AAGA,QAAI,iBAAiB,SAAS,GAAG;AAC7B,YAAM,QAAQ,IAAI,gBAAgB;AAClC,cAAQ,IAAI,WAAW,iBAAiB,MAAM,oBAAoB;AAAA,IACtE;AAEA,QAAI,iBAAiB,WAAW,GAAG;AAC/B,cAAQ,IAAI,iDAAiD;AAC7D,aAAO,EAAE,UAAU,WAAW,OAAO;AAAA,IACzC;AAGA,uBAAmB;AAGnB,UAAM,cAAc,MAAM,GAAG,WAAW,WAAW,EAAE,IAAI,2BAA2B,EAAE,IAAI;AAC1F,QAAI,CAAC,YAAY,QAAQ;AACrB,YAAM,IAAI,MAAM,iDAAiD;AAAA,IACrE;AAEA,UAAM,WAAW,YAAY,KAAK;AAClC,UAAM,aAAa,KAAK,UAAU,iBAAiB,IAAI,CAAC,GAAG,OAAO;AAAA,MAC9D,OAAO;AAAA,MACP,MAAM,EAAE,QAAQ,EAAE;AAAA,MAClB,aAAa,EAAE,eAAe,EAAE;AAAA,MAChC,SAAS,EAAE,YAAY,EAAE,WAAW,EAAE;AAAA;AAAA,MACtC,SAAS,EAAE;AAAA,MACX,OAAO,EAAE;AAAA,IACb,EAAE,CAAC;AAGH,UAAMC,UAAS,UAAU,QACpB,QAAQ,kBAAkB,QAAQ,EAClC,QAAQ,4BAA4B,eAAe,EACnD,QAAQ,sBAAsB,UAAU,SAAS,CAAC,EAClD,QAAQ,uBAAuB,UAAU;AAE9C,UAAM,SAAS,MAAM,MAAM,gBAAgBA,OAAM;AACjD,UAAM,WAAW,OAAO;AACxB,UAAM,OAAO,SAAS,KAAK;AAC3B,YAAQ,IAAI,wBAAwB,IAAI;AAGxC,UAAM,UAAU,KAAK,QAAQ,YAAY,EAAE,EAAE,QAAQ,QAAQ,EAAE,EAAE,KAAK;AACtE,UAAM,WAAW,KAAK,MAAM,OAAO;AAEnC,eAAW,SAAS;AAEpB,eAAW,QAAQ,UAAU;AACzB,UAAI,KAAK,aAAa;AAClB;AAEA,cAAM,iBAAiB,iBAAiB,KAAK,KAAK;AAClD,YAAI,CAAC,gBAAgB;AACjB,kBAAQ,KAAK,2BAA2B,KAAK,KAAK,qBAAqB,iBAAiB,MAAM,WAAW;AACzG;AAAA,QACJ;AAGA,cAAM,QAAQ,eAAe,QAAQ,eAAe,eAAe,eAAe,SAAS;AAE3F,cAAM,YAAY,GAAG,WAAW,SAAS,EAAE,IAAI;AAC/C,cAAM,YAAoB;AAAA,UACtB,IAAI,UAAU;AAAA,UACd,cAAc;AAAA,UACd,cAAc,KAAK,YAAY,CAAC,KAAK,SAAS,IAAI,CAAC;AAAA,UACnD,SAAS,eAAe,YAAY,KAAK,WAAW;AAAA,UACpD,MAAM,KAAK,QAAQ;AAAA,UACnB,OAAO,KAAK,SAAS;AAAA,UACrB,KAAK,KAAK,OAAO;AAAA,UACjB,SAAS,KAAK,WAAW;AAAA,UACzB,OAAO,eAAe,SAAS,KAAK,SAAS;AAAA,UAC7C,OAAO,eAAe,SAAS,KAAK,SAAS;AAAA,UAC7C,SAAS,eAAe,WAAW,KAAK,WAAW;AAAA;AAAA,UAEnD,UAAU,KAAK;AAAA,UACf;AAAA,UACA,iBAAiB,oBAAoB,eAAe;AAAA,UACpD,QAAQ;AAAA,UACR,WAAiB,gBAAU,WAAW,gBAAgB;AAAA,UACtD,WAAiB,gBAAU,WAAW,gBAAgB;AAAA,QAC1D;AAEA,gBAAQ,IAAI,qCAAqC,UAAU,YAAY,EAAE;AACzE,cAAM,IAAI,WAAW,SAAS;AAAA,MAClC;AAAA,IACJ;AAEA,QAAI,YAAY,GAAG;AACf,cAAQ,IAAI,uBAAuB,SAAS,aAAa;AACzD,YAAM,MAAM,OAAO;AACnB,cAAQ,IAAI,0BAA0B;AAAA,IAC1C,OAAO;AACH,cAAQ,IAAI,iCAAiC;AAAA,IACjD;AAAA,EAEJ,SAAS,KAAU;AACf,YAAQ,MAAM,uBAAuB,IAAI,OAAO;AAChD,YAAQ,MAAM,gBAAgB,MAAM;AACpC,WAAO,KAAK,IAAI,OAAO;AAGvB,YAAQ,IAAI,sEAAsE;AAElF,eAAW,kBAAkB,kBAAkB;AAC3C,YAAM,YAAY,GAAG,WAAW,SAAS,EAAE,IAAI;AAE/C,YAAM,QAAQ,eAAe,QAAQ,eAAe,eAAe,eAAe,SAAS;AAE3F,YAAM,YAAoB;AAAA,QACtB,IAAI,UAAU;AAAA,QACd,cAAc;AAAA,QACd,cAAc,CAAC;AAAA,QACf,SAAS,eAAe,YAAY,eAAe,WAAW;AAAA,QAC9D,OAAO,eAAe,SAAS;AAAA,QAC/B,OAAO,eAAe,SAAS;AAAA,QAC/B,SAAS,eAAe,WAAW;AAAA,QACnC,UAAU;AAAA,QACV,QAAQ;AAAA,QACR;AAAA,QACA,iBAAiB,oBAAoB,eAAe;AAAA,QACpD,aAAa,uBAAuB,IAAI,OAAO;AAAA,QAC/C,WAAiB,gBAAU,WAAW,gBAAgB;AAAA,QACtD,WAAiB,gBAAU,WAAW,gBAAgB;AAAA,MAC1D;AACA,YAAM,IAAI,WAAW,SAAS;AAC9B;AAAA,IACJ;AAEA,QAAI,YAAY,GAAG;AACf,cAAQ,IAAI,uBAAuB,SAAS,sBAAsB;AAClE,YAAM,MAAM,OAAO;AAAA,IACvB;AAAA,EACJ;AAEA,SAAO,EAAE,UAAU,WAAW,OAAO;AACzC;;;ACxNA,mBAAkB;AAoBX,IAAM,gBAAgB,OAAO,OAAe,aAA2C;AAC1F,QAAM,SAAS,QAAQ,IAAI,kBAAkB;AAC7C,MAAI,CAAC,QAAQ;AACT,YAAQ,KAAK,iDAAiD;AAC9D,WAAO,eAAe,OAAO,QAAQ;AAAA,EACzC;AAEA,QAAM,YAAY,GAAG,KAAK,OAAO,QAAQ;AACzC,UAAQ,IAAI,kBAAkB,SAAS,2BAA2B;AAElE,MAAI;AACA,UAAM,WAAW,MAAM,aAAAC,QAAM;AAAA,MACzB;AAAA,MACA,EAAE,GAAG,UAAU;AAAA,MACf,EAAE,SAAS,EAAE,aAAa,OAAO,KAAK,GAAG,gBAAgB,mBAAmB,EAAE;AAAA,IAClF;AAEA,UAAM,SAAS,SAAS,KAAK,UAAU,CAAC;AACxC,YAAQ,IAAI,mBAAmB,OAAO,MAAM,eAAe;AAI3D,UAAM,aAAa,OAAO,IAAI,CAAC,WAAgB;AAAA,MAC3C,MAAM,MAAM;AAAA,MACZ,aAAa,GAAG,MAAM,YAAY,EAAE,MAAM,MAAM,WAAW,EAAE;AAAA,MAC7D,UAAU,MAAM;AAAA,MAChB,OAAO,MAAM;AAAA,MACb,SAAS,MAAM;AAAA,MACf,QAAQ;AAAA,MACR,QAAQ,MAAM;AAAA,MACd,oBAAoB,MAAM;AAAA,IAC9B,EAAE;AAGF,UAAM,kBAAkB,WAAW,OAAO,CAAC,MAAW,EAAE,WAAW,UAAa,EAAE,UAAU,GAAG;AAC/F,YAAQ,IAAI,YAAY,WAAW,MAAM,OAAO,gBAAgB,MAAM,kCAAkC;AAExG,WAAO;AAAA,EAEX,SAASC,QAAY;AACjB,YAAQ,MAAM,4BAA4BA,OAAM,OAAO;AACvD,UAAM,IAAI,MAAM,6BAA6BA,OAAM,OAAO,EAAE;AAAA,EAChE;AACJ;AAGA,IAAM,iBAAiB,CAAC,OAAe,aAAkC;AACrE,SAAO;AAAA,IACH;AAAA,MACI,MAAM,4BAA4B;AAAA,MAClC,aAAa;AAAA,MACb;AAAA,MACA,QAAQ;AAAA,IACZ;AAAA,IACA;AAAA,MACI,MAAM,yBAAyB;AAAA,MAC/B,aAAa;AAAA,MACb;AAAA,MACA,QAAQ;AAAA,IACZ;AAAA,IACA;AAAA,MACI,MAAM;AAAA,MACN,aAAa;AAAA,MACb;AAAA,MACA,QAAQ;AAAA,IACZ;AAAA,EACJ;AACJ;;;ACvFA,uBAAkC;AAClC,IAAAC,SAAuB;AACvB,aAAwB;AAGxB,IAAI,CAAO,YAAK,QAAQ;AACpB,EAAM,qBAAc;AACxB;AACA,IAAMC,MAAW,iBAAU;AAE3B,QAAQ,IAAI,qCAAqC;AAE1C,IAAM,uBAAmB,oCAAkB,sBAAsB,OAAO,UAAU;AACrF,UAAQ,IAAI,6BAA6B;AACzC,MAAI,CAAC,MAAM,MAAM;AACb,YAAQ,IAAI,gBAAgB;AAC5B;AAAA,EACJ;AAEA,QAAM,UAAU,MAAM,KAAK,MAAM,KAAK;AACtC,QAAM,UAAU,MAAM,KAAK,OAAO,KAAK;AACvC,QAAM,WAAW,MAAM,OAAO;AAE9B,MAAI,CAAC,WAAW,CAAC,QAAS;AAG1B,MAAI,QAAQ,WAAW,eAAe,QAAQ,WAAW,aAAa;AAClE,IAAO,YAAK,UAAU,QAAQ,qCAAqC;AAEnE,QAAI;AAEA,YAAMA,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,QACzC;AAAA,QACA,MAAM;AAAA,QACN,aAAa;AAAA,QACb,WAAW,oBAAI,KAAK;AAAA,QACpB,UAAU;AAAA,UACN,WAAW,QAAQ;AAAA,UACnB,WAAW,QAAQ;AAAA,QACvB;AAAA,MACJ,CAAC;AAGD,YAAM,MAAM,KAAK,MAAM,IAAI,OAAO;AAAA,QAC9B,gBAAgB;AAAA,QAChB,iBAAiB,oBAAI,KAAK;AAAA,MAC9B,CAAC;AAID,YAAM,EAAE,aAAAC,aAAY,IAAI,MAAM;AAE9B,YAAMA,aAAYD,KAAI;AAAA,QAClB;AAAA,QACA,MAAM;AAAA,QACN,aAAa,oBAAI,KAAK;AAAA;AAAA,QACtB,UAAU;AAAA,UACN,QAAQ,QAAQ;AAAA,UAChB,mBAAmB,QAAQ;AAAA,UAC3B,OAAO,QAAQ;AAAA,UACf,aAAa,QAAQ;AAAA;AAAA,UACrB,WAAW,QAAQ,aAAa,QAAQ,eAAe,CAAC;AAAA,QAC5D;AAAA,MACJ,CAAC;AAED,MAAO,YAAK,gDAAgD,QAAQ,EAAE;AAAA,IAC1E,SAASE,QAAO;AACZ,MAAO,aAAM,uCAAuCA,MAAK;AAAA,IAC7D;AAAA,EACJ;AACJ,CAAC;;;ACtED,uBAA2B;AAC3B,IAAAC,SAAuB;AACvB,IAAAC,UAAwB;AACxB;;;ACDA,IAAM,aAAa;AACnB,IAAM,WAAW;AAIV,SAAS,oBAAoB,SAAoC;AACpE,QAAM,MAAM,oBAAI,KAAK;AAQrB,QAAM,MAAM,IAAI,OAAO;AACvB,QAAM,OAAO,IAAI,SAAS;AAE1B,QAAM,YAAY,QAAQ,KAAK,QAAQ;AACvC,QAAM,kBAAkB,CAAC,aAAa,QAAQ,cAAc,OAAO;AAEnE,MAAI,YAAY,YAAY,iBAAiB;AAEzC,WAAO,IAAI,KAAK,IAAI,QAAQ,IAAI,KAAK,GAAK;AAAA,EAC9C;AAGA,MAAI,WAAW,IAAI,KAAK,GAAG;AAE3B,MAAI,QAAQ,GAAG;AACX,aAAS,QAAQ,IAAI,QAAQ,IAAI,CAAC;AAAA,EACtC,WAAW,QAAQ,GAAG;AAClB,aAAS,QAAQ,IAAI,QAAQ,IAAI,CAAC;AAAA,EACtC,OAAO;AACH,aAAS,QAAQ,IAAI,QAAQ,IAAI,CAAC;AAAA,EACtC;AAGA,WAAS,SAAS,YAAY,WAAW,aAAa,aAAa,GAAG,GAAG,GAAG,CAAC;AAM7E,SAAO;AACX;;;AC9CA,IAAAC,wBAAmC;AACnC,IAAAC,SAAuB;AAEvB,IAAMC,WAAU,QAAQ,IAAI,kBAAkB;AAC9C,IAAMC,SAAQ,IAAI,yCAAmBD,QAAO;AAC5C,IAAME,SAAQD,OAAM,mBAAmB,EAAE,OAAO,mBAAmB,CAAC;AACpE,IAAME,MAAW,iBAAU;AAEpB,IAAM,0BAA0B,OAAO,QAAa,qBAAsC;AAC7F,QAAM,WAAW,OAAO;AACxB,QAAM,UAAU;AAEhB,MAAI;AAEA,UAAM,cAAc,MAAMA,IAAG,WAAW,WAAW,EAAE,IAAI,4BAA4B,EAAE,IAAI;AAC3F,QAAI,CAAC,YAAY,QAAQ;AACrB,YAAM,IAAI,MAAM,kDAAkD;AAAA,IACtE;AAEA,UAAM,WAAW,YAAY,KAAK;AAClC,UAAM,kBAAkB,WAClB,sDACA;AAGN,UAAMC,UAAS,UAAU,QACpB,QAAQ,uBAAuB,OAAO,WAAW,EACjD,QAAQ,sBAAsB,OAAO,aAAa,UAAU,EAC5D,QAAQ,4BAA4B,eAAe;AAExD,UAAM,SAAS,MAAMF,OAAM,gBAAgBE,OAAM;AACjD,QAAI,OAAO,OAAO,SAAS,KAAK;AAGhC,WAAO,KAAK,QAAQ,cAAc,EAAE,EAAE,QAAQ,UAAU,EAAE,EAAE,KAAK;AAEjE,UAAM,cAAc,KAAK,MAAM,IAAI;AAEnC,WAAO;AAAA,MACH;AAAA,MACA,KAAK,YAAY;AAAA,MACjB,OAAO,YAAY;AAAA,MACnB,aAAa,oBAAI,KAAK;AAAA,IAC1B;AAAA,EACJ,SAASC,QAAO;AACZ,YAAQ,MAAM,sCAAsCA,MAAK;AACzD,WAAO;AAAA,MACH;AAAA,MACA,KAAK;AAAA,MACL,OAAO,EAAE,SAAS,SAAS,MAAM,mDAAmD;AAAA,MACpF,OAAO;AAAA,IACX;AAAA,EACJ;AACJ;AAGO,IAAM,yBAAyB,OAAO,QAAa,gBAAwB,oBAA4B;AAC1G,MAAI;AAEA,UAAM,cAAc,MAAMF,IAAG,WAAW,WAAW,EAAE,IAAI,yBAAyB,EAAE,IAAI;AACxF,QAAI,CAAC,YAAY,QAAQ;AACrB,YAAM,IAAI,MAAM,+CAA+C;AAAA,IACnE;AAEA,UAAM,WAAW,YAAY,KAAK;AAGlC,UAAMC,UAAS,UAAU,QACpB,QAAQ,uBAAuB,OAAO,WAAW,EACjD,QAAQ,2BAA2B,cAAc,EACjD,QAAQ,4BAA4B,eAAe,EACnD,QAAQ,qBAAqB,OAAO,EAAE;AAE3C,UAAM,SAAS,MAAMF,OAAM,gBAAgBE,OAAM;AACjD,QAAI,OAAO,OAAO,SAAS,KAAK;AAChC,WAAO,KAAK,QAAQ,cAAc,EAAE,EAAE,QAAQ,UAAU,EAAE,EAAE,KAAK;AACjE,UAAM,cAAc,KAAK,MAAM,IAAI;AACnC,WAAO;AAAA,EACX,SAASC,QAAO;AACZ,YAAQ,MAAM,4BAA4BA,MAAK;AAC/C,WAAO,EAAE,QAAQ,SAAS,OAAO,2BAA2B;AAAA,EAChE;AACJ;;;AF3EA,IAAI,CAAO,YAAK,QAAQ;AACpB,EAAM,qBAAc;AACxB;AACA,IAAMC,MAAW,iBAAU;AAIpB,IAAM,2BAAuB,6BAAW,mBAAmB,OAAO,UAAU;AAC/E,EAAO,aAAK,8BAA8B;AAE1C,MAAI;AACA,UAAM,QAAQ,MAAM,kBAAkBA,GAAE;AACxC,QAAI,MAAM,WAAW,GAAG;AACpB,MAAO,aAAK,yBAAyB;AACrC;AAAA,IACJ;AAEA,IAAO,aAAK,SAAS,MAAM,MAAM,oBAAoB;AAErD,eAAW,QAAQ,OAAO;AACtB,UAAI;AACA,YAAI,KAAK,SAAS,YAAY;AAC1B,gBAAM,eAAe,IAAI;AAAA,QAC7B,WAAW,KAAK,SAAS,QAAQ;AAC7B,gBAAM,WAAW,IAAI;AAAA,QACzB;AAAA,MACJ,SAAS,KAAK;AACV,QAAO,cAAM,yBAAyB,KAAK,EAAE,KAAK,GAAG;AAGrD,cAAM,iBAAiB,KAAK,cAAc,KAAK;AAC/C,cAAM,SAAS,gBAAgB,IAAI,WAAW;AAG9C,cAAM,cAAc,oBAAI,KAAK;AAC7B,oBAAY,WAAW,YAAY,WAAW,IAAI,KAAK,IAAI,GAAG,aAAa,CAAC;AAE5E,cAAM,iBAAiBA,KAAI,KAAK,IAAK,QAAQ;AAAA,UACzC,YAAY;AAAA,UACZ,aAAmB,iBAAU,UAAU,SAAS,WAAW;AAAA,UAC3D,OAAO,OAAO,GAAG;AAAA,QACrB,CAAC;AAAA,MACL;AAAA,IACJ;AAAA,EACJ,SAASC,QAAO;AACZ,IAAO,cAAM,mCAAmCA,MAAK;AAAA,EACzD;AACJ,CAAC;AAED,eAAe,eAAe,MAAiB;AAC3C,EAAO,aAAK,+BAA+B,KAAK,EAAE,EAAE;AAIpD,QAAM,aAAa,KAAK;AAExB,QAAM,iBAAiB,MAAM,wBAAwB,YAAY,WAAW,QAAQ,QAAQ,OAAO;AAEnG,MAAI,eAAe,OAAO;AACtB,UAAM,IAAI,MAAM,4BAA4B,eAAe,OAAO,gBAAgB;AAAA,EACtF;AAGA,QAAMD,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,IACzC,UAAU,KAAK;AAAA,IACf,MAAM;AAAA;AAAA,IACN,aAAa;AAAA,IACb,WAAW,oBAAI,KAAK;AAAA,IACpB,UAAU;AAAA,MACN,KAAK,eAAe;AAAA,MACpB,OAAO,eAAe;AAAA,MACtB,kBAAkB,eAAe;AAAA,MACjC,iBAAiB,WAAW,oBAAoB,WAAW;AAAA,IAC/D;AAAA,EACJ,CAAC;AAGD,QAAM,gBAAgB,oBAAoB,WAAW,oBAAoB,WAAW,QAAQ;AAG5F,QAAM,YAAYA,KAAI;AAAA,IAClB,UAAU,KAAK;AAAA,IACf,MAAM;AAAA,IACN,aAAmB,iBAAU,UAAU,SAAS,aAAa;AAAA,IAC7D,UAAU;AAAA;AAAA,MAEN,KAAK,eAAe;AAAA,MACpB,OAAO,eAAe;AAAA,MACtB,SAAS,eAAe;AAAA,IAC5B;AAAA,EACJ,CAAC;AAGD,QAAM,iBAAiBA,KAAI,KAAK,IAAK,WAAW;AAChD,EAAO,aAAK,QAAQ,KAAK,EAAE,kCAAkC,cAAc,YAAY,CAAC,EAAE;AAC9F;AAEA,eAAe,WAAW,MAAiB;AACvC,EAAO,aAAK,2BAA2B,KAAK,EAAE,EAAE;AAKhD,QAAMA,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,IACzC,UAAU,KAAK;AAAA,IACf,MAAM;AAAA,IACN,aAAa,aAAa,KAAK,SAAS,OAAO;AAAA,IAC/C,WAAW,oBAAI,KAAK;AAAA,IACpB,UAAU;AAAA,MACN,SAAS,KAAK,SAAS;AAAA,MACvB,SAAS,KAAK,SAAS,YAAY,QAAQ,KAAK,SAAS,MAAM,KAAK,SAAS,MAAM;AAAA,IACvF;AAAA,EACJ,CAAC;AAED,QAAM,iBAAiBA,KAAI,KAAK,IAAK,WAAW;AAGhD,QAAMA,IAAG,WAAW,SAAS,EAAE,IAAI,KAAK,QAAQ,EAAE,OAAO;AAAA,IACrD,gBAAgB;AAAA,IAChB,iBAAiB,KAAK,SAAS;AAAA,IAC/B,cAAc,oBAAI,KAAK;AAAA,EAC3B,CAAC;AACL;;;AGjIA,IAAAE,oBAAkC;AAClC,IAAAC,SAAuB;AACvB,IAAAC,UAAwB;AAGxB,IAAI,CAAO,YAAK,QAAQ;AACpB,EAAM,qBAAc;AACxB;AACA,IAAMC,MAAW,iBAAU;AAEpB,IAAM,wBAAoB,qCAAkB,kCAAkC,OAAO,UAAU;AAClG,MAAI,CAAC,MAAM,KAAM;AAEjB,QAAM,WAAW,MAAM,KAAK,KAAK;AACjC,QAAM,WAAW,SAAS;AAG1B,MAAI,SAAS,SAAS,gBAAiB;AAEvC,EAAO,aAAK,0CAA0C,QAAQ,EAAE;AAEhE,MAAI;AAEA,UAAM,YAAY,MAAMA,IAAG,WAAW,SAAS,EAAE,IAAI,QAAQ,EAAE,IAAI;AACnE,QAAI,CAAC,UAAU,QAAQ;AACnB,MAAO,cAAM,UAAU,QAAQ,YAAY;AAC3C;AAAA,IACJ;AACA,UAAM,SAAS,UAAU,KAAK;AAI9B,UAAM,uBAAuB,MAAMA,IAAG,WAAW,mBAAmB,EAC/D,MAAM,YAAY,MAAM,QAAQ,EAChC,MAAM,QAAQ,MAAM,eAAe,EACnC,QAAQ,aAAa,MAAM,EAC3B,MAAM,CAAC,EACP,IAAI;AAET,UAAM,kBAAkB,CAAC,qBAAqB,QAC1C,qBAAqB,KAAK,CAAC,EAAE,KAAK,EAAE,cACpC;AAGJ,UAAM,WAAW,MAAM,uBAAuB,QAAQ,SAAS,aAAa,eAAe;AAE3F,IAAO,aAAK,uBAAuB,QAAQ,KAAK,KAAK,UAAU,QAAQ,CAAC,EAAE;AAG1E,QAAI,YAAY,QAAQ;AACxB,QAAI,oBAAoB;AAExB,QAAI,SAAS,WAAW,cAAc;AAClC,kBAAY;AACZ,0BAAoB;AAAA,IACxB,WAAW,SAAS,WAAW,kBAAkB;AAC7C,kBAAY;AACZ,0BAAoB;AAAA,IACxB,WAAW,SAAS,WAAW,YAAY;AACvC,kBAAY;AACZ,0BAAoB;AAAA,IACxB,OAAO;AACH,0BAAoB;AAAA,IACxB;AAGA,QAAI,aAAa,cAAc,QAAQ,QAAQ;AAC3C,YAAMA,IAAG,WAAW,SAAS,EAAE,IAAI,QAAQ,EAAE,OAAO;AAAA,QAChD,QAAQ;AAAA,QACR,iBAAiB,oBAAI,KAAK;AAAA,MAC9B,CAAC;AAED,YAAMA,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,QACzC;AAAA,QACA,MAAM;AAAA,QACN,aAAa;AAAA,QACb,WAAW,oBAAI,KAAK;AAAA,QACpB,UAAU;AAAA,UACN,WAAW,QAAQ;AAAA,UACnB;AAAA,UACA,UAAU,SAAS;AAAA,QACvB;AAAA,MACJ,CAAC;AAAA,IACL;AAGA,UAAMA,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,MACzC;AAAA,MACA,MAAM;AAAA,MACN,aAAa,SAAS;AAAA,MACtB,WAAW,oBAAI,KAAK;AAAA;AAAA,MACpB,UAAU;AAAA,QACN,QAAQ,SAAS;AAAA,QACjB,WAAW,MAAM,OAAO;AAAA,MAC5B;AAAA,IACJ,CAAC;AAAA,EAEL,SAASC,QAAO;AACZ,IAAO,cAAM,qCAAqCA,MAAK;AAAA,EAC3D;AACJ,CAAC;;;ACpGD,IAAAC,oBAAkC;AAClC,IAAAC,SAAuB;;;ACDvB,IAAAC,wBAAmC;AACnC,IAAAC,SAAuB;AAEvB,IAAMC,SAAQ,IAAI,yCAAmB,QAAQ,IAAI,kBAAkB,EAAE;AACrE,IAAMC,MAAW,iBAAU;AAQ3B,eAAsB,eAAe,SAAuB,YAAoB,WAAgD;AAC5H,QAAMC,SAAQF,OAAM,mBAAmB,EAAE,OAAO,mBAAmB,CAAC;AAIpE,MAAI,mBAAmB;AAEvB,MAAI,YAAY,OAAO;AACnB,UAAM,QAAQ,oBAAI,KAAK;AACvB,UAAM,WAAW,IAAI,KAAK,KAAK;AAC/B,aAAS,YAAY,MAAM,YAAY,IAAI,CAAC;AAE5C,uBAAmB;AAAA;AAAA;AAAA,uBAGJ,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0BAeP,SAAS,mBAAmB,CAAC;AAAA;AAAA,EAEnD,WAAW,YAAY,MAAM;AACzB,uBAAmB;AAAA;AAAA,oBAEP,UAAU;AAAA,6BACD,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOnC;AAEA,MAAI;AAEA,UAAM,cAAc,MAAMC,IAAG,WAAW,WAAW,EAAE,IAAI,0BAA0B,EAAE,IAAI;AACzF,QAAI,CAAC,YAAY,QAAQ;AACrB,YAAM,IAAI,MAAM,gDAAgD;AAAA,IACpE;AAEA,UAAM,WAAW,YAAY,KAAK;AAClC,UAAM,eAAe,YAAY,QAC3B,8DACA;AAGN,UAAME,UAAS,UAAU,QACpB,QAAQ,yBAAyB,OAAO,EACxC,QAAQ,uBAAuB,UAAU,EACzC,QAAQ,sBAAsB,SAAS,EACvC,QAAQ,yBAAyB,YAAY,EAC7C,QAAQ,oBAAoB,gBAAgB;AAEjD,UAAM,SAAS,MAAMD,OAAM,gBAAgB;AAAA,MACvC,UAAU,CAAC,EAAE,MAAM,QAAQ,OAAO,CAAC,EAAE,MAAMC,QAAO,CAAC,EAAE,CAAC;AAAA,IAC1D,CAAC;AACD,UAAM,eAAe,OAAO,SAAS,KAAK;AAC1C,UAAM,YAAY,aAAa,MAAM,aAAa;AAClD,QAAI,CAAC,UAAW,OAAM,IAAI,MAAM,2BAA2B;AAE3D,WAAO,KAAK,MAAM,UAAU,CAAC,CAAC;AAAA,EAClC,SAASC,QAAO;AACZ,YAAQ,MAAM,2BAA2BA,MAAK;AAC9C,WAAO;AAAA,MACH,OAAO;AAAA,MACP,WAAW,6BAA6BA;AAAA,MACxC,WAAW,CAAC;AAAA,IAChB;AAAA,EACJ;AACJ;;;ADzFA,IAAMC,MAAW,iBAAU;AAEpB,IAAM,yBAAqB,qCAAkB;AAAA,EAChD,UAAU;AAAA,EACV,SAAS,CAAC,gBAAgB;AAC9B,GAAG,OAAO,UAAU;AAChB,QAAM,SAAS,MAAM,MAAM,OAAO,KAAK;AACvC,QAAM,QAAQ,MAAM,MAAM,MAAM,KAAK;AACrC,QAAM,WAAW,MAAM,OAAO;AAE9B,MAAI,CAAC,UAAU,CAAC,MAAO;AAGvB,MAAI,MAAM,YAAY,KAAK,WAAW,aAAa,OAAO,YAAY,KAAK,WAAW,WAAW;AAC7F,YAAQ,IAAI,sBAAsB,QAAQ,EAAE;AAC5C,UAAM,gBAAgB,UAAU,OAAO,KAAK;AAAA,EAChD;AAGA,MAAI,MAAM,YAAY,IAAI,WAAW,aAAa,OAAO,YAAY,IAAI,WAAW,WAAW;AAC3F,YAAQ,IAAI,qBAAqB,QAAQ,EAAE;AAC3C,UAAM,gBAAgB,UAAU,MAAM,KAAK;AAAA,EAC/C;AACJ,CAAC;AAED,eAAe,gBAAgB,UAAkB,SAAuB,YAAiB;AACrF,MAAI;AACA,UAAM,SAAS,MAAM,eAAe,SAAS,WAAW,eAAe,UAAU,WAAW,aAAa,SAAS;AAGlH,UAAM,YAAY,YAAY,QAAQ,mBAAmB;AACzD,UAAMA,IAAG,IAAI,WAAW,QAAQ,EAAE,EAAE,OAAO;AAAA,MACvC,CAAC,GAAG,SAAS,SAAS,GAAG,OAAO,QAAQ,aAAa;AAAA,MACrD,CAAC,GAAG,SAAS,aAAa,GAAG;AAAA,QACzB,OAAO,OAAO;AAAA,QACd,WAAW,OAAO;AAAA,QAClB,WAAW,OAAO;AAAA,MACtB;AAAA,MACA,CAAC,GAAG,SAAS,aAAa,GAAS,iBAAU,WAAW,gBAAgB;AAAA,IAC5E,CAAC;AAGD,UAAMA,IAAG,WAAW,mBAAmB,EAAE,IAAI;AAAA,MACzC;AAAA,MACA,MAAM;AAAA;AAAA,MACN,aAAa,MAAM,OAAO,QAAQ,aAAa,UAAU,IAAI,OAAO,KAAK,OAAO,SAAS;AAAA,MACzF,WAAiB,iBAAU,WAAW,gBAAgB;AAAA,MACtD,UAAU;AAAA,QACN;AAAA,QACA,OAAO,OAAO;AAAA,QACd,WAAW,OAAO;AAAA,MACtB;AAAA,IACJ,CAAC;AAGD,QAAI,OAAO,OAAO;AACd,YAAM,EAAE,oBAAAC,oBAAmB,IAAI,MAAM;AACrC,YAAMA,oBAAmB,UAAU,2BAA2B;AAAA,QAC1D,cAAc,YAAY,QAAQ,6BAA6B;AAAA,MACnE,CAAC;AAAA,IACL;AAAA,EAEJ,SAASC,QAAO;AACZ,YAAQ,MAAM,2BAA2B,OAAO,KAAKA,MAAK;AAAA,EAC9D;AACJ;;;AR1DA,aAAwB;AACjB,cAAO;AAGd,IAAI,CAAO,aAAK,QAAQ;AACpB,EAAM,sBAAc;AACxB;AACA,IAAMC,MAAW,kBAAU;AAOpB,IAAM,oBAAgB,qBAAO;AAAA,EAChC,SAAS,CAAC,kBAAkB,gBAAgB;AAAA,EAC5C,MAAM;AAAA,IACF;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA,EACJ;AAAA,EACA,gBAAgB;AACpB,GAAG,OAAO,YAAY;AAClB,QAAM,OAAO,QAAQ,QAAQ,CAAC;AAC9B,QAAM,QAAQ,KAAK;AACnB,QAAM,WAAW,KAAK;AACtB,QAAM,oBAAoB,KAAK,qBAAqB;AAEpD,MAAI,CAAC,SAAS,CAAC,UAAU;AACrB,UAAM,IAAI,wBAAW,oBAAoB,2CAA2C;AAAA,EACxF;AAEA,MAAI;AACA,YAAQ,IAAI,8BAA8B,KAAK,eAAe,QAAQ,EAAE;AAGxE,UAAM,aAAa,MAAM,cAAc,OAAO,QAAQ;AACtD,YAAQ,IAAI,WAAW,WAAW,MAAM,WAAW;AAInD,UAAM,SAAS,MAAM,mBAAmB,YAAY,OAAO,iBAAiB;AAE5E,WAAO;AAAA,MACH,SAAS;AAAA,MACT,SAAS,WAAW;AAAA,MACpB,UAAU;AAAA,IACd;AAAA,EACJ,SAASC,QAAY;AACjB,YAAQ,MAAM,2BAA2BA,MAAK;AAC9C,UAAM,IAAI,wBAAW,YAAYA,OAAM,WAAW,6BAA6B;AAAA,EACnF;AACJ,CAAC;AAGM,IAAM,oBAAgB,qBAAO;AAAA,EAChC,MAAM;AAAA,IACF;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ;AACJ,GAAG,OAAO,YAAY;AAClB,MAAI;AACA,UAAM,WAAW,MAAMC,IAAG,WAAW,SAAS,EAAE,IAAI;AAEpD,QAAI,SAAS,OAAO;AAChB,aAAO,EAAE,SAAS,0BAA0B;AAAA,IAChD;AAIA,QAAI,QAAQ;AACZ,UAAM,SAAS,CAAC;AAChB,QAAI,eAAeA,IAAG,MAAM;AAE5B,aAAS,KAAK,QAAQ,CAAC,KAAK,UAAU;AAClC,mBAAa,OAAO,IAAI,GAAG;AAC3B;AACA,UAAI,QAAQ,QAAQ,GAAG;AACnB,eAAO,KAAK,aAAa,OAAO,CAAC;AACjC,uBAAeA,IAAG,MAAM;AAAA,MAC5B;AAAA,IACJ,CAAC;AAED,WAAO,KAAK,aAAa,OAAO,CAAC;AACjC,UAAM,QAAQ,IAAI,MAAM;AAExB,WAAO,EAAE,SAAS,WAAW,KAAK,0BAA0B;AAAA,EAChE,SAASD,QAAY;AACjB,UAAM,IAAI,wBAAW,YAAYA,OAAM,OAAO;AAAA,EAClD;AACJ,CAAC;AAGM,IAAM,wBAAoB,wBAAU,EAAE,SAAS,CAAC,gBAAgB,EAAE,GAAG,OAAO,KAAK,QAAQ;AAE5F,QAAM,aAAa,IAAI,KAAK,WAAW;AAAA,IACnC,EAAE,MAAM,gBAAgB,UAAU,uDAAuD;AAAA,IACzF,EAAE,MAAM,eAAe,UAAU,qBAAqB;AAAA,IACtD,EAAE,MAAM,cAAc,UAAU,0BAA0B;AAAA,EAC9D;AAEA,QAAM,SAAS,MAAM,mBAAmB,YAAY,qBAAqB;AACzE,MAAI,KAAK,MAAM;AACnB,CAAC;AAcM,IAAM,oBAAgB,qBAAO;AAAA,EAChC,SAAS,CAAC,kBAAkB,gBAAgB;AAAA,EAC5C,MAAM;AAAA,IACF;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACJ;AACJ,GAAG,OAAO,YAAY;AAClB,QAAM,EAAE,oBAAAE,oBAAmB,IAAI,MAAM;AACrC,QAAM,EAAE,UAAU,WAAW,IAAI,QAAQ;AAEzC,MAAI,CAAC,YAAY,CAAC,YAAY;AAC1B,UAAM,IAAI,wBAAW,oBAAoB,gCAAgC;AAAA,EAC7E;AAEA,MAAI;AACA,UAAMA,oBAAmB,UAAU,UAAU;AAC7C,WAAO,EAAE,SAAS,MAAM,SAAS,wBAAwB,QAAQ,GAAG;AAAA,EACxE,SAASF,QAAY;AACjB,YAAQ,MAAM,6BAA6BA,MAAK;AAChD,UAAM,IAAI,wBAAW,YAAYA,OAAM,WAAW,sBAAsB;AAAA,EAC5E;AACJ,CAAC;","names":["db","admin","db","error","model","genAI","prompt","admin","import_generative_ai","admin","prompt","axios","error","admin","db","enqueueTask","error","admin","logger","import_generative_ai","admin","API_KEY","genAI","model","db","prompt","error","db","error","import_firestore","admin","logger","db","error","import_firestore","admin","import_generative_ai","admin","genAI","db","model","prompt","error","db","sendTemplatedEmail","error","db","error","db","sendTemplatedEmail"]}