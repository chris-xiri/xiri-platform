{"version":3,"sources":["../src/utils/emailUtils.ts","../src/utils/queueUtils.ts","../src/index.ts","../src/utils/firebase.ts","../src/agents/recruiter.ts","../src/agents/sourcer.ts","../src/triggers/onVendorApproved.ts","../src/utils/websiteScraper.ts","../src/utils/emailVerification.ts","../src/utils/phoneValidation.ts","../src/triggers/outreachWorker.ts","../src/agents/outreach.ts","../src/triggers/onIncomingMessage.ts","../src/triggers/onDocumentUploaded.ts","../src/agents/documentVerifier.ts","../src/triggers/sendBookingConfirmation.ts","../src/triggers/enrichFromWebsite.ts","../src/triggers/onOnboardingComplete.ts","../src/triggers/dripScheduler.ts","../src/triggers/handleUnsubscribe.ts"],"sourcesContent":["import * as admin from \"firebase-admin\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { Resend } from 'resend';\r\n\r\nconst db = admin.firestore();\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst resend = new Resend(process.env.RESEND_API_KEY || \"re_dummy_key\");\r\n\r\ninterface EmailTemplate {\r\n    subject: string;\r\n    content: string;\r\n    variables: string[];\r\n}\r\n\r\n/**\r\n * Fetch a template from Firestore\r\n */\r\nexport async function getTemplate(templateId: string): Promise<EmailTemplate | null> {\r\n    try {\r\n        const doc = await db.collection(\"templates\").doc(templateId).get();\r\n        if (!doc.exists) {\r\n            console.error(`Template ${templateId} not found`);\r\n            return null;\r\n        }\r\n        return doc.data() as EmailTemplate;\r\n    } catch (error) {\r\n        console.error(\"Error fetching template:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Replace variables in template content\r\n */\r\nexport function replaceVariables(content: string, variables: Record<string, string>): string {\r\n    return content.replace(/\\{\\{(\\w+)\\}\\}/g, (_, key) => variables[key] || `{{${key}}}`);\r\n}\r\n\r\n/**\r\n * Generate personalized email using AI\r\n */\r\nexport async function generatePersonalizedEmail(\r\n    templateId: string,\r\n    variables: Record<string, string>\r\n): Promise<{ subject: string; body: string } | null> {\r\n    try {\r\n        const template = await getTemplate(templateId);\r\n        if (!template) return null;\r\n\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const prompt = `You are a professional email writer for Xiri Facility Solutions.\r\n\r\nTake this email template and personalize it while maintaining the core message:\r\n\r\nSubject: ${template.subject}\r\nBody:\r\n${template.content}\r\n\r\nVariables to use:\r\n${Object.entries(variables).map(([key, val]) => `- ${key}: ${val}`).join('\\n')}\r\n\r\nInstructions:\r\n1. Replace all {{variables}} with the actual values\r\n2. Make the tone warm and professional\r\n3. Keep it concise (under 150 words)\r\n4. Output ONLY the email in this format:\r\nSUBJECT: [subject line]\r\nBODY:\r\n[email body]`;\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n\r\n        const response = result.response.text();\r\n        const subjectMatch = response.match(/SUBJECT:\\s*(.+)/);\r\n        const bodyMatch = response.match(/BODY:\\s*([\\s\\S]+)/);\r\n\r\n        if (!subjectMatch || !bodyMatch) {\r\n            // Fallback to simple variable replacement\r\n            return {\r\n                subject: replaceVariables(template.subject, variables),\r\n                body: replaceVariables(template.content, variables)\r\n            };\r\n        }\r\n\r\n        return {\r\n            subject: subjectMatch[1].trim(),\r\n            body: bodyMatch[1].trim()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating email:\", error);\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Parse a raw US address string into structured components.\r\n * Handles formats like:\r\n * - \"123 Main St, New Hyde Park, NY 11040\"\r\n * - \"123 Main St, New Hyde Park, NY\"\r\n * - \"New Hyde Park, NY 11040\"\r\n */\r\nexport function parseAddress(raw?: string): {\r\n    streetAddress: string;\r\n    city: string;\r\n    state: string;\r\n    zip: string;\r\n} {\r\n    const empty = { streetAddress: '', city: '', state: '', zip: '' };\r\n    if (!raw || raw === 'Unknown') return empty;\r\n\r\n    // Extract ZIP first\r\n    const zipMatch = raw.match(/\\b(\\d{5})(-\\d{4})?\\b/);\r\n    const zip = zipMatch ? zipMatch[1] : '';\r\n\r\n    // Remove ZIP from string for easier parsing\r\n    let cleaned = raw.replace(/\\b\\d{5}(-\\d{4})?\\b/, '').trim().replace(/,\\s*$/, '');\r\n\r\n    // Split by commas\r\n    const parts = cleaned.split(',').map(p => p.trim()).filter(Boolean);\r\n\r\n    if (parts.length >= 3) {\r\n        // \"123 Main St, New Hyde Park, NY\"\r\n        return {\r\n            streetAddress: parts[0],\r\n            city: parts[1],\r\n            state: parts[2].replace(/[^A-Za-z]/g, '').substring(0, 2).toUpperCase(),\r\n            zip\r\n        };\r\n    } else if (parts.length === 2) {\r\n        // Could be \"123 Main St, New Hyde Park\" or \"New Hyde Park, NY\"\r\n        const stateMatch = parts[1].match(/^([A-Z]{2})\\b/);\r\n        if (stateMatch) {\r\n            // \"New Hyde Park, NY\" — no street\r\n            return { streetAddress: '', city: parts[0], state: stateMatch[1], zip };\r\n        }\r\n        // \"123 Main St, New Hyde Park\" — no state\r\n        return { streetAddress: parts[0], city: parts[1], state: '', zip };\r\n    } else if (parts.length === 1) {\r\n        // Single string — try to extract state\r\n        const stateMatch = parts[0].match(/\\b([A-Z]{2})\\b/);\r\n        if (stateMatch) {\r\n            const beforeState = parts[0].substring(0, parts[0].indexOf(stateMatch[1])).trim();\r\n            return { streetAddress: '', city: beforeState, state: stateMatch[1], zip };\r\n        }\r\n        return { streetAddress: '', city: parts[0], state: '', zip };\r\n    }\r\n\r\n    return empty;\r\n}\r\n\r\n/**\r\n * Extract ZIP code from address string (legacy wrapper)\r\n */\r\nfunction extractZipFromAddress(address?: string): string | null {\r\n    return parseAddress(address).zip || null;\r\n}\r\n\r\n/**\r\n * Send templated email (mock for now)\r\n */\r\nexport async function sendTemplatedEmail(\r\n    vendorId: string,\r\n    templateId: string,\r\n    customVariables?: Record<string, string>\r\n): Promise<void> {\r\n    try {\r\n        // Fetch vendor data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            console.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n\r\n        const vendor = vendorDoc.data();\r\n\r\n        // Build variables\r\n        const variables = {\r\n            vendorName: vendor?.businessName || \"Vendor\",\r\n            zipCode: vendor?.zipCode || extractZipFromAddress(vendor?.address) || \"your area\",\r\n            specialty: vendor?.specialty || \"your trade\",\r\n            portalLink: `https://xiri.ai/vendor/onboarding/${vendorId}`,\r\n            ...customVariables\r\n        };\r\n\r\n        // Generate email\r\n        const email = await generatePersonalizedEmail(templateId, variables);\r\n        if (!email) {\r\n            console.error(\"Failed to generate email\");\r\n            return;\r\n        }\r\n\r\n        // Send email via Resend\r\n        let resendId: string | undefined;\r\n        try {\r\n            const { data } = await resend.emails.send({\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                replyTo: 'chris@xiri.ai',\r\n                to: vendor?.email || '',\r\n                subject: email.subject,\r\n                html: email.body,\r\n            });\r\n            resendId = data?.id;\r\n            console.log(`✅ Email sent to ${vendor?.companyName}: ${email.subject} (Resend ID: ${data?.id})`);\r\n        } catch (error) {\r\n            console.error('❌ Resend API error:', error);\r\n            // Log failure but don't throw - non-blocking\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId,\r\n                type: \"EMAIL_FAILED\",\r\n                description: `Failed to send email: ${email.subject}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                metadata: {\r\n                    templateId,\r\n                    subject: email.subject,\r\n                    to: vendor?.email || \"unknown\",\r\n                    error: String(error)\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Log successful send to vendor_activities\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"EMAIL_SENT\",\r\n            description: `Email sent: ${email.subject}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                templateId,\r\n                subject: email.subject,\r\n                body: email.body,\r\n                to: vendor?.email || \"unknown\",\r\n                resendId // NEW: Track Resend email ID\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Error sending email:\", error);\r\n    }\r\n}\r\n\r\n/**\r\n * Send a raw email with optional attachments\r\n */\r\nexport async function sendEmail(\r\n    to: string,\r\n    subject: string,\r\n    html: string,\r\n    attachments?: any[]\r\n): Promise<boolean> {\r\n    try {\r\n        const { data, error } = await resend.emails.send({\r\n            from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            replyTo: 'chris@xiri.ai',\r\n            to,\r\n            subject,\r\n            html,\r\n            attachments\r\n        });\r\n\r\n        if (error) {\r\n            console.error('❌ Resend API error:', error);\r\n            return false;\r\n        }\r\n\r\n        console.log(`✅ Email sent to ${to}: ${subject} (ID: ${data?.id})`);\r\n        return true;\r\n    } catch (err) {\r\n        console.error('Error sending raw email:', err);\r\n        return false;\r\n    }\r\n}\r\n","import * as admin from 'firebase-admin';\r\n\r\nexport type QueueTaskType = 'GENERATE' | 'SEND' | 'FOLLOW_UP';\r\nexport type QueueStatus = 'PENDING' | 'RETRY' | 'COMPLETED' | 'FAILED' | 'CANCELLED';\r\n\r\nexport interface QueueItem {\r\n    id?: string;\r\n    vendorId: string;\r\n    type: QueueTaskType;\r\n    status: QueueStatus;\r\n    scheduledAt: admin.firestore.Timestamp;\r\n    createdAt: admin.firestore.Timestamp;\r\n    retryCount: number;\r\n    error?: string;\r\n    metadata?: any; // e.g. drafts for SEND task, sequence number for FOLLOW_UP\r\n}\r\n\r\nconst COLLECTION = 'outreach_queue';\r\n\r\nexport async function enqueueTask(db: admin.firestore.Firestore, task: Omit<QueueItem, 'id' | 'createdAt' | 'retryCount' | 'status'>) {\r\n    return db.collection(COLLECTION).add({\r\n        ...task,\r\n        status: 'PENDING',\r\n        retryCount: 0,\r\n        createdAt: new Date() as any\r\n    });\r\n}\r\n\r\nexport async function fetchPendingTasks(db: admin.firestore.Firestore) {\r\n    const now = admin.firestore.Timestamp.now();\r\n\r\n    // Fetch items that are PENDING or RETRY and scheduled time is past\r\n    // NOTE: Requires composite index if we mix filter + sort on different fields extensively.\r\n    // Simple query: Status IN ['PENDING', 'RETRY'] AND scheduledAt <= now\r\n\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .where('scheduledAt', '<=', now)\r\n        .limit(10) // Process in batches\r\n        .get();\r\n\r\n    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as QueueItem));\r\n}\r\n\r\nexport async function updateTaskStatus(db: admin.firestore.Firestore, taskId: string, status: QueueStatus, updates: Partial<QueueItem> = {}) {\r\n    await db.collection(COLLECTION).doc(taskId).update({\r\n        status,\r\n        ...updates\r\n    });\r\n}\r\n\r\n/**\r\n * Cancel all pending/retry tasks for a vendor (used on unsubscribe/dismiss).\r\n */\r\nexport async function cancelVendorTasks(db: admin.firestore.Firestore, vendorId: string) {\r\n    const snapshot = await db.collection(COLLECTION)\r\n        .where('vendorId', '==', vendorId)\r\n        .where('status', 'in', ['PENDING', 'RETRY'])\r\n        .get();\r\n\r\n    const batch = db.batch();\r\n    snapshot.docs.forEach(doc => {\r\n        batch.update(doc.ref, { status: 'CANCELLED', cancelledAt: new Date() });\r\n    });\r\n    await batch.commit();\r\n    return snapshot.size;\r\n}\r\n\r\n","import { onCall, onRequest, HttpsError } from \"firebase-functions/v2/https\";\r\nimport { db } from \"./utils/firebase\";\r\nimport { analyzeVendorLeads } from \"./agents/recruiter\";\r\nimport { searchVendors } from \"./agents/sourcer\";\r\n// import { telegramWebhook, autoApproveVendor, notifyHumanReview, onVendorCreated } from \"./triggers/telegramBot\";\r\nimport { onVendorApproved, onVendorCreated } from \"./triggers/onVendorApproved\";\r\nimport { processOutreachQueue } from \"./triggers/outreachWorker\";\r\nimport { onIncomingMessage } from \"./triggers/onIncomingMessage\";\r\nimport { onDocumentUploaded } from \"./triggers/onDocumentUploaded\";\r\nimport { sendBookingConfirmation } from \"./triggers/sendBookingConfirmation\";\r\nimport { enrichFromWebsite } from \"./triggers/enrichFromWebsite\";\r\nimport { onOnboardingComplete } from \"./triggers/onOnboardingComplete\";\r\nimport { onAwaitingOnboarding } from \"./triggers/dripScheduler\";\r\nimport { handleUnsubscribe } from \"./triggers/handleUnsubscribe\";\r\n\r\n// Export Bot Functions (Telegram disabled for now)\r\n// export { telegramWebhook, autoApproveVendor, onVendorCreated, onVendorApproved, processOutreachQueue, onIncomingMessage, onDocumentUploaded };\r\nexport { onVendorApproved, onVendorCreated, processOutreachQueue, onIncomingMessage, onDocumentUploaded, sendBookingConfirmation, enrichFromWebsite, onOnboardingComplete, onAwaitingOnboarding, handleUnsubscribe };\r\n\r\n// 1. Lead Sourcing Agent Trigger\r\nexport const generateLeads = onCall({\r\n    secrets: [\"SERPER_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\", // Dashboard Dev\r\n        \"http://localhost:3000\", // Public Site Dev\r\n        \"https://xiri.ai\", // Public Site Production\r\n        \"https://www.xiri.ai\", // Public Site WWW\r\n        \"https://app.xiri.ai\", // Dashboard Production\r\n        \"https://xiri-dashboard.vercel.app\", // Dashboard Vercel\r\n        \"https://xiri-dashboard-git-develop-xiri-facility-solutions.vercel.app\", // Vercel develop branch\r\n        /https:\\/\\/xiri-dashboard-.*\\.vercel\\.app$/, // All Vercel preview deployments\r\n        \"https://xiri-facility-solutions.web.app\", // Firebase Hosting\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n    timeoutSeconds: 540\r\n}, async (request) => {\r\n    const data = request.data || {};\r\n    const query = data.query;\r\n    const location = data.location;\r\n    const hasActiveContract = data.hasActiveContract || false; // Default to false (Building Supply)\r\n    const previewOnly = data.previewOnly || false; // Preview mode: don't save to Firestore\r\n\r\n    if (!query || !location) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing 'query' or 'location' in request.\");\r\n    }\r\n\r\n    try {\r\n        console.log(`Analyzing leads for query: ${query}, location: ${location}${previewOnly ? ' (PREVIEW MODE)' : ''}`);\r\n\r\n        // 1. Source Leads\r\n        const rawVendors = await searchVendors(query, location);\r\n        console.log(`Sourced ${rawVendors.length} vendors.`);\r\n\r\n        // 2. Analyze & Qualify (Recruiter Agent)\r\n        // When previewOnly=true, vendors are NOT saved to Firestore\r\n        const result = await analyzeVendorLeads(rawVendors, query, hasActiveContract, previewOnly);\r\n\r\n        return {\r\n            message: \"Lead generation process completed.\",\r\n            sourced: rawVendors.length,\r\n            analysis: result,\r\n            // Include vendor data in response for preview mode\r\n            vendors: previewOnly ? result.vendors : undefined\r\n        };\r\n    } catch (error: any) {\r\n        console.error(\"Error in generateLeads:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"An internal error occurred.\");\r\n    }\r\n});\r\n\r\n// 2. Clear Pipeline Tool\r\nexport const clearPipeline = onCall({\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    try {\r\n        const snapshot = await db.collection('vendors').get();\r\n\r\n        if (snapshot.empty) {\r\n            return { message: \"Pipeline already empty.\" };\r\n        }\r\n\r\n        // Firestore batch max is 500. If we have more, we need multiple batches.\r\n        // For safe deletion, we'll do chunks of 500.\r\n        let count = 0;\r\n        const chunks = [];\r\n        let currentBatch = db.batch(); // We can't reuse the outer batch easily if we chunk\r\n\r\n        snapshot.docs.forEach((doc, index) => {\r\n            currentBatch.delete(doc.ref);\r\n            count++;\r\n            if (count % 400 === 0) {\r\n                chunks.push(currentBatch.commit());\r\n                currentBatch = db.batch();\r\n            }\r\n        });\r\n\r\n        chunks.push(currentBatch.commit());\r\n        await Promise.all(chunks);\r\n\r\n        return { message: `Cleared ${count} vendors from pipeline.` };\r\n    } catch (error: any) {\r\n        throw new HttpsError(\"internal\", error.message);\r\n    }\r\n});\r\n\r\n// Test Function to manually trigger recruiter agent\r\nexport const runRecruiterAgent = onRequest({ secrets: [\"GEMINI_API_KEY\"] }, async (req, res) => {\r\n    // Mock data for testing\r\n    const rawVendors = req.body.vendors || [\r\n        { name: \"ABC Cleaning\", services: \"We do medical office cleaning and terminal cleaning.\" },\r\n        { name: \"Joe's Pizza\", services: \"Best pizza in town\" },\r\n        { name: \"Elite HVAC\", services: \"Commercial HVAC systems\" }\r\n    ];\r\n\r\n    const result = await analyzeVendorLeads(rawVendors, \"Commercial Cleaning\");\r\n    res.json(result);\r\n});\r\n\r\n\r\n// Test Function to manually trigger notification (Telegram disabled for now)\r\n/* export const testNotification = onRequest(async (req, res) => {\r\n    const vendorId = req.query.vendorId as any;\r\n    if (vendorId) {\r\n        await notifyHumanReview(vendorId);\r\n        res.send(`Notification sent for ${vendorId}`);\r\n    } else {\r\n        res.status(400).send(\"Provide vendorId query param\");\r\n    }\r\n}); */\r\n\r\nexport const testSendEmail = onCall({\r\n    secrets: [\"RESEND_API_KEY\", \"GEMINI_API_KEY\"],\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\"\r\n    ]\r\n}, async (request) => {\r\n    const { sendTemplatedEmail } = await import(\"./utils/emailUtils\");\r\n    const { vendorId, templateId } = request.data;\r\n\r\n    if (!vendorId || !templateId) {\r\n        throw new HttpsError(\"invalid-argument\", \"Missing vendorId or templateId\");\r\n    }\r\n\r\n    try {\r\n        await sendTemplatedEmail(vendorId, templateId);\r\n        return { success: true, message: `Email sent to vendor ${vendorId}` };\r\n    } catch (error: any) {\r\n        console.error(\"Error sending test email:\", error);\r\n        throw new HttpsError(\"internal\", error.message || \"Failed to send email\");\r\n    }\r\n});\r\n","import * as admin from \"firebase-admin\";\r\nimport * as dotenv from \"dotenv\";\r\n\r\ndotenv.config();\r\n\r\n// Initialize Admin only once\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nexport const db = admin.firestore();\r\n\r\n// Global Firestore Settings\r\n// ignoreUndefinedProperties: true allows us to save objects with undefined fields (e.g. missing optional data)\r\ntry {\r\n    db.settings({ ignoreUndefinedProperties: true });\r\n} catch (error) {\r\n    // Ignore error if settings already applied\r\n    console.log(\"Firestore settings usage note:\", error);\r\n}\r\n\r\nexport { admin };\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { admin, db } from \"../utils/firebase\";\r\nimport { Vendor, RecruitmentAnalysisResult } from \"../utils/types\";\r\nimport { parseAddress } from \"../utils/emailUtils\";\r\n\r\n// Initialize Gemini\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\nexport const analyzeVendorLeads = async (rawVendors: any[], jobQuery: string, hasActiveContract: boolean = false, previewOnly: boolean = false): Promise<RecruitmentAnalysisResult> => {\r\n    console.log(\"!!! RECRUITER AGENT UPDATED - V3 (Deduplication) !!!\");\r\n    let analyzed = 0;\r\n    let qualified = 0;\r\n    const errors: string[] = [];\r\n    const batch = db.batch();\r\n    const previewVendors: Vendor[] = [];\r\n\r\n    // We process in chunks if rawVendors is huge, but per prompt \"db.batch() ... processing 50+ vendors\"\r\n    // Firestore batch limit is 500. We'll assume rawVendors length < 500 for this iteration or just one batch.\r\n\r\n    // Construct the prompt\r\n    // We will send vendors in a batch to Gemini to save tokens/time if possible, \r\n    // or iterate. The prompt implies \"The function should accept a raw list... and use Gemini to Classify\".\r\n    // Doing it one by one might be slow, doing all at once might hit token limits. \r\n    // Let's do a simple loop for now as it's safer for \"Classify: Identify if the vendor...\". \r\n    // Actually, passing the whole list is better for 50 items.\r\n\r\n    if (rawVendors.length === 0) return { analyzed, qualified, errors };\r\n\r\n    // Determine strictness based on contract status\r\n    // Building Supply (hasActiveContract = false) -> Accept All (0 threshold)\r\n    // Urgent (hasActiveContract = true) -> Strict (50 threshold)\r\n    const threshold = hasActiveContract ? 50 : 0;\r\n    const modeDescription = hasActiveContract\r\n        ? \"URGENT FULFILLMENT: We need high-quality vendors ready to deploy. Be strict.\"\r\n        : \"DATABASE BUILDING: We are building a supply list. ACCEPT ALL VENDORS. Do not filter. Score is for reference only.\";\r\n\r\n    // List to process, defaults to rawVendors if deduplication fails or isn't run\r\n    let vendorsToAnalyze = rawVendors;\r\n    let prompt = \"\";\r\n\r\n    try {\r\n        // Build dismissed vendor name set (for tagging, not filtering)\r\n        let dismissedNames = new Set<string>();\r\n        try {\r\n            const dismissedSnapshot = await db.collection('dismissed_vendors').get();\r\n            if (!dismissedSnapshot.empty) {\r\n                dismissedNames = new Set(\r\n                    dismissedSnapshot.docs.map(doc => (doc.data().businessName || '').toLowerCase().trim())\r\n                );\r\n                console.log(`Loaded ${dismissedNames.size} dismissed vendor names for tagging.`);\r\n            }\r\n        } catch (dismissErr: any) {\r\n            console.warn(\"Could not check dismissed_vendors:\", dismissErr.message);\r\n        }\r\n\r\n        // Pre-process for duplicates (against existing vendors collection)\r\n        const vendorsToProcess: any[] = [];\r\n        const duplicateUpdates: Promise<any>[] = [];\r\n\r\n        console.log(`Checking ${rawVendors.length} vendors for duplicates...`);\r\n\r\n        for (const vendor of rawVendors) {\r\n            const bName = vendor.name || vendor.companyName || vendor.title;\r\n            if (!bName) {\r\n                vendorsToProcess.push(vendor);\r\n                continue;\r\n            }\r\n\r\n            // Check if exists\r\n            const existingSnapshot = await db.collection('vendors')\r\n                .where('businessName', '==', bName)\r\n                .limit(1)\r\n                .get();\r\n\r\n            if (!existingSnapshot.empty) {\r\n                const docId = existingSnapshot.docs[0].id;\r\n                console.log(`Found existing vendor: ${bName} (${docId}). Updating timestamp.`);\r\n                duplicateUpdates.push(\r\n                    db.collection('vendors').doc(docId).update({\r\n                        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n                    })\r\n                );\r\n            } else {\r\n                vendorsToProcess.push(vendor);\r\n            }\r\n        }\r\n\r\n        // Execute duplicate updates\r\n        if (duplicateUpdates.length > 0) {\r\n            await Promise.all(duplicateUpdates);\r\n            console.log(`Updated ${duplicateUpdates.length} existing vendors.`);\r\n        }\r\n\r\n        if (vendorsToProcess.length === 0) {\r\n            console.log(\"All vendors were duplicates or dismissed. Sourcing complete.\");\r\n            return { analyzed, qualified, errors };\r\n        }\r\n\r\n        // Continue with unique vendors\r\n        vendorsToAnalyze = vendorsToProcess;\r\n\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"recruiter_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Recruiter analysis prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const vendorList = JSON.stringify(vendorsToAnalyze.map((v, i) => ({\r\n            index: i,\r\n            name: v.name || v.companyName,\r\n            description: v.description || v.services,\r\n            address: v.location || v.address || v.vicinity, // Google Places often uses 'vicinity'\r\n            website: v.website,\r\n            phone: v.phone\r\n        })));\r\n\r\n        // Replace variables\r\n        prompt = template?.content\r\n            .replace(/\\{\\{query\\}\\}/g, jobQuery)\r\n            .replace(/\\{\\{modeDescription\\}\\}/g, modeDescription)\r\n            .replace(/\\{\\{threshold\\}\\}/g, threshold.toString())\r\n            .replace(/\\{\\{vendorList\\}\\}/g, vendorList);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        console.log(\"Gemini Raw Response:\", text); // Debug log\r\n\r\n        // Naive JSON clean up\r\n        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\r\n        const analysis = JSON.parse(jsonStr) as any[];\r\n\r\n        analyzed = analysis.length;\r\n\r\n        for (const item of analysis) {\r\n            if (item.isQualified) {\r\n                qualified++;\r\n                // Ensure index matches the filtered list\r\n                const originalVendor = vendorsToAnalyze[item.index];\r\n                if (!originalVendor) {\r\n                    console.warn(`Analysis returned index ${item.index} but we only have ${vendorsToAnalyze.length} vendors.`);\r\n                    continue;\r\n                }\r\n\r\n                // Fallback for business name\r\n                const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n                const vendorRef = db.collection('vendors').doc(); // Auto-ID\r\n                const rawAddr = originalVendor.location || item.address || \"Unknown\";\r\n                const parsed = parseAddress(rawAddr);\r\n                const newVendor: Vendor = {\r\n                    id: vendorRef.id,\r\n                    businessName: bName,\r\n                    capabilities: item.specialty ? [item.specialty] : [],\r\n                    address: rawAddr,\r\n                    streetAddress: parsed.streetAddress || undefined,\r\n                    city: item.city || parsed.city || undefined,\r\n                    state: item.state || parsed.state || undefined,\r\n                    zip: item.zip || parsed.zip || undefined,\r\n                    country: item.country || \"USA\",\r\n                    phone: originalVendor.phone || item.phone || undefined,\r\n                    email: originalVendor.email || item.email || undefined,\r\n                    website: originalVendor.website || item.website || undefined,\r\n                    fitScore: item.fitScore,\r\n                    hasActiveContract: hasActiveContract,\r\n                    onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                    status: 'pending_review',\r\n                    createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                    updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n                };\r\n\r\n                console.log(`Adding qualified vendor to batch: ${newVendor.businessName}`);\r\n                if (previewOnly) {\r\n                    // Tag as dismissed if in blacklist\r\n                    const isDismissed = dismissedNames.has((newVendor.businessName || '').toLowerCase().trim());\r\n                    previewVendors.push({ ...newVendor, isDismissed } as any);\r\n                } else {\r\n                    batch.set(vendorRef, newVendor);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (qualified > 0 && !previewOnly) {\r\n            console.log(`Committing batch of ${qualified} vendors...`);\r\n            await batch.commit();\r\n            console.log(\"Batch commit successful.\");\r\n        } else if (previewOnly) {\r\n            console.log(`Preview mode: ${qualified} vendors ready for review (not saved).`);\r\n        } else {\r\n            console.log(\"No qualified vendors to commit.\");\r\n        }\r\n\r\n    } catch (err: any) {\r\n        console.error(\"AI Analysis Failed:\", err.message);\r\n        console.error(\"Prompt used:\", prompt); // Log the prompt to debug formatting issues\r\n        errors.push(err.message);\r\n\r\n        // Fallback: Save vendors without analysis if AI fails\r\n        console.log(\"Saving raw vendors with 'pending_review' status due to AI failure...\");\r\n\r\n        for (const originalVendor of vendorsToAnalyze) {\r\n            const vendorRef = db.collection('vendors').doc();\r\n            // Fallback for business name: Use 'name' or 'companyName' or 'title' from raw source\r\n            const bName = originalVendor.name || originalVendor.companyName || originalVendor.title || \"Unknown Vendor\";\r\n\r\n            const rawAddr = originalVendor.location || originalVendor.address || \"Unknown\";\r\n            const parsed = parseAddress(rawAddr);\r\n            const newVendor: Vendor = {\r\n                id: vendorRef.id,\r\n                businessName: bName,\r\n                capabilities: [],\r\n                address: rawAddr,\r\n                streetAddress: parsed.streetAddress || undefined,\r\n                city: parsed.city || undefined,\r\n                state: parsed.state || undefined,\r\n                zip: parsed.zip || undefined,\r\n                phone: originalVendor.phone || undefined,\r\n                email: originalVendor.email || undefined,\r\n                website: originalVendor.website || undefined,\r\n                fitScore: 0,\r\n                status: 'pending_review',\r\n                hasActiveContract: hasActiveContract,\r\n                onboardingTrack: hasActiveContract ? 'FAST_TRACK' : 'STANDARD',\r\n                aiReasoning: `AI Analysis Failed: ${err.message}`,\r\n                createdAt: admin.firestore.FieldValue.serverTimestamp() as any,\r\n                updatedAt: admin.firestore.FieldValue.serverTimestamp() as any\r\n            };\r\n            batch.set(vendorRef, newVendor);\r\n            if (previewOnly) {\r\n                previewVendors.push(newVendor);\r\n            }\r\n            qualified++;\r\n        }\r\n\r\n        if (qualified > 0 && !previewOnly) {\r\n            console.log(`Committing batch of ${qualified} fallback vendors...`);\r\n            await batch.commit();\r\n        }\r\n    }\r\n\r\n    return { analyzed, qualified, errors, vendors: previewOnly ? previewVendors : undefined };\r\n};\r\n","import axios from 'axios';\r\n\r\n// Define the shape of a raw vendor outcome\r\nexport interface RawVendor {\r\n    name: string;\r\n    description: string;\r\n    location: string;\r\n    phone?: string;\r\n    website?: string;\r\n    source: string;\r\n    rating?: number;\r\n    user_ratings_total?: number;\r\n}\r\n\r\n/**\r\n * Lead Sourcing Agent\r\n * Uses Serper.dev (Google Maps) to find vendors.\r\n * \r\n * Requires: process.env.SERPER_API_KEY\r\n */\r\nexport const searchVendors = async (query: string, location: string): Promise<RawVendor[]> => {\r\n    const apiKey = process.env.SERPER_API_KEY || \"02ece77ffd27d2929e3e79604cb27e1dfaa40fe7\";\r\n    if (!apiKey) {\r\n        console.warn(\"SERPER_API_KEY is not set. Returning mock data.\");\r\n        return getMockVendors(query, location);\r\n    }\r\n\r\n    const fullQuery = `${query} in ${location}`;\r\n    console.log(`Searching for: ${fullQuery} using Serper (places)...`);\r\n\r\n    try {\r\n        const response = await axios.post(\r\n            'https://google.serper.dev/places',\r\n            { q: fullQuery },\r\n            { headers: { 'X-API-KEY': apiKey.trim(), 'Content-Type': 'application/json' } }\r\n        );\r\n\r\n        const places = response.data.places || [];\r\n        console.log(`Serper returned ${places.length} raw results.`);\r\n\r\n        // Return results directly from Serper without strict string matching on the city\r\n        // This allows \"NYC\" -> \"New York\" matches to persist.\r\n        const rawVendors = places.map((place: any) => ({\r\n            name: place.title,\r\n            description: `${place.category || ''} - ${place.address || ''}`,\r\n            location: place.address,\r\n            phone: place.phoneNumber,\r\n            website: place.website,\r\n            source: 'google_maps_serper',\r\n            rating: place.rating,\r\n            user_ratings_total: place.userRatingsTotal\r\n        }));\r\n\r\n        // Filter out low-rated vendors immediately\r\n        const filteredVendors = rawVendors.filter((v: any) => v.rating === undefined || v.rating >= 3.5);\r\n        console.log(`Filtered ${rawVendors.length} -> ${filteredVendors.length} vendors (Rating >= 3.5 or N/A).`);\r\n\r\n        return filteredVendors;\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Error searching vendors:\", error.message);\r\n        throw new Error(`Failed to source vendors: ${error.message}`);\r\n    }\r\n};\r\n\r\n// Fallback Mock Data if no API Key\r\nconst getMockVendors = (query: string, location: string): RawVendor[] => {\r\n    return [\r\n        {\r\n            name: \"Mock Cleaning Services \" + location,\r\n            description: \"Deep comercial cleaning and janitorial services.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"Test HVAC Solutions \" + location,\r\n            description: \"HVAC maintenance and repair.\",\r\n            location: location,\r\n            source: 'mock'\r\n        },\r\n        {\r\n            name: \"General Facilities Co\",\r\n            description: \"We do everything including plumbing and electrical.\",\r\n            location: location,\r\n            source: 'mock'\r\n        }\r\n    ];\r\n};\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport { defineSecret } from \"firebase-functions/params\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { scrapeWebsite } from \"../utils/websiteScraper\";\r\nimport { verifyEmail, isDisposableEmail, isRoleBasedEmail } from \"../utils/emailVerification\";\r\nimport { validatePhone } from \"../utils/phoneValidation\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\nconst GEMINI_API_KEY = defineSecret(\"GEMINI_API_KEY\");\r\n\r\nconsole.log(\"Loading onVendorApproved trigger...\");\r\n\r\n// ─── Trigger 1: Existing vendor updated TO 'qualified' ───\r\nexport const onVendorApproved = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [GEMINI_API_KEY],\r\n}, async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const newData = event.data.after.data();\r\n    const oldData = event.data.before.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!newData || !oldData) return;\r\n    if (newData.status !== 'qualified' || oldData.status === 'qualified') return;\r\n\r\n    logger.info(`[UPDATE] Vendor ${vendorId} status changed to qualified.`);\r\n    await runEnrichPipeline(vendorId, newData, oldData.status);\r\n});\r\n\r\n// ─── Trigger 2: New vendor created WITH status 'qualified' ───\r\nexport const onVendorCreated = onDocumentCreated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [GEMINI_API_KEY],\r\n}, async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const data = event.data.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!data) return;\r\n    if (data.status !== 'qualified') return;\r\n\r\n    logger.info(`[CREATE] Vendor ${vendorId} created with status qualified.`);\r\n    await runEnrichPipeline(vendorId, data, 'new');\r\n});\r\n\r\n\r\n// ═══════════════════════════════════════════════════════════\r\n//  SHARED PIPELINE LOGIC\r\n// ═══════════════════════════════════════════════════════════\r\n\r\nasync function runEnrichPipeline(vendorId: string, vendorData: any, previousStatus: string) {\r\n    try {\r\n        // 1. Log Activity: \"Vendor Approved\"\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: \"Vendor approved — starting onboarding pipeline.\",\r\n            createdAt: new Date(),\r\n            metadata: {\r\n                oldStatus: previousStatus,\r\n                newStatus: 'qualified',\r\n                onboardingTrack: vendorData.onboardingTrack || 'STANDARD',\r\n            }\r\n        });\r\n\r\n        const vendorEmail = vendorData.email?.trim();\r\n        const vendorWebsite = vendorData.website?.trim();\r\n\r\n        // ─── BRANCH 1: Already has email → go straight to outreach ───\r\n        if (vendorEmail) {\r\n            logger.info(`Vendor ${vendorId} has email (${vendorEmail}). Proceeding to outreach.`);\r\n            await setOutreachPending(vendorId, vendorData);\r\n            return;\r\n        }\r\n\r\n        // ─── BRANCH 2: No email but has website → try enrichment ───\r\n        if (vendorWebsite) {\r\n            logger.info(`Vendor ${vendorId} has no email but has website. Enriching...`);\r\n\r\n            await db.collection(\"vendors\").doc(vendorId).update({\r\n                outreachStatus: 'ENRICHING',\r\n                statusUpdatedAt: new Date(),\r\n            });\r\n\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId,\r\n                type: \"ENRICHMENT\",\r\n                description: `Scraping ${vendorWebsite} for contact info...`,\r\n                createdAt: new Date(),\r\n            });\r\n\r\n            try {\r\n                const scrapedResult = await scrapeWebsite(vendorWebsite, GEMINI_API_KEY.value());\r\n\r\n                if (!scrapedResult.success || !scrapedResult.data) {\r\n                    logger.warn(`Enrichment failed for ${vendorId}: ${scrapedResult.error}`);\r\n                    await markNeedsContact(vendorId, \"Website scrape failed\");\r\n                    return;\r\n                }\r\n\r\n                const scrapedData = scrapedResult.data;\r\n                const updateData: any = { updatedAt: admin.firestore.FieldValue.serverTimestamp() };\r\n                const enrichedFields: string[] = [];\r\n\r\n                // Verify and save email\r\n                let foundEmail: string | undefined;\r\n                if (scrapedData.email) {\r\n                    const emailVerification = await verifyEmail(scrapedData.email);\r\n                    if (emailVerification.valid &&\r\n                        emailVerification.deliverable &&\r\n                        !isDisposableEmail(scrapedData.email) &&\r\n                        !isRoleBasedEmail(scrapedData.email)) {\r\n                        foundEmail = scrapedData.email;\r\n                        updateData.email = foundEmail;\r\n                        enrichedFields.push('email');\r\n                    } else {\r\n                        logger.info(`Scraped email ${scrapedData.email} failed verification.`);\r\n                    }\r\n                }\r\n\r\n                // Validate and save phone\r\n                if (scrapedData.phone && !vendorData.phone) {\r\n                    const phoneValidation = validatePhone(scrapedData.phone);\r\n                    if (phoneValidation.valid) {\r\n                        updateData.phone = phoneValidation.formatted;\r\n                        enrichedFields.push('phone');\r\n                    }\r\n                }\r\n\r\n                // Save address if missing\r\n                if (scrapedData.address && !vendorData.address) {\r\n                    updateData.address = scrapedData.address;\r\n                    enrichedFields.push('address');\r\n                }\r\n\r\n                // Save social media\r\n                if (scrapedData.socialMedia) {\r\n                    const sm: any = {};\r\n                    if (scrapedData.socialMedia.linkedin) { sm.linkedin = scrapedData.socialMedia.linkedin; enrichedFields.push('linkedin'); }\r\n                    if (scrapedData.socialMedia.facebook) { sm.facebook = scrapedData.socialMedia.facebook; enrichedFields.push('facebook'); }\r\n                    if (scrapedData.socialMedia.twitter) { sm.twitter = scrapedData.socialMedia.twitter; enrichedFields.push('twitter'); }\r\n                    if (Object.keys(sm).length > 0) updateData.socialMedia = sm;\r\n                }\r\n\r\n                // Enrichment metadata\r\n                updateData.enrichment = {\r\n                    lastEnriched: admin.firestore.FieldValue.serverTimestamp(),\r\n                    enrichedFields,\r\n                    enrichmentSource: 'auto_onboarding',\r\n                    scrapedWebsite: vendorWebsite,\r\n                    confidence: scrapedData.confidence,\r\n                };\r\n\r\n                // Update vendor doc with scraped data\r\n                if (enrichedFields.length > 0) {\r\n                    await db.collection(\"vendors\").doc(vendorId).update(updateData);\r\n                }\r\n\r\n                await db.collection(\"vendor_activities\").add({\r\n                    vendorId,\r\n                    type: \"ENRICHMENT\",\r\n                    description: enrichedFields.length > 0\r\n                        ? `Enriched ${enrichedFields.length} field(s): ${enrichedFields.join(', ')}`\r\n                        : \"No new fields found from website.\",\r\n                    createdAt: new Date(),\r\n                    metadata: { enrichedFields, confidence: scrapedData.confidence },\r\n                });\r\n\r\n                // Did we find an email?\r\n                if (foundEmail) {\r\n                    logger.info(`Found email ${foundEmail} for vendor ${vendorId}. Proceeding to outreach.`);\r\n                    const updatedDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n                    await setOutreachPending(vendorId, updatedDoc.data() || vendorData);\r\n                } else {\r\n                    await markNeedsContact(vendorId, \"No email found after enrichment\");\r\n                }\r\n\r\n            } catch (enrichError: any) {\r\n                logger.error(`Enrichment error for ${vendorId}:`, enrichError);\r\n                await markNeedsContact(vendorId, `Enrichment error: ${enrichError.message}`);\r\n            }\r\n\r\n            return;\r\n        }\r\n\r\n        // ─── BRANCH 3: No email AND no website → needs manual contact ───\r\n        logger.info(`Vendor ${vendorId} has no email and no website. Marking NEEDS_CONTACT.`);\r\n        await markNeedsContact(vendorId, \"No email or website available\");\r\n\r\n    } catch (error) {\r\n        logger.error(\"Error in enrich pipeline:\", error);\r\n    }\r\n}\r\n\r\n\r\n// ─── Helper: set outreach pending and enqueue GENERATE task ───\r\nasync function setOutreachPending(vendorId: string, vendorData: any) {\r\n    await db.collection(\"vendors\").doc(vendorId).update({\r\n        outreachStatus: 'PENDING',\r\n        statusUpdatedAt: new Date(),\r\n    });\r\n\r\n    const { enqueueTask } = await import(\"../utils/queueUtils\");\r\n    await enqueueTask(db, {\r\n        vendorId,\r\n        type: 'GENERATE',\r\n        scheduledAt: new Date() as any,\r\n        metadata: {\r\n            status: vendorData.status,\r\n            hasActiveContract: vendorData.hasActiveContract,\r\n            phone: vendorData.phone,\r\n            companyName: vendorData.businessName,\r\n            specialty: vendorData.specialty || vendorData.capabilities?.[0],\r\n        }\r\n    });\r\n\r\n    logger.info(`Outreach GENERATE task enqueued for vendor ${vendorId}`);\r\n}\r\n\r\n\r\n// ─── Helper: mark vendor as NEEDS_CONTACT ───\r\nasync function markNeedsContact(vendorId: string, reason: string) {\r\n    await db.collection(\"vendors\").doc(vendorId).update({\r\n        outreachStatus: 'NEEDS_CONTACT',\r\n        statusUpdatedAt: new Date(),\r\n    });\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"NEEDS_CONTACT\",\r\n        description: `Manual outreach required: ${reason}`,\r\n        createdAt: new Date(),\r\n    });\r\n\r\n    logger.info(`Vendor ${vendorId} marked NEEDS_CONTACT: ${reason}`);\r\n}\r\n","import * as cheerio from 'cheerio';\r\nimport { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\ninterface ScrapedData {\r\n    email?: string;\r\n    phone?: string;\r\n    address?: string;\r\n    businessName?: string;\r\n    socialMedia?: {\r\n        linkedin?: string;\r\n        facebook?: string;\r\n        twitter?: string;\r\n    };\r\n    confidence: 'high' | 'medium' | 'low';\r\n    source: string;\r\n}\r\n\r\ninterface EnrichmentResult {\r\n    success: boolean;\r\n    data?: ScrapedData;\r\n    error?: string;\r\n}\r\n\r\n/**\r\n * Scrapes a website and extracts contact information using AI-powered extraction\r\n */\r\nexport async function scrapeWebsite(url: string, geminiApiKey: string): Promise<EnrichmentResult> {\r\n    try {\r\n        // 1. Fetch website HTML\r\n        const response = await fetch(url, {\r\n            headers: {\r\n                'User-Agent': 'Mozilla/5.0 (compatible; XiriBot/1.0; +https://xiri.ai/bot)',\r\n            },\r\n            signal: AbortSignal.timeout(10000), // 10 second timeout\r\n        });\r\n\r\n        if (!response.ok) {\r\n            return { success: false, error: `HTTP ${response.status}: ${response.statusText}` };\r\n        }\r\n\r\n        const html = await response.text();\r\n        const $ = cheerio.load(html);\r\n\r\n        // 2. Extract structured data first (fastest, most reliable)\r\n        const structuredData = extractStructuredData($);\r\n\r\n        // 3. Extract from common patterns\r\n        const patternData = extractFromPatterns($, html);\r\n\r\n        // 4. Find and scrape contact page if needed\r\n        let contactPageData: Partial<ScrapedData> = {};\r\n        if (!structuredData.email || !structuredData.phone) {\r\n            const contactUrl = findContactPage($, url);\r\n            if (contactUrl) {\r\n                contactPageData = await scrapeContactPage(contactUrl);\r\n            }\r\n        }\r\n\r\n        // 5. Combine all data sources\r\n        const combinedData: ScrapedData = {\r\n            email: structuredData.email || patternData.email || contactPageData.email,\r\n            phone: structuredData.phone || patternData.phone || contactPageData.phone,\r\n            address: structuredData.address || patternData.address || contactPageData.address,\r\n            businessName: structuredData.businessName || patternData.businessName,\r\n            socialMedia: {\r\n                linkedin: patternData.socialMedia?.linkedin,\r\n                facebook: patternData.socialMedia?.facebook,\r\n                twitter: patternData.socialMedia?.twitter,\r\n            },\r\n            confidence: determineConfidence(structuredData, patternData, contactPageData),\r\n            source: 'web-scraper',\r\n        };\r\n\r\n        // 6. If still missing critical data, use AI extraction\r\n        if (!combinedData.email || !combinedData.phone) {\r\n            const aiData = await extractWithAI(html, geminiApiKey);\r\n            combinedData.email = combinedData.email || aiData.email;\r\n            combinedData.phone = combinedData.phone || aiData.phone;\r\n            combinedData.address = combinedData.address || aiData.address;\r\n        }\r\n\r\n        // 7. Validate and format data\r\n        if (combinedData.email) {\r\n            combinedData.email = validateEmail(combinedData.email);\r\n        }\r\n        if (combinedData.phone) {\r\n            combinedData.phone = formatPhone(combinedData.phone);\r\n        }\r\n\r\n        return { success: true, data: combinedData };\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message };\r\n    }\r\n}\r\n\r\n/**\r\n * Extract data from structured meta tags and schema.org\r\n */\r\nfunction extractStructuredData($: cheerio.CheerioAPI): Partial<ScrapedData> {\r\n    const data: Partial<ScrapedData> = {};\r\n\r\n    // Meta tags\r\n    data.email = $('meta[property=\"og:email\"]').attr('content') ||\r\n        $('meta[name=\"contact:email\"]').attr('content');\r\n\r\n    data.phone = $('meta[property=\"og:phone_number\"]').attr('content') ||\r\n        $('meta[name=\"contact:phone\"]').attr('content');\r\n\r\n    // Schema.org structured data\r\n    $('script[type=\"application/ld+json\"]').each((_, elem) => {\r\n        try {\r\n            const json = JSON.parse($(elem).html() || '{}');\r\n            if (json['@type'] === 'Organization' || json['@type'] === 'LocalBusiness') {\r\n                data.email = data.email || json.email;\r\n                data.phone = data.phone || json.telephone;\r\n                data.businessName = data.businessName || json.name;\r\n                if (json.address) {\r\n                    data.address = typeof json.address === 'string'\r\n                        ? json.address\r\n                        : `${json.address.streetAddress}, ${json.address.addressLocality}, ${json.address.addressRegion} ${json.address.postalCode}`;\r\n                }\r\n            }\r\n        } catch (e) {\r\n            // Invalid JSON, skip\r\n        }\r\n    });\r\n\r\n    // Business name from title/h1\r\n    data.businessName = data.businessName ||\r\n        $('meta[property=\"og:site_name\"]').attr('content') ||\r\n        $('title').text().split('|')[0].trim() ||\r\n        $('h1').first().text().trim();\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Extract data using regex patterns\r\n */\r\nfunction extractFromPatterns($: cheerio.CheerioAPI, html: string): Partial<ScrapedData> {\r\n    const data: Partial<ScrapedData> = {\r\n        socialMedia: {},\r\n    };\r\n\r\n    // Email regex - exclude common generic/spam emails\r\n    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g;\r\n    const emails = html.match(emailRegex) || [];\r\n    const validEmails = emails.filter(email =>\r\n        !email.match(/^(info|admin|noreply|no-reply|support|hello|contact)@/i) &&\r\n        !email.includes('example.com') &&\r\n        !email.includes('domain.com')\r\n    );\r\n    data.email = validEmails[0];\r\n\r\n    // Phone regex (US format)\r\n    const phoneRegex = /(\\+1[-.\\s]?)?\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}/g;\r\n    const phones = html.match(phoneRegex) || [];\r\n    data.phone = phones[0];\r\n\r\n    // Social media links\r\n    $('a[href*=\"linkedin.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href && href.includes('/company/')) {\r\n            data.socialMedia!.linkedin = href;\r\n        }\r\n    });\r\n\r\n    $('a[href*=\"facebook.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href) {\r\n            data.socialMedia!.facebook = href;\r\n        }\r\n    });\r\n\r\n    $('a[href*=\"twitter.com\"], a[href*=\"x.com\"]').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        if (href) {\r\n            data.socialMedia!.twitter = href;\r\n        }\r\n    });\r\n\r\n    return data;\r\n}\r\n\r\n/**\r\n * Find contact page URL\r\n */\r\nfunction findContactPage($: cheerio.CheerioAPI, baseUrl: string): string | null {\r\n    const contactKeywords = ['contact', 'about', 'location', 'reach-us', 'get-in-touch'];\r\n\r\n    let contactUrl: string | null = null;\r\n    $('a').each((_, elem) => {\r\n        const href = $(elem).attr('href');\r\n        const text = $(elem).text().toLowerCase();\r\n\r\n        if (href && contactKeywords.some(keyword =>\r\n            href.toLowerCase().includes(keyword) || text.includes(keyword)\r\n        )) {\r\n            contactUrl = new URL(href, baseUrl).href;\r\n            return false; // break\r\n        }\r\n    });\r\n\r\n    return contactUrl;\r\n}\r\n\r\n/**\r\n * Scrape contact page\r\n */\r\nasync function scrapeContactPage(url: string): Promise<Partial<ScrapedData>> {\r\n    try {\r\n        const response = await fetch(url, {\r\n            headers: {\r\n                'User-Agent': 'Mozilla/5.0 (compatible; XiriBot/1.0; +https://xiri.ai/bot)',\r\n            },\r\n            signal: AbortSignal.timeout(10000),\r\n        });\r\n\r\n        if (!response.ok) return {};\r\n\r\n        const html = await response.text();\r\n        const $ = cheerio.load(html);\r\n\r\n        return extractFromPatterns($, html);\r\n    } catch (error) {\r\n        return {};\r\n    }\r\n}\r\n\r\n/**\r\n * Extract contact info using Gemini AI\r\n */\r\nasync function extractWithAI(html: string, geminiApiKey: string): Promise<Partial<ScrapedData>> {\r\n    try {\r\n        const genAI = new GoogleGenerativeAI(geminiApiKey);\r\n        const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });\r\n\r\n        // Strip HTML to plain text and limit size\r\n        const text = html.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').substring(0, 10000);\r\n\r\n        const prompt = `Extract business contact information from this website content. Return ONLY a JSON object with these fields (use null if not found):\r\n{\r\n  \"email\": \"primary business email (not info@, admin@, noreply@)\",\r\n  \"phone\": \"primary phone number in format (xxx) xxx-xxxx\",\r\n  \"address\": \"full physical address if available\",\r\n  \"businessName\": \"official business name\"\r\n}\r\n\r\nWebsite content:\r\n${text}`;\r\n\r\n        const result = await model.generateContent(prompt);\r\n        const response = result.response.text();\r\n\r\n        // Extract JSON from response (handle markdown code blocks)\r\n        const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n        if (jsonMatch) {\r\n            const data = JSON.parse(jsonMatch[0]);\r\n            return {\r\n                email: data.email !== 'null' ? data.email : undefined,\r\n                phone: data.phone !== 'null' ? data.phone : undefined,\r\n                address: data.address !== 'null' ? data.address : undefined,\r\n                businessName: data.businessName !== 'null' ? data.businessName : undefined,\r\n            };\r\n        }\r\n\r\n        return {};\r\n    } catch (error) {\r\n        console.error('AI extraction error:', error);\r\n        return {};\r\n    }\r\n}\r\n\r\n/**\r\n * Determine confidence level based on data sources\r\n */\r\nfunction determineConfidence(\r\n    structured: Partial<ScrapedData>,\r\n    pattern: Partial<ScrapedData>,\r\n    contact: Partial<ScrapedData>\r\n): 'high' | 'medium' | 'low' {\r\n    if (structured.email || structured.phone) return 'high';\r\n    if (contact.email || contact.phone) return 'medium';\r\n    if (pattern.email || pattern.phone) return 'low';\r\n    return 'low';\r\n}\r\n\r\n/**\r\n * Validate email format and exclude common invalid patterns\r\n */\r\nfunction validateEmail(email: string): string | undefined {\r\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n    if (!emailRegex.test(email)) return undefined;\r\n\r\n    // Exclude generic emails\r\n    if (email.match(/^(info|admin|noreply|no-reply|support|hello|contact|webmaster)@/i)) {\r\n        return undefined;\r\n    }\r\n\r\n    return email.toLowerCase();\r\n}\r\n\r\n/**\r\n * Format phone number to (xxx) xxx-xxxx\r\n */\r\nfunction formatPhone(phone: string): string | undefined {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    // Handle US numbers (10 or 11 digits)\r\n    if (digits.length === 10) {\r\n        return `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 10)}`;\r\n    }\r\n    if (digits.length === 11 && digits[0] === '1') {\r\n        return `(${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7, 11)}`;\r\n    }\r\n\r\n    return undefined;\r\n}\r\n","/**\r\n * Email verification utilities\r\n */\r\n\r\ninterface EmailVerificationResult {\r\n    valid: boolean;\r\n    deliverable?: boolean;\r\n    reason?: string;\r\n}\r\n\r\n/**\r\n * Verify email deliverability using DNS MX record lookup\r\n */\r\nexport async function verifyEmail(email: string): Promise<EmailVerificationResult> {\r\n    // Basic format validation\r\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n    if (!emailRegex.test(email)) {\r\n        return { valid: false, reason: 'Invalid email format' };\r\n    }\r\n\r\n    // Extract domain\r\n    const domain = email.split('@')[1];\r\n\r\n    try {\r\n        // Check if domain has MX records (indicates it can receive email)\r\n        const mxRecords = await resolveMX(domain);\r\n\r\n        if (mxRecords && mxRecords.length > 0) {\r\n            return { valid: true, deliverable: true };\r\n        } else {\r\n            return { valid: true, deliverable: false, reason: 'No MX records found' };\r\n        }\r\n    } catch (error) {\r\n        // DNS lookup failed - domain might not exist\r\n        return { valid: true, deliverable: false, reason: 'Domain not found' };\r\n    }\r\n}\r\n\r\n/**\r\n * Resolve MX records for a domain\r\n * Note: This uses Node.js dns module which is available in Cloud Functions\r\n */\r\nasync function resolveMX(domain: string): Promise<any[]> {\r\n    const dns = await import('dns');\r\n    const { promisify } = await import('util');\r\n    const resolveMx = promisify(dns.resolveMx);\r\n\r\n    try {\r\n        return await resolveMx(domain);\r\n    } catch (error) {\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Check if email is a disposable/temporary email service\r\n */\r\nexport function isDisposableEmail(email: string): boolean {\r\n    const disposableDomains = [\r\n        'tempmail.com',\r\n        'guerrillamail.com',\r\n        '10minutemail.com',\r\n        'mailinator.com',\r\n        'throwaway.email',\r\n        'temp-mail.org',\r\n    ];\r\n\r\n    const domain = email.split('@')[1].toLowerCase();\r\n    return disposableDomains.includes(domain);\r\n}\r\n\r\n/**\r\n * Check if email is a role-based email (not a personal contact)\r\n */\r\nexport function isRoleBasedEmail(email: string): boolean {\r\n    const roleBasedPrefixes = [\r\n        'info', 'admin', 'support', 'sales', 'contact',\r\n        'hello', 'help', 'noreply', 'no-reply', 'webmaster',\r\n        'postmaster', 'hostmaster', 'abuse',\r\n    ];\r\n\r\n    const prefix = email.split('@')[0].toLowerCase();\r\n    return roleBasedPrefixes.includes(prefix);\r\n}\r\n","/**\r\n * Phone number validation and formatting utilities\r\n */\r\n\r\ninterface PhoneVerificationResult {\r\n    valid: boolean;\r\n    formatted?: string;\r\n    type?: 'mobile' | 'landline' | 'voip' | 'unknown';\r\n    reason?: string;\r\n}\r\n\r\n/**\r\n * Validate and format US phone number\r\n */\r\nexport function validatePhone(phone: string): PhoneVerificationResult {\r\n    // Extract digits only\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    // Check length\r\n    if (digits.length === 10) {\r\n        // Valid 10-digit US number\r\n        const formatted = `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6, 10)}`;\r\n        return {\r\n            valid: true,\r\n            formatted,\r\n            type: determinePhoneType(digits),\r\n        };\r\n    } else if (digits.length === 11 && digits[0] === '1') {\r\n        // Valid 11-digit US number with country code\r\n        const formatted = `(${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7, 11)}`;\r\n        return {\r\n            valid: true,\r\n            formatted,\r\n            type: determinePhoneType(digits.substring(1)),\r\n        };\r\n    } else {\r\n        return {\r\n            valid: false,\r\n            reason: `Invalid phone number length: ${digits.length} digits`,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Determine phone type based on area code and prefix\r\n * Note: This is a simplified heuristic. For production, consider using a service like Twilio Lookup API\r\n */\r\nfunction determinePhoneType(digits: string): 'mobile' | 'landline' | 'voip' | 'unknown' {\r\n    const areaCode = digits.substring(0, 3);\r\n    const prefix = digits.substring(3, 6);\r\n\r\n    // Common VoIP area codes\r\n    const voipAreaCodes = ['800', '888', '877', '866', '855', '844', '833'];\r\n    if (voipAreaCodes.includes(areaCode)) {\r\n        return 'voip';\r\n    }\r\n\r\n    // This is a simplified check - in reality, you'd need a comprehensive database\r\n    // or use Twilio Lookup API for accurate mobile vs landline detection\r\n    return 'unknown';\r\n}\r\n\r\n/**\r\n * Check if phone number is likely a valid business number\r\n */\r\nexport function isBusinessPhone(phone: string): boolean {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    // Toll-free numbers are typically business\r\n    const tollFreeAreaCodes = ['800', '888', '877', '866', '855', '844', '833'];\r\n    const areaCode = digits.substring(0, 3);\r\n\r\n    return tollFreeAreaCodes.includes(areaCode);\r\n}\r\n\r\n/**\r\n * Format phone number for display\r\n */\r\nexport function formatPhoneForDisplay(phone: string): string {\r\n    const result = validatePhone(phone);\r\n    return result.formatted || phone;\r\n}\r\n\r\n/**\r\n * Format phone number for storage (E.164 format)\r\n */\r\nexport function formatPhoneForStorage(phone: string): string {\r\n    const digits = phone.replace(/\\D/g, '');\r\n\r\n    if (digits.length === 10) {\r\n        return `+1${digits}`;\r\n    } else if (digits.length === 11 && digits[0] === '1') {\r\n        return `+${digits}`;\r\n    }\r\n\r\n    return phone; // Return original if can't format\r\n}\r\n","import { onSchedule } from \"firebase-functions/v2/scheduler\";\r\nimport * as admin from 'firebase-admin';\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { fetchPendingTasks, updateTaskStatus, enqueueTask, QueueItem } from \"../utils/queueUtils\";\r\n// import { getNextBusinessSlot } from \"../utils/timeUtils\"; // TODO: Re-enable for production\r\nimport { generateOutreachContent } from \"../agents/outreach\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\n// Run every minute to check for pending tasks\r\n// Region must match project config\r\nexport const processOutreachQueue = onSchedule({\r\n    schedule: \"every 1 minutes\",\r\n    secrets: [\"RESEND_API_KEY\", \"GEMINI_API_KEY\"],\r\n}, async (event) => {\r\n    logger.info(\"Processing outreach queue...\");\r\n\r\n    try {\r\n        const tasks = await fetchPendingTasks(db);\r\n        if (tasks.length === 0) {\r\n            logger.info(\"No pending tasks found.\");\r\n            return;\r\n        }\r\n\r\n        logger.info(`Found ${tasks.length} tasks to process.`);\r\n\r\n        for (const task of tasks) {\r\n            try {\r\n                if (task.type === 'GENERATE') {\r\n                    await handleGenerate(task);\r\n                } else if (task.type === 'SEND') {\r\n                    await handleSend(task);\r\n                } else if (task.type === 'FOLLOW_UP') {\r\n                    await handleFollowUp(task);\r\n                }\r\n            } catch (err) {\r\n                logger.error(`Error processing task ${task.id}:`, err);\r\n                // Simple retry logic: Increment count, set to retry, backoff\r\n                // If > 5 retries, mark FAILED\r\n                const newRetryCount = (task.retryCount || 0) + 1;\r\n                const status = newRetryCount > 5 ? 'FAILED' : 'RETRY';\r\n\r\n                // Exponential backoff for retry (1m, 2m, 4m...)\r\n                const nextAttempt = new Date();\r\n                nextAttempt.setMinutes(nextAttempt.getMinutes() + Math.pow(2, newRetryCount));\r\n\r\n                await updateTaskStatus(db, task.id!, status, {\r\n                    retryCount: newRetryCount,\r\n                    scheduledAt: admin.firestore.Timestamp.fromDate(nextAttempt),\r\n                    error: String(err)\r\n                });\r\n            }\r\n        }\r\n    } catch (error) {\r\n        logger.error(\"Fatal error in queue processor:\", error);\r\n    }\r\n});\r\n\r\nasync function handleGenerate(task: QueueItem) {\r\n    logger.info(`Generating content for task ${task.id}`);\r\n\r\n    // Reconstruct vendor object from metadata\r\n    // In production, might be better to fetch fresh vendor data\r\n    const vendorData = task.metadata;\r\n\r\n    // TODO: Re-enable SMS channel when Twilio is integrated\r\n    // const preferredChannel = vendorData.phone ? 'SMS' : 'EMAIL';\r\n    const outreachResult = await generateOutreachContent(vendorData, 'EMAIL');\r\n\r\n    if (outreachResult.error) {\r\n        throw new Error(\"AI Generation Failed: \" + (outreachResult.sms || \"Unknown Error\"));\r\n    }\r\n\r\n    // 1. Log the drafts (Visible to User)\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: \"OUTREACH_QUEUED\", // Using same type for UI compatibility\r\n        description: `Outreach drafts generated (waiting to send).`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            sms: outreachResult.sms,\r\n            email: outreachResult.email,\r\n            preferredChannel: outreachResult.channel,\r\n            campaignUrgency: vendorData.hasActiveContract ? \"URGENT\" : \"SUPPLY\"\r\n        }\r\n    });\r\n\r\n    // 2. Schedule SEND immediately (next queue cycle ~1 min)\r\n    // TODO: Re-enable business-hours scheduling when in production\r\n    // const scheduledTime = getNextBusinessSlot(vendorData.hasActiveContract ? \"URGENT\" : \"SUPPLY\");\r\n    const scheduledTime = new Date();\r\n\r\n    // 3. Enqueue SEND Task\r\n    await enqueueTask(db, {\r\n        vendorId: task.vendorId,\r\n        type: 'SEND',\r\n        scheduledAt: admin.firestore.Timestamp.fromDate(scheduledTime),\r\n        metadata: {\r\n            // Pass the generated content along\r\n            sms: outreachResult.sms,\r\n            email: outreachResult.email,\r\n            channel: outreachResult.channel\r\n        }\r\n    });\r\n\r\n    // 4. Mark GENERATE task complete\r\n    await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n    logger.info(`Task ${task.id} completed. Send scheduled for ${scheduledTime.toISOString()}`);\r\n}\r\n\r\nasync function handleSend(task: QueueItem) {\r\n    logger.info(`Executing SEND for task ${task.id}`);\r\n\r\n    const vendorDoc = await db.collection(\"vendors\").doc(task.vendorId).get();\r\n    const vendor = vendorDoc.exists ? vendorDoc.data() : null;\r\n    const vendorEmail = vendor?.email || task.metadata?.email?.to;\r\n\r\n    let sendSuccess = false;\r\n\r\n    if (vendorEmail) {\r\n        // ─── Always send via Email until Twilio SMS is integrated ───\r\n        const emailData = task.metadata.email;\r\n        const htmlBody = `<div style=\"font-family: sans-serif; line-height: 1.6;\">${(emailData?.body || '').replace(/\\n/g, '<br/>')}</div>`;\r\n\r\n        sendSuccess = await sendEmail(\r\n            vendorEmail,\r\n            emailData?.subject || 'Xiri Facility Solutions — Partnership Opportunity',\r\n            htmlBody\r\n        );\r\n\r\n        if (!sendSuccess) {\r\n            logger.error(`Failed to send email to ${vendorEmail} for task ${task.id}`);\r\n            throw new Error(`Resend email failed for vendor ${task.vendorId}`);\r\n        }\r\n    } else {\r\n        logger.warn(`No email for task ${task.id}. Channel: ${task.metadata.channel}`);\r\n        sendSuccess = false;\r\n    }\r\n\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId: task.vendorId,\r\n        type: sendSuccess ? \"OUTREACH_SENT\" : \"OUTREACH_FAILED\",\r\n        description: sendSuccess\r\n            ? `Automated ${task.metadata.channel} sent to ${vendorEmail || 'vendor'}.`\r\n            : `Failed to send ${task.metadata.channel} to vendor.`,\r\n        createdAt: new Date(),\r\n        metadata: {\r\n            channel: task.metadata.channel,\r\n            to: vendorEmail || 'unknown',\r\n            content: task.metadata.channel === 'SMS' ? task.metadata.sms : task.metadata.email?.subject\r\n        }\r\n    });\r\n\r\n    await updateTaskStatus(db, task.id!, sendSuccess ? 'COMPLETED' : 'FAILED');\r\n\r\n    // Update Vendor Record\r\n    if (sendSuccess) {\r\n        await db.collection(\"vendors\").doc(task.vendorId).update({\r\n            status: 'awaiting_onboarding',\r\n            outreachStatus: 'SENT',\r\n            outreachChannel: task.metadata.channel,\r\n            outreachSentAt: new Date(),\r\n            statusUpdatedAt: new Date()\r\n        });\r\n\r\n        // Log status transition\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: task.vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: `Pipeline advanced: qualified → awaiting_onboarding (outreach ${task.metadata.channel} delivered)`,\r\n            createdAt: new Date(),\r\n            metadata: { from: 'qualified', to: 'awaiting_onboarding', trigger: 'outreach_sent' }\r\n        });\r\n    } else {\r\n        await db.collection(\"vendors\").doc(task.vendorId).update({\r\n            outreachStatus: 'PENDING',\r\n            outreachChannel: task.metadata.channel,\r\n            outreachTime: new Date()\r\n        });\r\n    }\r\n}\r\n\r\nasync function handleFollowUp(task: QueueItem) {\r\n    logger.info(`Processing FOLLOW_UP task ${task.id} (sequence ${task.metadata?.sequence})`);\r\n\r\n    const vendorDoc = await db.collection(\"vendors\").doc(task.vendorId).get();\r\n    const vendor = vendorDoc.exists ? vendorDoc.data() : null;\r\n\r\n    if (!vendor) {\r\n        logger.warn(`Vendor ${task.vendorId} not found, marking task completed.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    // Skip if vendor has already progressed past awaiting_onboarding\r\n    if (vendor.status !== 'awaiting_onboarding') {\r\n        logger.info(`Vendor ${task.vendorId} is now '${vendor.status}', skipping follow-up.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const vendorEmail = vendor.email || task.metadata?.email;\r\n    if (!vendorEmail) {\r\n        logger.warn(`No email for vendor ${task.vendorId}, skipping follow-up.`);\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        return;\r\n    }\r\n\r\n    const sequence = task.metadata?.sequence || 1;\r\n    const businessName = task.metadata?.businessName || vendor.businessName || 'there';\r\n    const isSpanish = (task.metadata?.preferredLanguage || vendor.preferredLanguage) === 'es';\r\n\r\n    const unsubscribeUrl = `https://us-central1-xiri-facility-solutions.cloudfunctions.net/handleUnsubscribe?vendorId=${task.vendorId}`;\r\n    const onboardingUrl = `https://xiri.ai/contractor?vid=${task.vendorId}`;\r\n\r\n    const subject = task.metadata?.subject || `Follow-up: Complete your Xiri profile`;\r\n    const html = buildFollowUpEmail(sequence, businessName, onboardingUrl, unsubscribeUrl, isSpanish);\r\n\r\n    const sendSuccess = await sendEmail(vendorEmail, subject, html);\r\n\r\n    if (sendSuccess) {\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: task.vendorId,\r\n            type: \"FOLLOW_UP_SENT\",\r\n            description: `Follow-up #${sequence} sent to ${vendorEmail}`,\r\n            createdAt: new Date(),\r\n            metadata: { sequence, email: vendorEmail, channel: 'EMAIL' }\r\n        });\r\n        await updateTaskStatus(db, task.id!, 'COMPLETED');\r\n        logger.info(`Follow-up #${sequence} sent to ${vendorEmail} for vendor ${task.vendorId}`);\r\n    } else {\r\n        throw new Error(`Failed to send follow-up #${sequence} to ${vendorEmail}`);\r\n    }\r\n}\r\n\r\nfunction buildFollowUpEmail(sequence: number, businessName: string, onboardingUrl: string, unsubscribeUrl: string, isSpanish: boolean): string {\r\n    const msgs: Record<number, { en: { body: string; cta: string }; es: { body: string; cta: string } }> = {\r\n        1: {\r\n            en: {\r\n                body: `We noticed you haven't completed your Xiri profile yet. Completing your profile is the first step to receiving work opportunities from our network of medical and commercial facilities.`,\r\n                cta: 'Complete My Profile'\r\n            },\r\n            es: {\r\n                body: `Notamos que aún no ha completado su perfil de Xiri. Completar su perfil es el primer paso para recibir oportunidades de trabajo de nuestra red de instalaciones médicas y comerciales.`,\r\n                cta: 'Completar Mi Perfil'\r\n            }\r\n        },\r\n        2: {\r\n            en: {\r\n                body: `Just checking in — we'd love to have you on board. Our contractor network is growing and there are active opportunities in your area. It only takes a few minutes to complete your profile.`,\r\n                cta: 'Finish My Application'\r\n            },\r\n            es: {\r\n                body: `Solo queríamos saber cómo está — nos encantaría contar con usted. Nuestra red de contratistas está creciendo y hay oportunidades activas en su área.`,\r\n                cta: 'Finalizar Mi Solicitud'\r\n            }\r\n        },\r\n        3: {\r\n            en: {\r\n                body: `This is our final follow-up. We don't want you to miss out on work opportunities with Xiri. If you're still interested, please complete your profile. Otherwise, we'll remove you from our outreach list.`,\r\n                cta: 'Complete Profile Now'\r\n            },\r\n            es: {\r\n                body: `Este es nuestro último seguimiento. No queremos que pierda las oportunidades de trabajo con Xiri. Si aún está interesado, complete su perfil.`,\r\n                cta: 'Completar Perfil Ahora'\r\n            }\r\n        }\r\n    };\r\n\r\n    const msg = msgs[sequence]?.[isSpanish ? 'es' : 'en'] || msgs[1].en;\r\n    const greeting = isSpanish ? `Hola ${businessName},` : `Hi ${businessName},`;\r\n    const reply = isSpanish ? '¿Preguntas? Simplemente responda a este correo.' : 'Questions? Just reply to this email.';\r\n    const unsub = isSpanish ? 'Cancelar suscripción' : 'Unsubscribe from future emails';\r\n    const signoff = isSpanish ? 'Saludos cordiales' : 'Best regards';\r\n\r\n    return `\r\n    <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1e293b;\">\r\n        <div style=\"background: #0c4a6e; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 20px;\">Xiri Facility Solutions</h1>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p style=\"font-size: 15px;\">${greeting}</p>\r\n            <p style=\"font-size: 15px; line-height: 1.7;\">${msg.body}</p>\r\n            <div style=\"text-align: center; margin: 32px 0;\">\r\n                <a href=\"${onboardingUrl}\" style=\"display: inline-block; padding: 14px 32px; background: #0369a1; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 15px;\">\r\n                    ${msg.cta}\r\n                </a>\r\n            </div>\r\n            <p style=\"font-size: 14px; color: #64748b;\">${reply}</p>\r\n            <p style=\"margin-top: 24px; font-size: 14px;\">${signoff},<br/><strong>Xiri Facility Solutions Team</strong></p>\r\n        </div>\r\n        <div style=\"text-align: center; margin-top: 16px;\">\r\n            <a href=\"${unsubscribeUrl}\" style=\"font-size: 11px; color: #94a3b8; text-decoration: underline;\">${unsub}</a>\r\n        </div>\r\n    </div>`;\r\n}\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY || \"\";\r\nconst genAI = new GoogleGenerativeAI(API_KEY);\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\nconst db = admin.firestore();\r\n\r\nexport const generateOutreachContent = async (vendor: any, preferredChannel: 'SMS' | 'EMAIL') => {\r\n    const isUrgent = vendor.hasActiveContract;\r\n    const channel = preferredChannel;\r\n\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"outreach_generation_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Outreach generation prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const campaignContext = isUrgent\r\n            ? \"URGENT JOB OPPORTUNITY (We have a contract ready)\"\r\n            : \"Building Supply Network (Partnership Opportunity)\";\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName)\r\n            .replace(/\\{\\{specialty\\}\\}/g, vendor.specialty || \"Services\")\r\n            .replace(/\\{\\{campaignContext\\}\\}/g, campaignContext);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n\r\n        // Sanitize code blocks if present\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n\r\n        const jsonContent = JSON.parse(text);\r\n\r\n        return {\r\n            channel,\r\n            sms: jsonContent.sms,\r\n            email: jsonContent.email,\r\n            generatedAt: new Date()\r\n        };\r\n    } catch (error) {\r\n        console.error(\"Error generating outreach content:\", error);\r\n        return {\r\n            channel,\r\n            sms: \"Error generating SMS.\",\r\n            email: { subject: \"Error\", body: \"Error generating content. Please draft manually.\" },\r\n            error: true\r\n        };\r\n    }\r\n};\r\n\r\n\r\nexport const analyzeIncomingMessage = async (vendor: any, messageContent: string, previousContext: string) => {\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"message_analysis_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Message analysis prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendor.companyName)\r\n            .replace(/\\{\\{messageContent\\}\\}/g, messageContent)\r\n            .replace(/\\{\\{previousContext\\}\\}/g, previousContext)\r\n            .replace(/\\{\\{vendorId\\}\\}/g, vendor.id);\r\n\r\n        const result = await model.generateContent(prompt);\r\n        let text = result.response.text();\r\n        text = text.replace(/^```json/gm, '').replace(/^```/gm, '').trim();\r\n        const jsonContent = JSON.parse(text);\r\n        return jsonContent;\r\n    } catch (error) {\r\n        console.error(\"Error analyzing message:\", error);\r\n        return { intent: \"OTHER\", reply: \"Error analyzing message.\" };\r\n    }\r\n};\r\n","import { onDocumentCreated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { analyzeIncomingMessage } from \"../agents/outreach\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\nconst db = admin.firestore();\r\n\r\nexport const onIncomingMessage = onDocumentCreated(\"vendor_activities/{activityId}\", async (event) => {\r\n    if (!event.data) return;\r\n\r\n    const activity = event.data.data();\r\n    const vendorId = activity.vendorId;\r\n\r\n    // Only process INBOUND_REPLY type\r\n    if (activity.type !== 'INBOUND_REPLY') return;\r\n\r\n    logger.info(`Processing inbound message from vendor ${vendorId}`);\r\n\r\n    try {\r\n        // 1. Fetch Vendor Data\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            logger.error(`Vendor ${vendorId} not found`);\r\n            return;\r\n        }\r\n        const vendor = vendorDoc.data();\r\n\r\n        // 2. Fetch Previous Context (Last Outreach Sent)\r\n        // Ideally query for the last OUTREACH_SENT activity\r\n        const lastOutreachSnapshot = await db.collection(\"vendor_activities\")\r\n            .where(\"vendorId\", \"==\", vendorId)\r\n            .where(\"type\", \"==\", \"OUTREACH_SENT\")\r\n            .orderBy(\"createdAt\", \"desc\")\r\n            .limit(1)\r\n            .get();\r\n\r\n        const previousContext = !lastOutreachSnapshot.empty ?\r\n            lastOutreachSnapshot.docs[0].data().description :\r\n            \"Initial outreach sent.\";\r\n\r\n        // 3. Analyze Message\r\n        const analysis = await analyzeIncomingMessage(vendor, activity.description, previousContext);\r\n\r\n        logger.info(`Analysis result for ${vendorId}: ${JSON.stringify(analysis)}`);\r\n\r\n        // 4. Take Action based on Intent\r\n        let newStatus = vendor?.status;\r\n        let actionDescription = \"\";\r\n\r\n        if (analysis.intent === 'INTERESTED') {\r\n            newStatus = 'NEGOTIATING';\r\n            actionDescription = \"Vendor expressed interest. Status updated to NEGOTIATING.\";\r\n        } else if (analysis.intent === 'NOT_INTERESTED') {\r\n            newStatus = 'REJECTED';\r\n            actionDescription = \"Vendor not interested. Status updated to REJECTED.\";\r\n        } else if (analysis.intent === 'QUESTION') {\r\n            newStatus = 'NEGOTIATING'; // Move to negotiating so we handle the Q\r\n            actionDescription = \"Vendor has a question.\";\r\n        } else {\r\n            actionDescription = \"AI could not determine clear intent.\";\r\n        }\r\n\r\n        // 5. Update Status if changed\r\n        if (newStatus && newStatus !== vendor?.status) {\r\n            await db.collection(\"vendors\").doc(vendorId).update({\r\n                status: newStatus,\r\n                statusUpdatedAt: new Date()\r\n            });\r\n            // Log the status change\r\n            await db.collection(\"vendor_activities\").add({\r\n                vendorId: vendorId,\r\n                type: 'STATUS_CHANGE',\r\n                description: actionDescription,\r\n                createdAt: new Date(),\r\n                metadata: {\r\n                    oldStatus: vendor?.status,\r\n                    newStatus: newStatus,\r\n                    aiIntent: analysis.intent\r\n                }\r\n            });\r\n        }\r\n\r\n        // 6. Draft/Send Reply (Log as AI_REPLY)\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId: vendorId,\r\n            type: 'AI_REPLY',\r\n            description: analysis.reply,\r\n            createdAt: new Date(), // Slightly after the inbound\r\n            metadata: {\r\n                intent: analysis.intent,\r\n                inReplyTo: event.params.activityId\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        logger.error(\"Error processing inbound message:\", error);\r\n    }\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport { verifyDocument } from \"../agents/documentVerifier\";\r\n\r\nconst db = admin.firestore();\r\n\r\nexport const onDocumentUploaded = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"GEMINI_API_KEY\"]\r\n}, async (event) => {\r\n    const before = event.data?.before.data();\r\n    const after = event.data?.after.data();\r\n    const vendorId = event.params.vendorId;\r\n\r\n    if (!before || !after) return;\r\n\r\n    // Check COI\r\n    if (after.compliance?.coi?.status === 'PENDING' && before.compliance?.coi?.status !== 'PENDING') {\r\n        console.log(`Processing COI for ${vendorId}`);\r\n        await runVerification(vendorId, 'COI', after);\r\n    }\r\n\r\n    // Check W9\r\n    if (after.compliance?.w9?.status === 'PENDING' && before.compliance?.w9?.status !== 'PENDING') {\r\n        console.log(`Processing W9 for ${vendorId}`);\r\n        await runVerification(vendorId, 'W9', after);\r\n    }\r\n});\r\n\r\nasync function runVerification(vendorId: string, docType: 'COI' | 'W9', vendorData: any) {\r\n    try {\r\n        const result = await verifyDocument(docType, vendorData.companyName || \"Vendor\", vendorData.specialty || \"General\");\r\n\r\n        // Update Vendor\r\n        const fieldPath = docType === 'COI' ? 'compliance.coi' : 'compliance.w9';\r\n        await db.doc(`vendors/${vendorId}`).update({\r\n            [`${fieldPath}.status`]: result.valid ? 'VERIFIED' : 'REJECTED',\r\n            [`${fieldPath}.aiAnalysis`]: {\r\n                valid: result.valid,\r\n                reasoning: result.reasoning,\r\n                extracted: result.extracted\r\n            },\r\n            [`${fieldPath}.verifiedAt`]: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n\r\n        // Log Activity\r\n        await db.collection('vendor_activities').add({\r\n            vendorId: vendorId,\r\n            type: 'AI_VERIFICATION', // New type\r\n            description: `AI ${result.valid ? 'Verified' : 'Rejected'} ${docType}: ${result.reasoning}`,\r\n            createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n            metadata: {\r\n                docType,\r\n                valid: result.valid,\r\n                extracted: result.extracted\r\n            }\r\n        });\r\n\r\n        // Send email notification\r\n        if (result.valid) {\r\n            const { sendTemplatedEmail } = await import('../utils/emailUtils');\r\n            await sendTemplatedEmail(vendorId, 'doc_upload_notification', {\r\n                documentType: docType === 'COI' ? 'Certificate of Insurance' : 'W-9 Form'\r\n            });\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(`Verification failed for ${docType}:`, error);\r\n    }\r\n}\r\n","import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst db = admin.firestore();\r\n\r\ninterface VerificationResult {\r\n    valid: boolean;\r\n    reasoning: string;\r\n    extracted: Record<string, any>;\r\n}\r\n\r\nexport async function verifyDocument(docType: 'COI' | 'W9', vendorName: string, specialty: string): Promise<VerificationResult> {\r\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n    // Simulate OCR extraction based on the doc type\r\n    // In a real app, this would be the output of a Vision API\r\n    let simulatedOcrText = \"\";\r\n\r\n    if (docType === 'COI') {\r\n        const today = new Date();\r\n        const nextYear = new Date(today);\r\n        nextYear.setFullYear(today.getFullYear() + 1);\r\n\r\n        simulatedOcrText = `\r\n            CERTIFICATE OF LIABILITY INSURANCE\r\n            PRODUCER: State Farm Insurance\r\n            INSURED: ${vendorName}\r\n            \r\n            COVERAGES:\r\n            COMMERCIAL GENERAL LIABILITY\r\n            EACH OCCURRENCE: $2,000,000\r\n            DAMAGE TO RENTED PREMISES: $100,000\r\n            MED EXP: $5,000\r\n            PERSONAL & ADV INJURY: $2,000,000\r\n            GENERAL AGGREGATE: $4,000,000\r\n            \r\n            WORKERS COMPENSATION\r\n            STATUTORY LIMITS: YES\r\n            E.L. EACH ACCIDENT: $1,000,000\r\n            \r\n            POLICY EFF: 01/01/2024\r\n            POLICY EXP: ${nextYear.toLocaleDateString()}\r\n        `;\r\n    } else if (docType === 'W9') {\r\n        simulatedOcrText = `\r\n            Form W-9\r\n            Name: ${vendorName}\r\n            Business Name: ${vendorName} LLC\r\n            Federal Tax Classification: Limited Liability Company\r\n            Address: 123 Main St\r\n            TIN: XX-XXX1234\r\n            Signed: JS\r\n            Date: 01/15/2024\r\n        `;\r\n    }\r\n\r\n    try {\r\n        // Fetch prompt from database\r\n        const templateDoc = await db.collection(\"templates\").doc(\"document_verifier_prompt\").get();\r\n        if (!templateDoc.exists) {\r\n            throw new Error(\"Document verifier prompt not found in database\");\r\n        }\r\n\r\n        const template = templateDoc.data();\r\n        const requirements = docType === 'COI'\r\n            ? 'Must have General Liability > $1,000,000 and valid dates.'\r\n            : 'Must be signed and have a TIN.';\r\n\r\n        // Replace variables\r\n        const prompt = template?.content\r\n            .replace(/\\{\\{documentType\\}\\}/g, docType)\r\n            .replace(/\\{\\{vendorName\\}\\}/g, vendorName)\r\n            .replace(/\\{\\{specialty\\}\\}/g, specialty)\r\n            .replace(/\\{\\{requirements\\}\\}/g, requirements)\r\n            .replace(/\\{\\{ocrText\\}\\}/g, simulatedOcrText);\r\n\r\n        const result = await model.generateContent({\r\n            contents: [{ role: \"user\", parts: [{ text: prompt }] }]\r\n        });\r\n        const responseText = result.response.text();\r\n        const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) throw new Error(\"No JSON found in response\");\r\n\r\n        return JSON.parse(jsonMatch[0]) as VerificationResult;\r\n    } catch (error) {\r\n        console.error(\"AI Verification Failed:\", error);\r\n        return {\r\n            valid: false,\r\n            reasoning: \"AI Verification Failed: \" + error,\r\n            extracted: {}\r\n        };\r\n    }\r\n}\r\n","import { onDocumentWritten } from \"firebase-functions/v2/firestore\";\r\nimport { sendEmail } from \"../utils/emailUtils\";\r\nimport { addMinutes, format } from \"date-fns\";\r\nimport * as admin from \"firebase-admin\";\r\n\r\nconst db = admin.firestore();\r\nconst TIMEOUT_SECONDS = 300;\r\n\r\nexport const sendBookingConfirmation = onDocumentWritten({\r\n    document: \"leads/{leadId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n    timeoutSeconds: TIMEOUT_SECONDS\r\n}, async (event) => {\r\n    // 1. Validate Event\r\n    if (!event.data) return; // Deletion\r\n\r\n    const before = event.data.before.data();\r\n    const after = event.data.after.data();\r\n\r\n    // 2. Check Triggers\r\n    // - Status changed to 'new' (Completed Wizard)\r\n    // - OR Times changed on an existing 'new' lead (Rescheduling)\r\n    const statusChangedToNew = (before?.status !== 'new' && after?.status === 'new');\r\n    const timesChanged = (JSON.stringify(before?.preferredAuditTimes) !== JSON.stringify(after?.preferredAuditTimes));\r\n\r\n    // Only proceed if status is 'new' AND (it just became new OR times changed)\r\n    const shouldSend = after?.status === 'new' && (statusChangedToNew || timesChanged);\r\n\r\n    if (!shouldSend) return;\r\n\r\n    // 3. Validate Data for Email\r\n    const { email, contactName, preferredAuditTimes, meetingType, meetingDuration, businessName } = after;\r\n\r\n    if (!email || !preferredAuditTimes || preferredAuditTimes.length === 0) {\r\n        console.log(\"Missing email or times for lead\", event.params.leadId);\r\n        return;\r\n    }\r\n\r\n    // 4. Prepare Meeting Details\r\n    const startTimeStr = preferredAuditTimes[0]; // ISO String\r\n    const startTime = new Date(startTimeStr);\r\n    const duration = meetingDuration || 60; // Default 60 mins\r\n    const endTime = addMinutes(startTime, duration);\r\n    const type = meetingType === 'intro' ? 'Intro Call' : 'Internal Audit';\r\n\r\n    // 5. Generate ICS File\r\n    const icsContent = generateICS({\r\n        start: startTime,\r\n        end: endTime,\r\n        summary: `Xiri ${type}: ${businessName || 'Facility Audit'}`,\r\n        description: `Meeting with ${contactName || 'Client'}.\\n\\nType: ${type}\\nDuration: ${duration} mins\\n\\nPower to the Facilities!`,\r\n        location: type === 'intro' ? 'Phone Call' : (after.address || after.zipCode || 'On Site'),\r\n        organizer: { name: \"Xiri Facility Solutions\", email: \"onboarding@xiri.ai\" }\r\n    });\r\n\r\n    // 6. Send Email\r\n    const subject = `Confirmed: Your Xini ${type}`;\r\n    const htmlBody = `\r\n        <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\r\n            <h1 style=\"color: #0ea5e9;\">You're booked!</h1>\r\n            <p>Hi ${contactName || 'there'},</p>\r\n            <p>We've confirmed your <strong>${type}</strong> for:</p>\r\n            <div style=\"background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n                <p style=\"margin: 0; font-size: 18px; font-weight: bold;\">\r\n                    ${format(startTime, \"EEEE, MMMM do 'at' h:mm a\")}\r\n                </p>\r\n                <p style=\"margin: 5px 0 0; color: #6b7280;\">Duration: ${duration} mins</p>\r\n            </div>\r\n            <p>A calendar invitation has been attached to this email.</p>\r\n            <p>Best,<br/>The Xiri Team</p>\r\n        </div>\r\n    `;\r\n\r\n    const sendSuccess = await sendEmail(email, subject, htmlBody, [\r\n        {\r\n            filename: 'invite.ics',\r\n            content: icsContent,\r\n        },\r\n    ]);\r\n\r\n    // Log to activity_logs for audit trail\r\n    await db.collection(\"activity_logs\").add({\r\n        entityType: 'lead',\r\n        entityId: event.params.leadId,\r\n        type: sendSuccess ? 'EMAIL_SENT' : 'EMAIL_FAILED',\r\n        description: `Booking confirmation ${sendSuccess ? 'sent' : 'failed'}: ${subject}`,\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        metadata: {\r\n            to: email,\r\n            subject,\r\n            meetingType: type,\r\n            meetingTime: startTimeStr,\r\n            channel: 'EMAIL'\r\n        }\r\n    });\r\n});\r\n\r\n// Helper: Generate ICS String\r\nfunction generateICS(event: {\r\n    start: Date;\r\n    end: Date;\r\n    summary: string;\r\n    description: string;\r\n    location: string;\r\n    organizer: { name: string; email: string };\r\n}) {\r\n    const formatDate = (date: Date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';\r\n\r\n    return `BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Xiri//Facility Solutions//EN\r\nCALSCALE:GREGORIAN\r\nMETHOD:REQUEST\r\nBEGIN:VEVENT\r\nUID:${Date.now()}@xiri.ai\r\nDTSTAMP:${formatDate(new Date())}\r\nDTSTART:${formatDate(event.start)}\r\nDTEND:${formatDate(event.end)}\r\nSUMMARY:${event.summary}\r\nDESCRIPTION:${event.description.replace(/\\n/g, '\\\\n')}\r\nLOCATION:${event.location}\r\nORGANIZER;CN=${event.organizer.name}:mailto:${event.organizer.email}\r\nSTATUS:CONFIRMED\r\nsequence:0\r\nEND:VEVENT\r\nEND:VCALENDAR`;\r\n}\r\n","import { onCall, HttpsError } from 'firebase-functions/v2/https';\r\nimport { getFirestore, FieldValue } from 'firebase-admin/firestore';\r\nimport { scrapeWebsite } from '../utils/websiteScraper';\r\nimport { verifyEmail, isDisposableEmail, isRoleBasedEmail } from '../utils/emailVerification';\r\nimport { validatePhone, isBusinessPhone } from '../utils/phoneValidation';\r\nimport { defineSecret } from 'firebase-functions/params';\r\n\r\nconst GEMINI_API_KEY = defineSecret('GEMINI_API_KEY');\r\n\r\ninterface EnrichRequest {\r\n    collection: 'leads' | 'vendors';\r\n    documentId: string;\r\n    website: string;\r\n    previewOnly?: boolean;\r\n}\r\n\r\ninterface EnrichResponse {\r\n    success: boolean;\r\n    enrichedFields: string[];\r\n    data?: any;\r\n    error?: string;\r\n}\r\n\r\nexport const enrichFromWebsite = onCall<EnrichRequest, Promise<EnrichResponse>>({\r\n    secrets: [GEMINI_API_KEY],\r\n    timeoutSeconds: 60,\r\n    memory: '512MiB',\r\n    cors: [\r\n        \"http://localhost:3001\",\r\n        \"http://localhost:3000\",\r\n        \"https://xiri.ai\",\r\n        \"https://www.xiri.ai\",\r\n        \"https://app.xiri.ai\",\r\n        \"https://xiri-dashboard.vercel.app\",\r\n        \"https://xiri-facility-solutions.web.app\",\r\n        \"https://xiri-facility-solutions.firebaseapp.com\"\r\n    ],\r\n}, async (request) => {\r\n    // 1. Validate request\r\n    if (!request.auth) {\r\n        throw new HttpsError('unauthenticated', 'User must be authenticated');\r\n    }\r\n\r\n    const { collection, documentId, website, previewOnly } = request.data;\r\n\r\n    if (!website) {\r\n        throw new HttpsError('invalid-argument', 'Missing website URL');\r\n    }\r\n\r\n    if (!previewOnly && (!collection || !documentId)) {\r\n        throw new HttpsError('invalid-argument', 'Missing required fields');\r\n    }\r\n\r\n    if (!previewOnly && !['leads', 'vendors'].includes(collection)) {\r\n        throw new HttpsError('invalid-argument', 'Invalid collection');\r\n    }\r\n\r\n    try {\r\n        // 2. Scrape website\r\n        console.log(`Enriching ${collection}/${documentId} from ${website}`);\r\n        const scrapedResult = await scrapeWebsite(website, GEMINI_API_KEY.value());\r\n\r\n        if (!scrapedResult.success) {\r\n            throw new HttpsError('internal', `Scraping failed: ${scrapedResult.error}`);\r\n        }\r\n\r\n        const scrapedData = scrapedResult.data!;\r\n\r\n        // 3. Verify email if found\r\n        let verifiedEmail: string | undefined;\r\n        if (scrapedData.email) {\r\n            const emailVerification = await verifyEmail(scrapedData.email);\r\n\r\n            if (emailVerification.valid &&\r\n                emailVerification.deliverable &&\r\n                !isDisposableEmail(scrapedData.email) &&\r\n                !isRoleBasedEmail(scrapedData.email)) {\r\n                verifiedEmail = scrapedData.email;\r\n            } else {\r\n                console.log(`Email ${scrapedData.email} failed verification:`, emailVerification.reason);\r\n            }\r\n        }\r\n\r\n        // 4. Validate phone if found\r\n        let validatedPhone: string | undefined;\r\n        if (scrapedData.phone) {\r\n            const phoneValidation = validatePhone(scrapedData.phone);\r\n\r\n            if (phoneValidation.valid) {\r\n                validatedPhone = phoneValidation.formatted;\r\n            } else {\r\n                console.log(`Phone ${scrapedData.phone} failed validation:`, phoneValidation.reason);\r\n            }\r\n        }\r\n\r\n        // 4b. If preview only, return scraped data without updating Firestore\r\n        if (previewOnly) {\r\n            return {\r\n                success: true,\r\n                enrichedFields: [\r\n                    ...(verifiedEmail ? ['email'] : []),\r\n                    ...(validatedPhone ? ['phone'] : []),\r\n                    ...(scrapedData.address ? ['address'] : []),\r\n                    ...(scrapedData.businessName ? ['businessName'] : []),\r\n                    ...(scrapedData.socialMedia?.linkedin ? ['linkedin'] : []),\r\n                    ...(scrapedData.socialMedia?.facebook ? ['facebook'] : []),\r\n                    ...(scrapedData.socialMedia?.twitter ? ['twitter'] : []),\r\n                ],\r\n                data: {\r\n                    email: verifiedEmail,\r\n                    phone: validatedPhone,\r\n                    address: scrapedData.address,\r\n                    businessName: scrapedData.businessName,\r\n                    socialMedia: scrapedData.socialMedia,\r\n                    confidence: scrapedData.confidence,\r\n                },\r\n            };\r\n        }\r\n\r\n        // 5. Prepare update data\r\n        const db = getFirestore();\r\n        const docRef = db.collection(collection).doc(documentId);\r\n        const docSnap = await docRef.get();\r\n\r\n        if (!docSnap.exists) {\r\n            throw new HttpsError('not-found', 'Document not found');\r\n        }\r\n\r\n        const existingData = docSnap.data()!;\r\n        const enrichedFields: string[] = [];\r\n        const updateData: any = {\r\n            updatedAt: FieldValue.serverTimestamp(),\r\n        };\r\n\r\n        // Only update fields that are missing or empty\r\n        if (verifiedEmail && !existingData.email) {\r\n            updateData.email = verifiedEmail;\r\n            enrichedFields.push('email');\r\n        }\r\n\r\n        if (validatedPhone && !existingData.phone) {\r\n            updateData.phone = validatedPhone;\r\n            enrichedFields.push('phone');\r\n        }\r\n\r\n        if (scrapedData.address && !existingData.address) {\r\n            updateData.address = scrapedData.address;\r\n            enrichedFields.push('address');\r\n        }\r\n\r\n        if (scrapedData.businessName && !existingData.businessName) {\r\n            updateData.businessName = scrapedData.businessName;\r\n            enrichedFields.push('businessName');\r\n        }\r\n\r\n        // Add social media links if found\r\n        if (scrapedData.socialMedia) {\r\n            const socialMedia: any = {};\r\n            if (scrapedData.socialMedia.linkedin) {\r\n                socialMedia.linkedin = scrapedData.socialMedia.linkedin;\r\n                enrichedFields.push('linkedin');\r\n            }\r\n            if (scrapedData.socialMedia.facebook) {\r\n                socialMedia.facebook = scrapedData.socialMedia.facebook;\r\n                enrichedFields.push('facebook');\r\n            }\r\n            if (scrapedData.socialMedia.twitter) {\r\n                socialMedia.twitter = scrapedData.socialMedia.twitter;\r\n                enrichedFields.push('twitter');\r\n            }\r\n\r\n            if (Object.keys(socialMedia).length > 0) {\r\n                updateData.socialMedia = socialMedia;\r\n            }\r\n        }\r\n\r\n        // Add enrichment metadata\r\n        updateData.enrichment = {\r\n            lastEnriched: FieldValue.serverTimestamp(),\r\n            enrichedFields,\r\n            enrichmentSource: 'manual',\r\n            scrapedWebsite: website,\r\n            confidence: scrapedData.confidence,\r\n        };\r\n\r\n        // 6. Update Firestore\r\n        if (enrichedFields.length > 0) {\r\n            await docRef.update(updateData);\r\n            console.log(`Successfully enriched ${enrichedFields.length} fields for ${collection}/${documentId}`);\r\n        } else {\r\n            console.log(`No new fields to enrich for ${collection}/${documentId}`);\r\n        }\r\n\r\n        // 7. Return result\r\n        return {\r\n            success: true,\r\n            enrichedFields,\r\n            data: {\r\n                email: verifiedEmail,\r\n                phone: validatedPhone,\r\n                address: scrapedData.address,\r\n                businessName: scrapedData.businessName,\r\n                socialMedia: scrapedData.socialMedia,\r\n                confidence: scrapedData.confidence,\r\n            },\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Enrichment error:', error);\r\n\r\n        if (error instanceof HttpsError) {\r\n            throw error;\r\n        }\r\n\r\n        throw new HttpsError('internal', `Enrichment failed: ${error.message}`);\r\n    }\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { Resend } from \"resend\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\n/**\r\n * Sends a notification email to chris@xiri.ai when a vendor\r\n * completes the onboarding form (status → compliance_review).\r\n */\r\nexport const onOnboardingComplete = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n    secrets: [\"RESEND_API_KEY\"],\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'compliance_review'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'compliance_review') return;\r\n\r\n    const vendorId = event.params.vendorId;\r\n    const businessName = after.businessName || 'Unknown Vendor';\r\n    const email = after.email || 'N/A';\r\n    const phone = after.phone || 'N/A';\r\n    const track = after.onboardingTrack || 'STANDARD';\r\n    const lang = after.preferredLanguage || 'en';\r\n\r\n    logger.info(`Vendor ${vendorId} (${businessName}) completed onboarding. Sending notification.`);\r\n\r\n    const resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\n    // Build compliance summary\r\n    const compliance = after.compliance || {};\r\n    const complianceLines = [\r\n        `Business Entity: ${compliance.hasBusinessEntity ? '✅ Yes' : '❌ No'}`,\r\n        `General Liability: ${compliance.generalLiability?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `Workers Comp: ${compliance.workersComp?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `Auto Insurance: ${compliance.autoInsurance?.hasInsurance ? '✅ Yes' : '❌ No'}`,\r\n        `W-9 Collected: ${compliance.w9Collected ? '✅ Yes' : '⏳ Pending'}`,\r\n    ].join('<br/>');\r\n\r\n    const dashboardLink = `https://app.xiri.ai/supply/crm/${vendorId}`;\r\n\r\n    const html = `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px;\">\r\n        <h2 style=\"color: #0c4a6e;\">🏗️ Vendor Onboarding Complete</h2>\r\n        <p><strong>${businessName}</strong> has completed the onboarding form and is ready for compliance review.</p>\r\n        \r\n        <table style=\"width: 100%; border-collapse: collapse; margin: 16px 0;\">\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Email</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${email}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Phone</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${phone}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Track</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${track === 'FAST_TRACK' ? '⚡ Express Contract' : '🤝 Partner Network'}</td></tr>\r\n            <tr><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0; color: #64748b;\">Language</td><td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${lang === 'es' ? '🇪🇸 Spanish' : '🇺🇸 English'}</td></tr>\r\n        </table>\r\n\r\n        <h3 style=\"color: #0c4a6e; margin-top: 24px;\">Compliance Self-Report</h3>\r\n        <div style=\"background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; font-size: 14px;\">\r\n            ${complianceLines}\r\n        </div>\r\n\r\n        <div style=\"margin-top: 24px;\">\r\n            <a href=\"${dashboardLink}\" style=\"display: inline-block; padding: 12px 24px; background: #0369a1; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;\">\r\n                Review in CRM →\r\n            </a>\r\n        </div>\r\n\r\n        <p style=\"margin-top: 32px; font-size: 12px; color: #94a3b8;\">\r\n            Vendor ID: ${vendorId}\r\n        </p>\r\n    </div>`;\r\n\r\n    try {\r\n        const { data, error } = await resend.emails.send({\r\n            from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n            to: 'chris@xiri.ai',\r\n            subject: `🏗️ Vendor Onboarded: ${businessName}`,\r\n            html,\r\n        });\r\n\r\n        if (error) {\r\n            logger.error('Failed to send onboarding notification:', error);\r\n        } else {\r\n            logger.info(`Notification sent to chris@xiri.ai (Resend ID: ${data?.id})`);\r\n        }\r\n    } catch (err) {\r\n        logger.error('Error sending onboarding notification:', err);\r\n    }\r\n\r\n    // ─── Vendor Confirmation Email ───\r\n    if (email && email !== 'N/A') {\r\n        const isSpanish = lang === 'es';\r\n\r\n        const vendorHtml = isSpanish ? `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px; color: #1e293b;\">\r\n        <div style=\"background: #0c4a6e; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 22px;\">¡Recibimos su solicitud!</h1>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p>Hola <strong>${businessName}</strong>,</p>\r\n            <p>Gracias por completar su solicitud para unirse a la Red de Contratistas de Xiri. Hemos recibido su información y nuestro equipo la revisará en breve.</p>\r\n\r\n            <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin: 20px 0;\">\r\n                <h3 style=\"margin: 0 0 12px 0; color: #0c4a6e; font-size: 15px;\">Lo que recibimos:</h3>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📧 Email: ${email}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📞 Teléfono: ${phone}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📋 Modalidad: ${track === 'FAST_TRACK' ? '⚡ Contrato Express' : '🤝 Red de Socios'}</p>\r\n            </div>\r\n\r\n            <h3 style=\"color: #0c4a6e; font-size: 15px;\">Próximos Pasos:</h3>\r\n            <ol style=\"font-size: 14px; padding-left: 20px;\">\r\n                <li>Nuestro equipo revisará sus documentos e información</li>\r\n                <li>Recibirá una confirmación cuando su cuenta esté verificada</li>\r\n                <li>Una vez aprobado, comenzará a recibir oportunidades de trabajo</li>\r\n            </ol>\r\n\r\n            <p style=\"font-size: 14px; color: #64748b;\">Si tiene alguna pregunta, simplemente responda a este correo.</p>\r\n\r\n            <p style=\"margin-top: 24px;\">Saludos cordiales,<br/><strong>Equipo Xiri Facility Solutions</strong></p>\r\n        </div>\r\n    </div>` : `\r\n    <div style=\"font-family: sans-serif; line-height: 1.8; max-width: 600px; color: #1e293b;\">\r\n        <div style=\"background: #0c4a6e; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\r\n            <h1 style=\"color: white; margin: 0; font-size: 22px;\">We've received your application!</h1>\r\n        </div>\r\n        <div style=\"padding: 32px; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 12px 12px;\">\r\n            <p>Hi <strong>${businessName}</strong>,</p>\r\n            <p>Thank you for completing your application to join the Xiri Contractor Network. We've received your information and our team will review it shortly.</p>\r\n\r\n            <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin: 20px 0;\">\r\n                <h3 style=\"margin: 0 0 12px 0; color: #0c4a6e; font-size: 15px;\">What we received:</h3>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📧 Email: ${email}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📞 Phone: ${phone}</p>\r\n                <p style=\"margin: 4px 0; font-size: 14px;\">📋 Track: ${track === 'FAST_TRACK' ? '⚡ Express Contract' : '🤝 Partner Network'}</p>\r\n            </div>\r\n\r\n            <h3 style=\"color: #0c4a6e; font-size: 15px;\">What happens next:</h3>\r\n            <ol style=\"font-size: 14px; padding-left: 20px;\">\r\n                <li>Our team will review your documents and information</li>\r\n                <li>You'll receive a confirmation once your account is verified</li>\r\n                <li>Once approved, you'll start receiving work opportunities</li>\r\n            </ol>\r\n\r\n            <p style=\"font-size: 14px; color: #64748b;\">If you have any questions, just reply to this email.</p>\r\n\r\n            <p style=\"margin-top: 24px;\">Best regards,<br/><strong>Xiri Facility Solutions Team</strong></p>\r\n        </div>\r\n    </div>`;\r\n\r\n        const vendorSubject = isSpanish\r\n            ? `✅ Solicitud recibida — ${businessName}`\r\n            : `✅ Application received — ${businessName}`;\r\n\r\n        try {\r\n            const { error: vendorError } = await resend.emails.send({\r\n                from: 'Xiri Facility Solutions <onboarding@xiri.ai>',\r\n                replyTo: 'chris@xiri.ai',\r\n                to: email,\r\n                subject: vendorSubject,\r\n                html: vendorHtml,\r\n            });\r\n\r\n            if (vendorError) {\r\n                logger.error('Failed to send vendor confirmation:', vendorError);\r\n            } else {\r\n                logger.info(`Vendor confirmation sent to ${email}`);\r\n            }\r\n        } catch (err) {\r\n            logger.error('Error sending vendor confirmation:', err);\r\n        }\r\n    }\r\n\r\n    // ─── Compliance Score Calculation ───\r\n    const db = admin.firestore();\r\n    const hasEntity = !!compliance.hasBusinessEntity;\r\n    const hasGL = !!compliance.generalLiability?.hasInsurance;\r\n    const hasWC = !!compliance.workersComp?.hasInsurance;\r\n    const hasAuto = !!compliance.autoInsurance?.hasInsurance;\r\n    const hasW9 = !!compliance.w9Collected;\r\n\r\n    // Attestation: up to 50 points (10 per item)\r\n    const attestationItems = [hasEntity, hasGL, hasWC, hasAuto, hasW9];\r\n    const attestationScore = attestationItems.filter(Boolean).length * 10;\r\n\r\n    // Doc uploads: up to 30 points (10 per doc type)\r\n    const uploads = compliance.uploadedDocs || {};\r\n    const docsCount = [uploads.coi, uploads.llc, uploads.w9].filter(Boolean).length;\r\n    const docsUploadedScore = docsCount * 10;\r\n\r\n    // AI verification: 0 for now (Phase 3)\r\n    const docsVerifiedScore = 0;\r\n\r\n    const totalScore = attestationScore + docsUploadedScore + docsVerifiedScore;\r\n\r\n    const complianceUpdate: Record<string, any> = {\r\n        complianceScore: totalScore,\r\n        complianceBreakdown: {\r\n            attestation: attestationScore,\r\n            docsUploaded: docsUploadedScore,\r\n            docsVerified: docsVerifiedScore,\r\n        },\r\n        statusUpdatedAt: new Date(),\r\n    };\r\n\r\n    // Auto-advance if docs are uploaded (score >= 80)\r\n    if (totalScore >= 80) {\r\n        complianceUpdate.status = 'pending_verification';\r\n    }\r\n\r\n    await db.collection(\"vendors\").doc(vendorId).update(complianceUpdate);\r\n\r\n    logger.info(`Vendor ${vendorId} compliance score: ${totalScore}/100 (attest=${attestationScore}, docs=${docsUploadedScore}, verified=${docsVerifiedScore})`);\r\n\r\n    // Log activity\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"ONBOARDING_COMPLETE\",\r\n        description: `${businessName} completed onboarding form (${track}). Compliance score: ${totalScore}/100.`,\r\n        createdAt: new Date(),\r\n        metadata: { track, email, phone, lang, complianceScore: totalScore }\r\n    });\r\n});\r\n","import { onDocumentUpdated } from \"firebase-functions/v2/firestore\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { enqueueTask } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Drip Campaign Scheduler\r\n * \r\n * When a vendor's status changes to 'awaiting_onboarding',\r\n * schedule follow-up emails at Day 3, Day 7, and Day 14.\r\n * \r\n * Each follow-up reminds them to complete the onboarding form.\r\n * After Day 14 with no response, the vendor is auto-dismissed at Day 21.\r\n */\r\nexport const onAwaitingOnboarding = onDocumentUpdated({\r\n    document: \"vendors/{vendorId}\",\r\n}, async (event) => {\r\n    const before = event.data?.before?.data();\r\n    const after = event.data?.after?.data();\r\n    if (!before || !after) return;\r\n\r\n    // Only trigger when status changes TO 'awaiting_onboarding'\r\n    if (before.status === after.status) return;\r\n    if (after.status !== 'awaiting_onboarding') return;\r\n\r\n    const vendorId = event.params.vendorId;\r\n    const businessName = after.businessName || 'Unknown';\r\n\r\n    logger.info(`Scheduling drip campaign for vendor ${vendorId} (${businessName})`);\r\n\r\n    const now = new Date();\r\n\r\n    // Schedule follow-ups: Day 3, Day 7, Day 14\r\n    const followUps = [\r\n        { dayOffset: 3, sequence: 1, subject: 'Quick reminder — complete your Xiri profile' },\r\n        { dayOffset: 7, sequence: 2, subject: 'Just checking in — your Xiri application' },\r\n        { dayOffset: 14, sequence: 3, subject: 'Final follow-up — don\\'t miss out on work opportunities' },\r\n    ];\r\n\r\n    for (const fu of followUps) {\r\n        const scheduledDate = new Date(now);\r\n        scheduledDate.setDate(scheduledDate.getDate() + fu.dayOffset);\r\n        // Schedule at 10am ET\r\n        scheduledDate.setHours(15, 0, 0, 0); // 15:00 UTC = 10:00 ET\r\n\r\n        await enqueueTask(db, {\r\n            vendorId,\r\n            type: 'FOLLOW_UP',\r\n            scheduledAt: admin.firestore.Timestamp.fromDate(scheduledDate),\r\n            metadata: {\r\n                sequence: fu.sequence,\r\n                subject: fu.subject,\r\n                businessName,\r\n                email: after.email,\r\n                preferredLanguage: after.preferredLanguage || 'en',\r\n            }\r\n        });\r\n    }\r\n\r\n    // Log activity\r\n    await db.collection(\"vendor_activities\").add({\r\n        vendorId,\r\n        type: \"DRIP_SCHEDULED\",\r\n        description: `Drip campaign scheduled: 3 follow-ups over 14 days for ${businessName}.`,\r\n        createdAt: new Date(),\r\n        metadata: { followUpCount: 3, schedule: '3d/7d/14d' }\r\n    });\r\n\r\n    logger.info(`Drip campaign scheduled for ${vendorId}: 3 follow-ups at days 3, 7, 14`);\r\n});\r\n","import { onRequest } from \"firebase-functions/v2/https\";\r\nimport * as admin from \"firebase-admin\";\r\nimport * as logger from \"firebase-functions/logger\";\r\nimport { cancelVendorTasks } from \"../utils/queueUtils\";\r\n\r\nif (!admin.apps.length) {\r\n    admin.initializeApp();\r\n}\r\n\r\nconst db = admin.firestore();\r\n\r\n/**\r\n * Unsubscribe Handler\r\n * \r\n * HTTP endpoint that handles vendor unsubscribe requests.\r\n * Called when a vendor clicks the unsubscribe link in their email.\r\n * \r\n * GET /handleUnsubscribe?vendorId=xxx&token=yyy\r\n * \r\n * - Sets vendor status to 'dismissed'\r\n * - Cancels all pending drip/outreach tasks\r\n * - Shows a confirmation page\r\n */\r\nexport const handleUnsubscribe = onRequest({\r\n    cors: true,\r\n}, async (req, res) => {\r\n    const vendorId = req.query.vendorId as string;\r\n\r\n    if (!vendorId) {\r\n        res.status(400).send(renderPage(\r\n            'Invalid Request',\r\n            'Missing vendor identifier. If you clicked a link from an email, please try again.',\r\n            false\r\n        ));\r\n        return;\r\n    }\r\n\r\n    try {\r\n        // Verify vendor exists\r\n        const vendorDoc = await db.collection(\"vendors\").doc(vendorId).get();\r\n        if (!vendorDoc.exists) {\r\n            res.status(404).send(renderPage(\r\n                'Not Found',\r\n                'We couldn\\'t find your record. You may have already been unsubscribed.',\r\n                false\r\n            ));\r\n            return;\r\n        }\r\n\r\n        const vendor = vendorDoc.data()!;\r\n        const businessName = vendor.businessName || 'Vendor';\r\n\r\n        // Already dismissed?\r\n        if (vendor.status === 'dismissed') {\r\n            res.status(200).send(renderPage(\r\n                'Already Unsubscribed',\r\n                `${businessName} has already been removed from our outreach list. You won't receive any more emails.`,\r\n                true\r\n            ));\r\n            return;\r\n        }\r\n\r\n        // Update vendor status to dismissed\r\n        await db.collection(\"vendors\").doc(vendorId).update({\r\n            status: 'dismissed',\r\n            statusUpdatedAt: new Date(),\r\n            dismissReason: 'unsubscribed',\r\n            unsubscribedAt: new Date(),\r\n        });\r\n\r\n        // Cancel all pending tasks\r\n        const cancelledCount = await cancelVendorTasks(db, vendorId);\r\n\r\n        // Log activity\r\n        await db.collection(\"vendor_activities\").add({\r\n            vendorId,\r\n            type: \"STATUS_CHANGE\",\r\n            description: `${businessName} unsubscribed via email link. ${cancelledCount} pending tasks cancelled.`,\r\n            createdAt: new Date(),\r\n            metadata: {\r\n                from: vendor.status,\r\n                to: 'dismissed',\r\n                trigger: 'unsubscribe_link',\r\n                cancelledTasks: cancelledCount,\r\n            }\r\n        });\r\n\r\n        logger.info(`Vendor ${vendorId} (${businessName}) unsubscribed. ${cancelledCount} tasks cancelled.`);\r\n\r\n        res.status(200).send(renderPage(\r\n            'Unsubscribed Successfully',\r\n            `${businessName} has been removed from our outreach list. You won't receive any more emails from Xiri Facility Solutions.<br/><br/>If this was a mistake, please contact us at <a href=\"mailto:chris@xiri.ai\" style=\"color: #0369a1;\">chris@xiri.ai</a>.`,\r\n            true\r\n        ));\r\n\r\n    } catch (err) {\r\n        logger.error(`Error processing unsubscribe for ${vendorId}:`, err);\r\n        res.status(500).send(renderPage(\r\n            'Something Went Wrong',\r\n            'We encountered an error processing your request. Please try again or contact us at <a href=\"mailto:chris@xiri.ai\" style=\"color: #0369a1;\">chris@xiri.ai</a>.',\r\n            false\r\n        ));\r\n    }\r\n});\r\n\r\nfunction renderPage(title: string, message: string, success: boolean): string {\r\n    const icon = success ? '✅' : '⚠️';\r\n    const color = success ? '#059669' : '#dc2626';\r\n\r\n    return `<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>${title} — Xiri Facility Solutions</title>\r\n    <style>\r\n        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f8fafc; }\r\n        .card { background: white; border-radius: 16px; padding: 48px; max-width: 480px; text-align: center; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }\r\n        .icon { font-size: 48px; margin-bottom: 16px; }\r\n        h1 { color: ${color}; font-size: 24px; margin: 0 0 16px 0; }\r\n        p { color: #475569; line-height: 1.6; font-size: 15px; margin: 0; }\r\n        .footer { margin-top: 32px; font-size: 12px; color: #94a3b8; }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div class=\"card\">\r\n        <div class=\"icon\">${icon}</div>\r\n        <h1>${title}</h1>\r\n        <p>${message}</p>\r\n        <div class=\"footer\">Xiri Facility Solutions</div>\r\n    </div>\r\n</body>\r\n</html>`;\r\n}\r\n"],"mappings":"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","names":["db","error","model","admin","db","admin","import_https","error","import_generative_ai","genAI","axios","error","import_firestore","admin","import_generative_ai","error","genAI","model","error","db","error","enqueueTask","admin","logger","import_generative_ai","admin","API_KEY","genAI","model","db","error","db","error","import_firestore","admin","logger","db","error","import_firestore","admin","import_generative_ai","admin","genAI","db","model","error","db","sendTemplatedEmail","error","import_firestore","admin","db","import_firestore","import_params","GEMINI_API_KEY","db","error","import_firestore","admin","logger","import_resend","resend","error","db","import_firestore","admin","logger","db","import_https","admin","logger","db","error","sendTemplatedEmail"]}